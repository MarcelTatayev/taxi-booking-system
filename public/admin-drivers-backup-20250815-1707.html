<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcel's Taxi - Drivers & Vehicles</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="version" content="2.1-fixed-meet-greet">
    
    <style>
        .table-header {
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .table-cell {
            padding: 10px 8px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: top;
            overflow: hidden;
        }
        
        .font-medium {
            font-weight: 500;
            color: #333;
        }
        
        .small-text {
            font-size: 11px;
            color: #666;
            margin-top: 2px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-weight: 500;
            text-transform: uppercase;
            font-size: 10px;
        }
        
        .status-badge.confirmed {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-badge.cancelled {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-badge {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-state h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .empty-state p {
            margin: 0;
            font-size: 14px;
        }
    </style>
    
    
    <script>
        // CRITICAL DRIVER FUNCTIONS - DEFINED IMMEDIATELY
        
        function closeDriverModal() {
            const modal = document.getElementById('addDriverModal');
            if (modal) {
                modal.style.display = 'none';
                console.log('‚úÖ Modal closed');
            }
        }
        
        
        // üî• MARCEL CENTRAL PRICE FUNCTION - ALWAYS USE THIS
        function getCorrectTripPrice(booking) {
            // If booking has individual tripPrice, use it (this should be correctly calculated)
            if (booking.tripPrice !== undefined) {
                console.log('‚úÖ Using individual tripPrice:', booking.tripPrice);
                return parseFloat(booking.tripPrice);
            }
            
            console.log('‚ö†Ô∏è Fallback to 50 euro');
            return 50; // Fallback
        }

        // üåç COUNTRY DETECTION FUNCTION
        function detectCountryFromAddress(address) {
            if (!address) return 'BE'; // Default to Belgium
            const addressLower = address.toLowerCase();
            
            // Belgium
            if (addressLower.includes('brussel') || addressLower.includes('bruxelles') || 
                addressLower.includes('antwerpen') || addressLower.includes('gent') || 
                addressLower.includes('brugge') || addressLower.includes('leuven') ||
                addressLower.includes('mechelen') || addressLower.includes('belgi√´') ||
                addressLower.includes('belgique') || addressLower.includes('belgium') ||
                addressLower.includes('zaventem') || addressLower.includes('charleroi')) {
                return 'BE';
            }
            
            // Netherlands  
            if (addressLower.includes('amsterdam') || addressLower.includes('rotterdam') ||
                addressLower.includes('den haag') || addressLower.includes('utrecht') ||
                addressLower.includes('eindhoven') || addressLower.includes('tilburg') ||
                addressLower.includes('nederland') || addressLower.includes('netherlands') ||
                addressLower.includes('holland') || addressLower.includes('schiphol')) {
                return 'NL';
            }
            
            // Germany
            if (addressLower.includes('berlin') || addressLower.includes('m√ºnchen') ||
                addressLower.includes('hamburg') || addressLower.includes('k√∂ln') ||
                addressLower.includes('frankfurt') || addressLower.includes('stuttgart') ||
                addressLower.includes('deutschland') || addressLower.includes('germany') ||
                addressLower.includes('d√ºsseldorf') || addressLower.includes('dortmund')) {
                return 'DE';
            }
            
            // Spain
            if (addressLower.includes('madrid') || addressLower.includes('barcelona') ||
                addressLower.includes('valencia') || addressLower.includes('sevilla') ||
                addressLower.includes('bilbao') || addressLower.includes('espa√±a') ||
                addressLower.includes('spain') || addressLower.includes('malaga')) {
                return 'ES';
            }
            
            // France
            if (addressLower.includes('paris') || addressLower.includes('lyon') ||
                addressLower.includes('marseille') || addressLower.includes('toulouse') ||
                addressLower.includes('nice') || addressLower.includes('nantes') ||
                addressLower.includes('france') || addressLower.includes('frankrijk')) {
                return 'FR';
            }
            
            return 'BE'; // Default
        }

        // üåç GET COUNTRY FLAG AND NAME
        function getCountryInfo(countryCode) {
            switch (countryCode) {
                case 'BE': return { flag: 'üáßüá™', name: 'BE', color: '#000000' };
                case 'NL': return { flag: 'üá≥üá±', name: 'NL', color: '#FF8C00' };
                case 'DE': return { flag: 'üá©üá™', name: 'DE', color: '#FF0000' };
                case 'ES': return { flag: 'üá™üá∏', name: 'ES', color: '#C60B1E' };
                case 'FR': return { flag: 'üá´üá∑', name: 'FR', color: '#0055A4' };
                default: return { flag: 'üáßüá™', name: 'BE', color: '#000000' };
            }
        }

        // üö® DISPATCH ACTIONS
        function dispatchAssignDriver(bookingId) {
            alert(`Assign driver functionality for booking ${bookingId} - Coming soon!`);
        }

        function dispatchBroadcastRide(bookingId) {
            alert(`Broadcast ride functionality for booking ${bookingId} - Coming soon!`);
        }

        function dispatchAutoAssign(bookingId) {
            alert(`Auto-assign functionality for booking ${bookingId} - Coming soon!`);
        }

        // üöó GET DRIVER OPTIONS HTML
        function getDriverOptionsHTML(selectedDriver) {
            const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            let html = '';
            
            drivers.forEach(driver => {
                if (driver.status === 'online') {
                    html += `<option value="${driver.id}" ${selectedDriver === driver.id ? 'selected' : ''}>${driver.name}</option>`;
                }
            });
            
            return html || '<option value="">No drivers available</option>';
        }

        // üöó ASSIGN DRIVER TO BOOKING
        function assignDriverToBooking(bookingId, driverValue) {
            console.log(`Assigning driver ${driverValue} to booking ${bookingId}`);
            
            // Get confirmed bookings
            let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            
            // Find and update booking
            const bookingIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                confirmedBookings[bookingIndex].driver = driverValue;
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                
                // Handle automatic assignments with email
                if (driverValue.startsWith('auto-')) {
                    const autoType = {
                        'auto-all': 'üì¢ Broadcasting to all drivers',
                        'auto-nearby': 'üìç Notifying nearby drivers',
                        'auto-lastminute': '‚è∞ Auto-assigning for last-minute transfer'
                    };
                    
                    // Determine email template based on auto type
                    let templateType = 'normal';
                    if (driverValue === 'auto-lastminute') {
                        templateType = 'lastminute';
                    } else if (driverValue === 'auto-all') {
                        // Check if urgent based on time
                        const booking = confirmedBookings[bookingIndex];
                        const tripDateTime = new Date(`${booking.trip.travelDate.split('/').reverse().join('-')}T${booking.trip.travelHour}:${booking.trip.travelMinute}`);
                        const now = new Date();
                        const hoursUntil = Math.ceil((tripDateTime - now) / (1000 * 60 * 60));
                        
                        if (hoursUntil <= 2) {
                            templateType = 'urgent';
                        } else if (hoursUntil <= 4) {
                            templateType = 'lastminute';
                        }
                    }
                    
                    showNotification(autoType[driverValue] || 'Driver assignment updated', 'success');
                    
                    // Auto-send email for broadcast options
                    setTimeout(() => {
                        if (confirm(`Wil je nu automatisch een email versturen naar de chauffeurs?`)) {
                            sendEmail(bookingId, templateType);
                        }
                    }, 1000);
                    
                } else if (driverValue) {
                    // Specific driver assignment
                    const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
                    const driver = drivers.find(d => d.id === driverValue);
                    showNotification(`‚úÖ Assigned to ${driver ? driver.name : 'driver'}`, 'success');
                    
                    // Option to send confirmation email to specific driver
                    if (driver) {
                        setTimeout(() => {
                            if (confirm(`Wil je een bevestigings email sturen naar ${driver.name}?`)) {
                                sendEmail(bookingId, 'normal');
                            }
                        }, 1000);
                    }
                }
            }
        }

        // üì± QUICK ACTIONS
        function sendSMS(bookingId) {
            alert(`SMS functionality for booking ${bookingId} - Coming soon!`);
        }

        // üìß EMAIL TEMPLATES
        const emailTemplates = {
            normal: {
                subject: "Nieuwe Taxirit Beschikbaar - {datetime}",
                body: `Beste chauffeur,

Er is een nieuwe taxirit beschikbaar:

üóìÔ∏è Datum & Tijd: {datetime}
üìç Ophalen: {pickup}
üìç Bestemming: {destination}
üë§ Klant: {customer} - {phone}
üöó Voertuig: {vehicle}
üí∞ Prijs: ‚Ç¨{price}
üìã Opmerkingen: {notes}

Reageer zo snel mogelijk als je deze rit kunt uitvoeren.

Met vriendelijke groet,
Taxi Dispatch Team`
            },
            urgent: {
                subject: "üö® URGENTE Taxirit - Binnen {timeLeft} uur!",
                body: `üö® URGENT - Directe chauffeur nodig!

BELANGRIJKE RIT DETAILS:
üóìÔ∏è Datum & Tijd: {datetime} (VANDAAG!)
üìç Ophalen: {pickup}
üìç Bestemming: {destination}
üë§ Klant: {customer} - {phone}
üöó Voertuig: {vehicle}
üí∞ Prijs: ‚Ç¨{price}
üìã Opmerkingen: {notes}

‚ö†Ô∏è Deze rit moet binnen {timeLeft} uur beginnen!
Reageer ONMIDDELLIJK als je beschikbaar bent.

Dringende groet,
Taxi Dispatch Team`
            },
            lastminute: {
                subject: "‚è∞ LAST-MINUTE Transfer - {datetime}",
                body: `‚è∞ LAST-MINUTE VERZOEK

Een klant heeft dringend een taxi nodig:

üóìÔ∏è Datum & Tijd: {datetime}
üìç Ophalen: {pickup}
üìç Bestemming: {destination}
üë§ Klant: {customer} - {phone}
üöó Voertuig: {vehicle}
üí∞ Prijs: ‚Ç¨{price}
üìã Opmerkingen: {notes}

Dit is een last-minute boeking. Eerste reactie krijgt de rit!

Met spoed,
Taxi Dispatch Team`
            }
        };

        function sendEmail(bookingId, templateType = 'normal') {
            // Get booking details
            let booking = null;
            
            // Search in all booking arrays
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            booking = confirmedBookings.find(b => b.bookingId === bookingId) || 
                     unconfirmedBookings.find(b => b.bookingId === bookingId);
            
            if (!booking) {
                alert('Boeking niet gevonden!');
                return;
            }
            
            showEmailModal(booking, templateType);
        }

        function showEmailModal(booking, templateType = 'normal') {
            // Calculate time until trip
            const tripDateTime = new Date(`${booking.trip.travelDate.split('/').reverse().join('-')}T${booking.trip.travelHour}:${booking.trip.travelMinute}`);
            const now = new Date();
            const hoursUntil = Math.ceil((tripDateTime - now) / (1000 * 60 * 60));
            
            // Auto-select template based on urgency
            if (hoursUntil <= 2) {
                templateType = 'urgent';
            } else if (hoursUntil <= 4) {
                templateType = 'lastminute';
            }
            
            const template = emailTemplates[templateType];
            const vehicleName = booking.vehicle?.vehicle?.name || 'Saloon';
            const price = booking.finalPrice || booking.totalPrice || '50.00';
            
            // Replace template variables
            const subject = template.subject
                .replace('{datetime}', `${booking.trip.travelDate} om ${booking.trip.travelHour}:${booking.trip.travelMinute}`)
                .replace('{timeLeft}', hoursUntil.toString());
                
            const body = template.body
                .replace('{datetime}', `${booking.trip.travelDate} om ${booking.trip.travelHour}:${booking.trip.travelMinute}`)
                .replace('{pickup}', booking.trip.fromLocation)
                .replace('{destination}', booking.trip.toLocation)
                .replace('{customer}', `${booking.customer.firstName} ${booking.customer.lastName}`)
                .replace('{phone}', booking.customer.phone)
                .replace('{vehicle}', vehicleName)
                .replace('{price}', price)
                .replace('{notes}', booking.specialInstructions || 'Geen bijzondere verzoeken')
                .replace(/{timeLeft}/g, hoursUntil.toString());
            
            // Show modal with email preview
            const modal = document.createElement('div');
            modal.id = 'emailModal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); display: flex; align-items: center; 
                justify-content: center; z-index: 1000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 700px; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin: 0 0 20px 0; color: #333;">üìß Email naar Chauffeurs</h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Template Type:</label>
                        <select id="templateSelect" style="padding: 8px; border: 1px solid #ddd; border-radius: 6px; width: 200px;" onchange="switchEmailTemplate('${booking.bookingId}', this.value)">
                            <option value="normal" ${templateType === 'normal' ? 'selected' : ''}>üìß Normale Email</option>
                            <option value="urgent" ${templateType === 'urgent' ? 'selected' : ''}>üö® Urgent</option>
                            <option value="lastminute" ${templateType === 'lastminute' ? 'selected' : ''}>‚è∞ Last-Minute</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Onderwerp:</label>
                        <input type="text" id="emailSubject" value="${subject}" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="font-weight: 600; display: block; margin-bottom: 5px;">Email Inhoud:</label>
                        <textarea id="emailBody" rows="12" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace; font-size: 14px;">${body}</textarea>
                    </div>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <h4 style="margin: 0 0 10px 0; color: #666;">Versturen naar:</h4>
                        <div id="recipientOptions">
                            <label style="display: block; margin-bottom: 8px;">
                                <input type="radio" name="recipients" value="all" checked> 
                                üìß Alle Chauffeurs (${getDrierCount()} chauffeurs)
                            </label>
                            <label style="display: block; margin-bottom: 8px;">
                                <input type="radio" name="recipients" value="country"> 
                                üåç Alleen Chauffeurs in ${getCountryName(booking.trip.fromLocation)}
                            </label>
                            <label style="display: block;">
                                <input type="radio" name="recipients" value="online"> 
                                üü¢ Alleen Online Chauffeurs
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEmailModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
                            Annuleren
                        </button>
                        <button onclick="sendEmailToDrivers('${booking.bookingId}')" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600;">
                            üìß Email Versturen
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function switchEmailTemplate(bookingId, templateType) {
            closeEmailModal();
            
            // Find booking and show modal with new template
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            const booking = confirmedBookings.find(b => b.bookingId === bookingId) || 
                           unconfirmedBookings.find(b => b.bookingId === bookingId);
            
            if (booking) {
                showEmailModal(booking, templateType);
            }
        }

        function getDrierCount() {
            const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            return drivers.length;
        }

        function getCountryName(address) {
            const country = detectCountryFromAddress(address);
            const countryNames = {
                'BE': 'Belgi√´',
                'NL': 'Nederland', 
                'DE': 'Duitsland',
                'ES': 'Spanje',
                'FR': 'Frankrijk'
            };
            return countryNames[country] || 'Belgi√´';
        }

        function sendEmailToDrivers(bookingId) {
            const subject = document.getElementById('emailSubject').value;
            const body = document.getElementById('emailBody').value;
            const recipients = document.querySelector('input[name="recipients"]:checked').value;
            
            // Get driver count based on selection
            const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            let recipientCount = 0;
            
            switch(recipients) {
                case 'all':
                    recipientCount = drivers.length;
                    break;
                case 'country':
                    recipientCount = drivers.filter(d => d.country === detectCountryFromAddress(document.querySelector('#emailBody').value)).length || Math.floor(drivers.length * 0.7);
                    break;
                case 'online':
                    recipientCount = drivers.filter(d => d.status === 'online').length;
                    break;
            }
            
            // Simulate email sending
            closeEmailModal();
            
            // Show success notification
            showNotification(`‚úÖ Email verzonden naar ${recipientCount} chauffeurs`, 'success');
            
            // Log the action
            console.log('üìß Email sent:', {
                bookingId,
                subject,
                recipients,
                recipientCount,
                timestamp: new Date().toISOString()
            });
            
            // Update booking with email sent status
            updateBookingEmailStatus(bookingId, recipients, recipientCount);
        }

        function updateBookingEmailStatus(bookingId, recipients, count) {
            const now = new Date().toLocaleString('nl-BE');
            
            // Update in confirmed bookings
            let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const confirmedIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (confirmedIndex !== -1) {
                if (!confirmedBookings[confirmedIndex].emailHistory) {
                    confirmedBookings[confirmedIndex].emailHistory = [];
                }
                confirmedBookings[confirmedIndex].emailHistory.push({
                    timestamp: now,
                    recipients: recipients,
                    count: count
                });
                confirmedBookings[confirmedIndex].lastEmailSent = now;
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            }
            
            // Update in unconfirmed bookings  
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const unconfirmedIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (unconfirmedIndex !== -1) {
                if (!unconfirmedBookings[unconfirmedIndex].emailHistory) {
                    unconfirmedBookings[unconfirmedIndex].emailHistory = [];
                }
                unconfirmedBookings[unconfirmedIndex].emailHistory.push({
                    timestamp: now,
                    recipients: recipients,
                    count: count
                });
                unconfirmedBookings[unconfirmedIndex].lastEmailSent = now;
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            }
        }

        function closeEmailModal() {
            const modal = document.getElementById('emailModal');
            if (modal) {
                modal.remove();
            }
        }

        function printBooking(bookingId) {
            alert(`Print functionality for booking ${bookingId} - Coming soon!`);
        }

        

        // WORKING DRIVER FUNCTIONS - LOADED FIRST
        let drivers = [];
        
        // üöÄ SAFE FUNCTION WRAPPER - PREVENT "NOT DEFINED" ERRORS
        window.safeCall = function(functionName, ...args) {
            if (typeof window[functionName] === 'function') {
                return window[functionName](...args);
            } else {
                console.warn(`Function ${functionName} not yet defined, retrying in 100ms...`);
                setTimeout(() => {
                    if (typeof window[functionName] === 'function') {
                        window[functionName](...args);
                    } else {
                        console.error(`Function ${functionName} still not defined after retry`);
                    }
                }, 100);
            }
        };
        
        // Placeholder functions that will be replaced when real functions load
        window.refreshUnconfirmedBookings = function() {
            console.log('üîÑ refreshUnconfirmedBookings placeholder - waiting for real function...');
        };

        // üß™ TEST DATA FUNCTION - Add sample confirmed bookings for Next 24 Hours

        
        // üöÄ CRITICAL UI FUNCTIONS - DEFINE IMMEDIATELY
        window.toggleMenu = function(menuName) {
            
            const menu = document.getElementById(menuName + '-menu');
            if (!menu) {
                console.error('‚ùå Menu not found:', menuName + '-menu');
                return;
            }
            
            
            // Close other menus
            const allMenus = document.querySelectorAll('.nav-submenu');
            allMenus.forEach(m => {
                if (m.id !== menuName + '-menu') {
                    m.style.display = 'none';
                }
            });
            
            // Toggle current menu
            if (menu.style.display === 'none' || menu.style.display === '') {
                menu.style.display = 'block';
                console.log('‚úÖ Menu opened:', menuName);
            } else {
                menu.style.display = 'none';
                console.log('‚úÖ Menu closed:', menuName);
            }
        };

        // üöÄ SHOWSECTION FUNCTION - DEFINE IMMEDIATELY
        window.showSection = function(sectionName) {
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    // Betere titels voor verschillende secties
                    const titleMap = {
                        'unconfirmed': 'üìã Unconfirmed Bookings',
                        'next-24h': 'üìã Next 24 Hours',
                        'latest': 'üìã Latest Bookings',
                        'completed': '‚úÖ Completed Bookings',
                        'cancelled': '‚ùå Cancelled Bookings',
                        'all-bookings': 'üìã All Bookings',
                        'trash': 'üóëÔ∏è Trash',
                        'distance-time': 'üí∞ Distance & Time Pricing',
                        'dispatch': 'üö® Dispatch Center',
                        'drivers': 'üöó TEST - Driver Management',
                        'vehicle-manager': 'üöó Vehicle Manager',
                        'general': '‚öôÔ∏è General Settings',
                        'mail': 'üìß Email Settings',
                        'item-surcharge': 'üí∞ Item Surcharge',
                        'location-surcharge': 'üìç Location Surcharge',
                        'payment-methods': 'üí≥ Payment Methods'
                    };
                    
                    pageTitle.textContent = titleMap[sectionName] || sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
                    
                    // Set subtitle
                    const pageSubtitle = document.getElementById('pageSubtitle');
                    const subtitleMap = {
                        'next-24h': 'Confirmed bookings for the next 24 hours',
                        'unconfirmed': 'New bookings awaiting confirmation',
                        'latest': 'Most recent booking requests',
                        'completed': 'Successfully completed trips and services',
                        'cancelled': 'Cancelled and deleted bookings',
                        'all-bookings': 'Complete history of all bookings from customer and dispatch systems',
                        'trash': 'Deleted bookings (can be restored or permanently deleted)',
                        'distance-time': 'Configure pricing for each vehicle type - prices will be used in the booking system',
                        'dispatch': 'Manual taxi booking and dispatch system'
                    };
                    
                    if (pageSubtitle) {
                        pageSubtitle.textContent = subtitleMap[sectionName] || '';
                    }
                }
                
                // Special section loading with safe function calls
                if (sectionName === 'distance-time') {
                    setTimeout(() => {
                        if (typeof loadVehiclePricing === 'function') loadVehiclePricing();
                    }, 200);
                }
                if (sectionName === 'unconfirmed') {
                    setTimeout(() => {
                        if (typeof loadUnconfirmedBookingsV2 === 'function') loadUnconfirmedBookingsV2();
                    }, 200);
                }
                if (sectionName === 'next-24h') {
                    setTimeout(() => {
                        if (typeof loadNext24hBookings === 'function') loadNext24hBookings();
                    }, 200);
                }
                if (sectionName === 'drivers') {
                    setTimeout(() => {
                        if (typeof loadDriversList === 'function') loadDriversList();
                    }, 200);
                }
                if (sectionName === 'dispatch') {
                    console.log('üö® Dispatch section loading...');
                    setTimeout(() => {
                        console.log('üîÑ Loading dispatch components...');
                        if (typeof loadDispatchTable === 'function') {
                            console.log('üìã Loading dispatch table...');
                            loadDispatchTable();
                        }
                        if (typeof initDispatchMap === 'function') {
                            console.log('üó∫Ô∏è Initializing dispatch map...');
                            initDispatchMap();
                        }
                        
                        // Force load vehicles with additional timeout to ensure DOM is ready
                        setTimeout(() => {
                            console.log('üöó Force loading dispatch vehicles...');
                            const vehicleSelect = document.getElementById('dispatchVehicleSelect');
                            if (vehicleSelect) {
                                console.log('‚úÖ Vehicle dropdown found, loading vehicles...');
                                
                                // Clear existing options
                                vehicleSelect.innerHTML = '';
                                
                                // Get vehicles from localStorage or create defaults
                                let taxiVehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
                                
                                // Default vehicles if none exist
                                if (taxiVehicles.length === 0) {
                                    taxiVehicles = [
                                        { id: 'saloon', name: 'Saloon', passengers: 4 },
                                        { id: 'estate', name: 'Estate', passengers: 4 },
                                        { id: 'minivan', name: 'Minivan', passengers: 6 },
                                        { id: 'minibus', name: 'Minibus', passengers: 8 }
                                    ];
                                    localStorage.setItem('taxiVehicles', JSON.stringify(taxiVehicles));
                                    console.log('‚ö†Ô∏è Created default vehicles');
                                }
                                
                                // Add Unassigned option first
                                const unassignedOption = document.createElement('option');
                                unassignedOption.value = '';
                                unassignedOption.textContent = 'üöó Unassigned';
                                vehicleSelect.appendChild(unassignedOption);
                                
                                // Add all vehicles
                                taxiVehicles.forEach(vehicle => {
                                    const option = document.createElement('option');
                                    option.value = vehicle.id;
                                    option.textContent = `üöó ${vehicle.name} (${vehicle.passengers} seats)`;
                                    vehicleSelect.appendChild(option);
                                    console.log(`‚ûï Added: ${vehicle.name}`);
                                });
                                
                                console.log(`‚úÖ Loaded ${taxiVehicles.length} vehicles into dropdown`);
                            } else {
                                console.error('‚ùå Vehicle dropdown element not found!');
                            }
                        }, 500);
                    }, 200);
                }
                if (sectionName === 'vehicle-manager') {
                    console.log('üöó Vehicle Manager section loading...');
                    setTimeout(() => {
                        loadAdminVehicles();
                    }, 200);
                }
            } else {
                console.error('‚ùå Section not found:', sectionName + '-section');
            }
        };
        
        
        function loadDriversList() {
            drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            
            const tbody = document.getElementById('driversTableBody');
            if (!tbody) {
                setTimeout(loadDriversList, 100); // Retry if element not ready
                return;
            }
            
            tbody.innerHTML = '';
            
            if (drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üöñ</div>
                            <div style="font-size: 18px;">Nog geen chauffeurs toegevoegd</div>
                            <div style="font-size: 14px; margin-top: 5px;">Klik op "Nieuwe Chauffeur Toevoegen" om te beginnen</div>
                        </td>
                    </tr>
                `;
                updateDriverStats();
                return;
            }
            
            drivers.forEach(driver => {
                const row = document.createElement('tr');
                
                const statusColor = driver.status === 'online' ? '#28a745' : '#6c757d';
                const statusText = driver.status === 'online' ? 'Online' : 'Offline';
                const verifiedText = driver.verified ? '‚úÖ Geverifieerd' : '‚è≥ Verificatie nodig';
                const verifiedColor = driver.verified ? '#28a745' : '#dc3545';
                
                row.innerHTML = `
                    <td class="col-status">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColor}"></div>
                            <span>${statusText}</span>
                        </div>
                    </td>
                    <td class="col-name" style="font-weight: 500;">${driver.name}</td>
                    <td class="col-phone">${driver.phone}</td>
                    <td class="col-email">${driver.email}</td>
                    <td class="col-vehicle">${driver.vehicle}</td>
                    <td class="col-documents">
                        <span style="color: ${verifiedColor};">${verifiedText}</span>
                    </td>
                    <td class="col-rating">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: #ffc107;">‚≠ê</span>
                            <span>${driver.rating}</span>
                        </div>
                    </td>
                    <td class="col-actions">
                        <button onclick="editDriver('${driver.id}')" style="background: #007bff; color: white;">
                            ‚úèÔ∏è Bewerk
                        </button>
                        <button onclick="deleteDriver('${driver.id}')" style="background: #dc3545; color: white;">
                            üóëÔ∏è Verwijder
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            updateDriverStats();
        }
        
        function editDriver(id) {
            drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            const driver = drivers.find(d => d.id === id);
            if (!driver) {
                alert('Chauffeur niet gevonden');
                return;
            }
            
            const newName = prompt('Nieuwe naam:', driver.name);
            if (newName) {
                driver.name = newName;
                localStorage.setItem('taxiDrivers', JSON.stringify(drivers));
                alert('Chauffeur bijgewerkt!');
                loadDriversList();
            }
        }
        
        function deleteDriver(id) {
            drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            const driver = drivers.find(d => d.id === id);
            if (!driver) {
                alert('Chauffeur niet gevonden');
                return;
            }
            
            if (confirm(`Weet je zeker dat je ${driver.name} wilt verwijderen?`)) {
                drivers = drivers.filter(d => d.id !== id);
                localStorage.setItem('taxiDrivers', JSON.stringify(drivers));
                alert('Chauffeur verwijderd!');
                loadDriversList();
            }
        }
        
        function searchDrivers(query) {
            drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            
            if (!query) {
                loadDriversList();
                return;
            }
            
            const filteredDrivers = drivers.filter(driver => 
                driver.name.toLowerCase().includes(query.toLowerCase()) ||
                driver.email.toLowerCase().includes(query.toLowerCase()) ||
                driver.phone.includes(query)
            );
            
            const tbody = document.getElementById('driversTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredDrivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                            Geen chauffeurs gevonden voor "${query}"
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredDrivers.forEach(driver => {
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid #dee2e6';
                
                const statusColor = driver.status === 'online' ? '#28a745' : '#6c757d';
                const statusText = driver.status === 'online' ? 'Online' : 'Offline';
                const verifiedText = driver.verified ? '‚úÖ Geverifieerd' : '‚è≥ Verificatie nodig';
                const verifiedColor = driver.verified ? '#28a745' : '#dc3545';
                
                row.innerHTML = `
                    <td class="section-padding">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColor}"></div>
                            <span>${statusText}</span>
                        </div>
                    </td>
                    <td style="padding: 15px; font-weight: 500;">${driver.name}</td>
                    <td class="section-padding">${driver.phone}</td>
                    <td class="section-padding">${driver.email}</td>
                    <td class="section-padding">${driver.vehicle}</td>
                    <td class="section-padding">
                        <span style="color: ${verifiedColor};">${verifiedText}</span>
                    </td>
                    <td class="section-padding">
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <span style="color: #ffc107;">‚≠ê</span>
                            <span>${driver.rating}</span>
                        </div>
                    </td>
                    <td style="padding: 15px; text-align: center;">
                        <button onclick="editDriver('${driver.id}')" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                            ‚úèÔ∏è Bewerk
                        </button>
                        <button onclick="deleteDriver('${driver.id}')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                            üóëÔ∏è Verwijder
                        </button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }
        
        function updateDriverStats() {
            drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            const totalCount = drivers.length;
            const onlineCount = drivers.filter(d => d.status === 'online').length;
            const busyCount = drivers.filter(d => d.status === 'busy').length;
            const pendingCount = drivers.filter(d => !d.verified).length;
            
            const totalEl = document.getElementById('totalDriversCount');
            const onlineEl = document.getElementById('onlineDriversCount');
            const busyEl = document.getElementById('busyDriversCount');
            const pendingEl = document.getElementById('pendingDocsCount');
            
            if (totalEl) totalEl.textContent = totalCount;
            if (onlineEl) onlineEl.textContent = onlineCount;
            if (busyEl) busyEl.textContent = busyCount;
            if (pendingEl) pendingEl.textContent = pendingCount;
        }
        
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
        }

        .admin-layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            grid-template-rows: auto 1fr;
            min-height: 100vh;
        }

        .sidebar {
            grid-row: 1 / -1;
            background: #2c3e50;
            color: white;
            padding: 0;
        }

        .sidebar-header {
            padding: 20px;
            background: #34495e;
            border-bottom: 1px solid #2c3e50;
        }

        .nav-menu {
            list-style: none;
            padding: 0;
        }

        .nav-item {
            border-bottom: 1px solid #34495e;
        }

        .nav-link {
            display: block;
            padding: 15px 20px;
            color: #bdc3c7;
            text-decoration: none;
            cursor: pointer;
            transition: all 0.3s;
        }

        .nav-link:hover {
            background: #34495e;
            color: white;
        }

        .nav-submenu {
            background: #1a252f;
            display: none;
        }

        .nav-submenu.show {
            display: block;
        }

        .nav-submenu .nav-link {
            padding: 12px 20px 12px 52px;
            font-size: 14px;
        }

        .main-content {
            flex: 1;
            background: #f5f7fa;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e1e8ed;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            display: block;
        }

        .content-area {
            padding: 30px;
            grid-column: 2;
            grid-row: 2;
            background: #f5f7fa;
        }

        .content-section {
            display: none;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .content-section.active {
            display: block;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-success {
            background: #27ae60;
            color: white;
        }

        .test-area {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            border: 2px dashed #dee2e6;
        }

        /* Booking Edit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 22px;
        }

        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px;
        }

        .modal-body {
            padding: 30px;
        }

        .edit-section {
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
        }

        .edit-section h3 {
            margin: 0 0 15px 0;
            color: #2c3e50;
            border-bottom: 2px solid #f8f9fa;
            padding-bottom: 10px;
        }

        .edit-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .edit-field {
            display: flex;
            flex-direction: column;
        }

        .edit-field label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .edit-field input,
        .edit-field select,
        .edit-field textarea {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .edit-field input:focus,
        .edit-field select:focus,
        .edit-field textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        .modal-actions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 0 0 12px 12px;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background: #007bff;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #0056b3;
        }

        .modal-btn-success {
            background: #28a745;
            color: white;
        }

        .modal-btn-success:hover {
            background: #1e7e34;
        }

        .modal-btn-danger {
            background: #dc3545;
            color: white;
        }

        /* üÜï BOOKING OVERVIEW STYLES */
        .overview-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-left: 4px solid #007bff;
        }

        .overview-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 2px solid #f8f9fa;
        }

        .overview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .overview-row:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-weight: 500;
            color: #495057;
            font-size: 14px;
        }

        .overview-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
            text-align: right;
        }

        .overview-total {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            border: 2px solid #dee2e6;
        }

        .overview-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            font-size: 16px;
        }

        .overview-total-row:last-child {
            font-weight: 700;
            font-size: 20px;
            color: #2c3e50;
            border-top: 2px solid #dee2e6;
            padding-top: 15px;
            margin-top: 10px;
        }

        .modal-btn-danger:hover {
            background: #c82333;
        }

        .modal-btn-secondary {
            background: #6c757d;
            color: white;
        }

        .modal-btn-secondary:hover {
            background: #545b62;
        }

        /* Status Dropdown */
        .status-dropdown {
            position: relative;
            display: inline-block;
        }

        .status-badge {
            background: #ffc107;
            color: #856404;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.3s ease;
        }

        .status-badge:hover {
            background: #e0a800;
            transform: translateY(-1px);
        }

        .status-badge.confirmed {
            background: #28a745;
            color: white;
        }

        .status-badge.confirmed:hover {
            background: #1e7e34;
        }

        .status-badge.cancelled {
            background: #dc3545;
            color: white;
        }

        .status-badge.cancelled:hover {
            background: #c82333;
        }

        .status-dropdown-menu {
            position: fixed;
            min-width: 180px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 99999;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .status-dropdown-menu.show {
            display: block;
        }

        .status-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-option:hover {
            background: #f8f9fa;
        }

        .status-option:first-child {
            border-radius: 6px 6px 0 0;
        }

        .status-option:last-child {
            border-radius: 0 0 6px 6px;
        }

        .status-option.current {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }

        .status-option .status-icon {
            width: 16px;
            text-align: center;
        }

        /* Driver Dropdown */
        .driver-dropdown {
            position: relative;
            display: inline-block;
        }

        .driver-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .driver-badge.unassigned {
            background: #6c757d;
            color: white;
        }

        .driver-badge.unassigned:hover {
            background: #545b62;
        }

        .driver-badge.assigned {
            background: #28a745;
            color: white;
        }

        .driver-badge.assigned:hover {
            background: #218838;
        }

        .driver-dropdown-menu {
            position: fixed;
            min-width: 200px;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            z-index: 99999;
            display: none;
            max-height: 300px;
            overflow-y: auto;
        }

        .driver-dropdown-menu.show {
            display: block;
        }

        .driver-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 14px;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .driver-option:hover {
            background: #f8f9fa;
            color: #495057;
        }

        .driver-option.selected {
            background: #28a745;
            color: white;
        }

        .driver-option.unassign {
            border-top: 1px solid #dee2e6;
            color: #dc3545;
        }

        .driver-option.unassign:hover {
            background: #f8d7da;
            color: #721c24;
        }

        /* REUSABLE CLASSES TO REPLACE INLINE STYLES */
        .table-cell { 
            padding: 6px; 
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            font-size: 12px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .table-header { 
            padding: 12px; 
            text-align: left; 
            font-weight: 600;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            color: #495057;
        }
        
        /* IMPROVED TABLE STYLING WITH PROPER COLUMN WIDTHS */
        .drivers-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed; /* Ensures consistent column widths */
        }
        
        .drivers-table th,
        .drivers-table td {
            padding: 15px 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
            vertical-align: middle;
            word-wrap: break-word;
            overflow: hidden;
        }
        
        .drivers-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
            white-space: nowrap;
        }
        
        /* DRIVERS TABLE SPECIFIC COLUMN WIDTHS */
        .drivers-table .col-status { width: 8%; min-width: 80px; }
        .drivers-table .col-name { width: 18%; min-width: 150px; }
        .drivers-table .col-phone { width: 12%; min-width: 120px; }
        .drivers-table .col-email { width: 20%; min-width: 180px; }
        .drivers-table .col-vehicle { width: 15%; min-width: 120px; }
        .drivers-table .col-documents { width: 12%; min-width: 120px; }
        .drivers-table .col-rating { width: 8%; min-width: 80px; }
        .drivers-table .col-actions { width: 15%; min-width: 140px; text-align: center; }
        
        /* RESPONSIVE TABLE BEHAVIOR */
        @media (max-width: 1200px) {
            .drivers-table .col-email { display: none; }
            .drivers-table .col-vehicle { width: 20%; }
            .drivers-table .col-name { width: 25%; }
        }
        
        @media (max-width: 768px) {
            .drivers-table .col-documents,
            .drivers-table .col-rating { display: none; }
            .drivers-table .col-name { width: 35%; }
            .drivers-table .col-phone { width: 20%; }
            .drivers-table .col-actions { width: 25%; }
        }
        
        /* TABLE ACTION BUTTONS STYLING */
        .drivers-table .col-actions button {
            padding: 6px 12px;
            margin: 2px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.3s ease;
            display: inline-block;
        }
        
        .drivers-table .col-actions button:hover {
            opacity: 0.8;
            transform: translateY(-1px);
        }
        
        /* GENERAL TABLE IMPROVEMENTS */
        table {
            border-spacing: 0;
        }
        
        table tr:hover {
            background-color: #f8f9fa;
        }
        
        table tr:nth-child(even) {
            background-color: #fafbfc;
        }
        
        table tr:nth-child(even):hover {
            background-color: #f1f3f4;
        }
        .input-field { width: 100%; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; }
        .form-label { display: block; font-weight: 600; margin-bottom: 5px; }
        .form-label-alt { display: block; font-weight: 500; margin-bottom: 8px; }
        .section-margin { margin-bottom: 15px; }
        .section-margin-lg { margin-bottom: 20px; }
        .section-padding { padding: 15px; }
        .input-field-alt { width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; }
        .text-color { color: #2c3e50; margin-bottom: 15px; }
        .input-large { width: 100%; padding: 10px; border: 1px solid #dee2e6; border-radius: 6px; font-size: 14px; }
        .form-label-gray { display: block; margin-bottom: 5px; font-weight: 500; color: #495057; }
        .small-text { font-size: 12px; color: #666; }
        .help-text { display: block; margin-bottom: 5px; color: #666; font-size: 13px; }
        .card { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .empty-state { text-align: center; padding: 40px; color: #6c757d; }
        .margin-left { margin-left: 5px; }
        .field-label { font-weight: 600; color: #495057; font-size: 14px; }
        .flex-center { display: flex; align-items: center; gap: 10px; }
        .font-medium { font-weight: 500; }
        .form-label-dark { display: block; margin-bottom: 5px; font-weight: 600; color: #2c3e50; }
        .input-xlarge { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; }
        .table-cell-alt { padding: 15px; text-align: left; border-bottom: 1px solid #dee2e6; }
        .btn-outline { background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer; }
        .field-value { margin-top: 4px; font-size: 16px; color: #2c3e50; }
        .white-card-12 { background: white; border-radius: 12px; }
        .padding-15 { padding: 15px; }
        .margin-bottom-20 { margin-bottom: 20px; }
        
        /* LAYOUT FIXES */
        .page-header {
            background: white;
            padding: 15px 30px;
            border-bottom: 1px solid #e1e8ed;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            display: block;
            grid-column: 2;
            grid-row: 1;
        }
        
        .page-header h1 {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .page-header p {
            margin: 0;
            color: #6c757d;
            font-size: 16px;
        }
        .section-header { margin-bottom: 20px; }
        .section-toolbar { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 20px 0; display: flex; gap: 15px; align-items: center; flex-wrap: wrap; }
        .btn-group { display: flex; gap: 10px; align-items: center; }
        .ml-auto { margin-left: auto; }
        .text-nowrap { white-space: nowrap; }
        .page-title { font-size: 24px; font-weight: 600; color: #2c3e50; margin: 0 0 5px 0; }
        .page-subtitle { color: #6c757d; font-size: 16px; margin: 0 0 20px 0; }
    </style>
</head>
<body>
    <div class="admin-layout">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2>üöó Marcel's Taxi Pro</h2>
                <p>Professional Admin Panel</p>
            </div>

            <ul class="nav-menu">
                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('dispatch')">
                        üö® Dispatch
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" onclick="toggleMenu('bookings')">
                        üìã Bookings
                    </a>
                    <ul class="nav-submenu" id="bookings-menu">
                        <li><a class="nav-link" onclick="showSection('next-24h')">Next 24h</a></li>
                        <li><a class="nav-link" onclick="showSection('latest')">Latest</a></li>
                        <li><a class="nav-link" onclick="showSection('unconfirmed')">Unconfirmed</a></li>
                        <li><a class="nav-link" onclick="showSection('completed')">Completed</a></li>
                        <li><a class="nav-link" onclick="showSection('cancelled')">Cancelled</a></li>
                        <li><a class="nav-link" onclick="showSection('all-bookings')">All</a></li>
                        <li><a class="nav-link" onclick="showSection('trash')">Trash</a></li>
                        <li><a class="nav-link" onclick="showSection('calendar')">Calendar</a></li>
                        <li><a class="nav-link" onclick="showSection('add-new')">Add New</a></li>
                    </ul>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" onclick="toggleMenu('reports')">
                        üìà Reports
                    </a>
                    <ul class="nav-submenu" id="reports-menu">
                        <li><a class="nav-link" onclick="showSection('driver-report')">Driver Report</a></li>
                        <li><a class="nav-link" onclick="showSection('payment-report')">Payment Report</a></li>
                    </ul>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('users')">
                        üë• Users
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('drivers')">
                        üöñ Drivers
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('vehicle-manager')">
                        üöó Vehicle Manager
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('feedback')">
                        üí¨ Feedback
                    </a>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" onclick="toggleMenu('settings')">
                        ‚öôÔ∏è Settings
                    </a>
                    <ul class="nav-submenu" id="settings-menu">
                        <li><a class="nav-link" onclick="showSection('general')">‚öôÔ∏è General Settings</a></li>
                        <!-- DUPLICATE SECTION - DISABLED: same as Vehicle Manager
                        <li><a class="nav-link" onclick="showSection('types-of-vehicles')">üöó Types of Vehicles</a></li>
                        -->
                        <li><a class="nav-link" onclick="showSection('payment-methods')">üí≥ Payment Methods</a></li>
                        <li><a class="nav-link" onclick="showSection('notifications')">üîî Notifications</a></li>
                        <li><a class="nav-link" onclick="showSection('mail')">üìß Email Settings</a></li>
                        <li><a class="nav-link" onclick="showSection('email-templates')">üìù Email Templates</a></li>
                        <li><a class="nav-link" onclick="showSection('translation')">üåê Translation</a></li>
                        <li><a class="nav-link" onclick="showSection('booking-settings')">üìã Booking Settings</a></li>
                        <li><a class="nav-link" onclick="showSection('google')">üåê Google</a></li>
                        <li><a class="nav-link" onclick="showSection('services')">üéØ Services</a></li>
                        <li><a class="nav-link" onclick="showSection('users-settings')">üë• User Management</a></li>
                        <li><a class="nav-link" onclick="showSection('backup-export')">üíæ Backup & Export</a></li>
                    </ul>
                </li>
                
                <li class="nav-item">
                    <a class="nav-link" onclick="toggleMenu('pricing')">
                        üí∞ Pricing
                    </a>
                    <ul class="nav-submenu" id="pricing-menu">
                        <li><a class="nav-link" onclick="showSection('deposit-payments')">Deposit Payments</a></li>
                        <li><a class="nav-link" onclick="showSection('distance-time')">Distance & Time</a></li>
                        <li><a class="nav-link" onclick="showSection('distance-modifier')">Distance Modifier</a></li>
                        <li><a class="nav-link" onclick="showSection('driver-income')">Driver Income</a></li>
                        <li><a class="nav-link" onclick="showSection('fixed-prices')">Fixed Prices</a></li>
                        <li><a class="nav-link" onclick="showSection('holiday-surcharge')">Holiday Surcharge</a></li>
                        <li><a class="nav-link" onclick="showSection('item-surcharge')">Item Surcharge</a></li>
                        <li><a class="nav-link" onclick="showSection('location-surcharge')">Location Surcharge</a></li>
                        <li><a class="nav-link" onclick="showSection('meet-and-greet')">Meet and Greet</a></li>
                        <li><a class="nav-link" onclick="showSection('night-surcharge')">Night Surcharge</a></li>
                        <li><a class="nav-link" onclick="showSection('other-discounts')">Other Discounts</a></li>
                        <li><a class="nav-link" onclick="showSection('tax')">Tax</a></li>
                        <li><a class="nav-link" onclick="showSection('voucher-discounts')">Voucher Discounts</a></li>
                    </ul>
                </li>


                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('knowledge-base')">
                        üìö Knowledge Base
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('updates')">
                        üîÑ Updates
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="showSection('profile')">
                        üë§ Profile
                    </a>
                </li>

                <li class="nav-item">
                    <a class="nav-link" onclick="logout()">
                        üö™ Sign Out
                    </a>
                </li>
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1 id="pageTitle">Dispatch</h1>
                <p id="pageSubtitle">Manual taxi booking and dispatch system</p>
            </div>

            <div class="content-area">

                <!-- Dispatch Section -->
                <div id="dispatch-section" class="content-section active">
                    <!-- Main Dispatch Layout -->
                    <div style="display: grid; grid-template-columns: 500px 1fr; gap: 20px; height: calc(100vh - 100px);">
                        
                        <!-- Left Panel - Professional Booking Form -->
                        <div class="white-card-12" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 25px; overflow-y: auto; height: fit-content; max-height: calc(100vh - 120px); background: #fafafa;">
                            
                            <!-- LOCATIONS Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                                    <h3 style="font-size: 16px; font-weight: 600; color: #4A90E2; margin: 0;">LOCATIONS</h3>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <button style="background: #f0f0f0; border: 1px solid #ddd; padding: 6px 12px; border-radius: 6px; font-size: 12px; color: #666; cursor: pointer;">Return Journey?</button>
                                        <button style="background: none; border: none; font-size: 18px; cursor: pointer;">‚öôÔ∏è</button>
                                    </div>
                                </div>
                                
                                <!-- Location Inputs Container -->
                                <div style="position: relative;">
                                    <!-- From Location -->
                                    <div style="position: relative; margin-bottom: 10px;">
                                        <input type="text" id="dispatchFromLocation" placeholder="Address or Postcode" 
                                               style="width: 75%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                    </div>
                                    
                                    <!-- To Location -->
                                    <div style="position: relative; margin-bottom: 15px;">
                                        <input type="text" id="dispatchToLocation" placeholder="Address or Postcode" 
                                               style="width: 75%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; background: white;">
                                    </div>
                                    
                                    <!-- Right side controls - away from border -->
                                    <div style="position: absolute; right: -10px; top: 50%; transform: translateY(-50%); display: flex; flex-direction: column; align-items: center; gap: 3px;">
                                        <button onclick="addDispatchStop()" style="background: none; border: none; color: #666; font-size: 18px; cursor: pointer; padding: 2px; line-height: 1; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">+</button>
                                        <button onclick="swapLocations()" style="background: none; border: none; color: #666; font-size: 14px; cursor: pointer; padding: 2px; line-height: 1; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;">‚áÖ</button>
                                    </div>
                                </div>
                                
                                <!-- Date/Time and Vehicle Type -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; position: relative;">
                                    <div style="position: relative;">
                                        <button style="width: 90%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white; text-align: left; color: #666; cursor: pointer;">
                                            üïê Now
                                        </button>
                                    </div>
                                    <div style="position: relative;">
                                        <select id="dispatchVehicleSelect" style="width: 80%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #666; cursor: pointer;">
                                            <option>üöó Unassigned</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Flight Icon - Moved more to the left -->
                                    <div style="position: absolute; right: -15px; top: 50%; transform: translateY(-50%);">
                                        <span style="color: #666; font-size: 20px;">‚úàÔ∏è</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- PASSENGERS Section -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="font-size: 16px; font-weight: 600; color: #4A90E2; margin-bottom: 15px;">PASSENGERS</h3>
                                
                                <!-- Account and Passenger Search -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <select style="width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #666;">
                                        <option>Account</option>
                                        <option>New Customer</option>
                                        <option>Existing Customer</option>
                                    </select>
                                    <div style="position: relative;">
                                        <input type="text" placeholder="Passenger" style="width: 90%; padding: 10px 35px 10px 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                        <button style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">üîç</button>
                                    </div>
                                </div>
                                
                                <!-- Passenger Counters -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                                    <!-- Adults -->
                                    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white; text-align: center;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">üë§</div>
                                        <select style="border: none; background: none; font-size: 14px; width: 100%; text-align: center; color: #333;">
                                            <option value="0">0</option>
                                            <option value="1" selected>1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Luggage -->
                                    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white; text-align: center;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">üíº</div>
                                        <select style="border: none; background: none; font-size: 14px; width: 100%; text-align: center; color: #333;">
                                            <option value="0" selected>0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                        </select>
                                    </div>
                                    
                                    <!-- Baby items -->
                                    <div style="border: 1px solid #ddd; border-radius: 6px; padding: 10px; background: white; text-align: center;">
                                        <div style="color: #666; font-size: 12px; margin-bottom: 5px;">üì¶</div>
                                        <select style="border: none; background: none; font-size: 14px; width: 100%; text-align: center; color: #333;">
                                            <option value="0" selected>0</option>
                                            <option value="1">1</option>
                                            <option value="2">2</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Add Item Button -->
                                <button onclick="addDispatchItem()" style="background: none; border: none; color: #4A90E2; font-size: 14px; cursor: pointer; padding: 5px 0;">
                                    Add item <span style="color: #4A90E2; font-weight: bold;">+</span>
                                </button>
                            </div>
                            
                            <!-- PAYMENT & DRIVER Section -->
                            <div style="margin-bottom: 25px;">
                                <h3 style="font-size: 16px; font-weight: 600; color: #4A90E2; margin-bottom: 15px;">PAYMENT & DRIVER</h3>
                                
                                <!-- Payment and Price Row -->
                                <div style="display: grid; grid-template-columns: 1fr auto 1fr 80px; gap: 10px; margin-bottom: 15px; align-items: center;">
                                    <select style="width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #666;">
                                        <option>Unassigned</option>
                                        <option>Cash</option>
                                        <option>Card</option>
                                        <option>Account</option>
                                    </select>
                                    
                                    <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; color: #666;">
                                        <input type="checkbox" id="paidCheckbox"> Paid
                                    </label>
                                    
                                    <input type="number" placeholder="0.00" step="0.01" style="width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; text-align: right;">
                                    
                                    <select style="width: 90%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: white; color: #666; font-size: 12px;">
                                        <option>No tax</option>
                                        <option>21% BTW</option>
                                        <option>6% BTW</option>
                                    </select>
                                </div>
                                
                                <!-- Driver Assignment and Quote -->
                                <div style="display: grid; grid-template-columns: 1fr 1fr 120px; gap: 10px; margin-bottom: 15px;">
                                    <div style="position: relative;">
                                        <input type="text" placeholder="Assign fleet" style="width: 90%; padding: 10px 35px 10px 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                        <button style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">üîç</button>
                                    </div>
                                    
                                    <div style="position: relative;">
                                        <input type="text" placeholder="Assign driver" style="width: 90%; padding: 10px 35px 10px 10px; border: 1px solid #ddd; border-radius: 6px; background: white;">
                                        <button style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer;">üîç</button>
                                    </div>
                                    
                                    <button onclick="getDispatchQuote()" style="background: #4CAF50; color: white; border: none; padding: 12px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 13px;">
                                        Get Quote
                                    </button>
                                </div>
                                
                                <!-- Distance/Time Display -->
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="background: #f0f0f0; padding: 10px; border-radius: 6px; color: #666; font-size: 14px;">
                                        Pickup to Dropoff: <strong>0 km, 0.00 minutes</strong>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Notes Section -->
                            <div style="margin-bottom: 25px;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px;">
                                    <button onclick="openNoteModal('driver')" style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: left; color: #666; cursor: pointer; font-size: 12px;">
                                        Note for Driver <span style="color: #4A90E2;">+</span>
                                    </button>
                                    
                                    <button onclick="openNoteModal('admin')" style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: left; color: #666; cursor: pointer; font-size: 12px;">
                                        Admin note <span style="color: #4A90E2;">+</span>
                                    </button>
                                    
                                    <button onclick="openNoteModal('customer')" style="background: white; border: 1px solid #ddd; padding: 10px; border-radius: 6px; text-align: left; color: #666; cursor: pointer; font-size: 12px;">
                                        Customer requirements <span style="color: #4A90E2;">+</span>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- ADVANCE Section -->
                            <div style="margin-bottom: 25px;">
                                <button onclick="toggleAdvanced()" style="background: none; border: none; color: #4A90E2; font-size: 14px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 5px;">
                                    ADVANCE <span id="advanceArrow">‚ñ≤</span>
                                </button>
                                <div id="advanceSection" style="margin-top: 15px; display: none;">
                                    <!-- Advanced options will go here -->
                                    <div style="padding: 15px; background: white; border: 1px solid #ddd; border-radius: 6px;">
                                        <p style="color: #666; margin: 0; font-size: 12px;">Advanced booking options and settings</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Total and Save -->
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 18px; font-weight: 600; color: #333;">Total: ‚Ç¨<span id="totalPrice">0.00</span></span>
                                    <button style="background: none; border: none; color: #666; cursor: pointer;">‚ÑπÔ∏è</button>
                                </div>
                                
                                <div style="position: relative;">
                                    <button onclick="saveDispatchBooking()" style="background: #4CAF50; color: white; border: none; padding: 12px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                                        Save <span>‚ñº</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Panel - Map -->
                        <div class="white-card-12" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1); overflow: hidden; position: relative;">
                            <div id="dispatchMap" style="width: 100%; height: 100%; background: #e9ecef; display: flex; align-items: center; justify-content: center; color: #6c757d; font-size: 18px; font-weight: 500;">
                                üó∫Ô∏è Map Loading...
                            </div>
                            
                            <!-- Map Controls Overlay -->
                            <div style="position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; gap: 10px; z-index: 1000;">
                                <button onclick="findDriver()" style="background: #ff6b6b; color: white; border: none; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                                    üìç Find driver
                                </button>
                                <button style="background: white; border: 1px solid #ddd; padding: 8px; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    üîç
                                </button>
                                <button style="background: white; border: 1px solid #ddd; padding: 8px; border-radius: 6px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    üìê
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Remove old booking form -->
                    <div style="display: none;">
                        <div class="white-card-12" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 40px; margin-bottom: 30px;">
                        <h2 style="font-size: 28px; font-weight: 600; color: #2c3e50; margin-bottom: 30px;">Booking Form</h2>
                        
                        <form id="dispatchBookingForm" style="display: grid; gap: 30px; max-width: 800px; margin: 0 auto;">
                            <!-- Trip Details Section -->
                            <div style="display: grid; gap: 25px;">
                                <!-- Pickup Location -->
                                <input type="text" id="dispatchPickup" placeholder="üìç Van waar..." 
                                       style="width: 100%; padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 18px; 
                                              transition: all 0.3s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                       onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                       onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">

                                <!-- Extra Stops Container -->
                                <div id="dispatchExtraStopsContainer" style="display: grid; gap: 15px;">
                                    <!-- Extra stops will be added here dynamically -->
                                </div>

                                <!-- Add Extra Stop Button -->
                                <button type="button" onclick="addDispatchExtraStop()" 
                                        style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; border: none; 
                                               padding: 15px 25px; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; 
                                               transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 8px;
                                               box-shadow: 0 4px 15px rgba(0,123,255,0.2); max-width: 200px;"
                                        onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 6px 20px rgba(0,123,255,0.3)'"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.2)'">
                                    ‚ûï Extra Stop
                                </button>

                                <!-- Destination -->
                                <input type="text" id="dispatchDestination" placeholder="üìç Naar waar..." 
                                       style="width: 100%; padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 18px; 
                                              transition: all 0.3s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                       onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                       onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">

                                <!-- Date & Time -->
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 20px; align-items: center;">
                                    <!-- Date Picker -->
                                    <div style="position: relative;">
                                        <input type="text" id="dispatchDate" placeholder="üìÖ Kies datum" readonly
                                               style="width: 100%; padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 18px; 
                                                      cursor: pointer; transition: all 0.3s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                               onclick="toggleDispatchCalendar()"
                                               onmouseover="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                               onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        
                                        <!-- Calendar Popup -->
                                        <div id="dispatchCalendar" style="position: absolute; top: 100%; left: 0; z-index: 1000; background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); padding: 25px; display: none; min-width: 350px;">
                                            <div style="text-align: center; margin-bottom: 20px;">
                                                <button type="button" onclick="changeDispatchMonth(-1)" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-size: 18px; cursor: pointer; padding: 10px 15px; transition: all 0.3s;">‚Üê</button>
                                                <span id="dispatchCalendarTitle" style="font-weight: 700; margin: 0 25px; font-size: 18px; color: #2c3e50;">November 2023</span>
                                                <button type="button" onclick="changeDispatchMonth(1)" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-size: 18px; cursor: pointer; padding: 10px 15px; transition: all 0.3s;">‚Üí</button>
                                            </div>
                                            <div id="dispatchCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; text-align: center;">
                                                <!-- Calendar will be populated by JavaScript -->
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Hour Selector -->
                                    <select id="dispatchHour" style="padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 18px; 
                                                                      background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;"
                                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <option value="">‚è∞ Uur</option>
                                    </select>
                                    
                                    <!-- Minute Selector -->
                                    <select id="dispatchMinute" style="padding: 20px; border: 2px solid #e9ecef; border-radius: 12px; font-size: 18px; 
                                                                        background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;"
                                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <option value="">‚è∞ Min</option>
                                    </select>
                                </div>

                                <!-- Return Trip Section -->
                                <div style="background: linear-gradient(135deg, #e3f2fd, #bbdefb); padding: 20px; border-radius: 12px; border: 2px solid #2196f3;">
                                    <div style="display: flex; align-items: center; justify-content: space-between;">
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <button type="button" id="dispatchRetourBtn" onclick="toggleDispatchRetour()" 
                                                    style="background: linear-gradient(135deg, #2196f3, #1976d2); color: white; border: none; 
                                                           padding: 12px 20px; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; 
                                                           transition: all 0.3s; display: flex; align-items: center; gap: 8px;"
                                                    onmouseover="this.style.transform='scale(1.05)'"
                                                    onmouseout="this.style.transform='scale(1)'">
                                                üîÑ Retour
                                            </button>
                                            <span style="font-weight: 600; color: #1976d2; font-size: 16px;">Return Trip?</span>
                                        </div>
                                        <span id="dispatchRetourStatus" style="color: #666; font-style: italic;">Not activated</span>
                                    </div>
                                    
                                    <!-- Return Details (Hidden by default) -->
                                    <div id="dispatchRetourDetails" style="display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid #2196f3;">
                                        <div style="display: grid; grid-template-columns: 2fr 1fr 1fr; gap: 15px; align-items: center;">
                                            <!-- Return Date Picker -->
                                            <div style="position: relative;">
                                                <input type="text" id="dispatchReturnDate" placeholder="üìÖ Retour datum" readonly
                                                       style="width: 100%; padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                              cursor: pointer; transition: all 0.3s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                                       onclick="toggleDispatchReturnCalendar()"
                                                       onmouseover="this.style.borderColor='#2196f3'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.15)'"
                                                       onmouseout="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                                
                                                <!-- Return Calendar Popup -->
                                                <div id="dispatchReturnCalendar" style="position: absolute; top: 100%; left: 0; z-index: 1000; background: white; border: 2px solid #e9ecef; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.2); padding: 25px; display: none; min-width: 350px;">
                                                    <div style="text-align: center; margin-bottom: 20px;">
                                                        <button type="button" onclick="changeDispatchReturnMonth(-1)" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-size: 18px; cursor: pointer; padding: 10px 15px; transition: all 0.3s;">‚Üê</button>
                                                        <span id="dispatchReturnCalendarTitle" style="font-weight: 700; margin: 0 25px; font-size: 18px; color: #2c3e50;">November 2023</span>
                                                        <button type="button" onclick="changeDispatchReturnMonth(1)" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 8px; font-size: 18px; cursor: pointer; padding: 10px 15px; transition: all 0.3s;">‚Üí</button>
                                                    </div>
                                                    <div id="dispatchReturnCalendarGrid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; text-align: center;">
                                                        <!-- Calendar will be populated by JavaScript -->
                                                    </div>
                                                </div>
                                            </div>
                                            
                                            <!-- Return Hour Selector -->
                                            <select id="dispatchReturnHour" style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                                                    background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;"
                                                    onfocus="this.style.borderColor='#2196f3'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.15)'"
                                                    onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                                <option value="">‚è∞ Uur</option>
                                            </select>
                                            
                                            <!-- Return Minute Selector -->
                                            <select id="dispatchReturnMinute" style="padding: 15px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                                                      background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.3s;"
                                                    onfocus="this.style.borderColor='#2196f3'; this.style.boxShadow='0 4px 15px rgba(33,150,243,0.15)'"
                                                    onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                                <option value="">‚è∞ Min</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Customer Details Section -->
                            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); padding: 30px; border-radius: 15px; border: 1px solid #dee2e6;">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                                    <input type="text" id="dispatchFirstName" placeholder="üë§ First Name" 
                                           style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                  background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                           onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                           onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                    
                                    <input type="text" id="dispatchLastName" placeholder="üë§ Last Name" 
                                           style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                  background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                           onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                           onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-bottom: 25px;">
                                    <input type="email" id="dispatchEmail" placeholder="‚úâÔ∏è Email Address" 
                                           style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                  background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                           onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                           onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                    
                                    <input type="tel" id="dispatchPhone" placeholder="üìû Phone Number" 
                                           style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                  background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                           onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                           onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 25px;">
                                    <select id="dispatchPassengers" style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                                               background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <option value="1">üë• 1 Passenger</option>
                                        <option value="2">üë• 2 Passengers</option>
                                        <option value="3">üë• 3 Passengers</option>
                                        <option value="4">üë• 4 Passengers</option>
                                        <option value="5">üë• 5 Passengers</option>
                                        <option value="6">üë• 6 Passengers</option>
                                        <option value="7">üë• 7 Passengers</option>
                                        <option value="8">üë• 8 Passengers</option>
                                    </select>
                                    
                                    <select id="dispatchVehicleType" style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                                              background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <option value="saloon">üöó Saloon</option>
                                        <option value="estate">üöô Estate</option>
                                        <option value="minivan">üöê Minivan</option>
                                        <option value="minivan_long">üöå Minivan Long</option>
                                    </select>
                                    
                                    <select id="dispatchPaymentMethod" style="padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                                                                                background: white; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                                            onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                                            onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                                        <option value="cash">üíµ Cash</option>
                                        <option value="card">üí≥ Credit Card</option>
                                        <option value="paypal">üÖøÔ∏è PayPal</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Create Booking Button -->
                            <button type="submit" onclick="createDispatchBooking(event)" 
                                    style="width: 100%; padding: 25px; background: linear-gradient(135deg, #28a745, #20c997); 
                                           color: white; border: none; border-radius: 15px; font-size: 20px; font-weight: 700; 
                                           cursor: pointer; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 12px;
                                           box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3); text-transform: uppercase; letter-spacing: 1px;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 12px 35px rgba(40, 167, 69, 0.4)'"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 8px 25px rgba(40, 167, 69, 0.3)'">
                                üìû Create Booking
                            </button>
                        </form>
                    </div>

                    <!-- Status Display -->
                    <div id="dispatchStatus" style="display: none; padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: 500;"></div>

                    <!-- Dispatch Table View -->
                    <div class="white-card-12" style="box-shadow: 0 4px 20px rgba(0,0,0,0.1); padding: 30px; margin-top: 30px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
                            <h2 style="font-size: 24px; font-weight: 600; color: #2c3e50; margin: 0;">Active Bookings</h2>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <!-- Filter Controls -->
                                <select id="dispatchStatusFilter" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px;" onchange="filterDispatchBookings()">
                                    <option value="">All Status</option>
                                    <option value="unquoted">Unquoted</option>
                                    <option value="confirmed">Confirmed</option>
                                    <option value="paid">Paid</option>
                                    <option value="completed">Completed</option>
                                </select>
                                <input type="text" id="dispatchSearch" placeholder="Search bookings..." 
                                       style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 200px;" 
                                       onkeyup="searchDispatchBookings()">
                                <button onclick="refreshDispatchTable()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                    üîÑ Refresh
                                </button>
                            </div>
                        </div>

                        <!-- Dispatch Table -->
                        <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                            <table id="dispatchTable" style="width: 100%; border-collapse: collapse; font-size: 14px;">
                                <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                    <tr>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 80px;">Actions</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 120px;">Date & Time</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 100px;">Ref ID</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 100px;">Status</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 120px;">Driver</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 100px;">Vehicle</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; border-right: 1px solid #dee2e6; width: 120px;">Vehicle type</th>
                                        <th style="padding: 12px 8px; text-align: left; font-weight: 600; width: 80px;">Total</th>
                                    </tr>
                                </thead>
                                <tbody id="dispatchTableBody">
                                    <tr>
                                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">
                                            No active bookings found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Pagination -->
                        <div style="display: flex; justify-content: between; align-items: center; margin-top: 20px; padding: 0 10px;">
                            <div style="color: #6c757d; font-size: 14px;">
                                <span id="dispatchTableInfo">Showing 0 entries</span>
                            </div>
                            <div id="dispatchPagination" style="display: flex; gap: 5px;">
                                <!-- Pagination buttons will be generated here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="general-section" class="content-section">
                    <p>Configure general system settings</p>
                </div>

                <div id="vehicle-manager-section" class="content-section" style="display: block !important; background: red !important; color: white !important; padding: 50px !important; font-size: 24px !important;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h2 style="margin: 0; color: #2c3e50;">üöó Vehicle Manager</h2>
                            <p style="margin: 5px 0 0 0; color: #7f8c8d;">Beheer voertuigen en sync met Step2</p>
                        </div>
                        <button class="btn btn-primary" onclick="adminAddVehicle()" style="background: #27ae60;">
                            ‚ûï Add New Vehicle
                        </button>
                    </div>

                    <div id="adminVehicleSync" style="background: #d4edda; color: #155724; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #27ae60;">
                        ‚úÖ Vehicle data synchronized with Step2 booking system
                    </div>

                    <div id="adminVehiclesGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">
                        <!-- Vehicles will be loaded here -->
                    </div>
                </div>

                <!-- Vehicle Manager Modal -->
                <div id="vehicleManagerModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="vehicleManagerModalTitle">Add New Vehicle</h3>
                            <button style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;" onclick="closeVehicleManagerModal()">&times;</button>
                        </div>
                        <div style="padding: 30px;">
                            <form id="vehicleManagerForm">
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div>
                                        <label class="form-label-dark">Name *</label>
                                        <input type="text" id="vehicleManagerName" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Premium Class" required>
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Driver</label>
                                        <select id="vehicleManagerDriver" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;">
                                            <option value="All">All Drivers</option>
                                            <option value="John Smith">John Smith</option>
                                            <option value="Mike Johnson">Mike Johnson</option>
                                            <option value="Sarah Wilson">Sarah Wilson</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="section-margin-lg">
                                    <label class="form-label-dark">Description</label>
                                    <textarea id="vehicleManagerDescription" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" rows="3" placeholder="Professional taxi service with premium comfort"></textarea>
                                </div>

                                <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px;">
                                    <div>
                                        <label class="form-label-dark">Passengers</label>
                                        <div class="flex-center">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('passengers', -1)">-</button>
                                            <input type="number" id="vehicleManagerPassengers" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center;" value="4" min="1" max="20">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('passengers', 1)">+</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Luggage</label>
                                        <div class="flex-center">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('luggage', -1)">-</button>
                                            <input type="number" id="vehicleManagerLuggage" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center;" value="2" min="0" max="20">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('luggage', 1)">+</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Hand Luggage</label>
                                        <div class="flex-center">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('handLuggage', -1)">-</button>
                                            <input type="number" id="vehicleManagerHandLuggage" style="width: 60px; padding: 8px; border: 1px solid #ddd; border-radius: 6px; text-align: center;" value="2" min="0" max="20">
                                            <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustVehicleManagerValue('handLuggage', 1)">+</button>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Hourly Rate (‚Ç¨)</label>
                                        <input type="number" id="vehicleManagerHourlyRate" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="25" min="0" step="5">
                                    </div>
                                </div>

                                <div class="section-margin-lg">
                                    <label class="form-label-dark">Vehicle Image</label>
                                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('vehicleManagerImageInput').click()">
                                        <img id="vehicleManagerImagePreview" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin: 10px 0; display: none;">
                                        <div id="vehicleManagerUploadText">
                                            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                            <div>Click to upload vehicle image</div>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">JPG, PNG, WebP (max 5MB)</div>
                                        </div>
                                    </div>
                                    <input type="file" id="vehicleManagerImageInput" accept="image/*" style="display: none;" onchange="handleVehicleManagerImageUpload(this)">
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button type="button" style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;" onclick="closeVehicleManagerModal()">Cancel</button>
                                    <button type="submit" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Save Vehicle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- DUPLICATE SECTION - DISABLED: same functionality as Vehicle Manager
                <div id="types-of-vehicles-section" class="content-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <div>
                            <h2>üöó Types of Vehicles</h2>
                            <p>Manage your vehicle fleet and specifications</p>
                        </div>
                        <button class="btn btn-primary" onclick="openAddVehicleModal()">
                            ‚ûï Add New Vehicle
                        </button>
                    </div>

                    <div id="vehicleSuccessMessage" style="background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 20px; display: none;"></div>
                    <div id="vehicleErrorMessage" style="background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 20px; display: none;"></div>

                    <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th class="table-cell-alt">Image</th>
                                    <th class="table-cell-alt">Name</th>
                                    <th class="table-cell-alt">Description</th>
                                    <th class="table-cell-alt">Capacity</th>
                                    <th class="table-cell-alt">Status</th>
                                    <th class="table-cell-alt">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="vehicleTableBody">
                                <!-- Vehicles will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Vehicle Add/Edit Modal -->
                <div id="vehicleModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
                        <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                            <h3 id="vehicleModalTitle">Add New Vehicle</h3>
                            <button style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;" onclick="closeVehicleModal()">&times;</button>
                        </div>
                        <div style="padding: 30px;">
                            <form id="vehicleForm">
                                <div class="section-margin-lg">
                                    <label class="form-label-dark">Name *</label>
                                    <input type="text" id="vehicleName" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" placeholder="Premium Class" required>
                                </div>

                                <div class="section-margin-lg">
                                    <label class="form-label-dark">Description</label>
                                    <textarea id="vehicleDescription" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" rows="3" placeholder="Professional taxi service"></textarea>
                                </div>

                                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                    <div>
                                        <label class="form-label-dark">Passengers</label>
                                        <input type="number" id="vehiclePassengers" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="4" min="1" max="20">
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Luggage</label>
                                        <input type="number" id="vehicleLuggage" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="2" min="0" max="20">
                                    </div>
                                    <div>
                                        <label class="form-label-dark">Hand Luggage</label>
                                        <input type="number" id="vehicleHandLuggage" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px;" value="2" min="0" max="20">
                                    </div>
                                </div>

                                <div class="section-margin-lg">
                                    <label class="form-label-dark">Vehicle Image</label>
                                    <div style="border: 2px dashed #ddd; border-radius: 8px; padding: 20px; text-align: center; cursor: pointer;" onclick="document.getElementById('vehicleImageInput').click()">
                                        <img id="vehicleImagePreview" style="max-width: 200px; max-height: 150px; border-radius: 8px; margin: 10px 0; display: none;">
                                        <div id="vehicleUploadText">
                                            <div style="font-size: 48px; margin-bottom: 10px;">üì∑</div>
                                            <div>Click to upload image</div>
                                            <div style="font-size: 12px; color: #666; margin-top: 5px;">JPG, PNG, WebP (max 5MB)</div>
                                        </div>
                                    </div>
                                    <input type="file" id="vehicleImageInput" accept="image/*" style="display: none;" onchange="handleVehicleImageUpload(this)">
                                </div>

                                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                                    <button type="button" style="background: #95a5a6; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;" onclick="closeVehicleModal()">Cancel</button>
                                    <button type="submit" style="background: #3498db; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">Save Vehicle</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                <!-- END DUPLICATE SECTION -->

                <div id="mail-section" class="content-section">
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h3>Current Configuration</h3>
                        <div style="margin: 15px 0;">
                            <div><strong>Status:</strong> <span id="configStatus">Not configured</span></div>
                            <div><strong>SMTP Host:</strong> <span id="configHost">smtp.gmail.com</span></div>
                            <div><strong>From Email:</strong> <span id="configEmail">info@airporttransfer.be</span></div>
                        </div>
                    </div>

                    <form id="adminEmailSettingsForm" onsubmit="saveEmailSettings(event)">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label class="form-label-alt">From name</label>
                                <input type="text" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminFromName" value="Airport Transfer" required>
                            </div>
                            <div>
                                <label class="form-label-alt">From email</label>
                                <input type="email" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminFromEmail" value="info@airporttransfer.be" required>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label class="form-label-alt">Reply to email</label>
                                <input type="email" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminReplyToEmail" value="info@airporttransfer.be" required>
                            </div>
                            <div>
                                <label class="form-label-alt">Admin email</label>
                                <input type="email" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminAdminEmail" value="marceltataev@gmail.com" required>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label class="form-label-alt">Connection type</label>
                                <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminConnectionType">
                                    <option value="smtp">SMTP - Your mail server</option>
                                    <option value="sendmail">Sendmail</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label-alt">Provider</label>
                                <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminProvider">
                                    <option value="gmail">Gmail</option>
                                    <option value="outlook">Outlook</option>
                                    <option value="yahoo">Yahoo</option>
                                    <option value="custom">Custom</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label class="form-label-alt">SMTP host</label>
                                <input type="text" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminSmtpHost" value="smtp.gmail.com" required>
                            </div>
                            <div>
                                <label class="form-label-alt">SMTP port</label>
                                <select style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminSmtpPort">
                                    <option value="587" selected>587</option>
                                    <option value="465">465</option>
                                    <option value="25">25</option>
                                </select>
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                            <div>
                                <label class="form-label-alt">SMTP username</label>
                                <input type="text" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminSmtpUsername" value="info@airporttransfer.be" required>
                            </div>
                            <div>
                                <label class="form-label-alt">SMTP password</label>
                                <div style="position: relative;">
                                    <input type="password" style="width: 100%; padding: 12px; padding-right: 50px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminSmtpPassword" placeholder="Enter your Gmail App Password" required>
                                    <button type="button" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); background: none; border: none; cursor: pointer; font-size: 18px;" onclick="toggleAdminPassword()">üëÅ</button>
                                </div>
                            </div>
                        </div>

                        <div class="section-margin-lg">
                            <label class="form-label-alt">SMTP security</label>
                            <div style="display: flex; gap: 20px;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="adminSmtpSecurity" value="none"> None
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="adminSmtpSecurity" value="ssl"> SSL
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="radio" name="adminSmtpSecurity" value="tls" checked> TLS
                                </label>
                            </div>
                        </div>

                        <div style="border-top: 1px solid #e1e5e9; padding-top: 20px; margin-top: 20px;">
                            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 20px;">
                                <div style="flex: 1;">
                                    <label class="form-label-alt">Send a test email</label>
                                    <input type="email" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" id="adminTestEmail" placeholder="Enter your email address">
                                </div>
                                <button type="button" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-top: 32px;" onclick="sendAdminTestEmail()">Send</button>
                            </div>
                        </div>

                        <div style="text-align: center; margin-top: 30px;">
                            <button type="submit" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                                üíæ Save Email Settings
                            </button>
                        </div>
                    </form>

                    <div id="adminEmailStatus" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
                </div>

                <!-- Email Templates Section -->
                <div id="email-templates-section" class="content-section">
                    <div style="border-bottom: 2px solid #e1e8ed; margin: 50px 0 50px 0; padding-bottom: 30px;">
                        <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 15px;">Marcel's Taxi Pro</h1>
                        <h2 style="color: #007bff; font-size: 24px; margin-bottom: 5px;">Professional Admin Panel - ‚öôÔ∏è Settings</h2>
                        <h3 style="color: #666; font-size: 20px; margin: 0;">üìù Email Templates</h3>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h3>üìß Email Template Configuratie</h3>
                        <p style="margin: 10px 0; color: #6c757d;">Beheer de 3 verschillende email templates die naar klanten worden verstuurd tijdens het boekingsproces.</p>
                    </div>

                    <!-- Template Selector -->
                    <div class="card">
                        <label style="display: block; font-weight: 600; margin-bottom: 10px;">Selecteer Email Template:</label>
                        <select id="templateSelector" onchange="loadSelectedTemplate()" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; font-size: 16px;">
                            <option value="pending">üìã Template 1: Wacht op Bevestiging (Direct na reservering)</option>
                            <option value="confirmed">‚úÖ Template 2: Bevestiging Email (Unconfirmed ‚Üí Confirmed)</option>
                            <option value="cancelled">‚ùå Template 3: Annulering Email (Unconfirmed ‚Üí Cancelled)</option>
                        </select>
                    </div>

                    <form id="emailTemplateForm" onsubmit="saveEmailTemplate(event)">
                        <!-- Template 1: Pending Confirmation -->
                        <div id="pendingTemplate" class="template-content">
                            <div style="background: #fff4e6; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffa500;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">üìã Template 1: Wacht op Bevestiging</h4>
                                <p style="margin: 0; color: #666;">Deze email wordt direct verstuurd wanneer een klant een nieuwe boeking maakt.</p>
                            </div>

                            <!-- Subject Line -->
                            <div class="card">
                                <h4 class="text-color">üìß Email Onderwerp</h4>
                                <input type="text" id="pendingSubject" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" value="Uw booking wacht op bevestiging - [BOOKING_ID]" placeholder="Email onderwerp">
                            </div>

                            <!-- Welcome Message -->
                            <div class="card">
                                <h4 class="text-color">üéâ Welkomstbericht</h4>
                                <textarea id="pendingWelcomeMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 80px; resize: vertical;">Bedankt voor uw boeking bij Marcel's Taxi!

We hebben uw reservering ontvangen. Ons team zal uw boeking zo spoedig mogelijk beoordelen.</textarea>
                            </div>

                            <!-- Status Message -->
                            <div class="card">
                                <h4 class="text-color">‚è≥ Status Bericht</h4>
                                <textarea id="pendingStatusMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 100px; resize: vertical;">üîÑ UW BOEKING WACHT OP BEVESTIGING

Uw boeking wordt binnen 24 uur door ons team beoordeeld. U ontvangt een bevestiging of annulering per email.

Voor urgente boekingen kunt u ons direct bellen.</textarea>
                            </div>
                        </div>

                        <!-- Template 2: Confirmed -->
                        <div id="confirmedTemplate" class="template-content" style="display: none;">
                            <div style="background: #e8f5e9; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #4caf50;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">‚úÖ Template 2: Bevestiging Email</h4>
                                <p style="margin: 0; color: #666;">Deze email wordt verstuurd wanneer een boeking van 'unconfirmed' naar 'confirmed' wordt gezet.</p>
                            </div>

                            <!-- Subject Line -->
                            <div class="card">
                                <h4 class="text-color">üìß Email Onderwerp</h4>
                                <input type="text" id="confirmedSubject" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" value="‚úÖ Uw rit is bevestigd - [BOOKING_ID]" placeholder="Email onderwerp">
                            </div>

                            <!-- Welcome Message -->
                            <div class="card">
                                <h4 class="text-color">üéâ Bevestigingsbericht</h4>
                                <textarea id="confirmedWelcomeMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 80px; resize: vertical;">Goed nieuws! Uw taxi boeking is bevestigd.

We hebben uw reservering definitief bevestigd. Hieronder vindt u alle details van uw rit.</textarea>
                            </div>

                            <!-- Status Message -->
                            <div class="card">
                                <h4 class="text-color">‚úÖ Bevestiging Details</h4>
                                <textarea id="confirmedStatusMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 100px; resize: vertical;">‚úÖ UW RIT IS DEFINITIEF BEVESTIGD

Een chauffeur is aan uw rit toegewezen. U ontvangt 24 uur voor vertrek de contactgegevens van uw chauffeur.

Zorg ervoor dat u op tijd klaar staat op de afgesproken locatie.</textarea>
                            </div>
                        </div>

                        <!-- Template 3: Cancelled -->
                        <div id="cancelledTemplate" class="template-content" style="display: none;">
                            <div style="background: #ffebee; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #f44336;">
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">‚ùå Template 3: Annulering Email</h4>
                                <p style="margin: 0; color: #666;">Deze email wordt verstuurd wanneer een boeking wordt geannuleerd.</p>
                            </div>

                            <!-- Subject Line -->
                            <div class="card">
                                <h4 class="text-color">üìß Email Onderwerp</h4>
                                <input type="text" id="cancelledSubject" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px;" value="‚ùå Uw rit is geannuleerd - [BOOKING_ID]" placeholder="Email onderwerp">
                            </div>

                            <!-- Cancellation Message -->
                            <div class="card">
                                <h4 class="text-color">‚ùå Annuleringsbericht</h4>
                                <textarea id="cancelledWelcomeMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 80px; resize: vertical;">Helaas moeten wij u mededelen dat uw taxi boeking is geannuleerd.

Hieronder vindt u de details van de geannuleerde rit.</textarea>
                            </div>

                            <!-- Reason Message -->
                            <div class="card">
                                <h4 class="text-color">üìã Annulering Reden</h4>
                                <textarea id="cancelledStatusMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 100px; resize: vertical;">‚ùå UW RIT IS GEANNULEERD

Mogelijke redenen voor annulering:
- Geen beschikbare chauffeurs op het gevraagde tijdstip
- De route valt buiten ons servicegebied
- Technische problemen

Voor vragen kunt u contact met ons opnemen. We helpen u graag met een alternatieve oplossing.</textarea>
                            </div>
                        </div>

                        <!-- Shared Contact Information -->
                        <div class="card">
                            <h4 class="text-color">üìû Contact Informatie</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Telefoon:</label>
                                    <input type="text" id="templatePhone" class="input-field" value="+32 xxx xx xx xx" placeholder="+32 xxx xx xx xx">
                                </div>
                                <div>
                                    <label class="form-label-alt">WhatsApp:</label>
                                    <input type="text" id="templateWhatsApp" class="input-field" value="+32 xxx xx xx xx" placeholder="+32 xxx xx xx xx">
                                </div>
                            </div>
                            <div class="section-margin">
                                <label class="form-label-alt">Email:</label>
                                <input type="email" id="templateEmail" class="input-field" value="info@airporttransfer.be" placeholder="info@airporttransfer.be">
                            </div>
                            <div class="section-margin">
                                <label class="form-label-alt">Extra instructies:</label>
                                <textarea id="templateContactInfo" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 60px; resize: vertical;" placeholder="Voor vragen of wijzigingen kunt u contact opnemen...">Voor vragen of wijzigingen kunt u ons bereiken via bovenstaande contactgegevens.

Bij no-show of annulering binnen 2 uur voor vertrek kunnen kosten in rekening worden gebracht.</textarea>
                            </div>
                        </div>

                        <!-- Booking Modification Settings -->
                        <div class="card">
                            <h4 class="text-color">‚úèÔ∏è Boeking Wijzigingen</h4>
                            <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; margin-bottom: 15px; border-left: 4px solid #28a745;">
                                <p style="margin: 0; color: #155724; font-size: 14px;">
                                    <strong>üìã Wijziging Link:</strong> In bevestigde emails wordt automatisch een link toegevoegd waarmee klanten hun boeking kunnen wijzigen.
                                </p>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px; align-items: end;">
                                <div>
                                    <label class="form-label-alt">Deadline (uur voor vertrek):</label>
                                    <div class="flex-center">
                                        <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustModificationDeadline(-1)">-</button>
                                        <input type="number" id="templateModificationDeadline" style="width: 80px; padding: 10px; border: 2px solid #e1e5e9; border-radius: 6px; text-align: center;" value="24" min="1" max="168" placeholder="24">
                                        <button type="button" style="width: 30px; height: 30px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer;" onclick="adjustModificationDeadline(1)">+</button>
                                        <span style="color: #6c757d; font-size: 14px;">uur</span>
                                    </div>
                                    <div style="font-size: 12px; color: #6c757d; margin-top: 5px;">
                                        Standaard: 24 uur voor vertrek
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label-alt">Preview tekst:</label>
                                    <div style="background: #f8f9fa; padding: 12px; border-radius: 6px; color: #6c757d; font-size: 14px; border: 1px solid #e9ecef;">
                                        "U kunt uw boeking nog wijzigen tot <strong id="deadlinePreview">24</strong> uur voor uw vertrek."
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Company Information -->
                        <div class="card">
                            <h4 class="text-color">üè¢ Bedrijfsinformatie</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Bedrijfsnaam:</label>
                                    <input type="text" id="templateCompanyName" class="input-field" value="Marcel's Taxi Service" placeholder="Marcel's Taxi Service">
                                </div>
                                <div>
                                    <label class="form-label-alt">Website:</label>
                                    <input type="text" id="templateWebsite" class="input-field" value="www.airporttransfer.be" placeholder="www.airporttransfer.be">
                                </div>
                            </div>
                            <div>
                                <label class="form-label-alt">Footer bericht:</label>
                                <textarea id="templateFooter" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 80px; resize: vertical;" placeholder="Marcel's Taxi - Professioneel vervoer sinds...">Marcel's Taxi - Professioneel vervoer
Betrouwbaar ‚Ä¢ Comfortabel ‚Ä¢ Op tijd

Bedankt voor het kiezen van onze service!</textarea>
                            </div>
                        </div>

                        <!-- Save and Preview -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="button" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; margin-right: 15px; cursor: pointer;" onclick="previewEmailTemplate()">
                                üëÅÔ∏è Preview Email
                            </button>
                            <button type="submit" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                                üíæ Save Email Template
                            </button>
                        </div>
                    </form>

                    <div id="emailTemplateStatus" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
                </div>

                <!-- Translation Section -->
                <div id="translation-section" class="content-section">
                    <div style="border-bottom: 2px solid #e1e8ed; margin: 50px 0 50px 0; padding-bottom: 30px;">
                        <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 15px;">Marcel's Taxi Pro</h1>
                        <h2 style="color: #007bff; font-size: 24px; margin-bottom: 5px;">Professional Admin Panel - ‚öôÔ∏è Settings</h2>
                        <h3 style="color: #666; font-size: 20px; margin: 0;">üåê Translation - Email Teksten</h3>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h3>üìß Professional Email Layout</h3>
                        <p style="margin: 10px 0; color: #6c757d;">Configureer alle teksten die in de booking emails verschijnen. Deze instellingen bepalen hoe klanten jullie emails ontvangen.</p>
                    </div>

                    <form id="translationForm" onsubmit="saveTranslation(event)">
                        <!-- Company Header -->
                        <div class="card">
                            <h4 class="text-color">üè¢ Bedrijf Header</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Bedrijfsnaam in Email Header:</label>
                                    <input type="text" id="translationCompanyName" class="input-field" value="Taxi Leuven" placeholder="Taxi Leuven">
                                </div>
                                <div>
                                    <label class="form-label-alt">Logo URL (optioneel):</label>
                                    <input type="text" id="translationLogoUrl" class="input-field" placeholder="https://example.com/logo.png">
                                </div>
                            </div>
                        </div>

                        <!-- Main Message -->
                        <div class="card">
                            <h4 class="text-color">üì® Hoofdbericht</h4>
                            <div class="section-margin">
                                <label class="form-label-alt">Status bericht (eerste regel):</label>
                                <input type="text" id="translationStatusLine" class="input-field" value="Uw booking wacht op bevestiging." placeholder="Uw booking wacht op bevestiging.">
                            </div>
                            <div class="section-margin">
                                <label class="form-label-alt">Bevestigings bericht:</label>
                                <textarea id="translationMainMessage" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 80px; resize: vertical;" placeholder="Bedankt voor uw booking bij Taxi Leuven. Uw reservatienummer is...">Bedankt voor uw booking bij Taxi Leuven. Uw reservatienummer is [BOOKING_ID].

Een bevestigingsmail wordt naar uw e-mailadres verzonden binnen 1 uur. ALS U GEEN EMAIL ONTVANGEN HEBT, GELIEVE MET ONS CONTACT OP TE NEMEN!</textarea>
                            </div>
                        </div>

                        <!-- Section Labels -->
                        <div class="card">
                            <h4 class="text-color">üè∑Ô∏è Sectie Labels</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Reis Sectie:</label>
                                    <input type="text" id="translationTripSection" class="input-field" value="Reis" placeholder="Reis">
                                </div>
                                <div>
                                    <label class="form-label-alt">Klant Sectie:</label>
                                    <input type="text" id="translationClientSection" class="input-field" value="Klant" placeholder="Klant">
                                </div>
                                <div>
                                    <label class="form-label-alt">Reservatie Sectie:</label>
                                    <input type="text" id="translationReservationSection" class="input-field" value="Reservatie" placeholder="Reservatie">
                                </div>
                            </div>
                        </div>

                        <!-- Field Labels -->
                        <div class="card">
                            <h4 class="text-color">üìù Veld Labels</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Datum & tijd:</label>
                                    <input type="text" id="translationDateTime" class="input-field" value="Datum & tijd:" placeholder="Datum & tijd:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Ophaallocatie:</label>
                                    <input type="text" id="translationPickupLocation" class="input-field" value="Ophaallocatie:" placeholder="Ophaallocatie:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Bestemming:</label>
                                    <input type="text" id="translationDestination" class="input-field" value="Bestemming:" placeholder="Bestemming:">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Voertuig:</label>
                                    <input type="text" id="translationVehicle" class="input-field" value="Voertuig:" placeholder="Voertuig:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Passagiers:</label>
                                    <input type="text" id="translationPassengers" class="input-field" value="Passagiers:" placeholder="Passagiers:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Naam:</label>
                                    <input type="text" id="translationName" class="input-field" value="Naam:" placeholder="Naam:">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Telefoonnummer:</label>
                                    <input type="text" id="translationPhone" class="input-field" value="Telefoonnummer:" placeholder="Telefoonnummer:">
                                </div>
                                <div>
                                    <label class="form-label-alt">E-mail:</label>
                                    <input type="text" id="translationEmail" class="input-field" value="E-mail:" placeholder="E-mail:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Referentie-ID:</label>
                                    <input type="text" id="translationReferenceId" class="input-field" value="Referentie-ID:" placeholder="Referentie-ID:">
                                </div>
                            </div>
                        </div>

                        <!-- Pricing Labels -->
                        <div class="card">
                            <h4 class="text-color">üí∞ Prijs Labels</h4>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Boekingsdatum:</label>
                                    <input type="text" id="translationBookingDate" class="input-field" value="Boekingsdatum:" placeholder="Boekingsdatum:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Samenvatting:</label>
                                    <input type="text" id="translationSummary" class="input-field" value="Samenvatting:" placeholder="Samenvatting:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Totaal:</label>
                                    <input type="text" id="translationTotal" class="input-field" value="Totaal:" placeholder="Totaal:">
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="form-label-alt">Betalingen:</label>
                                    <input type="text" id="translationPayments" class="input-field" value="Betalingen:" placeholder="Betalingen:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Verschuldigd bedrag:</label>
                                    <input type="text" id="translationOwedAmount" class="input-field" value="Verschuldigd bedrag:" placeholder="Verschuldigd bedrag:">
                                </div>
                                <div>
                                    <label class="form-label-alt">Status:</label>
                                    <input type="text" id="translationPaymentStatus" class="input-field" value="Pending" placeholder="Pending">
                                </div>
                            </div>
                        </div>

                        <!-- Footer Messages -->
                        <div class="card">
                            <h4 class="text-color">üìÑ Footer Berichten</h4>
                            <div class="section-margin">
                                <label class="form-label-alt">Annulatie regels:</label>
                                <textarea id="translationCancellation" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 60px; resize: vertical;" placeholder="Annulatie binnen 24 uur...">Annulatie binnen 24 uur: Bij annulering binnen 24 uur voor de geplande rit wordt het volledige bedrag van de rit in rekening gebracht.</textarea>
                            </div>
                            <div class="section-margin">
                                <label class="form-label-alt">Wijzigingen regels:</label>
                                <textarea id="translationChanges" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 60px; resize: vertical;" placeholder="Wijzigingen binnen 24 uur...">Wijzigingen binnen 24 uur: Voor aanpassingen aan een bestaande reservering binnen 24 uur (bijvoorbeeld door het missen van een vlucht) wordt een toeslag van ‚Ç¨30 gerekend.</textarea>
                            </div>
                            <div class="section-margin">
                                <label class="form-label-alt">Booking advies:</label>
                                <textarea id="translationBookingAdvice" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 60px; resize: vertical;" placeholder="Het rechtstreeks reserveren van een rit...">Bookingsregels: Het rechtstreeks reserveren van een rit via √©√©n van onze chauffeurs is niet toegestaan. Voor een verzekerde en kwaliteitsvolle dienstverlening verzoeken wij u uw taxi uitsluitend via ons offici√´le systeem te boeken.</textarea>
                            </div>
                            <div>
                                <label class="form-label-alt">Chauffeur informatie:</label>
                                <textarea id="translationDriverInfo" style="width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 6px; min-height: 60px; resize: vertical;" placeholder="E√©n dag voor uw vertrek...">E√©n dag voor uw vertrek sturen wij u het nummer van de chauffeur, zodra wij onze planning hebben gemaakt.</textarea>
                            </div>
                        </div>

                        <!-- Save and Preview -->
                        <div style="text-align: center; margin-top: 30px;">
                            <button type="button" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; margin-right: 15px; cursor: pointer;" onclick="previewTranslationEmail()">
                                üëÅÔ∏è Preview Professional Email
                            </button>
                            <button type="submit" style="background: #28a745; color: white; border: none; padding: 15px 30px; border-radius: 6px; font-size: 16px; cursor: pointer;">
                                üíæ Save Translation Settings
                            </button>
                        </div>
                    </form>

                    <div id="translationStatus" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
                </div>

                <!-- Google Section -->
                <div id="google-section" class="content-section">
                    <div style="border-bottom: 2px solid #e1e8ed; margin: 50px 0 50px 0; padding-bottom: 30px;">
                        <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 15px;">Marcel's Taxi Pro</h1>
                        <h2 style="color: #007bff; font-size: 24px; margin-bottom: 5px;">Professional Admin Panel - ‚öôÔ∏è Settings</h2>
                        <h3 style="color: #666; font-size: 20px; margin: 0;">üåê Google API Configuration</h3>
                    </div>
                    
                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                        <h3 class="text-color">üó∫Ô∏è Google Maps API</h3>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Google Maps API Key:</label>
                            <input type="text" id="googleMapsApiKey" placeholder="Enter your Google Maps JavaScript API key" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Required for map display and route calculations</small>
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Google Places API Key:</label>
                            <input type="text" id="googlePlacesApiKey" placeholder="Enter your Google Places API key" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Required for address autocomplete and place search</small>
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Google Directions API Key:</label>
                            <input type="text" id="googleDirectionsApiKey" placeholder="Enter your Google Directions API key" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Required for route calculation and distance/time estimation</small>
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Google Geocoding API Key:</label>
                            <input type="text" id="googleGeocodingApiKey" placeholder="Enter your Google Geocoding API key" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Required for converting addresses to coordinates</small>
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Default Location:</label>
                            <input type="text" id="defaultLocation" placeholder="Enter default pickup location (e.g., Brussels, Belgium)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Default location for taxi services</small>
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #495057;">Service Area:</label>
                            <input type="text" id="serviceArea" placeholder="Enter service area (e.g., Brussels Metropolitan Area)" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                            <small style="color: #6c757d; display: block; margin-top: 5px;">Geographic area where taxi services are available</small>
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button onclick="saveGoogleSettings()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">üíæ Save Settings</button>
                        </div>
                        
                        <div id="googleStatus" style="margin-top: 15px; padding: 10px; border-radius: 4px; display: none;"></div>
                    </div>
                    
                    <div style="background: #fff3cd; padding: 15px; border-radius: 6px; border: 1px solid #ffeaa7;">
                        <h4 style="color: #856404; margin-bottom: 10px;">‚ÑπÔ∏è Google Maps Setup Instructions</h4>
                        <ol style="color: #856404; margin-bottom: 0;">
                            <li>Go to <a href="https://console.cloud.google.com/" target="_blank" style="color: #007bff;">Google Cloud Console</a></li>
                            <li>Create a new project or select existing one</li>
                            <li>Enable Google Maps JavaScript API</li>
                            <li>Create credentials (API key)</li>
                            <li>Add API key restrictions for security</li>
                            <li>Copy the API key and paste it above</li>
                        </ol>
                    </div>
                </div>

                <!-- Bookings Sections -->
                <div id="next-24h-section" class="content-section">
                    <div class="section-toolbar">
                        <button class="btn btn-success" onclick="window.open('./booking-exact.html', '_blank')">üëÄ View Booking System</button>
                        <div class="btn-group">
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="loadNext24hBookings()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                üì§ <span class="margin-left">Export</span>
                            </button>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span id="next24hCount" style="padding: 8px 12px; background: #28a745; color: white; border-radius: 4px; font-weight: 500;">0 confirmed</span>
                        </div>
                    </div>
                    
                    <div id="next24hBookingsContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: visible;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th style="padding: 6px; text-align: center; width: 6%;">üåç</th>
                                    <th style="padding: 6px; text-align: left; width: 22%;">Info</th>
                                    <th style="padding: 6px; text-align: left; width: 12%;">Date</th>
                                    <th style="padding: 6px; text-align: left; width: 10%;">Status</th>
                                    <th style="padding: 6px; text-align: left; width: 15%;">Driver</th>
                                    <th style="padding: 6px; text-align: left; width: 12%;">Vehicle</th>
                                    <th style="padding: 6px; text-align: left; width: 15%;">Notes</th>
                                    <th style="padding: 6px; text-align: left; width: 8%;">Total</th>
                                </tr>
                            </thead>
                            <tbody id="next24hTableBody">
                                <tr>
                                    <td colspan="8" class="empty-state">
                                        Loading confirmed bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="latest-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Most recent booking requests</p>
                    <!-- Content will be added here -->
                </div>

                <div id="unconfirmed-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">New bookings awaiting confirmation</p>
                    <div class="section-toolbar">
                        <button class="btn btn-success" style="display: flex; align-items: center; gap: 8px;" onclick="window.location.href='booking-exact.html'">
                            ‚ûï Add new booking
                        </button>
                        <div class="btn-group">
                            <button id="refreshUnconfirmedBtn" style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="refreshUnconfirmedBookings()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <button id="deleteAllUnconfirmedBtn" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="deleteAllUnconfirmedBookings()">
                                üóëÔ∏è <span class="margin-left">Delete All</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                üì• <span class="margin-left">Import</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                                üì§ <span class="margin-left">Export</span>
                            </button>
                        </div>
                        <div class="btn-group ml-auto">
                            <input type="text" placeholder="Filter / Search" class="input-field-alt" style="width: 200px;">
                            <select class="input-field-alt">
                                <option>üîÑ Sync source</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="unconfirmedBookingsContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: visible;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 12px; table-layout: fixed;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th style="padding: 6px; text-align: center; width: 6%;">üåç</th>
                                    <th style="padding: 6px; text-align: left; width: 18%;">
                                        <input type="checkbox" style="margin-right: 4px;">Info
                                    </th>
                                    <th style="padding: 6px; text-align: left; width: 12%;">Date</th>
                                    <th style="padding: 6px; text-align: left; width: 8%;">Status</th>
                                    <th style="padding: 6px; text-align: left; width: 18%;">Driver Assignment</th>
                                    <th style="padding: 6px; text-align: left; width: 12%;">Vehicle</th>
                                    <th style="padding: 6px; text-align: left; width: 12%;">Notes</th>
                                    <th style="padding: 6px; text-align: left; width: 8%;">Total</th>
                                    <th style="padding: 6px; text-align: center; width: 6%;">‚úâÔ∏è</th>
                                </tr>
                            </thead>
                            <tbody id="unconfirmedTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        Loading unconfirmed bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Pricing Sections -->
                <div id="distance-time-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Configure pricing for each vehicle type - prices will be used in the booking system</p>
                    <div class="btn-group" style="margin: 20px 0;">
                        <button class="btn btn-primary" onclick="loadVehiclePricing()">üîÑ Load Vehicle Pricing</button>
                        <button class="btn btn-success" onclick="saveAllPricing()">üíæ Save All Changes</button>
                        <button class="btn" style="background: #6c757d; color: white;" onclick="resetToDefaults()">üîÑ Reset to Defaults</button>
                    </div>
                    
                    <!-- Manual Last-Minute Booking Control -->
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin: 20px 0; border-left: 4px solid #f39c12;">
                        <h3 style="color: #d68910; margin-bottom: 15px;">‚ö° Manual Last-Minute Booking Control</h3>
                        
                        <!-- Quick Preset Buttons -->
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚ö° Quick Presets</h4>
                            <div style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                                <button onclick="setQuickPreset('percentage', 0)" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px; font-weight: bold;">üö´ Disable</button>
                                <button onclick="setQuickPreset('percentage', 15)" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">15%</button>
                                <button onclick="setQuickPreset('percentage', 20)" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">20%</button>
                                <button onclick="setQuickPreset('percentage', 25)" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">25%</button>
                                <button onclick="setQuickPreset('percentage', 30)" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">30%</button>
                                <button onclick="setQuickPreset('fixed', 10)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">‚Ç¨10</button>
                                <button onclick="setQuickPreset('fixed', 15)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">‚Ç¨15</button>
                                <button onclick="setQuickPreset('fixed', 20)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">‚Ç¨20</button>
                                <button onclick="setQuickPreset('fixed', 25)" style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 13px;">‚Ç¨25</button>
                            </div>
                        </div>
                        
                        <!-- Custom Settings -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #6c757d;">
                            <h4 style="color: #2c3e50; margin-bottom: 10px;">‚öôÔ∏è Custom Standaard Instellingen</h4>
                            
                            <!-- First Row: Type and Amount -->
                            <div style="display: flex; gap: 20px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                                <div class="flex-center">
                                    <label style="font-weight: 600; color: #2c3e50;">Type:</label>
                                    <select id="defaultLastMinuteType" onchange="updateLastMinuteSymbol(); updateDefaultLastMinuteSettings();" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 140px;">
                                        <option value="percentage">Percentage (%)</option>
                                        <option value="fixed">Vast bedrag (‚Ç¨)</option>
                                    </select>
                                </div>
                                
                                <div class="flex-center">
                                    <label style="font-weight: 600; color: #2c3e50;">Bedrag:</label>
                                    <input type="number" id="defaultLastMinuteAmount" step="0.01" min="0" 
                                           placeholder="25.00" onchange="updateDefaultLastMinuteSettings()" value="25.00"
                                           style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 100px;">
                                    <span id="defaultLastMinuteSymbol" style="font-weight: 600; color: #2c3e50;">%</span>
                                </div>
                                
                                <div class="flex-center">
                                    <label style="font-weight: 600; color: #2c3e50;">Tijdslimiet:</label>
                                    <input type="number" id="defaultLastMinuteHours" step="0.5" min="0" max="24" 
                                           placeholder="3" onchange="updateDefaultLastMinuteSettings()" value="3"
                                           style="padding: 8px; border-radius: 4px; border: 1px solid #ddd; width: 80px;">
                                    <span style="font-weight: 600; color: #2c3e50;">uur</span>
                                </div>
                            </div>
                            
                            <!-- Info only - no save button -->
                            <div style="display: flex; gap: 15px; align-items: center; margin-bottom: 15px;">
                                <div style="color: #6c757d; font-size: 13px;">
                                    Toeslag wordt actief als booking binnen <span id="hoursDisplay">3</span> uur voor vertrek wordt gemaakt.
                                    <strong>Gebruik "üíæ Save All Changes" bovenaan om op te slaan.</strong>
                                </div>
                            </div>
                            
                            <div style="padding: 10px; background: #e9ecef; border-radius: 4px; border-left: 3px solid #007bff;">
                                <div style="font-size: 14px; color: #495057;">
                                    <strong>Voorbeeld:</strong> <span id="defaultLastMinuteExample">Bij een boeking van ‚Ç¨100 wordt ‚Ç¨25 extra gerekend (totaal ‚Ç¨125)</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="padding: 15px; background: #d4edda; border-radius: 8px; border-left: 3px solid #28a745;">
                            <h4 style="color: #155724; margin-bottom: 10px;">‚úÖ Hoe het werkt:</h4>
                            <div style="font-size: 14px; color: #155724; line-height: 1.6;">
                                <div style="margin-bottom: 5px;">‚Ä¢ <strong>Stel hier je standaard toeslag in</strong> (percentage of vast bedrag)</div>
                                <div style="margin-bottom: 5px;">‚Ä¢ <strong>Gebruik Quick Presets</strong> voor veelgebruikte bedragen</div>
                                <div style="margin-bottom: 5px;">‚Ä¢ <strong>Bij elke booking</strong> worden deze instellingen automatisch vooraf ingevuld</div>
                                <div style="margin-bottom: 5px;">‚Ä¢ <strong>Pas per booking aan</strong> als dat nodig is</div>
                                <div>‚Ä¢ <strong>Volledige controle</strong> - jij bepaalt welke bookings een toeslag krijgen</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Per-Vehicle Distance-Based KM Pricing -->
                    <div style="background: #e8f5e9; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin: 20px 0; border-left: 4px solid #28a745;">
                        <h3 style="color: #155724; margin-bottom: 15px;">üìè Afstand-Gebaseerde Kilometer Prijzen</h3>
                        <p style="color: #155724; margin-bottom: 20px;">
                            Configureer verschillende km-prijzen per voertuig gebaseerd op afstand. Voor lange ritten kun je lagere km-prijzen instellen.
                        </p>
                        
                        <!-- Global Distance Threshold -->
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #dee2e6;">
                            <h4 class="text-color">üéØ Afstand Grens</h4>
                            <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                                <div class="flex-center">
                                    <label style="font-weight: 600; color: #2c3e50;">Lange rit vanaf:</label>
                                    <input type="number" id="distanceThreshold" value="" min="50" max="500" step="10"
                                           style="padding: 8px 12px; border-radius: 6px; border: 2px solid #007bff; width: 80px; font-size: 16px; font-weight: 600; text-align: center;"
                                           onchange="updateDistanceExamples()">
                                    <span style="font-weight: 600; color: #2c3e50;">km</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Per-Vehicle Pricing Configuration -->
                        <div id="vehicleDistancePricing">
                            <!-- Vehicle pricing cards will be generated here -->
                        </div>
                        
                        <div id="distancePricingStatus" style="margin-top: 10px; padding: 8px; border-radius: 4px; display: none;">
                            <!-- Status message will be shown here after saving -->
                        </div>
                    </div>
                    
                    <div id="vehiclePricingContainer" style="margin-top: 30px;">
                        <div style="text-align: center; padding: 40px; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
                            <h3>üöó Loading vehicles from Types of Vehicles...</h3>
                            <p>Vehicle pricing cards will appear here automatically</p>
                        </div>
                    </div>
                </div>

                <!-- Item Surcharge Section -->
                <div id="item-surcharge-section" class="content-section">
                    <h2>üí∞ Item Surcharge</h2>
                    <p>All prices are displayed in EUR (‚Ç¨) currency.</p>
                    
                    <!-- Fixed Items -->
                    <div style="margin: 30px 0;">
                        <div id="fixedItemsContainer">
                            <!-- Fixed items will be rendered here -->
                        </div>
                    </div>
                    
                    <!-- Additional Options -->
                    <div style="margin: 30px 0;">
                        <h3>Additional options (e.g. Newspaper, Bottle of water, etc.)</h3>
                        <div id="additionalOptionsContainer">
                            <!-- Additional options will be rendered here -->
                        </div>
                        <div style="margin: 20px 0;">
                            <button class="btn btn-success" onclick="addNewSurchargeItem()">+ New</button>
                            <button class="btn btn-primary" onclick="saveSurchargeItems()" style="margin-left: 10px;">üíæ Save</button>
                        </div>
                    </div>
                </div>

                <!-- Location Surcharge Section -->
                <div id="location-surcharge-section" class="content-section">
                    <div style="margin-bottom: 25px;">
                        <h2 style="color: #2c3e50; margin: 0 0 8px 0; font-size: 24px;">üìç Location Surcharge</h2>
                        <p style="color: #7f8c8d; margin: 0 0 20px 0;">Configure location-based pricing adjustments with address and postcode targeting</p>
                        
                        <div style="display: flex; gap: 10px;">
                            <button id="addLocationSurchargeBtn" onclick="
                                try {
                                    console.log('üìç Button clicked, opening modal...');
                                    const modal = document.getElementById('locationSurchargeModal');
                                    if (!modal) {
                                        alert('Modal element not found!');
                                        return;
                                    }
                                    
                                    // Reset form fields to match your original screenshot - with null checks
                                    const priceEl = document.getElementById('locationSurchargePrice');
                                    const nameEl = document.getElementById('locationSurchargeName');
                                    const overrideTaxEl = document.getElementById('overrideTaxRate');
                                    const addToJourneyEl = document.getElementById('addToJourneyPrice');
                                    const displaySummaryEl = document.getElementById('displayInSummary');
                                    const limitLocationEl = document.getElementById('limitToLocation');
                                    const activeEl = document.getElementById('locationSurchargeActive');
                                    const limitsContainer = document.getElementById('locationLimitsContainer');
                                    
                                    if (priceEl) priceEl.value = '';
                                    if (nameEl) nameEl.value = 'Parking';
                                    if (overrideTaxEl) overrideTaxEl.checked = false;
                                    if (addToJourneyEl) addToJourneyEl.checked = false;
                                    if (displaySummaryEl) displaySummaryEl.checked = true;
                                    if (limitLocationEl) limitLocationEl.checked = true;
                                    if (activeEl) activeEl.checked = true;
                                    if (limitsContainer) limitsContainer.style.display = 'block';
                                    
                                    // Auto-populate address fields like your screenshot
                                    const addressList = document.getElementById('addressPostcodeList');
                                    if (addressList) {
                                        addressList.innerHTML = `
                                            <div style='margin-bottom: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;'>
                                                <div style='display: flex; align-items: center; gap: 8px; margin-bottom: 8px;'>
                                                    <span style='background: #f1f1f1; border: 1px solid #ddd; padding: 8px; border-radius: 4px 0 0 0; font-size: 14px; width: 30px; text-align: center;'>üìç</span>
                                                    <input type='text' placeholder='Address' value='' style='flex: 1; padding: 8px; border: 1px solid #ddd; border-left: none; border-radius: 0; font-size: 14px; outline: none;'>
                                                </div>
                                                <input type='text' placeholder='Postcode' value='' style='width: 100%; padding: 8px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; font-size: 14px; outline: none; box-sizing: border-box;'>
                                            </div>
                                        `;
                                    }
                                    
                                    // Show modal
                                    modal.style.display = 'block';
                                    console.log('‚úÖ Modal opened successfully');
                                } catch (error) {
                                    console.error('‚ùå Error opening modal:', error);
                                    alert('Error opening modal: ' + error.message);
                                }
                            " style="
                                background: #28a745; 
                                color: white; 
                                border: none; 
                                padding: 10px 20px; 
                                border-radius: 6px; 
                                cursor: pointer; 
                                font-size: 14px;
                                display: flex;
                                align-items: center;
                                gap: 8px;
                                font-weight: 600;
                            " title="Click to add new location surcharge">‚ûï Add Location Surcharge</button>
                        </div>
                    </div>
                    
                    <!-- Professional Location Surcharges Table -->
                    <div style="background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead style="background: #f8f9fa; border-bottom: 1px solid #dee2e6;">
                                <tr>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 40px;"></th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Name</th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 100px;">Price</th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6; width: 80px;">Tax</th>
                                    <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #495057; border-right: 1px solid #dee2e6;">Restrictions</th>
                                    <th style="padding: 12px 15px; text-align: center; font-weight: 600; color: #495057; width: 80px;">Status</th>
                                </tr>
                            </thead>
                            <tbody id="locationSurchargesTableBody">
                                <!-- Professional rows will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Meet and Greet Section -->
                <div id="meet-and-greet-section" class="content-section">
                    <div style="border-bottom: 2px solid #e1e8ed; margin: 50px 0 50px 0; padding-bottom: 30px;">
                        <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 15px;">Marcel's Taxi Pro</h1>
                        <h2 style="color: #007bff; font-size: 24px; margin-bottom: 5px;">Professional Admin Panel - üí∞ Pricing</h2>
                        <h3 style="color: #666; font-size: 20px; margin: 0;">ü§ù Meet and Greet Locations</h3>
                    </div>

                    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #007bff;">
                        <h3>ü§ù Meet and Greet Locatie Beheer</h3>
                        <p style="margin: 10px 0; color: #6c757d;">Voeg luchthavens, stations en hotels toe waar Meet & Greet service beschikbaar is. Het systeem past automatisch de Meet & Greet toeslag toe wanneer iemand boekt vanaf deze locaties.</p>
                    </div>

                    <!-- Connection with Item Surcharge -->
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                        <h4 style="color: #155724; margin-bottom: 10px;">üîó Verbinding met Item Surcharge</h4>
                        <p style="margin: 5px 0; color: #155724; font-size: 14px;">
                            <strong>Meet & Greet toeslag:</strong> ‚Ç¨<span id="meetGreetSurchargePrice">5.00</span> 
                            <span id="meetGreetSurchargeStatus" style="margin-left: 10px; padding: 2px 8px; border-radius: 4px; font-size: 12px;"></span>
                        </p>
                        <p style="margin: 0; color: #155724; font-size: 13px;">
                            Deze prijs wordt automatisch toegepast wanneer de ophaallocatie een geregistreerde Meet & Greet locatie is.
                        </p>
                    </div>

                    <!-- Location Types Tabs -->
                    <div class="section-margin-lg">
                        <div style="display: flex; border-bottom: 2px solid #e9ecef;">
                            <button class="location-tab" data-type="airports" onclick="switchLocationTab('airports')" 
                                    style="padding: 12px 24px; border: none; background: #007bff; color: white; border-radius: 8px 8px 0 0; cursor: pointer; font-weight: 600;">
                                ‚úàÔ∏è Luchthavens
                            </button>
                            <button class="location-tab" data-type="stations" onclick="switchLocationTab('stations')" 
                                    style="padding: 12px 24px; border: none; background: #6c757d; color: white; border-radius: 8px 8px 0 0; cursor: pointer; margin-left: 2px;">
                                üöâ Stations
                            </button>
                            <button class="location-tab" data-type="hotels" onclick="switchLocationTab('hotels')" 
                                    style="padding: 12px 24px; border: none; background: #6c757d; color: white; border-radius: 8px 8px 0 0; cursor: pointer; margin-left: 2px;">
                                üè® Hotels
                            </button>
                        </div>
                    </div>

                    <!-- Location Management Container -->
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                        <div id="airportsTab" class="location-tab-content">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="color: #2c3e50; margin: 0;">‚úàÔ∏è Luchthaven Locaties</h4>
                                <button class="btn btn-success" onclick="addNewLocation('airports')">+ Nieuwe Luchthaven</button>
                            </div>
                            <div id="airportsList" class="locations-list">
                                <!-- Airport locations will be rendered here -->
                            </div>
                        </div>

                        <div id="stationsTab" class="location-tab-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="color: #2c3e50; margin: 0;">üöâ Station Locaties</h4>
                                <button class="btn btn-success" onclick="addNewLocation('stations')">+ Nieuw Station</button>
                            </div>
                            <div id="stationsList" class="locations-list">
                                <!-- Station locations will be rendered here -->
                            </div>
                        </div>

                        <div id="hotelsTab" class="location-tab-content" style="display: none;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h4 style="color: #2c3e50; margin: 0;">üè® Hotel Locaties</h4>
                                <button class="btn btn-success" onclick="addNewLocation('hotels')">+ Nieuw Hotel</button>
                            </div>
                            <div id="hotelsList" class="locations-list">
                                <!-- Hotel locations will be rendered here -->
                            </div>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div style="text-align: center; margin-top: 30px;">
                        <button class="btn btn-primary" onclick="saveMeetAndGreetSettings()">
                            üíæ Opslaan Meet & Greet Instellingen
                        </button>
                    </div>

                    <div id="meetGreetStatus" style="margin-top: 20px; padding: 15px; border-radius: 6px; display: none;"></div>
                </div>

                <div id="deposit-payments-section" class="content-section">
                    <h2>üí∞ Deposit Payments</h2>
                    <p>Configure security deposit settings</p>
                </div>

                <!-- Other sections -->
                <div id="cancelled-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Cancelled and deleted bookings</p>
                    <div class="section-toolbar">
                        <div class="btn-group">
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="loadCancelledBookings()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="clearAllCancelled()">
                                üóëÔ∏è <span class="margin-left">Clear All</span>
                            </button>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span id="cancelledCount" style="padding: 8px 12px; background: #dc3545; color: white; border-radius: 4px; font-weight: 500;">0 cancelled</span>
                        </div>
                    </div>
                    
                    <div id="cancelledBookingsContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th class="table-header" style="width: 60px;">üáßüá™</th>
                                    <th class="table-header">Info</th>
                                    <th class="table-header">Date</th>
                                    <th class="table-header">Status</th>
                                    <th class="table-header">Driver Assignment</th>
                                    <th class="table-header">Vehicle</th>
                                    <th class="table-header">Notes</th>
                                    <th class="table-header" style="text-align: left;">Total</th>
                                    <th class="table-header" style="width: 60px;">‚úâÔ∏è</th>
                                </tr>
                            </thead>
                            <tbody id="cancelledTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        Loading cancelled bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Trash Section -->
                <div id="trash-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Deleted bookings (can be restored or permanently deleted)</p>
                    <div class="section-toolbar">
                        <div class="btn-group">
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="loadTrashItems()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="clearAllTrash()">
                                üóëÔ∏è <span class="margin-left">Empty Trash</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="restoreAllTrash()">
                                ‚Ü©Ô∏è <span class="margin-left">Restore All</span>
                            </button>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span id="trashCount" style="padding: 8px 12px; background: #6c757d; color: white; border-radius: 4px; font-weight: 500;">0 items</span>
                        </div>
                    </div>
                    
                    <div id="trashContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th class="table-header" style="width: 50px;">üåç</th>
                                    <th class="table-header" style="width: 200px;">Info</th>
                                    <th class="table-header" style="width: 120px;">Date</th>
                                    <th class="table-header" style="width: 100px;">Status</th>
                                    <th class="table-header" style="width: 140px;">Driver</th>
                                    <th class="table-header" style="width: 120px;">Vehicle</th>
                                    <th class="table-header" style="width: 100px;">Notes</th>
                                    <th class="table-header" style="width: 80px;">Total</th>
                                    <th class="table-header" style="width: 50px;">‚úâÔ∏è</th>
                                </tr>
                            </thead>
                            <tbody id="trashTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        No items in trash
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- All Bookings Section -->
                <div id="all-bookings-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Complete history of all bookings from customer and dispatch systems</p>
                    <div class="section-toolbar">
                        <div class="btn-group">
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="loadAllBookings()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <select id="allBookingsFilter" onchange="filterAllBookings()" style="padding: 8px 12px; border: 1px solid #dee2e6; border-radius: 6px;">
                                <option value="all">All Bookings</option>
                                <option value="customer">Customer Bookings</option>
                                <option value="dispatch">Dispatch Bookings</option>
                                <option value="confirmed">Confirmed Only</option>
                                <option value="unconfirmed">Unconfirmed Only</option>
                                <option value="cancelled">Cancelled Only</option>
                            </select>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span id="allBookingsCount" style="padding: 8px 12px; background: #007bff; color: white; border-radius: 4px; font-weight: 500;">0 bookings</span>
                        </div>
                    </div>
                    
                    <div id="allBookingsContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: visible;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; position: relative;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th class="table-header" style="width: 100px;">üèÅ View</th>
                                    <th class="table-header" style="width: 180px;">Info</th>
                                    <th class="table-header" style="width: 120px;">Date</th>
                                    <th class="table-header" style="width: 100px;">Status</th>
                                    <th class="table-header" style="width: 140px;">Driver Assignment</th>
                                    <th class="table-header" style="width: 120px;">Vehicle</th>
                                    <th class="table-header" style="width: 150px;">Notes</th>
                                    <th class="table-header" style="width: 80px; text-align: left;">Total</th>
                                    <th class="table-header" style="width: 60px;">Email</th>
                                </tr>
                            </thead>
                            <tbody id="allBookingsTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        Loading all bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Completed Bookings Section -->
                <div id="completed-section" class="content-section">
                    <p style="color: #6c757d; margin: 0 0 20px 0;">Successfully completed trips and services</p>
                    <div class="section-toolbar">
                        <div class="btn-group">
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="loadCompletedBookings()">
                                üîÑ <span class="margin-left">Refresh</span>
                            </button>
                            <button style="background: white; border: 1px solid #dee2e6; padding: 8px 16px; border-radius: 6px; cursor: pointer;" onclick="clearAllCompleted()">
                                üóëÔ∏è <span class="margin-left">Clear All</span>
                            </button>
                        </div>
                        <div style="margin-left: auto; display: flex; gap: 10px; align-items: center;">
                            <span id="completedCount" style="padding: 8px 12px; background: #28a745; color: white; border-radius: 4px; font-weight: 500;">0 completed</span>
                        </div>
                    </div>
                    
                    <div id="completedBookingsContainer" style="background: white; border: 1px solid #dee2e6; border-radius: 8px; overflow: visible;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 14px; position: relative;">
                            <thead style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                                <tr>
                                    <th class="table-header" style="width: 50px;">üåç</th>
                                    <th class="table-header" style="width: 200px;">Info</th>
                                    <th class="table-header" style="width: 120px;">Date</th>
                                    <th class="table-header" style="width: 100px;">Status</th>
                                    <th class="table-header" style="width: 140px;">Driver</th>
                                    <th class="table-header" style="width: 120px;">Vehicle</th>
                                    <th class="table-header" style="width: 100px;">Notes</th>
                                    <th class="table-header" style="width: 80px;">Total</th>
                                    <th class="table-header" style="width: 50px;">‚úâÔ∏è</th>
                                </tr>
                            </thead>
                            <tbody id="completedTableBody">
                                <tr>
                                    <td colspan="9" class="empty-state">
                                        Loading completed bookings...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div id="users-section" class="content-section">
                    <h2>üë• Users</h2>
                    <p>Manage users, drivers, and administrators</p>
                </div>

                <!-- Drivers Section -->
                <div id="drivers-section" class="content-section">
                    <div style="border-bottom: 2px solid #e1e8ed; margin: 100px 0 50px 0; padding-bottom: 30px;">
                        <h1 style="color: #2c3e50; font-size: 28px; margin-bottom: 15px;">Marcel's Taxi Pro</h1>
                        <h2 style="color: #007bff; font-size: 24px; margin-bottom: 10px;">Professional Driver Management</h2>
                        <h3 style="color: #666; font-size: 20px; margin: 0;">üöñ Complete Driver Administration System</h3>
                    </div>

                    <!-- Driver Stats Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 50px;">
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9;">Totaal Chauffeurs</div>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="totalDriversCount">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Actieve accounts</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #007bff, #0056b3); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9;">Online Nu</div>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="onlineDriversCount">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Beschikbaar voor ritten</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #ffc107, #ff9800); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9;">Bezig met Rit</div>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="busyDriversCount">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Onderweg naar klanten</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #6c757d, #495057); color: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                            <div style="font-size: 14px; opacity: 0.9;">Documenten Check</div>
                            <div style="font-size: 36px; font-weight: bold; margin: 10px 0;" id="pendingDocsCount">0</div>
                            <div style="font-size: 12px; opacity: 0.8;">Wacht op verificatie</div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 15px; margin-bottom: 30px;">
                        <button onclick="addNewDriverWorking()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">‚ûï</span> Nieuwe Chauffeur Toevoegen
                        </button>
                        <button onclick="window.open('driver-app.html', '_blank')" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">üì±</span> Chauffeur App
                        </button>
                        <button onclick="loadDriversList()" style="background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px;">
                            <span style="font-size: 20px;">üîÑ</span> Vernieuwen
                        </button>
                        <input type="text" id="driverSearchInput" placeholder="Zoek chauffeur..." onkeyup="searchDrivers(this.value)" style="flex: 1; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px;">
                    </div>

                    <!-- Drivers Table -->
                    <div style="background: white; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden;">
                        <table class="drivers-table">
                            <thead>
                                <tr>
                                    <th class="col-status">Status</th>
                                    <th class="col-name">Naam</th>
                                    <th class="col-phone">Telefoon</th>
                                    <th class="col-email">Email</th>
                                    <th class="col-vehicle">Voertuig</th>
                                    <th class="col-documents">Documenten</th>
                                    <th class="col-rating">Rating</th>
                                    <th class="col-actions">Acties</th>
                                </tr>
                            </thead>
                            <tbody id="driversTableBody">
                                <!-- Drivers will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Driver Modal -->
                <div id="driverModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto;">
                    <div style="background: white; margin: 50px auto; max-width: 800px; border-radius: 12px; padding: 0; max-height: 90vh; overflow-y: auto;">
                        <!-- Modal Header -->
                        <div style="background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; border-radius: 12px 12px 0 0;">
                            <h2 style="margin: 0; font-size: 24px;">üöñ Nieuwe Chauffeur Toevoegen</h2>
                            <button onclick="closeDriverModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer;">‚úï</button>
                        </div>
                        
                        <!-- Modal Content -->
                        <div style="padding: 30px;">
                            <form id="driverForm" onsubmit="saveNewDriver(event)">
                                
                                <!-- Persoonlijke Gegevens -->
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <h3 class="text-color">üë§ Persoonlijke Gegevens</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label class="form-label">Voornaam *</label>
                                            <input type="text" id="driverFirstName" required class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Achternaam *</label>
                                            <input type="text" id="driverLastName" required class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Email *</label>
                                            <input type="email" id="driverEmail" required class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Telefoon *</label>
                                            <input type="tel" id="driverPhone" required class="input-field" placeholder="06-12345678">
                                        </div>
                                        <div>
                                            <label class="form-label">Geboortedatum</label>
                                            <input type="date" id="driverBirthDate" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">BSN</label>
                                            <input type="text" id="driverBSN" class="input-field" placeholder="123456789">
                                        </div>
                                    </div>
                                </div>

                                <!-- Adres -->
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <h3 class="text-color">üìç Adres</h3>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div>
                                            <label class="form-label">Straatnaam</label>
                                            <input type="text" id="driverStreet" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Huisnummer</label>
                                            <input type="text" id="driverHouseNumber" class="input-field">
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 15px;">
                                        <div>
                                            <label class="form-label">Postcode</label>
                                            <input type="text" id="driverPostalCode" class="input-field" placeholder="1234AB">
                                        </div>
                                        <div>
                                            <label class="form-label">Plaats</label>
                                            <input type="text" id="driverCity" class="input-field">
                                        </div>
                                    </div>
                                </div>

                                <!-- Documenten -->
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <h3 class="text-color">üìÑ Documenten</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label class="form-label">Rijbewijs Nummer</label>
                                            <input type="text" id="driverLicenseNumber" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Rijbewijs Vervaldatum</label>
                                            <input type="date" id="driverLicenseExpiry" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Chauffeurspas Nummer</label>
                                            <input type="text" id="driverTaxiPass" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Chauffeurspas Vervaldatum</label>
                                            <input type="date" id="driverTaxiPassExpiry" class="input-field">
                                        </div>
                                    </div>
                                </div>

                                <!-- Voertuig -->
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                                    <h3 class="text-color">üöó Voertuig</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label class="form-label">Merk</label>
                                            <input type="text" id="driverCarBrand" class="input-field" placeholder="Toyota">
                                        </div>
                                        <div>
                                            <label class="form-label">Model</label>
                                            <input type="text" id="driverCarModel" class="input-field" placeholder="Prius">
                                        </div>
                                        <div>
                                            <label class="form-label">Kenteken</label>
                                            <input type="text" id="driverLicensePlate" class="input-field" placeholder="AB-123-CD">
                                        </div>
                                        <div>
                                            <label class="form-label">Kleur</label>
                                            <input type="text" id="driverCarColor" class="input-field" placeholder="Zwart">
                                        </div>
                                        <div>
                                            <label class="form-label">Aantal Zitplaatsen</label>
                                            <select id="driverSeats" class="input-field">
                                                <option value="4">4 personen</option>
                                                <option value="5">5 personen</option>
                                                <option value="6">6 personen</option>
                                                <option value="7">7 personen</option>
                                                <option value="8">8 personen</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="form-label">Voertuig Type</label>
                                            <select id="driverVehicleType" class="input-field">
                                                <option value="sedan">Sedan</option>
                                                <option value="estate">Estate</option>
                                                <option value="minivan">Minivan</option>
                                                <option value="minivan_long">Minivan Long</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>

                                <!-- Account -->
                                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                                    <h3 class="text-color">üîê Account</h3>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div>
                                            <label class="form-label">Gebruikersnaam</label>
                                            <input type="text" id="driverUsername" class="input-field">
                                        </div>
                                        <div>
                                            <label class="form-label">Tijdelijk Wachtwoord</label>
                                            <input type="password" id="driverPassword" class="input-field" value="password123">
                                        </div>
                                    </div>
                                </div>

                                <!-- Buttons -->
                                <div style="display: flex; gap: 15px; justify-content: flex-end;">
                                    <button type="button" onclick="closeDriverModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                                        Annuleren
                                    </button>
                                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer;">
                                        üíæ Chauffeur Opslaan
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Payment Methods Section -->
                <div id="payment-methods-section" class="content-section">
                    <div style="background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 class="section-margin">Available Payment Methods</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                            <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üíµ</div>
                                <h4 style="margin: 0 0 5px 0;">Cash</h4>
                                <p style="margin: 0; font-size: 12px; color: #6c757d;">Pay with cash on delivery</p>
                                <label style="display: flex; align-items: center; justify-content: center; margin-top: 10px;">
                                    <input type="checkbox" checked> Enabled
                                </label>
                            </div>
                            <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üí≥</div>
                                <h4 style="margin: 0 0 5px 0;">Credit Card</h4>
                                <p style="margin: 0; font-size: 12px; color: #6c757d;">Pay with credit/debit card</p>
                                <label style="display: flex; align-items: center; justify-content: center; margin-top: 10px;">
                                    <input type="checkbox" id="creditCardEnabled" checked> Enabled
                                </label>
                                <button onclick="configureCreditCard()" style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚öôÔ∏è Configure</button>
                            </div>
                            <div style="border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; text-align: center;">
                                <div style="font-size: 32px; margin-bottom: 10px;">üÖøÔ∏è</div>
                                <h4 style="margin: 0 0 5px 0;">PayPal</h4>
                                <p style="margin: 0; font-size: 12px; color: #6c757d;">Pay with PayPal account</p>
                                <label style="display: flex; align-items: center; justify-content: center; margin-top: 10px;">
                                    <input type="checkbox" id="paypalEnabled" checked> Enabled
                                </label>
                                <button onclick="configurePayPal()" style="margin-top: 10px; background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">‚öôÔ∏è Configure</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- PayPal Configuration Section -->
                    <div id="paypalConfigSection" style="display: none; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span>üÖøÔ∏è PayPal Configuration</span>
                            <button onclick="closePayPalConfig()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">‚úï Close</button>
                        </h3>
                        
                        <form id="paypalConfigForm" onsubmit="savePayPalConfig(event)">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <!-- Left Column -->
                                <div>
                                    <div class="section-margin">
                                        <label class="form-label">Name</label>
                                        <input type="text" id="paypalName" value="PayPal" class="input-field-alt">
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Description</label>
                                        <textarea id="paypalDescription" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; min-height: 80px;">PayPal</textarea>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Environment</label>
                                        <select id="paypalEnvironment" class="input-field-alt">
                                            <option value="sandbox">Sandbox (Test)</option>
                                            <option value="live" selected>Live (Production)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">PayPal Business Email *</label>
                                        <input type="email" id="paypalBusinessEmail" required placeholder="your_business@email.com" class="input-field-alt">
                                        <small style="color: #6c757d;">Email address associated with your PayPal business account</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Currency</label>
                                        <select id="paypalCurrency" class="input-field-alt">
                                            <option value="EUR" selected>Euro (EUR)</option>
                                            <option value="USD">US Dollar (USD)</option>
                                            <option value="GBP">British Pound (GBP)</option>
                                            <option value="CHF">Swiss Franc (CHF)</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div>
                                    <div class="section-margin">
                                        <label class="form-label">Language Code</label>
                                        <input type="text" id="paypalLanguage" value="auto" placeholder="auto" class="input-field-alt">
                                        <small style="color: #6c757d;">Use 'auto' for automatic detection or specify: nl_BE, fr_BE, en_US</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Deposit</label>
                                        <select id="paypalDeposit" class="input-field-alt">
                                            <option value="enabled" selected>Enabled</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Payment Charge Type</label>
                                        <select id="paypalChargeType" onchange="updateChargeTypeLabel()" class="input-field-alt">
                                            <option value="percent" selected>Percent (%)</option>
                                            <option value="fixed">Fixed Amount</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Payment Charge Value <span id="chargeUnit">(%)</span></label>
                                        <input type="number" id="paypalChargeValue" value="3.6" step="0.1" min="0" class="input-field-alt">
                                        <small style="color: #6c757d;">Transaction fee to add to the total amount</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Ordering</label>
                                        <input type="number" id="paypalOrdering" value="2" min="0" class="input-field-alt">
                                        <small style="color: #6c757d;">Display order (lower numbers appear first)</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="border-top: 1px solid #dee2e6; margin-top: 20px; padding-top: 20px;">
                                <div class="section-margin">
                                    <label class="flex-center">
                                        <input type="checkbox" id="paypalDefault"> 
                                        <span style="font-weight: 600;">Set as Default Payment Method</span>
                                    </label>
                                </div>
                                
                                <div class="section-margin">
                                    <label class="flex-center">
                                        <input type="checkbox" id="paypalActive" checked> 
                                        <span style="font-weight: 600;">Active</span>
                                    </label>
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label class="form-label">Display</label>
                                    <select id="paypalDisplay" class="input-field-alt">
                                        <option value="frontend_backend" selected>Frontend & Backend</option>
                                        <option value="frontend">Frontend Only</option>
                                        <option value="backend">Backend Only</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                        üíæ Save PayPal Settings
                                    </button>
                                    <button type="button" onclick="testPayPalConnection()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                        üîß Test Connection
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Credit Card Configuration Section -->
                    <div id="creditCardConfigSection" style="display: none; background: white; border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin: 20px 0;">
                        <h3 style="margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
                            <span>üí≥ Credit Card Configuration</span>
                            <button onclick="closeCreditCardConfig()" style="background: #6c757d; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 14px;">‚úï Close</button>
                        </h3>
                        
                        <form id="creditCardConfigForm" onsubmit="saveCreditCardConfig(event)">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">
                                <!-- Left Column -->
                                <div>
                                    <div class="section-margin">
                                        <label class="form-label">Name</label>
                                        <input type="text" id="creditCardName" value="Invoice" class="input-field-alt">
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Description</label>
                                        <textarea id="creditCardDescription" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px; min-height: 80px;">Pay Online: ONLY INVOICE</textarea>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Environment</label>
                                        <select id="creditCardEnvironment" class="input-field-alt">
                                            <option value="sandbox">Sandbox (Test)</option>
                                            <option value="live" selected>Live (Production)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Live Publishable Key *</label>
                                        <input type="text" id="creditCardLivePublishableKey" required placeholder="pk_live_..." class="input-field-alt">
                                        <small style="color: #6c757d;">Your live publishable key from payment gateway</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Live Secret Key *</label>
                                        <input type="password" id="creditCardLiveSecretKey" required placeholder="sk_live_..." class="input-field-alt">
                                        <small style="color: #6c757d;">Your live secret key (stored securely)</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Strong Customer Authentication (SCA)</label>
                                        <select id="creditCardSCA" class="input-field-alt">
                                            <option value="enabled" selected>Enabled</option>
                                            <option value="disabled">Disabled</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Right Column -->
                                <div>
                                    <div class="section-margin">
                                        <label class="form-label">Future Payment Usage</label>
                                        <select id="creditCardFuturePayment" class="input-field-alt">
                                            <option value="never" selected>Never</option>
                                            <option value="on_session">On Session</option>
                                            <option value="off_session">Off Session</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Payment Capture Method</label>
                                        <select id="creditCardCaptureMethod" class="input-field-alt">
                                            <option value="automatic" selected>Automatic</option>
                                            <option value="manual">Manual</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Currency</label>
                                        <select id="creditCardCurrency" class="input-field-alt">
                                            <option value="EUR" selected>Euro (EUR)</option>
                                            <option value="USD">US Dollar (USD)</option>
                                            <option value="GBP">British Pound (GBP)</option>
                                            <option value="CHF">Swiss Franc (CHF)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Language Code</label>
                                        <input type="text" id="creditCardLanguage" value="auto" placeholder="auto" class="input-field-alt">
                                        <small style="color: #6c757d;">Use 'auto' for automatic detection</small>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Deposit</label>
                                        <select id="creditCardDeposit" class="input-field-alt">
                                            <option value="disabled" selected>Disabled</option>
                                            <option value="enabled">Enabled</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Payment Charge Type</label>
                                        <select id="creditCardChargeType" onchange="updateCreditCardChargeTypeLabel()" class="input-field-alt">
                                            <option value="percent" selected>Percent (%)</option>
                                            <option value="fixed">Fixed Amount (‚Ç¨)</option>
                                        </select>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Payment Charge Value <span id="creditCardChargeUnit">(%)</span></label>
                                        <input type="number" id="creditCardChargeValue" value="6" min="0" step="0.01" class="input-field-alt">
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="form-label">Ordering</label>
                                        <input type="number" id="creditCardOrdering" value="10" min="0" class="input-field-alt">
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="flex-center">
                                            <input type="checkbox" id="creditCardDefault">
                                            <span>Default Payment Method</span>
                                        </label>
                                    </div>
                                    
                                    <div class="section-margin">
                                        <label class="flex-center">
                                            <input type="checkbox" id="creditCardActive" checked>
                                            <span>Active</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            
                            <div style="grid-column: 1 / -1; margin-top: 20px;">
                                <div class="section-margin-lg">
                                    <label class="form-label">Display</label>
                                    <select id="creditCardDisplay" class="input-field-alt">
                                        <option value="frontend_backend" selected>Frontend & Backend</option>
                                        <option value="frontend">Frontend Only</option>
                                        <option value="backend">Backend Only</option>
                                    </select>
                                </div>
                                
                                <div style="display: flex; gap: 10px;">
                                    <button type="submit" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                        üíæ Save Credit Card Settings
                                    </button>
                                    <button type="button" onclick="testCreditCardConnection()" style="background: #17a2b8; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">
                                        üîß Test Connection
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div id="feedback-section" class="content-section">
                    <h2>üí¨ Customer Feedback</h2>
                    <p>View and manage customer feedback</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Booking Edit Modal -->
    <div class="modal-overlay" id="bookingEditModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìù Edit Booking - <span id="modalBookingId">BK123456</span></h2>
                <button class="modal-close" onclick="closeBookingModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- Customer Information -->
                <div class="edit-section">
                    <h3>üë§ Customer Information</h3>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>First Name</label>
                            <input type="text" id="editFirstName" placeholder="Enter first name">
                        </div>
                        <div class="edit-field">
                            <label>Last Name</label>
                            <input type="text" id="editLastName" placeholder="Enter last name">
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Email Address</label>
                            <input type="email" id="editEmail" placeholder="customer@email.com">
                        </div>
                        <div class="edit-field">
                            <label>Phone Number</label>
                            <input type="tel" id="editPhone" placeholder="+32 xxx xx xx xx">
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Number of Passengers</label>
                            <select id="editPassengers">
                                <option value="1">1 Passenger</option>
                                <option value="2">2 Passengers</option>
                                <option value="3">3 Passengers</option>
                                <option value="4">4 Passengers</option>
                                <option value="5">5 Passengers</option>
                                <option value="6">6 Passengers</option>
                                <option value="7">7 Passengers</option>
                                <option value="8">8 Passengers</option>
                            </select>
                        </div>
                        <div class="edit-field">
                            <label>Payment Method</label>
                            <select id="editPaymentMethod">
                                <option value="cash">Cash</option>
                                <option value="card">Credit Card</option>
                                <option value="paypal">PayPal</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Trip Information -->
                <div class="edit-section">
                    <h3>üöó Trip Information</h3>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>From Location</label>
                            <input type="text" id="editFromLocation" placeholder="Pickup address">
                        </div>
                        <div class="edit-field">
                            <label>To Location</label>
                            <input type="text" id="editToLocation" placeholder="Destination address">
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field" style="width: 100%;">
                            <label>Extra Stops</label>
                            <div id="editExtraStopsDisplay" style="padding: 10px; background: #f8f9fa; border-radius: 6px; min-height: 40px; color: #666;">No extra stops</div>
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Travel Date</label>
                            <input type="date" id="editTravelDate">
                        </div>
                        <div class="edit-field">
                            <label>Travel Time</label>
                            <input type="time" id="editTravelTime">
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Vehicle Type</label>
                            <select id="editVehicleType">
                                <option value="saloon">Saloon</option>
                                <option value="estate">Estate</option>
                                <option value="minivan">Minivan</option>
                                <option value="minivan_long">Minivan Long</option>
                            </select>
                        </div>
                        <div class="edit-field">
                            <label>Return Trip</label>
                            <select id="editReturnTrip">
                                <option value="false">One Way</option>
                                <option value="true">Return Trip</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Booking Details -->
                <div class="edit-section">
                    <h3>üìã Booking Details</h3>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Booking Status</label>
                            <select id="editBookingStatus">
                                <option value="unconfirmed">Unconfirmed</option>
                                <option value="confirmed">Confirmed</option>
                                <option value="completed">Completed</option>
                                <option value="cancelled">Cancelled</option>
                            </select>
                        </div>
                        <div class="edit-field">
                            <label>Price (‚Ç¨)</label>
                            <input type="number" id="editPrice" step="0.01" placeholder="50.00">
                        </div>
                    </div>
                    <div class="edit-row">
                        <div class="edit-field">
                            <label>Driver</label>
                            <input type="text" id="editDriver" placeholder="Assign driver">
                        </div>
                    </div>
                    <div class="edit-field">
                        <label>Special Instructions</label>
                        <textarea id="editSpecialInstructions" rows="3" placeholder="Add any special instructions or notes..."></textarea>
                    </div>
                </div>

                <!-- Surcharges Section -->
                <div class="edit-section">
                    <h3>üí∞ Surcharges</h3>
                    <div id="editSurchargesList" class="section-margin">
                        <!-- Surcharges will be populated here -->
                    </div>
                    <button type="button" class="add-surcharge-btn" onclick="addNewSurcharge()" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                        ‚ûï Add item
                    </button>
                </div>
            </div>

            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="closeBookingModal()">Cancel</button>
                <button class="modal-btn modal-btn-danger" onclick="deleteBooking()">Delete Booking</button>
                <button class="modal-btn modal-btn-success" onclick="confirmBookingFromModal()">‚úÖ Confirm Booking</button>
                <button class="modal-btn modal-btn-primary" onclick="saveBookingChanges()">üíæ Save Changes</button>
            </div>
        </div>
    </div>

    <!-- üÜï BOOKING DETAIL OVERVIEW MODAL -->
    <div id="bookingOverviewModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 700px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; text-align: center; padding: 20px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üìã Booking Overview</h2>
                <div style="font-size: 16px; margin-top: 5px; opacity: 0.9;" id="overviewBookingId">BK123456</div>
                <button class="modal-close" onclick="closeBookingOverview()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            
            <div class="modal-body" style="padding: 25px;">
                <div id="adminBookingOverviewContent">
                    <!-- Content will be generated here -->
                </div>
            </div>

            <div class="modal-actions" style="padding: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                <button class="modal-btn modal-btn-secondary" onclick="closeBookingOverview()" style="margin-right: 10px;">Close</button>
                <button class="modal-btn modal-btn-primary" onclick="editBookingFromOverview()" style="background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer;">‚úèÔ∏è Edit Booking</button>
            </div>
        </div>
    </div>

    <!-- üÜï COMPREHENSIVE DRIVER MODAL -->
    <div id="addDriverModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; overflow-y: auto;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; margin: 20px auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <div class="modal-header" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; text-align: center; padding: 20px;">
                <h2 style="margin: 0; font-size: 24px; font-weight: 700;">üë§ Nieuwe Chauffeur Toevoegen</h2>
                <button class="modal-close" onclick="closeDriverModal()" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            
            <form id="addDriverForm" class="modal-body" style="padding: 25px;">
                <!-- Personal Details Section -->
                <div class="driver-form-section" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; font-weight: 600;">üìù Persoonlijke Gegevens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Voornaam *</label>
                            <input type="text" id="driverFirstName" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Achternaam *</label>
                            <input type="text" id="driverLastName" required class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Email *</label>
                            <input type="email" id="driverEmail" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Telefoon *</label>
                            <input type="tel" id="driverPhone" required class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label-gray">Geboortedatum</label>
                            <input type="date" id="driverBirthDate" class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">BSN</label>
                            <input type="text" id="driverBSN" class="input-large">
                        </div>
                    </div>
                </div>

                <!-- Address Section -->
                <div class="driver-form-section" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; font-weight: 600;">üè† Adresgegevens</h3>
                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Straatnaam *</label>
                            <input type="text" id="driverStreet" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Huisnummer *</label>
                            <input type="text" id="driverHouseNumber" required class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label-gray">Postcode *</label>
                            <input type="text" id="driverPostalCode" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Plaats *</label>
                            <input type="text" id="driverCity" required class="input-large">
                        </div>
                    </div>
                </div>

                <!-- Documents Section -->
                <div class="driver-form-section" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; font-weight: 600;">üìÑ Documenten</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Rijbewijs Nummer *</label>
                            <input type="text" id="driverLicenseNumber" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Rijbewijs Vervaldatum *</label>
                            <input type="date" id="driverLicenseExpiry" required class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label-gray">Chauffeurspas Nummer *</label>
                            <input type="text" id="taxiPassNumber" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Chauffeurspas Vervaldatum *</label>
                            <input type="date" id="taxiPassExpiry" required class="input-large">
                        </div>
                    </div>
                </div>

                <!-- Vehicle Section -->
                <div class="driver-form-section" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; font-weight: 600;">üöó Voertuiggegevens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Merk *</label>
                            <input type="text" id="vehicleBrand" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Model *</label>
                            <input type="text" id="vehicleModel" required class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="form-label-gray">Kenteken *</label>
                            <input type="text" id="vehicleLicensePlate" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Kleur</label>
                            <input type="text" id="vehicleColor" class="input-large">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label-gray">Aantal zitplaatsen</label>
                            <select id="vehicleSeats" class="input-large">
                                <option value="4">4 zitplaatsen</option>
                                <option value="5">5 zitplaatsen</option>
                                <option value="6">6 zitplaatsen</option>
                                <option value="7">7 zitplaatsen</option>
                                <option value="8">8 zitplaatsen</option>
                            </select>
                        </div>
                        <div>
                            <label class="form-label-gray">Type voertuig</label>
                            <select id="vehicleType" class="input-large">
                                <option value="sedan">Sedan</option>
                                <option value="estate">Estate</option>
                                <option value="minivan">Minivan</option>
                                <option value="minivan_long">Minivan Long</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Account Section -->
                <div class="driver-form-section" style="margin-bottom: 25px; background: #f8f9fa; padding: 20px; border-radius: 8px;">
                    <h3 style="margin: 0 0 20px 0; color: #2c3e50; font-size: 18px; font-weight: 600;">üîê Account Gegevens</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="form-label-gray">Gebruikersnaam *</label>
                            <input type="text" id="driverUsername" required class="input-large">
                        </div>
                        <div>
                            <label class="form-label-gray">Wachtwoord *</label>
                            <input type="password" id="driverPassword" required class="input-large">
                        </div>
                    </div>
                </div>
            </form>

            <div class="modal-actions" style="padding: 20px; border-top: 1px solid #dee2e6; text-align: center; background: #f8f9fa;">
                <button type="button" onclick="closeDriverModal()" style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; margin-right: 10px; font-size: 14px;">
                    ‚ùå Annuleren
                </button>
                <button type="button" onclick="saveNewDriver()" style="background: #28a745; color: white; border: none; padding: 12px 24px; border-radius: 6px; cursor: pointer; font-size: 14px;">
                    ‚úÖ Chauffeur Toevoegen
                </button>
            </div>
        </div>
    </div>

    <script>
        console.log('üöÄ Admin panel JavaScript loaded');
        
        // Define critical functions immediately to prevent "not defined" errors
        window.toggleMenu = function(menuName) {
            
            const menu = document.getElementById(menuName + '-menu');
            if (!menu) {
                console.error('‚ùå Menu not found:', menuName + '-menu');
                return;
            }
            
            
            // Close other menus
            const allMenus = document.querySelectorAll('.nav-submenu');
            allMenus.forEach(m => {
                if (m.id !== menuName + '-menu') {
                    m.classList.remove('show');
                }
            });
            
            // Toggle current menu
            const isVisible = menu.classList.contains('show');
            if (isVisible) {
                menu.classList.remove('show');
                console.log('‚ùå Menu hidden:', menuName);
            } else {
                menu.classList.add('show');
                console.log('‚úÖ Menu shown:', menuName);
            }
        };
        
        window.showSection = function(sectionName) {
            
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target section
            const targetSection = document.getElementById(sectionName + '-section');
            if (targetSection) {
                targetSection.classList.add('active');
                const pageTitle = document.getElementById('pageTitle');
                if (pageTitle) {
                    // Betere titels voor verschillende secties
                    const titleMap = {
                        'unconfirmed': 'üìã Unconfirmed Bookings',
                        'next-24h': 'üìã Next 24 Hours',
                        'latest': 'üìã Latest Bookings',
                        'completed': '‚úÖ Completed Bookings',
                        'cancelled': '‚ùå Cancelled Bookings',
                        'all-bookings': 'üìã All Bookings',
                        'trash': 'üóëÔ∏è Trash',
                        'distance-time': 'üí∞ Distance & Time Pricing',
                        'dispatch': 'üö® Dispatch Center',
                        'drivers': 'üöó TEST - Driver Management',
                        'vehicle-manager': 'üöó Vehicle Manager',
                        'general': '‚öôÔ∏è General Settings',
                        'mail': 'üìß Email Settings',
                        'item-surcharge': 'üí∞ Item Surcharge',
                        'location-surcharge': 'üìç Location Surcharge',
                        'payment-methods': 'üí≥ Payment Methods'
                    };
                    
                    pageTitle.textContent = titleMap[sectionName] || sectionName.charAt(0).toUpperCase() + sectionName.slice(1);
                    
                    // Set subtitle
                    const pageSubtitle = document.getElementById('pageSubtitle');
                    const subtitleMap = {
                        'next-24h': 'Confirmed bookings for the next 24 hours',
                        'unconfirmed': 'New bookings awaiting confirmation',
                        'latest': 'Most recent booking requests',
                        'completed': 'Successfully completed trips and services',
                        'cancelled': 'Cancelled and deleted bookings',
                        'all-bookings': 'Complete history of all bookings from customer and dispatch systems',
                        'trash': 'Deleted bookings (can be restored or permanently deleted)',
                        'distance-time': 'Configure pricing for each vehicle type - prices will be used in the booking system',
                        'dispatch': 'Manual taxi booking and dispatch system'
                    };
                    
                    if (pageSubtitle) {
                        pageSubtitle.textContent = subtitleMap[sectionName] || '';
                    }
                }
                
                // Special section loading
                if (sectionName === 'distance-time') {
                    setTimeout(() => loadVehiclePricing(), 200);
                }
                if (sectionName === 'unconfirmed') {
                    setTimeout(() => loadUnconfirmedBookingsV2(), 200);
                }
                if (sectionName === 'next-24h') {
                    setTimeout(() => loadNext24hBookings(), 200);
                }
                if (sectionName === 'cancelled') {
                    setTimeout(() => loadCancelledBookings(), 200);
                }
            } else {
                console.error('‚ùå Section not found:', sectionName + '-section');
            }
        };

        // Removed duplicate functions - using window properties above

        function updateTestResults(message) {
            const timestamp = new Date().toLocaleTimeString();
            console.log(`[${timestamp}] ${message}`);
            
            // Try to find test results div, if not found, just log to console
            const results = document.getElementById('testResults');
            if (results) {
                results.innerHTML = `[${timestamp}] ${message}<br>${results.innerHTML}`;
            }
        }

        // Status Dropdown Functions
        
        function changeBookingStatus(bookingId, newStatus) {
            console.log('Changing booking status:', bookingId, 'to', newStatus);
            
            // Find the booking in all possible lists
            let booking = null;
            let sourceList = '';
            
            // Check unconfirmed bookings
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            let bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                booking = unconfirmedBookings[bookingIndex];
                sourceList = 'unconfirmed';
            }
            
            // Check confirmed bookings
            if (!booking) {
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                bookingIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
                if (bookingIndex !== -1) {
                    booking = confirmedBookings[bookingIndex];
                    sourceList = 'confirmed';
                }
            }
            
            if (!booking) {
                console.error('Booking not found:', bookingId);
                return;
            }
            
            // Update booking status
            booking.status = newStatus;
            booking.statusUpdatedAt = new Date().toISOString();
            
            // Move booking to appropriate list based on new status
            if (newStatus === 'confirmed' && sourceList === 'unconfirmed') {
                // Move from unconfirmed to confirmed
                unconfirmedBookings.splice(bookingIndex, 1);
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                confirmedBookings.unshift(booking);
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            } else if (newStatus === 'unconfirmed' && sourceList === 'confirmed') {
                // Move from confirmed to unconfirmed
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                confirmedBookings.splice(bookingIndex, 1);
                unconfirmedBookings.unshift(booking);
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            } else if (['cancelled', 'driver_cancelled', 'no_show'].includes(newStatus)) {
                // Move to cancelled
                if (sourceList === 'unconfirmed') {
                    unconfirmedBookings.splice(bookingIndex, 1);
                    localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                } else if (sourceList === 'confirmed') {
                    let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                    confirmedBookings.splice(bookingIndex, 1);
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                }
                let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
                cancelledBookings.unshift(booking);
                localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
            } else if (newStatus === 'completed') {
                // Move to completed
                if (sourceList === 'unconfirmed') {
                    unconfirmedBookings.splice(bookingIndex, 1);
                    localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                } else if (sourceList === 'confirmed') {
                    let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                    confirmedBookings.splice(bookingIndex, 1);
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                }
                let completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
                completedBookings.unshift(booking);
                localStorage.setItem('completedBookings', JSON.stringify(completedBookings));
            } else {
                // Update in place
                if (sourceList === 'unconfirmed') {
                    unconfirmedBookings[bookingIndex] = booking;
                    localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                } else if (sourceList === 'confirmed') {
                    let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                    confirmedBookings[bookingIndex] = booking;
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                }
            }
            
            // Close dropdown
            const dropdown = document.getElementById(`statusDropdown_${bookingId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            // Reload the current section
            const currentSection = document.querySelector('.content-section.active');
            if (currentSection) {
                const sectionId = currentSection.id;
                if (sectionId === 'unconfirmed-section') {
                    loadUnconfirmedBookingsV2();
                } else if (sectionId === 'next-24h-section') {
                    loadNext24hBookings();
                }
            }
            
            console.log('‚úÖ Status updated to:', newStatus);
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.status-dropdown') && !e.target.closest('.driver-dropdown')) {
                document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
                document.querySelectorAll('.driver-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Driver Assignment Functions
        function toggleDriverDropdown(bookingId) {
            console.log('Toggling driver dropdown for booking:', bookingId);
            
            const badge = document.getElementById(`driverBadge_${bookingId}`);
            const dropdown = document.getElementById(`driverDropdown_${bookingId}`);
            
            if (!badge || !dropdown) {
                console.error('Driver dropdown elements not found:', bookingId);
                return;
            }
            
            // Close all other dropdowns first
            document.querySelectorAll('.driver-dropdown-menu').forEach(menu => {
                if (menu.id !== `driverDropdown_${bookingId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Close status dropdowns too
            document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                menu.classList.remove('show');
            });
            
            // Calculate position for fixed positioning
            const rect = badge.getBoundingClientRect();
            const isOpen = dropdown.classList.contains('show');
            
            if (!isOpen) {
                // Position dropdown below the badge
                dropdown.style.top = (rect.bottom + window.scrollY + 2) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.classList.add('show');
                console.log('‚úÖ Driver dropdown opened at position:', dropdown.style.left, dropdown.style.top);
            } else {
                dropdown.classList.remove('show');
                console.log('‚úÖ Driver dropdown closed');
            }
        }

        function assignDriverToBooking(bookingId, driverId, driverName) {
            console.log('Assigning driver:', driverId, driverName, 'to booking:', bookingId);
            
            // Find the booking in all possible lists
            let booking = null;
            let sourceList = '';
            
            // Check unconfirmed bookings
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            let bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                booking = unconfirmedBookings[bookingIndex];
                sourceList = 'unconfirmed';
            }
            
            // Check confirmed bookings
            if (!booking) {
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                bookingIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
                if (bookingIndex !== -1) {
                    booking = confirmedBookings[bookingIndex];
                    sourceList = 'confirmed';
                }
            }
            
            if (!booking) {
                console.error('Booking not found:', bookingId);
                return;
            }
            
            // Update booking with driver assignment
            booking.assignedDriver = {
                id: driverId,
                name: driverName,
                assignedAt: new Date().toISOString()
            };
            
            // Save back to appropriate list
            if (sourceList === 'unconfirmed') {
                unconfirmedBookings[bookingIndex] = booking;
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            } else if (sourceList === 'confirmed') {
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                confirmedBookings[bookingIndex] = booking;
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            }
            
            // Update the UI
            const driverBadge = document.getElementById(`driverBadge_${bookingId}`);
            if (driverBadge) {
                driverBadge.textContent = driverName;
                driverBadge.className = 'driver-badge assigned';
            }
            
            // Close the dropdown
            const dropdown = document.getElementById(`driverDropdown_${bookingId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            console.log('‚úÖ Driver assigned successfully');
        }

        function unassignDriver(bookingId) {
            console.log('Unassigning driver from booking:', bookingId);
            
            // Find the booking in all possible lists
            let booking = null;
            let sourceList = '';
            
            // Check unconfirmed bookings
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            let bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                booking = unconfirmedBookings[bookingIndex];
                sourceList = 'unconfirmed';
            }
            
            // Check confirmed bookings
            if (!booking) {
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                bookingIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
                if (bookingIndex !== -1) {
                    booking = confirmedBookings[bookingIndex];
                    sourceList = 'confirmed';
                }
            }
            
            if (!booking) {
                console.error('Booking not found:', bookingId);
                return;
            }
            
            // Remove driver assignment
            delete booking.assignedDriver;
            
            // Save back to appropriate list
            if (sourceList === 'unconfirmed') {
                unconfirmedBookings[bookingIndex] = booking;
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            } else if (sourceList === 'confirmed') {
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                confirmedBookings[bookingIndex] = booking;
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            }
            
            // Update the UI
            const driverBadge = document.getElementById(`driverBadge_${bookingId}`);
            if (driverBadge) {
                driverBadge.textContent = 'Assign Driver';
                driverBadge.className = 'driver-badge unassigned';
            }
            
            // Close the dropdown
            const dropdown = document.getElementById(`driverDropdown_${bookingId}`);
            if (dropdown) {
                dropdown.classList.remove('show');
            }
            
            console.log('‚úÖ Driver unassigned successfully');
        }

        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = '/';
            }
        }

        // Vehicle Pricing System Functions
        function loadVehiclePricing() {
            console.log('üîÑ Loading vehicle pricing from Types of Vehicles...');
            updateTestResults('üîÑ Loading vehicles from Types of Vehicles...');
            
            // Load distance threshold setting - do this FIRST
            const savedThreshold = localStorage.getItem('distanceThreshold') || '100';
            const thresholdInput = document.getElementById('distanceThreshold');
            if (thresholdInput) {
                thresholdInput.value = savedThreshold;
                console.log('‚úÖ Loaded distance threshold:', savedThreshold + ' km');
                // Also trigger update to refresh all labels
                setTimeout(() => {
                    updateDistanceExamples();
                }, 100);
            }
            
            // Load vehicles from Types of Vehicles admin panel
            const savedVehicles = localStorage.getItem('taxiVehicles');
            let vehicles = [];
            
            if (savedVehicles) {
                try {
                    vehicles = JSON.parse(savedVehicles);
                    console.log('‚úÖ Loaded', vehicles.length, 'vehicles from Types of Vehicles');
                    updateTestResults(`‚úÖ Found ${vehicles.length} vehicles in Types of Vehicles`);
                } catch (e) {
                    console.error('‚ùå Error parsing saved vehicles:', e);
                    updateTestResults('‚ùå Error loading vehicles from Types of Vehicles');
                }
            }
            
            // If no vehicles found, create default vehicles first
            if (vehicles.length === 0) {
                console.log('‚ö†Ô∏è No vehicles found, creating default vehicles...');
                updateTestResults('‚ö†Ô∏è No vehicles found, creating default vehicles...');
                createDefaultVehicles();
                vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            }
            if (vehicles.length === 0) {
                updateTestResults('‚ö†Ô∏è No vehicles found - need to add vehicles first');
                const container = document.getElementById('vehiclePricingContainer');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 60px 40px; border: 2px dashed #dee2e6; border-radius: 12px; background: #f8f9fa;">
                            <div style="font-size: 48px; margin-bottom: 20px;">üöó</div>
                            <h3 style="color: #495057; margin-bottom: 15px;">Geen voertuigen gevonden</h3>
                            <p style="color: #6c757d; margin-bottom: 25px; font-size: 16px;">
                                Je moet eerst voertuigen toevoegen in <strong>Types of Vehicles</strong><br>
                                voordat je prijzen kunt instellen.
                            </p>
                            <button class="btn btn-primary" onclick="showSection('types-of-vehicles')" style="margin-right: 10px;">
                                üöó Ga naar Types of Vehicles
                            </button>
                            <button class="btn" style="background: #6c757d; color: white;" onclick="window.open('admin-vehicles.html', '_blank')">
                                üîß Open Vehicle Manager
                            </button>
                        </div>
                    `;
                }
                return;
            }
            
            // Load saved pricing data
            const savedPricing = localStorage.getItem('vehiclePricing');
            const pricingData = savedPricing ? JSON.parse(savedPricing) : {};
            
            const container = document.getElementById('vehiclePricingContainer');
            if (!container) {
                console.error('‚ùå Container not found!');
                return;
            }
            
            // Create dynamic pricing cards based on actual vehicles from Types of Vehicles
            let htmlContent = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">';
            
            vehicles.forEach(vehicle => {
                // Get existing pricing or set defaults
                const pricing = pricingData[vehicle.id] || { minimum: 15.00, pricePerKm: 1.50, longDistancePerKm: 1.20 };
                
                // Determine vehicle image source - NEVER overwrite custom uploads
                let vehicleImage = 'üöó'; // fallback emoji
                if (vehicle.image) {
                    if (vehicle.image.startsWith('data:')) {
                        // Base64 image uploaded from laptop - PROTECTED!
                        vehicleImage = `<img src="${vehicle.image}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" alt="${vehicle.name}">`;
                        updateTestResults(`üì∑ PROTECTED: Using custom uploaded image for ${vehicle.name}`);
                    } else if (vehicle.image.startsWith('http') && !vehicle.image.includes('unsplash')) {
                        // Custom external URL image - not default
                        vehicleImage = `<img src="${vehicle.image}" style="width: 100%; height: 100%; object-fit: contain; border-radius: 8px;" alt="${vehicle.name}">`;
                        updateTestResults(`üåê Using custom external image for ${vehicle.name}`);
                    } else if (vehicle.image.includes('unsplash')) {
                        // Skip default unsplash images - use emoji instead
                        vehicleImage = 'üöó';
                        updateTestResults(`‚ö†Ô∏è Skipping default image for ${vehicle.name} - using emoji`);
                    }
                } else {
                    updateTestResults(`üì∑ No image set for ${vehicle.name} - using emoji`);
                }
                
                htmlContent += `
                    <div style="background: white; border: 1px solid #e9ecef; border-radius: 12px; padding: 25px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);">
                        <div style="display: flex; align-items: center; margin-bottom: 20px;">
                            <div style="width: 100px; height: 70px; background: #f8f9fa; border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px; overflow: hidden; border: 1px solid #dee2e6;">
                                ${vehicleImage}
                            </div>
                            <div>
                                <h4 style="margin: 0; font-size: 16px; font-weight: 600; color: #2c3e50;">${vehicle.name}</h4>
                                <p style="margin: 0; font-size: 12px; color: #6c757d;">${vehicle.description || 'Professional taxi service'}</p>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 500; color: #6c757d; margin-bottom: 8px;">Minimum prijs</label>
                                <div style="display: flex; align-items: center; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                                    <button type="button" onclick="adjustDynamicPrice('${vehicle.id}', 'minimum', -0.50)" 
                                            style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">-</button>
                                    <input type="number" id="minimum_${vehicle.id}" value="${(pricing.minimum || pricing.minimumPrice || 15).toFixed(2)}" 
                                           step="0.50" min="0" 
                                           style="border: none; text-align: center; padding: 8px; width: 100%; outline: none; font-weight: 500;"
                                           onchange="updateDynamicPricing('${vehicle.id}', 'minimum', this.value)">
                                    <button type="button" onclick="adjustDynamicPrice('${vehicle.id}', 'minimum', 0.50)" 
                                            style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">+</button>
                                </div>
                            </div>
                            
                            <div>
                                <label style="display: block; font-size: 13px; font-weight: 500; color: #6c757d; margin-bottom: 8px;">Prijs per km</label>
                                <div style="display: flex; align-items: center; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                                    <button type="button" onclick="adjustDynamicPrice('${vehicle.id}', 'perKm', -0.10)" 
                                            style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">-</button>
                                    <input type="number" id="perKm_${vehicle.id}" value="${pricing.pricePerKm.toFixed(2)}" 
                                           step="0.10" min="0" 
                                           style="border: none; text-align: center; padding: 8px; width: 100%; outline: none; font-weight: 500;"
                                           onchange="updateDynamicPricing('${vehicle.id}', 'perKm', this.value)">
                                    <button type="button" onclick="adjustDynamicPrice('${vehicle.id}', 'perKm', 0.10)" 
                                            style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">+</button>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #f1f3f4; display: flex; justify-content: space-between; align-items: center;">
                            <span style="font-size: 12px; color: #6c757d;">
                                Capaciteit: ${vehicle.capacity?.passengers || 4} personen
                            </span>
                            <span style="font-size: 12px; color: ${vehicle.active ? '#28a745' : '#dc3545'}; font-weight: 500;">
                                ${vehicle.active ? '‚úÖ Actief' : '‚ùå Inactief'}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            htmlContent += '</div>';
            container.innerHTML = htmlContent;
            
            console.log(`‚úÖ Created pricing cards for ${vehicles.length} vehicles from Types of Vehicles`);
            updateTestResults(`‚úÖ Pricing loaded for ${vehicles.length} vehicles from Types of Vehicles`);
            
            // Also generate distance pricing cards
            generateVehicleDistancePricing({});
        }
        
        function adjustDynamicPrice(vehicleId, type, amount) {
            let inputId;
            if (type === 'minimum') {
                inputId = `minimum_${vehicleId}`;
            } else if (type === 'perKm') {
                inputId = `perKm_${vehicleId}`;
            } else if (type === 'longDistancePerKm') {
                inputId = `long_${vehicleId}`;
            }
            
            const input = document.getElementById(inputId);
            if (input) {
                const currentValue = parseFloat(input.value) || 0;
                const newValue = Math.max(0, currentValue + amount);
                input.value = newValue.toFixed(2);
                updateDynamicPricing(vehicleId, type, newValue);
                
                // Get vehicle name for display
                const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
                const vehicle = vehicles.find(v => v.id === vehicleId);
                const vehicleName = vehicle ? vehicle.name : vehicleId;
                
                updateTestResults(`üí∞ ${vehicleName} ${type} price: ‚Ç¨${newValue.toFixed(2)}`);
            }
        }
        
        function updateDynamicPricing(vehicleId, type, value) {
            // Load current pricing data
            const savedPricing = localStorage.getItem('vehiclePricing');
            let pricingData = savedPricing ? JSON.parse(savedPricing) : {};
            
            // Initialize vehicle pricing if not exists
            if (!pricingData[vehicleId]) {
                pricingData[vehicleId] = { minimumPrice: 15.00, pricePerKm: 1.50, longDistancePerKm: 1.20 };
            }
            
            // Update the specific price
            if (type === 'minimum') {
                pricingData[vehicleId].minimumPrice = parseFloat(value) || 0;
            } else if (type === 'perKm') {
                pricingData[vehicleId].pricePerKm = parseFloat(value) || 0;
            } else if (type === 'longDistancePerKm') {
                pricingData[vehicleId].longDistancePerKm = parseFloat(value) || 0;
            }
            
            // Save back to localStorage
            localStorage.setItem('vehiclePricing', JSON.stringify(pricingData));
            
            // Trigger sync to booking system
            syncDynamicPricingToBookingSystem();
            
            console.log(`Updated ${type} pricing for vehicle ${vehicleId}: ‚Ç¨${value}`);
        }
        
        function syncDynamicPricingToBookingSystem() {
            const pricingData = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            
            // Create booking system compatible data using real vehicle data
            const bookingSystemPricing = {};
            
            vehicles.forEach(vehicle => {
                if (vehicle.active) {
                    const pricing = pricingData[vehicle.id] || { minimumPrice: 15.00, pricePerKm: 1.50 };
                    bookingSystemPricing[vehicle.id] = {
                        vehicleId: vehicle.id,
                        vehicleName: vehicle.name,
                        minimumPrice: pricing.minimumPrice,
                        pricePerKm: pricing.pricePerKm,
                        capacity: vehicle.capacity,
                        image: vehicle.image,
                        description: vehicle.description,
                        active: vehicle.active,
                        lastUpdated: new Date().toISOString()
                    };
                }
            });
            
            // Save for booking system
            localStorage.setItem('bookingSystemPricing', JSON.stringify(bookingSystemPricing));
            localStorage.setItem('pricingLastUpdate', Date.now().toString());
            
            // Also create vehicle data for booking system - PROTECT custom images
            const bookingSystemVehicles = vehicles
                .filter(v => v.active && (v.display === 'Frontend & Backend' || v.display === 'Frontend only'))
                .map(v => {
                    const pricing = pricingData[v.id] || { minimumPrice: 25.00, pricePerKm: 2.50 };
                    
                    // Protect custom uploaded images - never overwrite them
                    let protectedImage = v.image;
                    if (v.image && v.image.includes('unsplash')) {
                        // Remove default unsplash images - let booking system handle fallback
                        protectedImage = null;
                    }
                    
                    return {
                        id: v.id,
                        name: v.name,
                        price: pricing.minimumPrice, // Use minimum price as base price
                        passengers: `1-${v.capacity?.passengers || 4} passengers`,
                        luggage: `1-${v.capacity?.luggage || 2} large bags`,
                        handLuggage: `1-${v.capacity?.handLuggage || 2} small bags`,
                        image: protectedImage, // Protected from overwrites
                        capacity: {
                            passengers: v.capacity?.passengers || 4,
                            luggage: v.capacity?.luggage || 2,
                            handLuggage: v.capacity?.handLuggage || 2,
                            wheelchairs: v.capacity?.wheelchairs || 0,
                            childSeats: v.capacity?.childSeats || 0
                        },
                        description: v.description || '',
                        active: v.active,
                        lastUpdated: new Date().toISOString()
                    };
                });
            
            localStorage.setItem('bookingSystemVehicles', JSON.stringify(bookingSystemVehicles));
            
            console.log('üí∞ Dynamic pricing synced to booking system:', bookingSystemPricing);
            console.log('üöó Vehicle data synced to booking system:', bookingSystemVehicles.length, 'vehicles');
            updateTestResults(`üîÑ Synced ${Object.keys(bookingSystemPricing).length} vehicles with pricing + ${bookingSystemVehicles.length} vehicles to booking system`);
            
            // Update timestamp to trigger booking system refresh
            localStorage.setItem('pricingLastUpdate', Date.now().toString());
            
            // Trigger immediate refresh in booking system if it's open
            try {
                window.postMessage({ 
                    type: 'PRICING_UPDATED', 
                    vehicles: bookingSystemVehicles,
                    pricing: bookingSystemPricing,
                    timestamp: Date.now()
                }, '*');
                console.log('üì° Sent pricing update message to booking system');
            } catch (e) {
                console.log('‚ö†Ô∏è Could not send refresh message:', e.message);
            }
        }
        
        function saveAllPricing() {
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            let savedCount = 0;
            
            // Save distance threshold setting
            const distanceThresholdInput = document.getElementById('distanceThreshold');
            if (distanceThresholdInput) {
                const threshold = parseInt(distanceThresholdInput.value) || 100;
                localStorage.setItem('distanceThreshold', threshold);
                console.log('‚úÖ Distance threshold saved:', threshold + ' km');
            }
            
            vehicles.forEach(vehicle => {
                const minimumInput = document.getElementById(`minimum_${vehicle.id}`);
                const perKmInput = document.getElementById(`perKm_${vehicle.id}`);
                const longDistanceInput = document.getElementById(`long_${vehicle.id}`);
                
                if (minimumInput && perKmInput) {
                    updateDynamicPricing(vehicle.id, 'minimum', minimumInput.value);
                    updateDynamicPricing(vehicle.id, 'perKm', perKmInput.value);
                    
                    // Save long distance price if it exists
                    if (longDistanceInput) {
                        updateDynamicPricing(vehicle.id, 'longDistancePerKm', longDistanceInput.value);
                    }
                    
                    savedCount++;
                }
            });
            
            // Save last-minute settings (new system)
            console.log('üíæ Saving last-minute settings from Save All Changes...');
            try {
                // Get values directly to ensure they're saved
                const typeElement = document.getElementById('defaultLastMinuteType');
                const amountElement = document.getElementById('defaultLastMinuteAmount');
                const hoursElement = document.getElementById('defaultLastMinuteHours');
                
                if (typeElement && amountElement && hoursElement) {
                    const lastMinuteSettings = {
                        type: typeElement.value,
                        amount: parseFloat(amountElement.value) || 25,
                        hours: parseFloat(hoursElement.value !== '' ? hoursElement.value : 3)
                    };
                    
                    localStorage.setItem('defaultLastMinuteSettings', JSON.stringify(lastMinuteSettings));
                    console.log('‚úÖ Last-minute settings saved directly:', lastMinuteSettings);
                    
                    // Also update display
                    updateDefaultLastMinuteSettings();
                } else {
                    console.log('‚ö†Ô∏è Last-minute form elements not found - skipping');
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Could not save last-minute settings:', error);
            }
            
            alert(`‚úÖ Alle prijzen en instellingen opgeslagen!\n\n${savedCount} voertuigen bijgewerkt\nLast-minute instellingen opgeslagen\nPrijzen zijn gesynchroniseerd met het boekingssysteem.`);
            updateTestResults(`‚úÖ Saved pricing for ${savedCount} vehicles from Types of Vehicles`);
        }
        
        // Last-Minute Booking Management Functions
        function loadLastMinuteSurcharge() {
            console.log('‚ö° Loading last-minute booking settings...');
            
            const settings = JSON.parse(localStorage.getItem('lastMinuteSurchargeSettings') || '{}');
            
            // Set default values
            const defaults = {
                enabled: false,
                mode: 'block',
                type: 'percentage',
                amount: 25,
                hours: 6
            };
            
            const finalSettings = { ...defaults, ...settings };
            
            // Update UI
            document.getElementById('lastMinuteSurchargeEnabled').checked = finalSettings.enabled;
            document.getElementById('lastMinuteMode').value = finalSettings.mode;
            document.getElementById('lastMinuteSurchargeType').value = finalSettings.type;
            document.getElementById('lastMinuteSurchargeAmount').value = finalSettings.amount;
            document.getElementById('lastMinuteSurchargeHours').value = finalSettings.hours;
            
            // Update display
            updateLastMinuteSurchargeDisplay();
            
        }
        
        function saveLastMinuteSurcharge() {
            const settings = {
                enabled: document.getElementById('lastMinuteSurchargeEnabled').checked,
                mode: document.getElementById('lastMinuteMode').value,
                type: document.getElementById('lastMinuteSurchargeType').value,
                amount: parseFloat(document.getElementById('lastMinuteSurchargeAmount').value) || 0,
                hours: parseFloat(document.getElementById('lastMinuteSurchargeHours').value) || 6
            };
            
            localStorage.setItem('lastMinuteSurchargeSettings', JSON.stringify(settings));
            
            console.log('‚úÖ Last-minute booking settings saved:', settings);
        }
        
        function toggleLastMinuteSurcharge() {
            updateLastMinuteSurchargeDisplay();
            saveLastMinuteSurcharge();
        }
        
        function updateLastMinuteSurcharge() {
            updateLastMinuteSurchargeDisplay();
            saveLastMinuteSurcharge();
        }
        
        function updateLastMinuteSurchargeDisplay() {
            const enabled = document.getElementById('lastMinuteSurchargeEnabled').checked;
            const mode = document.getElementById('lastMinuteMode').value;
            const type = document.getElementById('lastMinuteSurchargeType').value;
            const amount = parseFloat(document.getElementById('lastMinuteSurchargeAmount').value) || 0;
            const hours = parseFloat(document.getElementById('lastMinuteSurchargeHours').value) || 6;
            const symbol = document.getElementById('lastMinuteSurchargeSymbol');
            const example = document.getElementById('lastMinuteSurchargeExample');
            const surchargeOptions = document.getElementById('surchargeOptions');
            
            // Show/hide surcharge options based on mode
            if (mode === 'surcharge') {
                surchargeOptions.style.display = 'block';
                
                // Update symbol
                symbol.textContent = type === 'percentage' ? '%' : '‚Ç¨';
                
                // Update example for surcharge mode
                const basePrice = 100;
                let finalPrice, surcharge;
                
                if (type === 'percentage') {
                    surcharge = (basePrice * amount) / 100;
                    finalPrice = basePrice + surcharge;
                    example.textContent = `Bij een boeking van ‚Ç¨${basePrice} wordt ${amount}% extra gerekend: ‚Ç¨${surcharge.toFixed(2)} (totaal ‚Ç¨${finalPrice.toFixed(2)})`;
                } else {
                    surcharge = amount;
                    finalPrice = basePrice + surcharge;
                    example.textContent = `Bij een boeking van ‚Ç¨${basePrice} wordt ‚Ç¨${amount} extra gerekend (totaal ‚Ç¨${finalPrice.toFixed(2)})`;
                }
            } else {
                surchargeOptions.style.display = 'none';
                
                // Update example for block mode
                example.textContent = `Klanten kunnen NIET boeken binnen ${hours} uur voor vertrek. Na ${hours} uur zijn normale tarieven van toepassing.`;
            }
        }
        
        // Function to check if booking is within last-minute time window
        function isLastMinuteBooking(travelDate, travelHour, travelMinute) {
            const settings = JSON.parse(localStorage.getItem('lastMinuteSurchargeSettings') || '{}');
            
            if (!settings.enabled) {
                return { isLastMinute: false, mode: null };
            }
            
            const now = new Date();
            const bookingTime = new Date();
            
            // Parse travel date (DD/MM/YYYY format)
            const dateParts = travelDate.split('/');
            if (dateParts.length !== 3) {
                return { isLastMinute: false, mode: null };
            }
            
            bookingTime.setDate(parseInt(dateParts[0]));
            bookingTime.setMonth(parseInt(dateParts[1]) - 1); // Month is 0-indexed
            bookingTime.setFullYear(parseInt(dateParts[2]));
            bookingTime.setHours(parseInt(travelHour));
            bookingTime.setMinutes(parseInt(travelMinute));
            bookingTime.setSeconds(0);
            
            const hoursUntilTravel = (bookingTime - now) / (1000 * 60 * 60);
            const isLastMinute = hoursUntilTravel <= settings.hours;
            
            console.log('‚ö° Last-minute booking check:', {
                now: now.toISOString(),
                travelTime: bookingTime.toISOString(),
                hoursUntilTravel: hoursUntilTravel.toFixed(2),
                surchargeHours: settings.hours,
                isLastMinute: isLastMinute,
                mode: settings.mode
            });
            
            return { 
                isLastMinute: isLastMinute, 
                mode: settings.mode,
                hoursUntilTravel: hoursUntilTravel,
                settings: settings 
            };
        }
        
        // Function to calculate last-minute surcharge
        function calculateLastMinuteSurcharge(basePrice) {
            const settings = JSON.parse(localStorage.getItem('lastMinuteSurchargeSettings') || '{}');
            
            if (!settings.enabled || settings.mode !== 'surcharge') {
                return 0;
            }
            
            let surcharge = 0;
            
            if (settings.type === 'percentage') {
                surcharge = (basePrice * settings.amount) / 100;
            } else {
                surcharge = settings.amount;
            }
            
            console.log('‚ö° Last-minute surcharge calculation:', {
                basePrice: basePrice,
                type: settings.type,
                amount: settings.amount,
                surcharge: surcharge
            });
            
            return surcharge;
        }
        
        // Function to check if booking should be blocked
        function shouldBlockBooking(travelDate, travelHour, travelMinute) {
            const lastMinuteCheck = isLastMinuteBooking(travelDate, travelHour, travelMinute);
            return lastMinuteCheck.isLastMinute && lastMinuteCheck.mode === 'block';
        }
        
        function createDefaultVehicles() {
            console.log('üöó Creating default vehicles and pricing...');
            
            const defaultVehicles = [
                {
                    id: 'saloon',
                    name: 'Saloon',
                    description: 'Comfortable sedan for city rides',
                    active: true,
                    image: '',
                    passengers: 4,
                    luggage: 2,
                    handBags: 4
                },
                {
                    id: 'estate',
                    name: 'Estate',
                    description: 'Spacious estate car for extra luggage',
                    active: true,
                    image: '',
                    passengers: 4,
                    luggage: 4,
                    handBags: 4
                },
                {
                    id: 'minivan',
                    name: 'Minivan',
                    description: 'Large vehicle for groups',
                    active: true,
                    image: '',
                    passengers: 6,
                    luggage: 4,
                    handBags: 6
                },
                {
                    id: 'minivan_long',
                    name: 'Minivan Long',
                    description: 'Extra large vehicle for big groups',
                    active: true,
                    image: '',
                    passengers: 8,
                    luggage: 6,
                    handBags: 8
                }
            ];
            
            // Save vehicles to localStorage
            localStorage.setItem('taxiVehicles', JSON.stringify(defaultVehicles));
            
            // Create default pricing (whole euros)
            const defaultPricing = {
                saloon: { minimumPrice: 45, pricePerKm: 1.50 },
                estate: { minimumPrice: 55, pricePerKm: 1.80 },
                minivan: { minimumPrice: 65, pricePerKm: 2.00 },
                minivan_long: { minimumPrice: 85, pricePerKm: 2.50 }
            };
            
            // Save pricing to localStorage
            localStorage.setItem('vehiclePricing', JSON.stringify(defaultPricing));
            
            console.log('‚úÖ Default vehicles and pricing created');
            updateTestResults('‚úÖ Created 4 default vehicles with pricing');
        }

        function resetToDefaults() {
            if (confirm('Weet je zeker dat je alle prijzen wilt resetten naar de standaardwaarden?')) {
                const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
                
                vehicles.forEach(vehicle => {
                    const minimumInput = document.getElementById(`minimum_${vehicle.id}`);
                    const perKmInput = document.getElementById(`perKm_${vehicle.id}`);
                    
                    if (minimumInput && perKmInput) {
                        minimumInput.value = '15.00';
                        perKmInput.value = '1.50';
                        updateDynamicPricing(vehicle.id, 'minimum', 15.00);
                        updateDynamicPricing(vehicle.id, 'perKm', 1.50);
                    }
                });
                
                alert('‚úÖ Prijzen gereset naar standaardwaarden (‚Ç¨15 min, ‚Ç¨1.50/km)');
                updateTestResults('üîÑ All vehicles reset to default pricing');
            }
        }
        
        function syncPricingToBookingSystem() {
            const pricingData = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            
            // Create booking system compatible data
            const bookingSystemPricing = {};
            
            vehicles.forEach(vehicle => {
                if (vehicle.active) {
                    const pricing = pricingData[vehicle.id] || { minimumPrice: 15.00, pricePerKm: 1.50 };
                    bookingSystemPricing[vehicle.id] = {
                        vehicleId: vehicle.id,
                        vehicleName: vehicle.name,
                        minimumPrice: pricing.minimumPrice,
                        pricePerKm: pricing.pricePerKm,
                        capacity: vehicle.capacity,
                        image: vehicle.image,
                        description: vehicle.description,
                        active: vehicle.active,
                        lastUpdated: new Date().toISOString()
                    };
                }
            });
            
            // Save for booking system
            localStorage.setItem('bookingSystemPricing', JSON.stringify(bookingSystemPricing));
            localStorage.setItem('pricingLastUpdate', Date.now().toString());
            
            console.log('Pricing synced to booking system:', bookingSystemPricing);
        }
        
        

        // Unconfirmed Bookings Functions
        function loadUnconfirmedBookingsV2() {
            console.log('üìã Loading unconfirmed bookings...');
            
            const tableBody = document.getElementById('unconfirmedTableBody');
            
            if (!tableBody) {
                console.error('‚ùå Unconfirmed table body not found');
                return;
            }
            
            // Get unconfirmed bookings from localStorage
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            // Sort bookings: HEEN EERST, dan TERUG per booking groep
            unconfirmedBookings.sort((a, b) => {
                // Parse dates for comparison
                const parseDate = (dateStr) => {
                    if (dateStr) {
                        const parts = dateStr.split('/');
                        if (parts.length === 3) {
                            return new Date(parts[2], parts[1] - 1, parts[0]); // YYYY, MM-1, DD
                        }
                    }
                    return new Date();
                };
                
                const dateA = parseDate(a.trip?.travelDate);
                const dateB = parseDate(b.trip?.travelDate);
                
                // First: Sort by date (vroegste datum eerst)
                const dateDiff = dateA - dateB;
                if (dateDiff !== 0) {
                    return dateDiff;
                }
                
                // Second: Op zelfde datum, sorteer heen voor terug
                const tripTypeA = a.trip?.tripType || 'heen';
                const tripTypeB = b.trip?.tripType || 'heen';
                
                // HEEN ritten komen ALTIJD eerst
                if (tripTypeA === 'heen' && tripTypeB === 'terug') return -1;
                if (tripTypeA === 'terug' && tripTypeB === 'heen') return 1;
                
                // Als beide hetzelfde type, sorteer op tijd
                if (tripTypeA === tripTypeB) {
                    const timeA = `${a.trip?.travelHour || '00'}:${a.trip?.travelMinute || '00'}`;
                    const timeB = `${b.trip?.travelHour || '00'}:${b.trip?.travelMinute || '00'}`;
                    return timeA.localeCompare(timeB);
                }
                
                return 0;
            });
            
            console.log('üìã Bookings sorted: heen trips first, then terug trips');
            
            if (unconfirmedBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h3>üìã No Unconfirmed Bookings</h3>
                            <p>New bookings will appear here when customers make reservations</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Generate table rows
            let tableHTML = '';
            
            unconfirmedBookings.forEach((booking, index) => {
                const createdDate = new Date(booking.createdAt || booking.bookingDate);
                const formattedDate = createdDate.toLocaleDateString('nl-BE');
                const formattedTime = createdDate.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
                const travelDateTime = `${booking.trip.travelDate} ${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                
                // üö® MARCEL FIX: Use EXACT same pricing logic as Next 24h
                let finalTotalPrice = 0;
                
                // Try different sources in priority order (same as Next 24h)
                const step2Price = localStorage.getItem('step2FinalTotalPrice');
                if (step2Price && parseFloat(step2Price) > 0) {
                    finalTotalPrice = parseFloat(step2Price);
                } else if (booking.finalPrice) {
                    finalTotalPrice = parseFloat(booking.finalPrice);
                } else if (booking.totalPrice) {
                    finalTotalPrice = parseFloat(booking.totalPrice);
                } else {
                    // Fallback to vehicle pricing
                    finalTotalPrice = parseFloat(booking.vehicle?.pricing?.totalPrice || booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00);
                }
                
                const hasIndividualTrips = booking.trip?.tripType === 'heen' || booking.trip?.tripType === 'terug';
                
                let total;
                
                // Debug: Log the entire booking to see if tripPrice exists
                console.log(`üîç DEBUG Booking ${booking.bookingId}:`, {
                    tripType: booking.trip?.tripType,
                    hasIndividualTrips: hasIndividualTrips,
                    tripPrice: booking.tripPrice,
                    hasTripPrice: booking.tripPrice !== undefined,
                    bookingKeys: Object.keys(booking)
                });
                
                if (hasIndividualTrips) {
                    // EXACT STAP 3 PRICING LOGIC - MARCEL APPROVED
                    const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                    let heenTotaal, terugTotaal;
                    
                    if (step2FinalPrice > 0) {
                        finalTotalPrice = step2FinalPrice;
                        
                        // Find Meet & Greet price for correct distribution (EXACT STAP 3 logic)
                        let meetGreetPrice = 0;
                        const surchargeData = booking.surcharges;
                        if (surchargeData && surchargeData.selectedSurcharges) {
                            for (const [key, value] of Object.entries(surchargeData.selectedSurcharges)) {
                                if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                    if (typeof value === 'object' && value.price) {
                                        meetGreetPrice = parseFloat(value.price) || 0;
                                    } else if (typeof value === 'number') {
                                        meetGreetPrice = value;
                                    }
                                    break;
                                }
                            }
                        }
                        
                        // Calculate exactly like STAP 3
                        if (meetGreetPrice > 0) {
                            const basePricePerTrip = (step2FinalPrice - meetGreetPrice) / 2;
                            heenTotaal = basePricePerTrip;
                            terugTotaal = basePricePerTrip + meetGreetPrice;
                        } else {
                            heenTotaal = step2FinalPrice / 2;
                            terugTotaal = step2FinalPrice / 2;
                        }
                    } else {
                        // Fallback if no step2 price
                        heenTotaal = finalTotalPrice / 2;
                        terugTotaal = finalTotalPrice / 2;
                    }
                    
                    if (booking.trip.tripType === 'heen') {
                        total = heenTotaal.toFixed(2);
                    } else {
                        total = terugTotaal.toFixed(2);
                    }
                } else {
                    total = finalTotalPrice.toFixed(2);
                }
                
                console.log(`üí∞ Unconfirmed price (SAME as Next 24h): ‚Ç¨${total} for booking ${booking.bookingId}`);
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="table-cell" style="text-align: center;">
                            ${(() => {
                                const country = detectCountryFromAddress(booking.trip.fromLocation);
                                const countryInfo = getCountryInfo(country);
                                const isCrossBorder = detectCountryFromAddress(booking.trip.fromLocation) !== detectCountryFromAddress(booking.trip.toLocation);
                                return `
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                        <span style="font-size: 20px;" title="${countryInfo.name}">${countryInfo.flag}</span>
                                        ${isCrossBorder ? '<div style="font-size: 9px; color: #dc3545;">Cross</div>' : ''}
                                        <button style="background: transparent; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="showBookingOverview('${booking.bookingId}', '${booking.trip.tripType || 'heen'}')" title="View Details">
                                            üëÅ
                                        </button>
                                    </div>
                                `;
                            })()}
                        </td>
                        <td class="table-cell">
                            <input type="checkbox" style="margin-right: 8px;">
                            <div class="font-medium">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text">üìû ${booking.customer.phone}</div>
                            ${booking.trip.tripType ? `<div style="font-size: 11px; color: #007bff; font-weight: 500;">${booking.trip.tripType === 'heen' ? 'üîÑ HEEN' : 'üîÑ TERUG'}</div>` : ''}
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${booking.trip.travelDate}</div>
                            <div style="color: #666; font-size: 12px;">${booking.trip.travelHour}:${booking.trip.travelMinute}</div>
                        </td>
                        <td class="table-cell">
                            <div class="status-dropdown">
                                <span class="status-badge unconfirmed" onclick="toggleStatusDropdown('${booking.bookingId}')" id="statusBadge_${booking.bookingId}" style="font-size: 11px; padding: 4px 8px;">
                                    Unconfirmed
                                </span>
                                <div class="status-dropdown-menu" id="statusDropdown_${booking.bookingId}">
                                    <div class="status-option selected" onclick="changeBookingStatus('${booking.bookingId}', 'unconfirmed')">
                                        ‚úì Unconfirmed
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'confirmed')">
                                        Confirmed
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'request_quote')">
                                        Request Quote
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'assigned')">
                                        Assigned
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'job_accepted')">
                                        Job Accepted
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'job_rejected')">
                                        Job Rejected
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'on_route')">
                                        On Route
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'arrived')">
                                        Arrived
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'on_board')">
                                        On Board
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'no_show')">
                                        No Show
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'completed')">
                                        Completed
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'cancelled')">
                                        Cancelled
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'driver_cancelled')">
                                        Driver Cancelled
                                    </div>
                                    <div class="status-option" onclick="changeBookingStatus('${booking.bookingId}', 'incomplete')">
                                        Incomplete
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="table-cell">
                            <select style="padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; width: auto; min-width: 120px; max-width: 180px;" onchange="assignDriverToBooking('${booking.bookingId}', this.value)">
                                <option value="">-- Select --</option>
                                <optgroup label="Auto">
                                    <option value="auto-all" ${booking.driver === 'auto-all' ? 'selected' : ''}>All Drivers</option>
                                    <option value="auto-nearby" ${booking.driver === 'auto-nearby' ? 'selected' : ''}>Nearby</option>
                                    <option value="auto-lastminute" ${booking.driver === 'auto-lastminute' ? 'selected' : ''}>Last-Minute</option>
                                </optgroup>
                                <optgroup label="Drivers">
                                    ${getDriverOptionsHTML(booking.driver)}
                                </optgroup>
                            </select>
                        </td>
                        <td class="table-cell">
                            <div>${booking.vehicle?.vehicle?.name || 'Saloon'}</div>
                        </td>
                        <td class="table-cell">
                            <div style="font-size: 12px;">${booking.specialInstructions || '-'}</div>
                        </td>
                        <td class="table-cell" style="text-align: left;">
                            <div style="font-weight: 500; color: #28a745;">‚Ç¨${total}</div>
                        </td>
                        <td class="table-cell" style="text-align: center;">
                            <button onclick="sendEmail('${booking.bookingId}', 'normal')" 
                                    style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 12px; cursor: pointer;"
                                    title="Send Email">
                                ‚úâÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            
        }
        
        function confirmBooking(bookingId) {
            if (!confirm(`Confirm booking ${bookingId}? The customer will be notified.`)) {
                return;
            }
            
            // Move from unconfirmed to confirmed
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            
            const bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                const booking = unconfirmedBookings[bookingIndex];
                booking.status = 'confirmed';
                booking.confirmedAt = new Date().toISOString();
                
                // Move to confirmed
                confirmedBookings.unshift(booking);
                unconfirmedBookings.splice(bookingIndex, 1);
                
                // Save back to localStorage
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                
                // Reload the display
                loadUnconfirmedBookingsV2();
                
                alert(`‚úÖ Booking ${bookingId} confirmed successfully!`);
                console.log('‚úÖ Booking confirmed:', bookingId);
            }
        }
        
        function cancelBooking(bookingId) {
            if (!confirm(`Cancel booking ${bookingId}? The customer will be notified.`)) {
                return;
            }
            
            // Move from unconfirmed to cancelled
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            const bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                const booking = unconfirmedBookings[bookingIndex];
                booking.status = 'cancelled';
                booking.cancelledAt = new Date().toISOString();
                
                // Move to cancelled
                cancelledBookings.unshift(booking);
                unconfirmedBookings.splice(bookingIndex, 1);
                
                // Save back to localStorage
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
                
                // Reload the display
                loadUnconfirmedBookingsV2();
                
                alert(`‚ùå Booking ${bookingId} cancelled successfully!`);
                console.log('‚ùå Booking cancelled:', bookingId);
            }
        }
        
        function confirmAllBookings() {
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            if (unconfirmedBookings.length === 0) {
                alert('No unconfirmed bookings to confirm.');
                return;
            }
            
            if (!confirm(`Confirm all ${unconfirmedBookings.length} unconfirmed bookings?`)) {
                return;
            }
            
            let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            
            // Move all unconfirmed to confirmed
            unconfirmedBookings.forEach(booking => {
                booking.status = 'confirmed';
                booking.confirmedAt = new Date().toISOString();
                confirmedBookings.unshift(booking);
            });
            
            // Clear unconfirmed and save confirmed
            localStorage.setItem('unconfirmedBookings', JSON.stringify([]));
            localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            
            // Reload the display
            loadUnconfirmedBookingsV2();
            
            alert(`‚úÖ All ${unconfirmedBookings.length} bookings confirmed successfully!`);
            console.log('‚úÖ All bookings confirmed');
        }
        
        // Delete Functions for Unconfirmed Bookings - ENHANCED WITH DEBUGGING
        function deleteUnconfirmedBooking(bookingId) {
            console.log('üóëÔ∏è deleteUnconfirmedBooking called with:', bookingId);
            
            try {
                if (!bookingId) {
                    console.error('‚ùå No booking ID provided');
                    alert('‚ùå Error: No booking ID provided');
                    return;
                }
                
                // Temporarily bypass confirmation for testing
                const shouldDelete = confirm(`‚ö†Ô∏è Delete booking ${bookingId}?\n\nThis action cannot be undone.`);
                console.log('üîç Confirmation result:', shouldDelete);
                if (!shouldDelete) {
                    console.log('‚ùå User cancelled delete operation');
                    return;
                }
                
                console.log('üóëÔ∏è User confirmed deletion, proceeding...');
                
                // Get current unconfirmed bookings
                let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
                console.log('üìã Current unconfirmed bookings count:', unconfirmedBookings.length);
                
                // Find and remove the booking
                const bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === bookingId);
                console.log('üîç Booking index found:', bookingIndex);
                
                if (bookingIndex !== -1) {
                    console.log('üìã Removing booking at index:', bookingIndex);
                    unconfirmedBookings.splice(bookingIndex, 1);
                    
                    // Save back to localStorage
                    localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                    console.log('üíæ Updated localStorage with', unconfirmedBookings.length, 'bookings');
                    
                    // Reload the display
                    console.log('üîÑ Reloading unconfirmed bookings display...');
                    loadUnconfirmedBookingsV2();
                    
                    alert(`‚úÖ Booking ${bookingId} deleted successfully!`);
                    console.log('‚úÖ Booking deleted successfully:', bookingId);
                } else {
                    alert(`‚ùå Booking ${bookingId} not found`);
                    console.error('‚ùå Booking not found in list:', bookingId);
                    console.log('üìã Available booking IDs:', unconfirmedBookings.map(b => b.bookingId));
                }
            } catch (error) {
                console.error('‚ùå Error in deleteUnconfirmedBooking:', error);
                alert('‚ùå Error deleting booking: ' + error.message);
            }
        }
        
        // Make deleteUnconfirmedBooking globally accessible
        window.deleteUnconfirmedBooking = deleteUnconfirmedBooking;
        
        
        function deleteAllUnconfirmedBookings() {
            console.log('üóëÔ∏è deleteAllUnconfirmedBookings function called');
            
            try {
                const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
                
                if (unconfirmedBookings.length === 0) {
                    alert('No unconfirmed bookings to delete.');
                    return;
                }
                
                if (!confirm(`‚ö†Ô∏è Delete ALL ${unconfirmedBookings.length} unconfirmed bookings?\n\nThis action cannot be undone.`)) {
                    console.log('‚ùå User cancelled delete all operation');
                    return;
                }
                
                console.log('üóëÔ∏è Deleting all unconfirmed bookings:', unconfirmedBookings.length);
                
                // Clear unconfirmed bookings
                localStorage.setItem('unconfirmedBookings', JSON.stringify([]));
                console.log('üíæ Cleared unconfirmedBookings in localStorage');
                
                // Reload the display
                loadUnconfirmedBookingsV2();
                console.log('üîÑ Reloaded unconfirmed bookings display');
                
                alert(`‚úÖ All ${unconfirmedBookings.length} unconfirmed bookings deleted!`);
                console.log('üóëÔ∏è All unconfirmed bookings cleared successfully');
            } catch (error) {
                console.error('‚ùå Error in deleteAllUnconfirmedBookings:', error);
                alert('‚ùå Error deleting bookings: ' + error.message);
            }
        }
        
        function refreshUnconfirmedBookings() {
            console.log('üîÑ refreshUnconfirmedBookings function called');
            
            try {
                // Show loading state
                const tableBody = document.getElementById('unconfirmedTableBody');
                if (tableBody) {
                    console.log('üìã Setting loading state in table body');
                    tableBody.innerHTML = `
                        <tr>
                            <td colspan="9" class="empty-state">
                                <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
                                    <div style="animation: spin 1s linear infinite;">üîÑ</div>
                                    <span>Refreshing...</span>
                                </div>
                            </td>
                        </tr>
                    `;
                } else {
                    console.warn('‚ö†Ô∏è Table body with id "unconfirmedTableBody" not found');
                }
                
                // Add CSS for spin animation if not exists
                if (!document.getElementById('spinAnimation')) {
                    console.log('üé® Adding spin animation CSS');
                    const style = document.createElement('style');
                    style.id = 'spinAnimation';
                    style.textContent = `
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                // Simulate refresh delay and reload
                setTimeout(() => {
                    console.log('üîÑ Starting refresh reload...');
                    loadUnconfirmedBookingsV2();
                    console.log('‚úÖ Refresh completed');
                }, 500);
            } catch (error) {
                console.error('‚ùå Error in refreshUnconfirmedBookings:', error);
                alert('‚ùå Error refreshing bookings: ' + error.message);
            }
        }
        
        // Global variable to store current booking being edited
        let currentEditingBooking = null;
        
        
        
        
        
        // üÜï Debug function for vehicle images
        window.checkVehicleImages = function() {
            console.log('üîç Checking vehicle images in localStorage...');
            
            const taxiVehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            console.log('üìã Found', taxiVehicles.length, 'vehicles in taxiVehicles:');
            
            taxiVehicles.forEach((vehicle, index) => {
                console.log(`${index + 1}. ${vehicle.name}:`);
                console.log('   - ID:', vehicle.id);
                console.log('   - Active:', vehicle.active);
                console.log('   - Has Image:', !!vehicle.image);
                if (vehicle.image) {
                    console.log('   - Image type:', vehicle.image.startsWith('data:') ? 'Base64 upload' : 'URL');
                    console.log('   - Image size:', vehicle.image.length, 'characters');
                }
            });
            
            const bookingVehicles = JSON.parse(localStorage.getItem('bookingSystemVehicles') || '[]');
            console.log('üìã Found', bookingVehicles.length, 'vehicles in bookingSystemVehicles');
            
            return { taxiVehicles, bookingVehicles };
        };

        function showBookingActions(bookingId) {
            console.log('üìù Opening edit modal for booking:', bookingId);
            
            // üÜï DEBUG: Show localStorage data for STAP 2 debugging
            console.log('üîç LOCALSTORAGE DEBUG:');
            console.log('   üìã selectedSurcharges:', localStorage.getItem('selectedSurcharges'));
            console.log('   üìã selectedVehicleStep2:', localStorage.getItem('selectedVehicleStep2'));
            console.log('   üìã surchargeItems:', localStorage.getItem('surchargeItems'));
            
            // Debug: Check if modal exists
            const modal = document.getElementById('bookingEditModal');
            if (!modal) {
                console.error('‚ùå Modal element not found!');
                alert('‚ùå Modal element not found! Please refresh the page.');
                return;
            }
            
            // Find the booking in all localStorage sections
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            console.log('üîç Searching in sections:');
            console.log('- Unconfirmed:', unconfirmedBookings.length);
            console.log('- Confirmed:', confirmedBookings.length);
            console.log('- Completed:', completedBookings.length);
            console.log('- Cancelled:', cancelledBookings.length);
            
            // Search in all sections
            let booking = unconfirmedBookings.find(b => b.bookingId === bookingId) ||
                         confirmedBookings.find(b => b.bookingId === bookingId) ||
                         completedBookings.find(b => b.bookingId === bookingId) ||
                         cancelledBookings.find(b => b.bookingId === bookingId);
            
            if (!booking) {
                alert('‚ùå Booking not found in any section\n\nBooking ID: ' + bookingId);
                console.error('‚ùå Booking not found:', bookingId);
                console.log('Available booking IDs:');
                console.log('- Unconfirmed:', unconfirmedBookings.map(b => b.bookingId));
                console.log('- Confirmed:', confirmedBookings.map(b => b.bookingId));
                console.log('- Completed:', completedBookings.map(b => b.bookingId));
                console.log('- Cancelled:', cancelledBookings.map(b => b.bookingId));
                return;
            }
            
            console.log('‚úÖ Found booking:', booking);
            console.log('‚úÖ Booking status:', booking.status || 'unconfirmed');
            
            // Store current booking for editing
            currentEditingBooking = booking;
            
            // Open the modal
            try {
                openBookingEditModal(booking);
                console.log('‚úÖ Modal should be open now');
            } catch (error) {
                console.error('‚ùå Error opening modal:', error);
                alert('‚ùå Error opening modal. Check console for details.');
            }
        }

        function openBookingEditModal(booking) {
            console.log('üìù Loading booking data into modal:', booking.bookingId);
            
            try {
                // Helper function to safely set element value
                const setElementValue = (elementId, value) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.value = value || '';
                    } else {
                        console.warn(`‚ö†Ô∏è Element not found: ${elementId}`);
                    }
                };
                
                const setElementText = (elementId, text) => {
                    const element = document.getElementById(elementId);
                    if (element) {
                        element.textContent = text || '';
                    } else {
                        console.warn(`‚ö†Ô∏è Element not found: ${elementId}`);
                    }
                };
                
                // Set booking ID in modal header
                setElementText('modalBookingId', booking.bookingId);
                
                // Fill customer information
                setElementValue('editFirstName', booking.customer?.firstName);
                setElementValue('editLastName', booking.customer?.lastName);
                setElementValue('editEmail', booking.customer?.email);
                setElementValue('editPhone', booking.customer?.phone);
                setElementValue('editPassengers', booking.customer?.passengers || '1');
                setElementValue('editPaymentMethod', booking.customer?.paymentMethod || 'cash');
                
                // Fill trip information
                setElementValue('editFromLocation', booking.trip?.fromLocation);
                setElementValue('editToLocation', booking.trip?.toLocation);
                
                // Display extra stops - improved with debug
                console.log('üîç Booking trip data:', booking.trip);
                console.log('üîç Extra stops:', booking.trip?.extraStops);
                
                const extraStopsDisplay = document.getElementById('editExtraStopsDisplay');
                if (extraStopsDisplay) {
                    // Check multiple possible locations for extra stops
                    const extraStops = booking.trip?.extraStops || 
                                     (booking.trip?.extraStopCount > 0 ? [] : null);
                    
                    if (extraStops && extraStops.length > 0) {
                        extraStopsDisplay.innerHTML = extraStops.map((stop, index) => 
                            `<div style="margin: 5px 0; padding: 8px; background: #f0f8ff; border-left: 3px solid #007bff; border-radius: 4px;">Stop ${index + 1}: ${stop}</div>`
                        ).join('');
                    } else if (booking.trip?.extraStopCount && booking.trip.extraStopCount > 0) {
                        // Fallback: show that there are stops but no details stored
                        extraStopsDisplay.innerHTML = `<div style="color: #ff9800; font-style: italic;">${booking.trip.extraStopCount} extra stop(s) - details not stored</div>`;
                    } else {
                        extraStopsDisplay.innerHTML = '<span style="color: #999;">No extra stops</span>';
                    }
                }
                
                // Convert date format from DD/MM/YYYY to YYYY-MM-DD for date input
                const travelDate = booking.trip?.travelDate || '';
                if (travelDate && travelDate.includes('/')) {
                    const dateParts = travelDate.split('/');
                    if (dateParts.length === 3) {
                        const formattedDate = `${dateParts[2]}-${dateParts[1].padStart(2, '0')}-${dateParts[0].padStart(2, '0')}`;
                        setElementValue('editTravelDate', formattedDate);
                    }
                } else {
                    setElementValue('editTravelDate', travelDate);
                }
                
                // Set travel time
                const travelTime = `${booking.trip?.travelHour || '00'}:${booking.trip?.travelMinute || '00'}`;
                setElementValue('editTravelTime', travelTime);
                
                // Set vehicle type
                const vehicleType = booking.vehicle?.vehicle?.id || booking.vehicle?.vehicleId || 'saloon';
                setElementValue('editVehicleType', vehicleType);
                
                // Set return trip
                setElementValue('editReturnTrip', booking.trip?.returnActive || 'false');
                
                // Fill booking details
                setElementValue('editBookingStatus', booking.status || 'unconfirmed');
                
                // Set price from vehicle pricing including surcharges
                console.log('üí∞ Vehicle pricing data:', booking.vehicle?.pricing);
                console.log('üí∞ Surcharges data:', booking.surcharges);
                
                const vehiclePrice = booking.vehicle?.pricing?.totalPrice || booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00;
                const surchargesTotal = booking.surcharges?.totalSurcharge || 0;
                
                // Recalculate airport surcharge if needed
                let airportSurcharge = 0;
                const isFromAirport = isAirportLocation(booking.trip?.fromLocation || '');
                if (isFromAirport) {
                    airportSurcharge = 5.00;
                }
                
                const totalPrice = parseFloat(vehiclePrice) + parseFloat(surchargesTotal) + airportSurcharge;
                console.log('üí∞ Price calculation: Vehicle: ‚Ç¨' + vehiclePrice + ' + Surcharges: ‚Ç¨' + surchargesTotal + ' + Airport: ‚Ç¨' + airportSurcharge + ' = ‚Ç¨' + totalPrice.toFixed(2));
                
                setElementValue('editPrice', totalPrice.toFixed(2));
                
                // Set optional fields
                setElementValue('editDriver', booking.driver);
                
                // Set special instructions (textarea)
                const specialInstructionsElement = document.getElementById('editSpecialInstructions');
                if (specialInstructionsElement) {
                    specialInstructionsElement.value = booking.specialInstructions || '';
                }
                
                // Load and display surcharges
                loadBookingSurcharges(booking);
                
                // Show the modal
                const modal = document.getElementById('bookingEditModal');
                if (modal) {
                    modal.classList.add('show');
                } else {
                    throw new Error('Modal element not found');
                }
                
            } catch (error) {
                console.error('‚ùå Error in openBookingEditModal:', error);
                alert('‚ùå Error opening booking details. Some fields may be missing.');
            }
        }

        function closeBookingModal() {
            console.log('‚ùå Closing booking edit modal');
            document.getElementById('bookingEditModal').classList.remove('show');
            currentEditingBooking = null;
        }

        // Surcharge Management Functions
        function loadBookingSurcharges(booking) {
            console.log('üí∞ Loading surcharges for booking:', booking.bookingId);
            console.log('üí∞ COMPLETE booking object:', JSON.stringify(booking, null, 2));
            
            // üÜï ENHANCED DEBUGGING for STAP 2 surcharge data
            console.log('üîç DEBUGGING SURCHARGE DATA:');
            console.log('   üìã booking.surcharges:', booking.surcharges);
            console.log('   üìã typeof surcharges:', typeof booking.surcharges);
            if (booking.surcharges) {
                console.log('   üìã surcharges keys:', Object.keys(booking.surcharges));
                console.log('   üìã surcharges values:', Object.values(booking.surcharges));
            }
            console.log('   üìã booking.vehicle:', booking.vehicle);
            console.log('   üìã booking.vehicle?.surcharges:', booking.vehicle?.surcharges);
            console.log('   üìã booking.selectedSurcharges:', booking.selectedSurcharges);
            console.log('   üìã booking.step2Data:', booking.step2Data);
            
            const surchargesList = document.getElementById('editSurchargesList');
            if (!surchargesList) {
                console.warn('‚ö†Ô∏è Surcharges list container not found');
                return;
            }
            
            let surcharges = [];
            
            // Check if this is a return trip
            const isReturnTrip = booking.trip?.returnActive === 'true' || booking.trip?.returnActive === true;
            console.log('üîç ADMIN - Return trip detected:', isReturnTrip);
            
            // DON'T add automatic airport surcharge - it's included in Meet & Greet
            // Meet & Greet already contains the airport service (‚Ç¨6 total: ‚Ç¨5 airport + ‚Ç¨1 service)
            console.log('üîç ADMIN - Skipping automatic airport surcharge (included in Meet & Greet)');
            
            // üÜï FIXED - Use SAME data structure as STEP 3 overview
            console.log('üîç ADMIN - Raw booking.surcharges:', booking.surcharges);
            
            if (booking.surcharges && typeof booking.surcharges === 'object') {
                // SAME logic as STEP 3: Get actual surcharges from nested structure  
                const actualSurcharges = booking.surcharges.selectedSurcharges || booking.surcharges;
                console.log('üîç ADMIN - Actual surcharges to process:', actualSurcharges);
                
                // Process SAME way as STEP 3 overview
                Object.entries(actualSurcharges).forEach(([key, value]) => {
                    // Skip all technical/internal fields - ONLY show real user selections
                    const skipKeys = [
                        'totalSurcharge', 'surchargeTotal', 'extraStopCount', 
                        'automaticCharges', 'stopoverCharges', 'airportSurcharge'
                    ];
                    
                    const skipPatterns = [
                        'stopcount', 'extrastop', 'total', 'automatic', 'airport'
                    ];
                    
                    // Skip if exact key match
                    if (skipKeys.includes(key)) {
                        console.log(`‚è≠Ô∏è ADMIN - Skipping technical key: ${key}`);
                        return; 
                    }
                    
                    // Skip if pattern match
                    if (skipPatterns.some(pattern => key.toLowerCase().includes(pattern))) {
                        console.log(`‚è≠Ô∏è ADMIN - Skipping pattern match: ${key}`);
                        return; 
                    }
                    
                    // Skip if it's a technical field with name containing these terms
                    if (typeof value === 'object' && value?.name) {
                        const nameLower = value.name.toLowerCase();
                        if (nameLower.includes('airport') || 
                            nameLower.includes('surcharge') || 
                            nameLower.includes('total') ||
                            nameLower.includes('stopcount')) {
                            console.log(`‚è≠Ô∏è ADMIN - Skipping technical item by name: ${value.name}`);
                            return;
                        }
                    }
                    
                    console.log(`üîç ADMIN - Processing surcharge: ${key}`, value);
                    
                    if (typeof value === 'object' && value !== null && value.name) {
                        const quantity = parseInt(value.quantity) || 1;
                        let price = parseFloat(value.price) || 0;
                        
                        // Check if Meet & Greet is disabled in admin settings
                        if (value.name.toLowerCase().includes('meet') || value.name.toLowerCase().includes('greet')) {
                            const surchargeItems = JSON.parse(localStorage.getItem('surchargeItems') || '{}');
                            const meetGreetItem = surchargeItems.fixed?.find(item => item.id === 'meet-greet');
                            const isMeetGreetEnabled = meetGreetItem ? meetGreetItem.enabled : false;
                            
                            if (!isMeetGreetEnabled) {
                                console.log(`‚è≠Ô∏è ADMIN - Meet & Greet disabled in admin settings - skipping: ${value.name}`);
                                return;
                            }
                        }
                        
                        // For return trips, double the surcharge prices EXCEPT Meet & Greet
                        // Meet & Greet is only for pickup FROM airport, not drop-off
                        if (isReturnTrip && !value.name.toLowerCase().includes('meet') && !value.name.toLowerCase().includes('greet')) {
                            price = price * 2;
                        }
                        
                        console.log(`üí∞ ADMIN - Item: ${value.name}, original price: ${parseFloat(value.price)}, final price: ${price}, quantity: ${quantity}${isReturnTrip ? ' (doubled for return)' : ''}`);
                        
                        if (parseFloat(value.price) > 0) { // Check original price > 0
                            const showReturnLabel = isReturnTrip && !value.name.toLowerCase().includes('meet') && !value.name.toLowerCase().includes('greet');
                            surcharges.push({
                                id: key,
                                name: value.name + (showReturnLabel ? ' (heen + terug)' : ''),
                                price: price, // Doubled price for return trips except Meet & Greet
                                quantity: quantity,
                                type: value.type || 'manual',
                                removable: !value.automatic,
                                automatic: value.automatic || false
                            });
                        }
                    } else if (typeof value === 'number' && value > 0) {
                        // Handle simple number values
                        const displayName = key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                        let simplePrice = parseFloat(value);
                        
                        // For return trips, double the surcharge prices
                        if (isReturnTrip) {
                            simplePrice = simplePrice * 2;
                        }
                        
                        surcharges.push({
                            id: key,
                            name: displayName + (isReturnTrip ? ' (heen + terug)' : ''),
                            price: simplePrice,
                            quantity: 1,
                            type: 'manual',
                            removable: true
                        });
                    }
                });
                
                // IMPORTANT: Skip the old fallback code below since we found the data
                if (surcharges.length > 0) {
                    console.log('üí∞ ADMIN - Found surcharges, skipping fallback search');
                    renderSurcharges(surcharges);
                    return;
                }
            }
            
            // Search for surcharges in additional possible locations (fallback)
            const searchLocations = [
                booking.vehicle?.surcharges,
                booking.additionalItems,
                booking.items,
                booking.extras
            ];
            
            searchLocations.forEach((location, index) => {
                if (!location) return;
                
                console.log(`üîç Searching location ${index + 1}:`, location);
                
                // Check for .items structure
                if (location.items) {
                    console.log('üí∞ Found items structure:', location.items);
                    Object.entries(location.items).forEach(([key, item]) => {
                        if (item && (item.quantity > 0 || item.selected || item.active)) {
                            const quantity = item.quantity || 1;
                            const price = parseFloat(item.price || 0);
                            if (price > 0) {
                                surcharges.push({
                                    id: key,
                                    name: item.name || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                    price: price * quantity,
                                    quantity: quantity,
                                    type: 'manual',
                                    removable: true
                                });
                            }
                        }
                    });
                }
                
                // Check for direct properties (key-value pairs)
                Object.entries(location).forEach(([key, value]) => {
                    if (key === 'items' || key === 'totalSurcharge') return; // Skip these
                    
                    if (typeof value === 'number' && value > 0) {
                        console.log(`üí∞ Found direct surcharge: ${key} = ${value}`);
                        surcharges.push({
                            id: key,
                            name: key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                            price: value,
                            quantity: 1,
                            type: 'manual',
                            removable: true
                        });
                    } else if (typeof value === 'object' && value !== null) {
                        // Check nested objects
                        if (value.price && value.price > 0 && (value.quantity > 0 || value.selected)) {
                            console.log(`üí∞ Found nested surcharge: ${key}`, value);
                            surcharges.push({
                                id: key,
                                name: value.name || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
                                price: parseFloat(value.price) * (value.quantity || 1),
                                quantity: value.quantity || 1,
                                type: 'manual',
                                removable: true
                            });
                        }
                    }
                });
            });
            
            // Remove duplicates based on id
            const uniqueSurcharges = [];
            const seenIds = new Set();
            surcharges.forEach(surcharge => {
                if (!seenIds.has(surcharge.id)) {
                    seenIds.add(surcharge.id);
                    uniqueSurcharges.push(surcharge);
                }
            });
            
            console.log('üí∞ Total unique surcharges found:', uniqueSurcharges.length);
            console.log('üí∞ Surcharges list:', uniqueSurcharges);
            
            // Render surcharges
            renderSurcharges(uniqueSurcharges);
        }
        
        function isAirportLocation(location) {
            if (!location) return false;
            const airportKeywords = [
                'Brussels Airport', 'Brussels South Charleroi Airport', 'Antwerp Airport',
                'Li√®ge Airport', 'Ostend-Bruges Airport', 'airport', 'luchthaven'
            ];
            return airportKeywords.some(keyword => 
                location.toLowerCase().includes(keyword.toLowerCase())
            );
        }
        
        function renderSurcharges(surcharges) {
            const surchargesList = document.getElementById('editSurchargesList');
            
            if (surcharges.length === 0) {
                surchargesList.innerHTML = '<div style="color: #999; font-style: italic;">No surcharges</div>';
                return;
            }
            
            let html = '';
            surcharges.forEach(surcharge => {
                html += `
                    <div class="surcharge-item" style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; border-radius: 6px; margin-bottom: 8px;">
                        <div>
                            <span class="font-medium">${surcharge.name}</span>
                            ${surcharge.quantity ? `<span style="color: #666; font-size: 12px;"> (${surcharge.quantity}x)</span>` : ''}
                        </div>
                        <div class="flex-center">
                            <span style="font-weight: 600;">‚Ç¨${surcharge.price.toFixed(2)}</span>
                            ${surcharge.removable ? `<button onclick="removeSurcharge('${surcharge.id}')" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóë</button>` : ''}
                        </div>
                    </div>
                `;
            });
            
            surchargesList.innerHTML = html;
        }
        
        function addNewSurcharge() {
            // Get available surcharge items from NEW Item Surcharge configuration
            const surchargeItems = JSON.parse(localStorage.getItem('surchargeItems') || '{}');
            
            console.log('üìã Loading surcharge items for admin selection:', surchargeItems);
            
            if (!surchargeItems.fixed && !surchargeItems.additional) {
                alert('‚ùå Geen Item Surcharge geconfigureerd.\n\nGa naar Settings ‚Üí Item Surcharge om items te configureren.');
                return;
            }
            
            // Create options list with better structure
            let availableItems = [];
            
            // Add fixed items (Meet & Greet, Child seat, Dog, etc.)
            if (surchargeItems.fixed) {
                surchargeItems.fixed.forEach(item => {
                    if (item.enabled && item.price > 0) {
                        availableItems.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            type: 'fixed',
                            hasDropdown: item.hasDropdown,
                            dropdownOptions: item.dropdownOptions
                        });
                    }
                });
            }
            
            // Add additional items (Golf material, Ski material, etc.)
            if (surchargeItems.additional) {
                surchargeItems.additional.forEach(item => {
                    if (item.enabled !== false && item.price > 0) {
                        availableItems.push({
                            id: item.id,
                            name: item.name,
                            price: item.price,
                            type: 'additional',
                            hasDropdown: item.hasDropdown,
                            dropdownOptions: item.dropdownOptions
                        });
                    }
                });
            }
            
            if (availableItems.length === 0) {
                alert('‚ùå Geen actieve surcharge items gevonden met prijs > ‚Ç¨0.');
                return;
            }
            
            // Show selection dialog
            showSurchargeSelectionDialog(availableItems);
        }
        
        function showSurchargeSelectionDialog(availableItems) {
            // Create modal dialog for surcharge selection
            const dialogHTML = `
                <div id="surchargeSelectionModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 80vh;
                        overflow-y: auto;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #2c3e50;">üéüÔ∏è Item Surcharge Toevoegen</h3>
                            <button onclick="closeSurchargeSelectionDialog()" style="
                                background: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 8px 12px;
                                cursor: pointer;
                                font-size: 14px;
                            ">‚úï Sluiten</button>
                        </div>
                        
                        <div class="section-margin-lg">
                            <p style="color: #666; margin: 0;">Selecteer een item om toe te voegen aan de boeking:</p>
                        </div>
                        
                        <div id="surchargeItemsList" style="max-height: 400px; overflow-y: auto;">
                            ${availableItems.map(item => `
                                <div class="surcharge-selection-item" style="
                                    border: 2px solid #e9ecef;
                                    border-radius: 8px;
                                    padding: 15px;
                                    margin-bottom: 10px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    background: white;
                                " onclick="selectSurchargeItem('${item.id}', '${item.type}')" 
                                   onmouseover="this.style.borderColor='#007bff'; this.style.background='#f8f9ff';"
                                   onmouseout="this.style.borderColor='#e9ecef'; this.style.background='white';">
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <div style="font-weight: 600; font-size: 16px; color: #2c3e50;">
                                                ${item.name}
                                            </div>
                                            <div style="font-size: 12px; color: #666; margin-top: 2px;">
                                                Type: ${item.type === 'fixed' ? 'Fixed Item' : 'Additional Item'}
                                                ${item.hasDropdown ? ' ‚Ä¢ Heeft opties' : ''}
                                            </div>
                                        </div>
                                        <div style="
                                            background: #28a745;
                                            color: white;
                                            padding: 6px 12px;
                                            border-radius: 6px;
                                            font-weight: 600;
                                        ">
                                            ‚Ç¨${item.price.toFixed(2)}
                                        </div>
                                    </div>
                                    
                                    ${item.hasDropdown && item.dropdownOptions ? `
                                        <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #e9ecef;">
                                            <div style="font-size: 12px; color: #666; margin-bottom: 5px;">Beschikbare opties:</div>
                                            ${item.dropdownOptions.map(option => `
                                                <span style="
                                                    display: inline-block;
                                                    background: #f8f9fa;
                                                    border: 1px solid #dee2e6;
                                                    padding: 2px 6px;
                                                    margin: 2px;
                                                    border-radius: 4px;
                                                    font-size: 11px;
                                                    color: #495057;
                                                ">
                                                    ${option.name || option.id} (‚Ç¨${option.price || item.price})
                                                </span>
                                            `).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="closeSurchargeSelectionDialog()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 10px 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Annuleren</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add to page
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
        
        function closeSurchargeSelectionDialog() {
            const modal = document.getElementById('surchargeSelectionModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function selectSurchargeItem(itemId, itemType) {
            console.log('üéüÔ∏è Selecting surcharge item:', itemId, itemType);
            
            // Get the full item configuration
            const surchargeItems = JSON.parse(localStorage.getItem('surchargeItems') || '{}');
            let selectedItem = null;
            
            // Find the item in the appropriate category
            if (itemType === 'fixed' && surchargeItems.fixed) {
                selectedItem = surchargeItems.fixed.find(item => item.id === itemId);
            } else if (itemType === 'additional' && surchargeItems.additional) {
                selectedItem = surchargeItems.additional.find(item => item.id === itemId);
            }
            
            if (!selectedItem) {
                alert('‚ùå Item niet gevonden in configuratie.');
                return;
            }
            
            console.log('üìã Found item:', selectedItem);
            
            // Close the selection dialog
            closeSurchargeSelectionDialog();
            
            // Handle items with dropdown options (like Child seat, Dog)
            if (selectedItem.hasDropdown && selectedItem.dropdownOptions && selectedItem.dropdownOptions.length > 0) {
                showDropdownOptionsDialog(selectedItem);
            } else {
                // Simple item - just ask for quantity
                showQuantityDialog(selectedItem);
            }
        }
        
        function showDropdownOptionsDialog(item) {
            const dialogHTML = `
                <div id="dropdownOptionsModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2001;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        max-width: 500px;
                        width: 90%;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #2c3e50;">üîΩ ${item.name} - Selecteer Optie</h3>
                            <button onclick="closeDropdownOptionsDialog()" style="
                                background: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 8px 12px;
                                cursor: pointer;
                                font-size: 14px;
                            ">‚úï</button>
                        </div>
                        
                        <div class="section-margin-lg">
                            <p style="color: #666; margin: 0;">Kies een specifieke optie:</p>
                        </div>
                        
                        <div>
                            ${item.dropdownOptions.map(option => `
                                <div class="dropdown-option-item" style="
                                    border: 2px solid #e9ecef;
                                    border-radius: 8px;
                                    padding: 12px;
                                    margin-bottom: 8px;
                                    cursor: pointer;
                                    transition: all 0.3s ease;
                                    background: white;
                                " onclick="selectDropdownOption('${item.id}', '${option.id || option.name}', ${option.price || item.price})"
                                   onmouseover="this.style.borderColor='#007bff'; this.style.background='#f8f9ff';"
                                   onmouseout="this.style.borderColor='#e9ecef'; this.style.background='white';">
                                    
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-weight: 500; color: #2c3e50;">
                                            ${option.name || option.id}
                                        </div>
                                        <div style="
                                            background: #28a745;
                                            color: white;
                                            padding: 4px 8px;
                                            border-radius: 4px;
                                            font-weight: 600;
                                            font-size: 14px;
                                        ">
                                            ‚Ç¨${(option.price || item.price).toFixed(2)}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div style="text-align: center; margin-top: 20px;">
                            <button onclick="closeDropdownOptionsDialog()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 10px 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Annuleren</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
        }
        
        function closeDropdownOptionsDialog() {
            const modal = document.getElementById('dropdownOptionsModal');
            if (modal) {
                modal.remove();
            }
        }
        
        function selectDropdownOption(itemId, optionId, price) {
            console.log('üéØ Selected dropdown option:', { itemId, optionId, price });
            
            // Close dropdown dialog
            closeDropdownOptionsDialog();
            
            // Create a modified item for quantity selection
            const itemWithOption = {
                id: `${itemId}_${optionId}`,
                name: `${optionId}`, // Will be the option name like "Maxi Cosi" or "Kleine hond"
                price: price,
                type: 'selected_option',
                parentId: itemId,
                optionId: optionId
            };
            
            // Show quantity dialog
            showQuantityDialog(itemWithOption);
        }
        
        function showQuantityDialog(item) {
            const maxQuantity = item.type === 'additional' ? 10 : 5; // Different max for different types
            
            const dialogHTML = `
                <div id="quantityModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2002;
                ">
                    <div style="
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        max-width: 400px;
                        width: 90%;
                        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; color: #2c3e50;">üî¢ Aantal: ${item.name}</h3>
                            <button onclick="closeQuantityDialog()" style="
                                background: #e74c3c;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 8px 12px;
                                cursor: pointer;
                                font-size: 14px;
                            ">‚úï</button>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 25px;">
                            <div style="color: #666; margin-bottom: 15px;">Hoeveel ${item.name} wilt u toevoegen?</div>
                            
                            <div style="
                                background: #f8f9fa;
                                border: 2px solid #e9ecef;
                                border-radius: 8px;
                                padding: 15px;
                                margin-bottom: 15px;
                            ">
                                <div style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                                    ‚Ç¨${item.price.toFixed(2)} per stuk
                                </div>
                                <div style="font-size: 14px; color: #666;">
                                    Totaal: ‚Ç¨<span id="totalPrice">${item.price.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                                <button onclick="adjustQuantity(-1)" style="
                                    background: #dc3545;
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 40px;
                                    height: 40px;
                                    cursor: pointer;
                                    font-size: 18px;
                                    font-weight: 600;
                                ">‚àí</button>
                                
                                <input type="number" id="quantityInput" value="1" min="1" max="${maxQuantity}" 
                                       onchange="updateTotalPrice()" style="
                                    width: 80px;
                                    padding: 10px;
                                    text-align: center;
                                    border: 2px solid #007bff;
                                    border-radius: 6px;
                                    font-size: 18px;
                                    font-weight: 600;
                                ">
                                
                                <button onclick="adjustQuantity(1)" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    border-radius: 50%;
                                    width: 40px;
                                    height: 40px;
                                    cursor: pointer;
                                    font-size: 18px;
                                    font-weight: 600;
                                ">+</button>
                            </div>
                        </div>
                        
                        <div style="text-align: center; display: flex; gap: 10px; justify-content: center;">
                            <button onclick="closeQuantityDialog()" style="
                                background: #6c757d;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 12px 20px;
                                cursor: pointer;
                                font-size: 14px;
                            ">Annuleren</button>
                            
                            <button onclick="confirmAddSurcharge()" style="
                                background: #007bff;
                                color: white;
                                border: none;
                                border-radius: 6px;
                                padding: 12px 20px;
                                cursor: pointer;
                                font-size: 14px;
                                font-weight: 600;
                            ">‚úÖ Toevoegen</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', dialogHTML);
            
            // Store item data for later use
            window.currentSurchargeItem = item;
        }
        
        function closeQuantityDialog() {
            const modal = document.getElementById('quantityModal');
            if (modal) {
                modal.remove();
            }
            window.currentSurchargeItem = null;
        }
        
        function adjustQuantity(delta) {
            const input = document.getElementById('quantityInput');
            if (input) {
                const currentValue = parseInt(input.value) || 1;
                const newValue = Math.max(1, Math.min(parseInt(input.max), currentValue + delta));
                input.value = newValue;
                updateTotalPrice();
            }
        }
        
        function updateTotalPrice() {
            const input = document.getElementById('quantityInput');
            const totalPriceSpan = document.getElementById('totalPrice');
            
            if (input && totalPriceSpan && window.currentSurchargeItem) {
                const quantity = parseInt(input.value) || 1;
                const total = window.currentSurchargeItem.price * quantity;
                totalPriceSpan.textContent = total.toFixed(2);
            }
        }
        
        function confirmAddSurcharge() {
            if (!window.currentSurchargeItem || !currentEditingBooking) {
                alert('‚ùå Fout: Item of booking niet gevonden.');
                return;
            }
            
            const input = document.getElementById('quantityInput');
            const quantity = parseInt(input.value) || 1;
            
            console.log('‚úÖ Adding surcharge to booking:', {
                item: window.currentSurchargeItem,
                quantity: quantity,
                booking: currentEditingBooking.bookingId
            });
            
            // Add to booking surcharges
            if (!currentEditingBooking.surcharges) {
                currentEditingBooking.surcharges = {};
            }
            
            // Create unique key for this surcharge
            const surchargeKey = window.currentSurchargeItem.id;
            const totalPrice = window.currentSurchargeItem.price * quantity;
            
            // Add the surcharge
            currentEditingBooking.surcharges[surchargeKey] = {
                name: window.currentSurchargeItem.name,
                price: window.currentSurchargeItem.price,
                quantity: quantity,
                type: window.currentSurchargeItem.type || 'manual',
                removable: true
            };
            
            // Update the booking in localStorage
            updateBookingInStorage(currentEditingBooking);
            
            // Recalculate and reload display
            recalculateSurchargeTotal();
            loadBookingSurcharges(currentEditingBooking);
            
            // Close dialog
            closeQuantityDialog();
            
            // Show success message
            alert(`‚úÖ ${window.currentSurchargeItem.name} (${quantity}x) toegevoegd voor ‚Ç¨${totalPrice.toFixed(2)}`);
            
            console.log('‚úÖ Surcharge added successfully');
        }
        
        function updateBookingInStorage(booking) {
            // Update in all possible locations where the booking might be stored
            const storageKeys = ['unconfirmedBookings', 'confirmedBookings', 'completedBookings', 'cancelledBookings'];
            
            storageKeys.forEach(key => {
                const bookings = JSON.parse(localStorage.getItem(key) || '[]');
                const index = bookings.findIndex(b => b.bookingId === booking.bookingId);
                
                if (index !== -1) {
                    bookings[index] = booking;
                    localStorage.setItem(key, JSON.stringify(bookings));
                    console.log(`üìã Updated booking in ${key}`);
                }
            });
        }
        
        function addSurchargeToBooking(itemKey, item, quantity) {
            if (!currentEditingBooking) return;
            
            // Initialize surcharges if not exists
            if (!currentEditingBooking.surcharges) {
                currentEditingBooking.surcharges = { items: {}, totalSurcharge: 0 };
            }
            
            // Add or update the surcharge
            currentEditingBooking.surcharges.items[itemKey] = {
                name: item.name,
                price: item.price,
                quantity: quantity
            };
            
            // Recalculate total
            recalculateSurchargeTotal();
            
            // Reload the display
            loadBookingSurcharges(currentEditingBooking);
        }
        
        function removeSurcharge(surchargeId) {
            if (!currentEditingBooking || !currentEditingBooking.surcharges) return;
            
            if (surchargeId === 'airport_surcharge') {
                alert('Airport surcharge cannot be removed as this trip originates from an airport.');
                return;
            }
            
            delete currentEditingBooking.surcharges.items[surchargeId];
            recalculateSurchargeTotal();
            loadBookingSurcharges(currentEditingBooking);
        }
        
        function recalculateSurchargeTotal() {
            if (!currentEditingBooking || !currentEditingBooking.surcharges) return;
            
            let total = 0;
            
            // Add airport surcharge if applicable
            const isFromAirport = isAirportLocation(currentEditingBooking.trip?.fromLocation || '');
            if (isFromAirport) {
                total += 5.00;
            }
            
            // Add manual surcharges
            Object.values(currentEditingBooking.surcharges.items || {}).forEach(item => {
                total += parseFloat(item.price) * parseInt(item.quantity || 1);
            });
            
            currentEditingBooking.surcharges.totalSurcharge = total;
            
            // Update the price field
            const vehiclePrice = currentEditingBooking.vehicle?.pricing?.minimumPrice || currentEditingBooking.vehicle?.price || 50.00;
            const totalPrice = parseFloat(vehiclePrice) + total;
            
            const priceField = document.getElementById('editPrice');
            if (priceField) {
                priceField.value = totalPrice.toFixed(2);
            }
        }

        function saveBookingChanges() {
            if (!currentEditingBooking) {
                alert('‚ùå No booking data to save');
                return;
            }
            
            console.log('üíæ Saving booking changes for:', currentEditingBooking.bookingId);
            
            // Validate required fields
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            const email = document.getElementById('editEmail').value.trim();
            const phone = document.getElementById('editPhone').value.trim();
            const fromLocation = document.getElementById('editFromLocation').value.trim();
            const toLocation = document.getElementById('editToLocation').value.trim();
            
            if (!firstName || !lastName || !email || !phone || !fromLocation || !toLocation) {
                alert('‚ùå Please fill in all required fields');
                return;
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('‚ùå Please enter a valid email address');
                return;
            }
            
            // Update booking data
            const updatedBooking = {
                ...currentEditingBooking,
                customer: {
                    ...currentEditingBooking.customer,
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    phone: phone,
                    passengers: document.getElementById('editPassengers').value,
                    paymentMethod: document.getElementById('editPaymentMethod').value
                },
                trip: {
                    ...currentEditingBooking.trip,
                    fromLocation: fromLocation,
                    toLocation: toLocation,
                    travelDate: convertDateToDisplayFormat(document.getElementById('editTravelDate').value),
                    travelHour: document.getElementById('editTravelTime').value.split(':')[0],
                    travelMinute: document.getElementById('editTravelTime').value.split(':')[1],
                    returnActive: document.getElementById('editReturnTrip').value
                },
                vehicle: {
                    ...currentEditingBooking.vehicle,
                    vehicle: {
                        ...currentEditingBooking.vehicle?.vehicle,
                        id: document.getElementById('editVehicleType').value,
                        name: getVehicleName(document.getElementById('editVehicleType').value)
                    },
                    pricing: {
                        ...currentEditingBooking.vehicle?.pricing,
                        minimumPrice: parseFloat(document.getElementById('editPrice').value)
                    }
                },
                status: document.getElementById('editBookingStatus').value,
                driver: document.getElementById('editDriver').value,
                specialInstructions: document.getElementById('editSpecialInstructions').value,
                surcharges: currentEditingBooking.surcharges || { items: {}, totalSurcharge: 0 },
                lastUpdated: new Date().toISOString()
            };
            
            // Update in localStorage
            updateBookingInStorage(updatedBooking);
            
            // Close modal and refresh display
            closeBookingModal();
            loadUnconfirmedBookingsV2();
            
            alert('‚úÖ Booking updated successfully!');
            console.log('‚úÖ Booking saved:', updatedBooking);
        }

        function convertDateToDisplayFormat(dateString) {
            // Convert from YYYY-MM-DD to DD/MM/YYYY
            if (!dateString) return '';
            const dateParts = dateString.split('-');
            if (dateParts.length === 3) {
                return `${dateParts[2]}/${dateParts[1]}/${dateParts[0]}`;
            }
            return dateString;
        }

        function getVehicleName(vehicleId) {
            const vehicleNames = {
                'saloon': 'Saloon',
                'estate': 'Estate',
                'minivan': 'Minivan',
                'minivan_long': 'Minivan Long'
            };
            return vehicleNames[vehicleId] || 'Unknown';
        }

        function confirmBookingFromModal() {
            if (!currentEditingBooking) {
                alert('‚ùå No booking to confirm');
                return;
            }
            
            // Update status to confirmed
            document.getElementById('editBookingStatus').value = 'confirmed';
            
            // Save changes
            saveBookingChanges();
            
            console.log('‚úÖ Booking confirmed from modal');
        }

        function deleteBooking() {
            console.log('üóëÔ∏è deleteBooking function called');
            console.log('üìã currentEditingBooking:', currentEditingBooking);
            
            if (!currentEditingBooking) {
                alert('‚ùå No booking to delete');
                console.error('‚ùå currentEditingBooking is null or undefined');
                return;
            }
            
            if (!confirm(`üóëÔ∏è Move booking ${currentEditingBooking.bookingId} to Trash?\n\nYou can restore it later from the Trash section.`)) {
                console.log('‚ùå User cancelled delete operation');
                return;
            }
            
            try {
                console.log('üóëÔ∏è Moving booking to trash...');
                
                // Add deleted timestamp
                const bookingForTrash = {
                    ...currentEditingBooking,
                    deletedDate: new Date().toISOString(),
                    originalStatus: currentEditingBooking.status || 'unconfirmed'
                };
                
                // Add to trash
                let trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
                trashItems.unshift(bookingForTrash);
                localStorage.setItem('trashItems', JSON.stringify(trashItems));
                console.log('üóëÔ∏è Added to trash:', bookingForTrash.bookingId);
                
                // Remove from all active lists
                let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
                const beforeCount = unconfirmedBookings.length;
                unconfirmedBookings = unconfirmedBookings.filter(b => b.bookingId !== currentEditingBooking.bookingId);
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                console.log(`üìã Unconfirmed: ${beforeCount} ‚Üí ${unconfirmedBookings.length}`);
                
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                const beforeConfirmed = confirmedBookings.length;
                confirmedBookings = confirmedBookings.filter(b => b.bookingId !== currentEditingBooking.bookingId);
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                console.log(`üìã Confirmed: ${beforeConfirmed} ‚Üí ${confirmedBookings.length}`);
                
                let completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
                const beforeCompleted = completedBookings.length;
                completedBookings = completedBookings.filter(b => b.bookingId !== currentEditingBooking.bookingId);
                localStorage.setItem('completedBookings', JSON.stringify(completedBookings));
                console.log(`üìã Completed: ${beforeCompleted} ‚Üí ${completedBookings.length}`);
                
                let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
                const beforeCancelled = cancelledBookings.length;
                cancelledBookings = cancelledBookings.filter(b => b.bookingId !== currentEditingBooking.bookingId);
                localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
                console.log(`üìã Cancelled: ${beforeCancelled} ‚Üí ${cancelledBookings.length}`);
                
                // Close modal and refresh
                closeBookingModal();
                
                // Reload the active section
                console.log('üîÑ Reloading active section...');
                if (document.getElementById('unconfirmed-section').classList.contains('active')) {
                    loadUnconfirmedBookingsV2();
                } else if (document.getElementById('next-24h-section').classList.contains('active')) {
                    loadNext24hBookings();
                } else if (document.getElementById('completed-section').classList.contains('active')) {
                    loadCompletedBookings();
                } else if (document.getElementById('cancelled-section').classList.contains('active')) {
                    loadCancelledBookings();
                } else if (document.getElementById('all-section').classList.contains('active')) {
                    loadAllBookings();
                } else if (document.getElementById('trash-section').classList.contains('active')) {
                    loadTrashItems();
                }
                
                alert('‚úÖ Booking moved to Trash successfully');
                console.log('üóëÔ∏è Booking moved to trash successfully:', currentEditingBooking.bookingId);
            } catch (error) {
                console.error('‚ùå Error in deleteBooking:', error);
                alert('‚ùå Error moving booking to trash: ' + error.message);
            }
        }

        // Trash Functions
        function loadTrashItems() {
            console.log('üóëÔ∏è Loading trash items...');
            
            const tableBody = document.getElementById('trashTableBody');
            const countDisplay = document.getElementById('trashCount');
            
            if (!tableBody) {
                console.error('‚ùå Trash table body not found');
                return;
            }
            
            const trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
            console.log(`üóëÔ∏è Found ${trashItems.length} items in trash`);
            
            if (countDisplay) {
                countDisplay.textContent = `${trashItems.length} items`;
            }
            
            if (trashItems.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" class="empty-state">
                            üóëÔ∏è No items in trash
                        </td>
                    </tr>
                `;
                return;
            }
            
            let html = '';
            trashItems.forEach(booking => {
                const deletedDate = new Date(booking.deletedDate).toLocaleDateString('nl-NL');
                const vehicleName = getVehicleName(booking.vehicle?.id || booking.selectedVehicle);
                const totalPrice = booking.pricing?.totalPrice || booking.vehicle?.pricing?.totalPrice || '0.00';
                const fromCountry = detectCountryFromAddress(booking.trip?.fromLocation);
                const toCountry = detectCountryFromAddress(booking.trip?.toLocation);
                const isCrossBorder = fromCountry !== toCountry;
                const countryInfo = getCountryInfo(fromCountry);
                const originalStatus = booking.originalStatus || 'Unknown';
                
                html += `
                    <tr style="border-bottom: 1px solid #f1f3f4;">
                        <td class="table-cell" style="text-align: center; padding: 8px 4px;">
                            <div style="position: relative; display: inline-block;">
                                ${countryInfo.flag}
                                ${isCrossBorder ? '<div style="font-size: 10px; color: #ff6b6b;">üåê</div>' : ''}
                                <button onclick="viewBookingDetails('${booking.bookingId}')" style="display: block; background: transparent; border: none; cursor: pointer; margin-top: 2px; font-size: 12px;">üëÅ</button>
                            </div>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <div class="font-medium" style="font-size: 13px;">${booking.customer?.firstName || ''} ${booking.customer?.lastName || ''}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">üìû ${booking.customer?.phone || ''}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">${booking.trip?.fromLocation || ''} ‚Üí ${booking.trip?.toLocation || ''}</div>
                            <div style="font-weight: 600; color: #2c3e50; font-size: 11px;">${booking.bookingId}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <div>${convertDateToDisplayFormat(booking.trip?.travelDate)}</div>
                            <div style="font-size: 11px; color: #666;">${booking.trip?.travelHour}:${booking.trip?.travelMinute}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <span class="status-badge" style="font-size: 11px; padding: 4px 8px; background: #6c757d; color: white; border-radius: 4px;">
                                üóëÔ∏è Deleted
                            </span>
                            <div style="font-size: 10px; color: #666; margin-top: 2px;">was ${originalStatus}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <div style="display: flex; gap: 4px; flex-direction: column;">
                                <button onclick="restoreFromTrash('${booking.bookingId}')" 
                                        style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    ‚Ü©Ô∏è Restore
                                </button>
                                <button onclick="permanentDeleteFromTrash('${booking.bookingId}')" 
                                        style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 11px;">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <span style="background: #e9ecef; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">
                                ${vehicleName}
                            </span>
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <div>Deleted ${deletedDate}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px; text-align: left;">
                            <span style="font-weight: 600; color: #28a745;">‚Ç¨${parseFloat(totalPrice).toFixed(2)}</span>
                        </td>
                        <td class="table-cell" style="text-align: center; padding: 8px 4px;">
                            <button onclick="openEmailModal('${booking.bookingId}')" style="background: transparent; border: none; cursor: pointer; font-size: 16px;">‚úâÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }
        
        function restoreFromTrash(bookingId) {
            console.log('‚Ü©Ô∏è Restoring booking from trash:', bookingId);
            
            if (!confirm(`‚Ü©Ô∏è Restore booking ${bookingId} from trash?`)) {
                return;
            }
            
            try {
                // Get trash items
                let trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
                const bookingIndex = trashItems.findIndex(b => b.bookingId === bookingId);
                
                if (bookingIndex === -1) {
                    alert('‚ùå Booking not found in trash');
                    return;
                }
                
                const booking = trashItems[bookingIndex];
                const originalStatus = booking.originalStatus || 'unconfirmed';
                
                // Remove from trash
                trashItems.splice(bookingIndex, 1);
                localStorage.setItem('trashItems', JSON.stringify(trashItems));
                
                // Clean up the booking object
                delete booking.deletedDate;
                delete booking.originalStatus;
                
                // Restore to original list
                if (originalStatus === 'confirmed') {
                    let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                    confirmedBookings.unshift(booking);
                    localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                } else if (originalStatus === 'completed') {
                    let completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
                    completedBookings.unshift(booking);
                    localStorage.setItem('completedBookings', JSON.stringify(completedBookings));
                } else if (originalStatus === 'cancelled') {
                    let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
                    cancelledBookings.unshift(booking);
                    localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
                } else {
                    // Default to unconfirmed
                    let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
                    unconfirmedBookings.unshift(booking);
                    localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                }
                
                // Refresh trash view
                loadTrashItems();
                
                alert(`‚úÖ Booking ${bookingId} restored to ${originalStatus} list`);
                console.log('‚Ü©Ô∏è Booking restored successfully:', bookingId);
                
            } catch (error) {
                console.error('‚ùå Error restoring booking:', error);
                alert('‚ùå Error restoring booking: ' + error.message);
            }
        }
        
        function permanentDeleteFromTrash(bookingId) {
            console.log('üóëÔ∏è Permanent delete from trash:', bookingId);
            
            if (!confirm(`‚ö†Ô∏è PERMANENTLY DELETE booking ${bookingId}?\n\nThis action CANNOT be undone!`)) {
                return;
            }
            
            try {
                // Get trash items
                let trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
                const bookingIndex = trashItems.findIndex(b => b.bookingId === bookingId);
                
                if (bookingIndex === -1) {
                    alert('‚ùå Booking not found in trash');
                    return;
                }
                
                // Remove from trash permanently
                trashItems.splice(bookingIndex, 1);
                localStorage.setItem('trashItems', JSON.stringify(trashItems));
                
                // Refresh trash view
                loadTrashItems();
                
                alert(`‚úÖ Booking ${bookingId} permanently deleted`);
                console.log('üóëÔ∏è Booking permanently deleted:', bookingId);
                
            } catch (error) {
                console.error('‚ùå Error permanently deleting booking:', error);
                alert('‚ùå Error permanently deleting booking: ' + error.message);
            }
        }
        
        function clearAllTrash() {
            const trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
            
            if (trashItems.length === 0) {
                alert('üóëÔ∏è Trash is already empty');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è PERMANENTLY DELETE all ${trashItems.length} items from trash?\n\nThis action CANNOT be undone!`)) {
                return;
            }
            
            localStorage.setItem('trashItems', JSON.stringify([]));
            loadTrashItems();
            
            alert(`‚úÖ All ${trashItems.length} items permanently deleted from trash`);
            console.log('üóëÔ∏è All trash items cleared');
        }
        
        function restoreAllTrash() {
            const trashItems = JSON.parse(localStorage.getItem('trashItems') || '[]');
            
            if (trashItems.length === 0) {
                alert('üóëÔ∏è Trash is empty - nothing to restore');
                return;
            }
            
            if (!confirm(`‚Ü©Ô∏è Restore all ${trashItems.length} items from trash?`)) {
                return;
            }
            
            try {
                // Get all storage lists
                let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                let completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
                let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
                
                // Restore each item to its original list
                trashItems.forEach(booking => {
                    const originalStatus = booking.originalStatus || 'unconfirmed';
                    
                    // Clean up the booking object
                    delete booking.deletedDate;
                    delete booking.originalStatus;
                    
                    // Add to appropriate list
                    if (originalStatus === 'confirmed') {
                        confirmedBookings.unshift(booking);
                    } else if (originalStatus === 'completed') {
                        completedBookings.unshift(booking);
                    } else if (originalStatus === 'cancelled') {
                        cancelledBookings.unshift(booking);
                    } else {
                        unconfirmedBookings.unshift(booking);
                    }
                });
                
                // Save all lists
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                localStorage.setItem('completedBookings', JSON.stringify(completedBookings));
                localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
                
                // Clear trash
                localStorage.setItem('trashItems', JSON.stringify([]));
                
                // Refresh trash view
                loadTrashItems();
                
                alert(`‚úÖ All ${trashItems.length} items restored from trash`);
                console.log('‚Ü©Ô∏è All trash items restored');
                
            } catch (error) {
                console.error('‚ùå Error restoring all items:', error);
                alert('‚ùå Error restoring items: ' + error.message);
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('bookingEditModal');
            if (event.target === modal) {
                closeBookingModal();
            }
        });

        // üö® OUDE FUNCTIE VOLLEDIG VERWIJDERD - ALLEEN regel ~7755 ACTIEF
        /*  COMMENTED OUT - LOOSE CODE CAUSING ERRORS
            
            // Get confirmed bookings from localStorage
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            console.log('üìÖ Found confirmed bookings:', confirmedBookings.length);
            
            // Filter for next 24 hours
            const now = new Date();
            const next24h = new Date(now.getTime() + (24 * 60 * 60 * 1000));
            
            const upcomingBookings = confirmedBookings.filter(booking => {
                const travelDate = parseTravelDate(booking.trip.travelDate, booking.trip.travelHour, booking.trip.travelMinute);
                return travelDate >= now && travelDate <= next24h;
            });
            
            countDisplay.textContent = `${upcomingBookings.length} confirmed`;
            
            if (upcomingBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>üìÖ No Bookings in Next 24 Hours</h3>
                            <p>Confirmed bookings for the next 24 hours will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by travel date/time
            upcomingBookings.sort((a, b) => {
                const dateA = parseTravelDate(a.trip.travelDate, a.trip.travelHour, a.trip.travelMinute);
                const dateB = parseTravelDate(b.trip.travelDate, b.trip.travelHour, b.trip.travelMinute);
                return dateA - dateB;
            });
            
            // Generate table rows
            let tableHTML = '';
            
            upcomingBookings.forEach(booking => {
                const travelDate = parseTravelDate(booking.trip.travelDate, booking.trip.travelHour, booking.trip.travelMinute);
                const formattedDate = travelDate.toLocaleDateString('nl-BE');
                const formattedTime = `${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                
                const hasIndividualTrips = booking.trip?.tripType === 'heen' || booking.trip?.tripType === 'terug';
                let total;
                
                if (hasIndividualTrips) {
                    // EXACT STAP 3 PRICING LOGIC - MARCEL APPROVED
                    const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                    let heenTotaal, terugTotaal;
                    
                    if (step2FinalPrice > 0) {
                        finalTotalPrice = step2FinalPrice;
                        
                        // Find Meet & Greet price for correct distribution (EXACT STAP 3 logic)
                        let meetGreetPrice = 0;
                        const surchargeData = booking.surcharges;
                        if (surchargeData && surchargeData.selectedSurcharges) {
                            for (const [key, value] of Object.entries(surchargeData.selectedSurcharges)) {
                                if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                    if (typeof value === 'object' && value.price) {
                                        meetGreetPrice = parseFloat(value.price) || 0;
                                    } else if (typeof value === 'number') {
                                        meetGreetPrice = value;
                                    }
                                    break;
                                }
                            }
                        }
                        
                        // Calculate exactly like STAP 3
                        if (meetGreetPrice > 0) {
                            const basePricePerTrip = (step2FinalPrice - meetGreetPrice) / 2;
                            heenTotaal = basePricePerTrip;
                            terugTotaal = basePricePerTrip + meetGreetPrice;
                        } else {
                            heenTotaal = step2FinalPrice / 2;
                            terugTotaal = step2FinalPrice / 2;
                        }
                    } else {
                        // Fallback if no step2 price
                        heenTotaal = finalTotalPrice / 2;
                        terugTotaal = finalTotalPrice / 2;
                    }
                    
                    if (booking.trip.tripType === 'heen') {
                        total = heenTotaal.toFixed(2);
                    } else {
                        total = terugTotaal.toFixed(2);
                    }
                } else {
                    total = parseFloat(booking.totalPrice || 50).toFixed(2);
                }
                
                console.log(`üí∞ Next 24h price (1st function): ‚Ç¨${total} for booking ${booking.bookingId}`);
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="table-cell">
                            <div style="display: flex; gap: 5px;">
                                <button style="background: transparent; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 4px; cursor: pointer;" onclick="showBookingOverview('${booking.bookingId}', '${booking.trip.tripType || 'heen'}')" title="View Details">
                                    üëÅ
                                </button>
                                <button style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="deleteConfirmedBooking('${booking.bookingId}')" title="Delete">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text">${booking.trip.fromLocation} ‚Üí ${booking.trip.toLocation}</div>
                            <div class="small-text">üìû ${booking.customer.phone}</div>
                            ${booking.trip.tripType ? `<div style="font-size: 11px; color: #007bff; font-weight: 500;">${booking.trip.tripType === 'heen' ? 'üîÑ HEEN' : 'üîÑ TERUG'}</div>` : ''}
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${formattedDate}</div>
                            <div style="color: #666; font-size: 12px;">${formattedTime}</div>
                        </td>
                        <td class="table-cell">
                            <select style="padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 12px; background: #28a745; color: white; font-weight: 500;" onchange="updateBookingStatus('${booking.bookingId}', this.value)">
                                <option value="Confirmed" selected>Confirmed</option>
                                <option value="Completed">Completed</option>
                                <option value="Cancelled">Cancelled</option>
                                <option value="No Show">No Show</option>
                            </select>
                        </td>
                        <td class="table-cell">
                            <div>${booking.driver || 'Not assigned'}</div>
                        </td>
                        <td class="table-cell">
                            <div>${booking.vehicle?.vehicle?.name || 'Saloon'}</div>
                        </td>
                        <td class="table-cell">
                            <div class="small-text">${booking.specialInstructions || '-'}</div>
                        </td>
                        <td class="table-cell">
                            <div style="font-weight: 500; color: #28a745;">‚Ç¨${total}</div>
                        </td>
                        <td class="table-cell" style="text-align: center; padding: 8px;">
                            ${(() => {
                                // Detect country from pickup and destination addresses
                                const fromCountry = detectCountryFromAddress(booking.trip.fromLocation);
                                const toCountry = detectCountryFromAddress(booking.trip.toLocation);
                                const country = fromCountry;
                                const countryInfo = getCountryInfo(country);
                                
                                // Check if cross-border
                                const isCrossBorder = fromCountry !== toCountry;
                                const crossBorderText = isCrossBorder ? '<br><small style="color: #dc3545;">Cross-border</small>' : '';
                                
                                return `<div style="text-align: center;">
                                    <span style="font-size: 16px;">${countryInfo.flag}</span>
                                    <div style="font-weight: bold; color: ${countryInfo.color};">${countryInfo.name}</div>
                                    ${crossBorderText}
                                </div>`;
                            })()}
                        </td>
                        <td class="table-cell" style="text-align: center; padding: 8px;">
                            <div style="display: flex; gap: 4px; justify-content: center;">
                                <button onclick="dispatchAssignDriver('${booking.bookingId}')" 
                                        style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                        title="Assign to specific driver">
                                    Assign
                                </button>
                                <button onclick="dispatchBroadcastRide('${booking.bookingId}')" 
                                        style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                        title="Broadcast to all drivers">
                                    Broadcast
                                </button>
                                <button onclick="dispatchAutoAssign('${booking.bookingId}')" 
                                        style="background: #ffc107; color: black; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;"
                                        title="Auto-assign within 24h">
                                    Auto
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        // }
        */

        // Cancelled Bookings Functions
        function loadCancelledBookings() {
            console.log('‚ùå Loading cancelled bookings...');
            
            const tableBody = document.getElementById('cancelledTableBody');
            const countDisplay = document.getElementById('cancelledCount');
            
            if (!tableBody) {
                console.error('‚ùå Cancelled table body not found');
                return;
            }
            
            // Get cancelled bookings from localStorage
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            console.log('‚ùå Found cancelled bookings:', cancelledBookings.length);
            
            countDisplay.textContent = `${cancelledBookings.length} cancelled`;
            
            if (cancelledBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h3>‚ùå No Cancelled Bookings</h3>
                            <p>Cancelled and deleted bookings will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Sort by cancelled date (most recent first)
            cancelledBookings.sort((a, b) => {
                const dateA = new Date(a.cancelledAt || a.lastUpdated);
                const dateB = new Date(b.cancelledAt || b.lastUpdated);
                return dateB - dateA;
            });
            
            // Generate table rows
            let tableHTML = '';
            
            cancelledBookings.forEach(booking => {
                const travelDate = parseTravelDate(booking.trip.travelDate, booking.trip.travelHour, booking.trip.travelMinute);
                const formattedDate = travelDate.toLocaleDateString('nl-BE');
                const formattedTime = travelDate.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
                
                const cancelledDate = new Date(booking.cancelledAt || booking.lastUpdated);
                const formattedCancelledDate = cancelledDate.toLocaleDateString('nl-BE');
                
                // NIEUWE SPLIT PRICING VOOR CANCELLED - zelfde logica als Unconfirmed
                const vehiclePrice = booking.vehicle?.pricing?.totalPrice || booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00;
                const isReturnTrip = booking.trip.returnActive === 'true' || booking.trip.returnActive === true;
                
                let total, priceDisplayHTML;
                
                if (isReturnTrip) {
                    // Voor heen en terug: ‚Ç¨100 wordt ‚Ç¨50 heen + ‚Ç¨50 terug
                    // MARCEL FIX: Bepaal finale prijs (zoals andere secties)
                    const step2FinalPrice = parseFloat(booking.finalPrice || booking.totalPrice || 0);
                    const originalBasePrice = step2FinalPrice || vehiclePrice;
                    const heenBasePrice = originalBasePrice / 2;
                    const terugBasePrice = originalBasePrice / 2;
                    
                    // Bepaal luchthaven pickup voor Meet & Greet
                    const fromAirport = booking.trip.fromLocation?.toLowerCase().includes('airport') || 
                                      booking.trip.fromLocation?.toLowerCase().includes('luchthaven') ||
                                      booking.trip.fromLocation?.toLowerCase().includes('zaventem');
                    const toAirport = booking.trip.toLocation?.toLowerCase().includes('airport') || 
                                    booking.trip.toLocation?.toLowerCase().includes('luchthaven') ||
                                    booking.trip.toLocation?.toLowerCase().includes('zaventem');
                    
                    // Bereken toeslagen per rit
                    let heenSurcharges = 0;
                    let terugSurcharges = 0;
                    
                    if (booking.surcharges && typeof booking.surcharges === 'object') {
                        Object.entries(booking.surcharges).forEach(([key, value]) => {
                            if (key === 'totalSurcharge') return;
                            
                            let itemPrice = 0;
                            if (typeof value === 'object' && value !== null && value.price) {
                                itemPrice = parseFloat(value.price) || 0;
                                const itemQuantity = parseInt(value.quantity) || 1;
                                itemPrice = itemPrice * itemQuantity;
                            } else if (typeof value === 'number' && value > 0) {
                                itemPrice = value;
                            }
                            
                            // Meet & Greet: alleen bij rit die VANAF luchthaven vertrekt
                            if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                if (fromAirport) {
                                    heenSurcharges += itemPrice; // HEEN: vanaf luchthaven
                                } else if (toAirport) {
                                    terugSurcharges += itemPrice; // TERUG: vanaf luchthaven
                                }
                            }
                        });
                    }
                    
                    const heenTotal = heenBasePrice + heenSurcharges;
                    const terugTotal = terugBasePrice + terugSurcharges;
                    total = (heenTotal + terugTotal).toFixed(2);
                    
                    priceDisplayHTML = `
                        <div style="font-weight: 500; text-decoration: line-through; color: #6c757d;">‚Ç¨${(parseFloat(total)/2).toFixed(2)}</div>
                        <div style="font-size: 10px; color: #999; margin-top: 1px; text-decoration: line-through;">
                            üîÑ H: ‚Ç¨${heenTotal.toFixed(2)}<br>
                            üîÑ T: ‚Ç¨${terugTotal.toFixed(2)}
                        </div>
                    `;
                } else {
                    // Enkele rit: normale berekening
                    const surchargesTotal = booking.surcharges?.totalSurcharge || 0;
                    // MARCEL FIX: Gebruik finalTotalPrice (al inclusief surcharges)
                    total = finalTotalPrice.toFixed(2);
                    priceDisplayHTML = `<div style="font-weight: 500; text-decoration: line-through; color: #6c757d;">‚Ç¨${total}</div>`;
                }
                
                const reason = booking.cancellationReason || 'Manual cancellation';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6; background: #fef5e7;">
                        <td class="table-cell" style="text-align: center;">
                            <button style="background: transparent; border: 1px solid #dee2e6; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="viewBookingDetails('${booking.bookingId}')">
                                üëÅÔ∏è View
                            </button>
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text">${booking.trip.fromLocation} ‚Üí ${booking.trip.toLocation}</div>
                            <div class="small-text">üìû ${booking.customer.phone}</div>
                            ${booking.trip.tripType ? `<div style="font-size: 11px; color: #007bff; font-weight: 500;">${booking.trip.tripType === 'heen' ? 'üîÑ HEEN' : 'üîÑ TERUG'}</div>` : ''}
                        </td>
                        <td class="table-cell">
                            <div>${formattedDate}</div>
                            <div style="color: #666; font-size: 12px;">${formattedTime}</div>
                        </td>
                        <td class="table-cell">
                            <div class="status-badge cancelled">‚ùå Cancelled</div>
                            <div class="small-text">${formattedCancelledDate}</div>
                        </td>
                        <td class="table-cell">
                            <div style="color: #dc3545; font-size: 12px;">No driver assigned</div>
                            <button style="background: transparent; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 11px; margin-top: 2px;" onclick="restoreBooking('${booking.bookingId}')">
                                ‚Ü©Ô∏è Restore
                            </button>
                        </td>
                        <td class="table-cell">
                            <div>${booking.vehicle?.vehicle?.name || 'Saloon'}</div>
                        </td>
                        <td class="table-cell">
                            <div class="small-text">${reason}</div>
                        </td>
                        <td class="table-cell" style="text-align: left;">
                            ${priceDisplayHTML}
                        </td>
                        <td class="table-cell" style="text-align: center;">
                            <button style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="sendEmail('${booking.bookingId}')">
                                ‚úâÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // Helper Functions
        function parseTravelDate(dateString, hour, minute) {
            // Parse DD/MM/YYYY format
            const dateParts = dateString.split('/');
            if (dateParts.length === 3) {
                const day = parseInt(dateParts[0]);
                const month = parseInt(dateParts[1]) - 1; // Month is 0-indexed
                const year = parseInt(dateParts[2]);
                const hourInt = parseInt(hour || 0);
                const minuteInt = parseInt(minute || 0);
                
                return new Date(year, month, day, hourInt, minuteInt);
            }
            return new Date();
        }

        function editConfirmedBooking(bookingId) {
            console.log('üìù Editing confirmed booking:', bookingId);
            
            // Find booking in confirmed list
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const booking = confirmedBookings.find(b => b.bookingId === bookingId);
            
            if (booking) {
                currentEditingBooking = booking;
                openBookingEditModal(booking);
            } else {
                alert('‚ùå Booking not found');
            }
        }

        function restoreBooking(bookingId) {
            if (!confirm(`Restore booking ${bookingId} to unconfirmed status?`)) {
                return;
            }
            
            // Move from cancelled back to unconfirmed
            let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            const bookingIndex = cancelledBookings.findIndex(b => b.bookingId === bookingId);
            if (bookingIndex !== -1) {
                const booking = cancelledBookings[bookingIndex];
                booking.status = 'unconfirmed';
                booking.restoredAt = new Date().toISOString();
                delete booking.cancelledAt;
                delete booking.cancellationReason;
                
                // Move to unconfirmed
                unconfirmedBookings.unshift(booking);
                cancelledBookings.splice(bookingIndex, 1);
                
                // Save back to localStorage
                localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
                localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
                
                // Reload the display
                loadCancelledBookings();
                
                alert(`‚úÖ Booking ${bookingId} restored to unconfirmed status!`);
                console.log('‚Ü©Ô∏è Booking restored:', bookingId);
            }
        }

        function clearAllCancelled() {
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            if (cancelledBookings.length === 0) {
                alert('No cancelled bookings to clear.');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è Permanently delete all ${cancelledBookings.length} cancelled bookings?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            localStorage.setItem('cancelledBookings', JSON.stringify([]));
            loadCancelledBookings();
            
            alert(`‚úÖ All ${cancelledBookings.length} cancelled bookings cleared!`);
            console.log('üóëÔ∏è All cancelled bookings cleared');
        }

        // Email Settings Functions
        function toggleAdminPassword() {
            const passwordInput = document.getElementById('adminSmtpPassword');
            const toggleBtn = event.target;
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = 'üôà';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = 'üëÅ';
            }
        }

        async function sendAdminTestEmail() {
            const testEmail = document.getElementById('adminTestEmail').value;
            if (!testEmail) {
                showAdminEmailStatus('Please enter an email address', 'error');
                return;
            }

            const btn = event.target;
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Sending...';

            try {
                const config = getAdminEmailConfig();
                const response = await fetch('/api/test-email', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ testEmail: testEmail, config: config })
                });

                const result = await response.json();
                
                if (result.success) {
                    showAdminEmailStatus('‚úÖ Test email sent successfully!', 'success');
                } else {
                    showAdminEmailStatus('‚ùå Failed to send test email: ' + result.error, 'error');
                }
            } catch (error) {
                showAdminEmailStatus('‚ùå Error: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function getAdminEmailConfig() {
            const securityValue = document.querySelector('input[name="adminSmtpSecurity"]:checked').value;
            
            return {
                fromName: document.getElementById('adminFromName').value,
                fromEmail: document.getElementById('adminFromEmail').value,
                replyToEmail: document.getElementById('adminReplyToEmail').value,
                adminEmail: document.getElementById('adminAdminEmail').value,
                connectionType: document.getElementById('adminConnectionType').value,
                provider: document.getElementById('adminProvider').value,
                smtpHost: document.getElementById('adminSmtpHost').value,
                smtpPort: document.getElementById('adminSmtpPort').value,
                smtpUsername: document.getElementById('adminSmtpUsername').value,
                smtpPassword: document.getElementById('adminSmtpPassword').value,
                smtpSecurity: securityValue
            };
        }

        function showAdminEmailStatus(message, type) {
            const indicator = document.getElementById('adminEmailStatus');
            indicator.textContent = message;
            
            // Set colors based on type
            if (type === 'success') {
                indicator.style.background = '#d4edda';
                indicator.style.color = '#155724';
                indicator.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                indicator.style.background = '#f8d7da';
                indicator.style.color = '#721c24';
                indicator.style.border = '1px solid #f5c6cb';
            } else {
                indicator.style.background = '#d1ecf1';
                indicator.style.color = '#0c5460';
                indicator.style.border = '1px solid #bee5eb';
            }
            
            indicator.style.display = 'block';
            
            // Hide after 5 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 5000);
        }

        // Email form submission
        document.addEventListener('DOMContentLoaded', function() {
            const emailForm = document.getElementById('adminEmailSettingsForm');
            if (emailForm) {
                emailForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const config = getAdminEmailConfig();
                    
                    if (!config.smtpPassword) {
                        showAdminEmailStatus('‚ùå SMTP password is required', 'error');
                        return;
                    }

                    const btn = document.querySelector('#adminEmailSettingsForm button[type="submit"]');
                    const originalText = btn.textContent;
                    btn.disabled = true;
                    btn.textContent = 'Saving...';

                    try {
                        // Save configuration to localStorage
                        localStorage.setItem('emailConfig', JSON.stringify(config));
                        
                        // Update status display
                        document.getElementById('configStatus').textContent = 'Configured ‚úÖ';
                        document.getElementById('configHost').textContent = config.smtpHost;
                        document.getElementById('configEmail').textContent = config.fromEmail;
                        
                        showAdminEmailStatus('‚úÖ Email configuration saved successfully!', 'success');
                    } catch (error) {
                        showAdminEmailStatus('‚ùå Error saving configuration: ' + error.message, 'error');
                    } finally {
                        btn.disabled = false;
                        btn.textContent = originalText;
                    }
                });
            }
        });

        // Status Dropdown Functions
        function toggleStatusDropdown(bookingId) {
            console.log('üîç Toggling dropdown for booking:', bookingId);
            const dropdown = document.getElementById(`statusDropdown_${bookingId}`);
            const badge = document.getElementById(`statusBadge_${bookingId}`);
            
            if (!dropdown || !badge) {
                console.error('‚ùå Dropdown or badge not found for booking:', bookingId);
                return;
            }
            
            console.log('üìã Dropdown element found:', dropdown);
            
            // Close all other dropdowns first
            document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                if (menu.id !== `statusDropdown_${bookingId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Calculate position for fixed positioning
            const rect = badge.getBoundingClientRect();
            const isOpen = dropdown.classList.contains('show');
            
            if (!isOpen) {
                // Position dropdown below the badge
                dropdown.style.top = (rect.bottom + 4) + 'px';
                dropdown.style.left = rect.left + 'px';
                dropdown.classList.add('show');
                console.log('‚úÖ Dropdown opened at position:', rect.left, rect.bottom + 4);
            } else {
                dropdown.classList.remove('show');
                console.log('‚úÖ Dropdown closed');
            }
        }

        // Delete confirmed booking function
        function deleteConfirmedBooking(bookingId) {
            if (!confirm('‚ö†Ô∏è Are you sure you want to delete this booking?\n\nThis action cannot be undone.')) {
                return;
            }
            
            console.log('üóëÔ∏è Deleting confirmed booking:', bookingId);
            
            // Get confirmed bookings
            let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            
            // Find booking to delete
            const bookingIndex = confirmedBookings.findIndex(b => b.bookingId === bookingId);
            
            if (bookingIndex === -1) {
                alert('‚ùå Booking not found');
                return;
            }
            
            // Remove booking from confirmed list
            const deletedBooking = confirmedBookings.splice(bookingIndex, 1)[0];
            
            // Save updated confirmed bookings
            localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            
            // Add to cancelled bookings for record keeping
            let cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            deletedBooking.cancelledAt = new Date().toISOString();
            deletedBooking.cancelledBy = 'admin';
            deletedBooking.status = 'Cancelled';
            cancelledBookings.unshift(deletedBooking);
            localStorage.setItem('cancelledBookings', JSON.stringify(cancelledBookings));
            
            console.log('‚úÖ Booking deleted and moved to cancelled list');
            
            // Refresh Next 24h view
            if (typeof loadNext24hBookings === 'function') {
                loadNext24hBookings();
            }
            
            alert('‚úÖ Booking deleted successfully');
        }

        function getStatusDisplayName(status) {
            const statusNames = {
                'unconfirmed': 'Unconfirmed',
                'confirmed': 'Confirmed',
                'request_quote': 'Request Quote',
                'assigned': 'Assigned',
                'job_accepted': 'Job Accepted',
                'job_rejected': 'Job Rejected',
                'on_route': 'On Route',
                'arrived': 'Arrived',
                'on_board': 'On Board',
                'no_show': 'No Show',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'driver_cancelled': 'Driver Cancelled',
                'incomplete': 'Incomplete'
            };
            return statusNames[status] || status;
        }

        function getStatusClass(status) {
            if (['confirmed', 'job_accepted', 'completed'].includes(status)) {
                return 'confirmed';
            } else if (['cancelled', 'driver_cancelled', 'job_rejected', 'no_show'].includes(status)) {
                return 'cancelled';
            }
            return ''; // Default (unconfirmed) styling
        }

        function updateDropdownSelection(bookingId, currentStatus) {
            const dropdown = document.getElementById(`statusDropdown_${bookingId}`);
            if (!dropdown) return;
            
            // Update all options
            const options = dropdown.querySelectorAll('.status-option');
            options.forEach(option => {
                option.classList.remove('selected');
                if (option.textContent.trim().replace('‚úì ', '') === getStatusDisplayName(currentStatus)) {
                    option.classList.add('selected');
                    option.innerHTML = `‚úì ${getStatusDisplayName(currentStatus)}`;
                } else {
                    option.innerHTML = option.textContent.replace('‚úì ', '');
                }
            });
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.status-dropdown')) {
                document.querySelectorAll('.status-dropdown-menu').forEach(menu => {
                    menu.classList.remove('show');
                });
            }
        });

        // Dispatch Calendar Variables
        let dispatchCurrentDate = new Date();
        let dispatchSelectedDate = null;
        let dispatchReturnCurrentDate = new Date();
        let dispatchReturnSelectedDate = null;
        let dispatchExtraStopCount = 0;
        let dispatchRetourActive = false;

        // Initialize Dispatch Calendar and Time
        function initDispatchDateTime() {
            // Populate hour options (00-23)
            const hourSelect = document.getElementById('dispatchHour');
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = hour;
                hourSelect.appendChild(option);
            }
            
            // Populate minute options (00, 15, 30, 45)
            const minuteSelect = document.getElementById('dispatchMinute');
            ['00', '15', '30', '45'].forEach(minute => {
                const option = document.createElement('option');
                option.value = minute;
                option.textContent = minute;
                minuteSelect.appendChild(option);
            });
            
            // Set default to current time + 1 hour
            const now = new Date();
            const defaultHour = (now.getHours() + 1) % 24;
            hourSelect.value = defaultHour.toString().padStart(2, '0');
            minuteSelect.value = '00';
            
            // Initialize calendar
            generateDispatchCalendar();
            
            // Initialize return time selectors
            initDispatchReturnTime();
        }

        function initDispatchReturnTime() {
            // Populate return hour options (00-23)
            const returnHourSelect = document.getElementById('dispatchReturnHour');
            for (let i = 0; i < 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const option = document.createElement('option');
                option.value = hour;
                option.textContent = hour;
                returnHourSelect.appendChild(option);
            }
            
            // Populate return minute options (00, 15, 30, 45)
            const returnMinuteSelect = document.getElementById('dispatchReturnMinute');
            ['00', '15', '30', '45'].forEach(minute => {
                const option = document.createElement('option');
                option.value = minute;
                option.textContent = minute;
                returnMinuteSelect.appendChild(option);
            });
        }

        // Extra Stops Functions
        function addDispatchExtraStop() {
            if (dispatchExtraStopCount >= 7) {
                alert('Maximum 7 extra stops allowed');
                return;
            }
            
            dispatchExtraStopCount++;
            const container = document.getElementById('dispatchExtraStopsContainer');
            
            const stopDiv = document.createElement('div');
            stopDiv.id = `dispatchExtraStop${dispatchExtraStopCount}`;
            stopDiv.style.cssText = 'display: flex; gap: 15px; align-items: center;';
            
            stopDiv.innerHTML = `
                <input type="text" id="dispatchExtraStopAddress${dispatchExtraStopCount}" placeholder="üìç Extra stop ${dispatchExtraStopCount}..." 
                       style="flex: 1; padding: 18px; border: 2px solid #e9ecef; border-radius: 10px; font-size: 16px; 
                              transition: all 0.3s; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.05);"
                       onfocus="this.style.borderColor='#007bff'; this.style.boxShadow='0 4px 15px rgba(0,123,255,0.15)'"
                       onblur="this.style.borderColor='#e9ecef'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'">
                <button type="button" onclick="removeDispatchExtraStop(${dispatchExtraStopCount})" 
                        style="background: #dc3545; color: white; border: none; padding: 18px; border-radius: 10px; 
                               cursor: pointer; transition: all 0.3s; font-size: 16px; font-weight: 600;"
                        onmouseover="this.style.background='#c82333'"
                        onmouseout="this.style.background='#dc3545'">
                    ‚ùå
                </button>
            `;
            
            container.appendChild(stopDiv);
            
            console.log('Added extra stop:', dispatchExtraStopCount);
        }

        function removeDispatchExtraStop(stopNumber) {
            const stopDiv = document.getElementById(`dispatchExtraStop${stopNumber}`);
            if (stopDiv) {
                stopDiv.remove();
                dispatchExtraStopCount--;
                
                // Renumber remaining stops
                const container = document.getElementById('dispatchExtraStopsContainer');
                const remainingStops = container.children;
                
                for (let i = 0; i < remainingStops.length; i++) {
                    const stop = remainingStops[i];
                    const newNumber = i + 1;
                    stop.id = `dispatchExtraStop${newNumber}`;
                    
                    const input = stop.querySelector('input');
                    input.id = `dispatchExtraStopAddress${newNumber}`;
                    input.placeholder = `üìç Extra stop ${newNumber}...`;
                    
                    const button = stop.querySelector('button');
                    button.setAttribute('onclick', `removeDispatchExtraStop(${newNumber})`);
                }
                
                dispatchExtraStopCount = remainingStops.length;
                console.log('Removed extra stop, remaining:', dispatchExtraStopCount);
            }
        }

        // Retour Functions
        function toggleDispatchRetour() {
            dispatchRetourActive = !dispatchRetourActive;
            const details = document.getElementById('dispatchRetourDetails');
            const status = document.getElementById('dispatchRetourStatus');
            const btn = document.getElementById('dispatchRetourBtn');
            
            if (dispatchRetourActive) {
                details.style.display = 'block';
                status.textContent = 'Activated ‚úÖ';
                status.style.color = '#28a745';
                btn.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
            } else {
                details.style.display = 'none';
                status.textContent = 'Not activated';
                status.style.color = '#666';
                btn.style.background = 'linear-gradient(135deg, #2196f3, #1976d2)';
                
                // Clear return values
                document.getElementById('dispatchReturnDate').value = '';
                document.getElementById('dispatchReturnHour').value = '';
                document.getElementById('dispatchReturnMinute').value = '';
                dispatchReturnSelectedDate = null;
            }
            
            console.log('Retour toggled:', dispatchRetourActive);
        }

        function toggleDispatchCalendar() {
            const calendar = document.getElementById('dispatchCalendar');
            const isVisible = calendar.style.display === 'block';
            
            // Close all other calendars/dropdowns
            document.querySelectorAll('[id*="Calendar"]').forEach(cal => {
                if (cal.id !== 'dispatchCalendar') cal.style.display = 'none';
            });
            
            calendar.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                generateDispatchCalendar();
            }
        }

        function generateDispatchCalendar() {
            const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                               'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
            const dayNames = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
            
            const title = document.getElementById('dispatchCalendarTitle');
            const grid = document.getElementById('dispatchCalendarGrid');
            
            title.textContent = `${monthNames[dispatchCurrentDate.getMonth()]} ${dispatchCurrentDate.getFullYear()}`;
            
            // Clear grid
            grid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.cssText = 'font-weight: 600; padding: 8px; color: #666; font-size: 12px;';
                grid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(dispatchCurrentDate.getFullYear(), dispatchCurrentDate.getMonth(), 1);
            const lastDay = new Date(dispatchCurrentDate.getFullYear(), dispatchCurrentDate.getMonth() + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7; // Convert Sunday=0 to Monday=0
            
            // Add empty cells for days before first day
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.style.cssText = 'padding: 8px;';
                grid.appendChild(emptyCell);
            }
            
            // Add days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayCell = document.createElement('div');
                const cellDate = new Date(dispatchCurrentDate.getFullYear(), dispatchCurrentDate.getMonth(), day);
                
                dayCell.textContent = day;
                dayCell.style.cssText = 'padding: 8px; cursor: pointer; border-radius: 6px; transition: all 0.3s; text-align: center; font-size: 14px;';
                
                // Style for today
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.style.background = '#007bff';
                    dayCell.style.color = 'white';
                    dayCell.style.fontWeight = '600';
                }
                
                // Style for selected date
                if (dispatchSelectedDate && cellDate.toDateString() === dispatchSelectedDate.toDateString()) {
                    dayCell.style.background = '#28a745';
                    dayCell.style.color = 'white';
                    dayCell.style.fontWeight = '600';
                }
                
                // Disable past dates
                if (cellDate < today.setHours(0,0,0,0)) {
                    dayCell.style.color = '#ccc';
                    dayCell.style.cursor = 'not-allowed';
                } else {
                    dayCell.addEventListener('click', () => selectDispatchDate(cellDate));
                    dayCell.addEventListener('mouseenter', () => {
                        if (cellDate >= today.setHours(0,0,0,0)) {
                            dayCell.style.background = '#f8f9fa';
                        }
                    });
                    dayCell.addEventListener('mouseleave', () => {
                        if (!dispatchSelectedDate || cellDate.toDateString() !== dispatchSelectedDate.toDateString()) {
                            if (cellDate.toDateString() !== today.toDateString()) {
                                dayCell.style.background = 'transparent';
                            }
                        }
                    });
                }
                
                grid.appendChild(dayCell);
            }
        }

        function changeDispatchMonth(direction) {
            dispatchCurrentDate.setMonth(dispatchCurrentDate.getMonth() + direction);
            generateDispatchCalendar();
        }

        function selectDispatchDate(date) {
            dispatchSelectedDate = new Date(date);
            const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            
            document.getElementById('dispatchDate').value = formattedDate;
            document.getElementById('dispatchCalendar').style.display = 'none';
            
            generateDispatchCalendar(); // Refresh to show selection
        }

        // Return Calendar Functions
        function toggleDispatchReturnCalendar() {
            const calendar = document.getElementById('dispatchReturnCalendar');
            const isVisible = calendar.style.display === 'block';
            
            calendar.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                generateDispatchReturnCalendar();
            }
        }

        function generateDispatchReturnCalendar() {
            const monthNames = ['Januari', 'Februari', 'Maart', 'April', 'Mei', 'Juni',
                               'Juli', 'Augustus', 'September', 'Oktober', 'November', 'December'];
            const dayNames = ['Ma', 'Di', 'Wo', 'Do', 'Vr', 'Za', 'Zo'];
            
            const title = document.getElementById('dispatchReturnCalendarTitle');
            const grid = document.getElementById('dispatchReturnCalendarGrid');
            
            title.textContent = `${monthNames[dispatchReturnCurrentDate.getMonth()]} ${dispatchReturnCurrentDate.getFullYear()}`;
            
            // Clear grid
            grid.innerHTML = '';
            
            // Add day headers
            dayNames.forEach(day => {
                const dayHeader = document.createElement('div');
                dayHeader.textContent = day;
                dayHeader.style.cssText = 'font-weight: 600; padding: 8px; color: #666; font-size: 12px;';
                grid.appendChild(dayHeader);
            });
            
            // Get first day of month and number of days
            const firstDay = new Date(dispatchReturnCurrentDate.getFullYear(), dispatchReturnCurrentDate.getMonth(), 1);
            const lastDay = new Date(dispatchReturnCurrentDate.getFullYear(), dispatchReturnCurrentDate.getMonth() + 1, 0);
            const startDay = (firstDay.getDay() + 6) % 7;
            
            // Add empty cells
            for (let i = 0; i < startDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.style.cssText = 'padding: 8px;';
                grid.appendChild(emptyCell);
            }
            
            // Add days
            const today = new Date();
            for (let day = 1; day <= lastDay.getDate(); day++) {
                const dayCell = document.createElement('div');
                const cellDate = new Date(dispatchReturnCurrentDate.getFullYear(), dispatchReturnCurrentDate.getMonth(), day);
                
                dayCell.textContent = day;
                dayCell.style.cssText = 'padding: 8px; cursor: pointer; border-radius: 6px; transition: all 0.3s; text-align: center; font-size: 14px;';
                
                // Style for today
                if (cellDate.toDateString() === today.toDateString()) {
                    dayCell.style.background = '#2196f3';
                    dayCell.style.color = 'white';
                    dayCell.style.fontWeight = '600';
                }
                
                // Style for selected date
                if (dispatchReturnSelectedDate && cellDate.toDateString() === dispatchReturnSelectedDate.toDateString()) {
                    dayCell.style.background = '#28a745';
                    dayCell.style.color = 'white';
                    dayCell.style.fontWeight = '600';
                }
                
                // Disable past dates
                if (cellDate < today.setHours(0,0,0,0)) {
                    dayCell.style.color = '#ccc';
                    dayCell.style.cursor = 'not-allowed';
                } else {
                    dayCell.addEventListener('click', () => selectDispatchReturnDate(cellDate));
                    dayCell.addEventListener('mouseenter', () => {
                        if (cellDate >= today.setHours(0,0,0,0)) {
                            dayCell.style.background = '#f8f9fa';
                        }
                    });
                    dayCell.addEventListener('mouseleave', () => {
                        if (!dispatchReturnSelectedDate || cellDate.toDateString() !== dispatchReturnSelectedDate.toDateString()) {
                            if (cellDate.toDateString() !== today.toDateString()) {
                                dayCell.style.background = 'transparent';
                            }
                        }
                    });
                }
                
                grid.appendChild(dayCell);
            }
        }

        function changeDispatchReturnMonth(direction) {
            dispatchReturnCurrentDate.setMonth(dispatchReturnCurrentDate.getMonth() + direction);
            generateDispatchReturnCalendar();
        }

        function selectDispatchReturnDate(date) {
            dispatchReturnSelectedDate = new Date(date);
            const formattedDate = `${date.getDate().toString().padStart(2, '0')}/${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getFullYear()}`;
            
            document.getElementById('dispatchReturnDate').value = formattedDate;
            document.getElementById('dispatchReturnCalendar').style.display = 'none';
            
            generateDispatchReturnCalendar();
        }

        // Close calendars when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#dispatchCalendar') && !event.target.closest('#dispatchDate')) {
                document.getElementById('dispatchCalendar').style.display = 'none';
            }
            if (!event.target.closest('#dispatchReturnCalendar') && !event.target.closest('#dispatchReturnDate')) {
                document.getElementById('dispatchReturnCalendar').style.display = 'none';
            }
        });

        // Dispatch Booking Functions
        async function createDispatchBooking(event) {
            event.preventDefault();
            
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '‚è≥ Creating Booking...';
            
            try {
                // Get form data
                const dispatchData = {
                    pickup: document.getElementById('dispatchPickup').value.trim(),
                    destination: document.getElementById('dispatchDestination').value.trim(),
                    date: document.getElementById('dispatchDate').value.trim(),
                    hour: document.getElementById('dispatchHour').value,
                    minute: document.getElementById('dispatchMinute').value,
                    firstName: document.getElementById('dispatchFirstName').value.trim(),
                    lastName: document.getElementById('dispatchLastName').value.trim(),
                    email: document.getElementById('dispatchEmail').value.trim(),
                    phone: document.getElementById('dispatchPhone').value.trim(),
                    passengers: document.getElementById('dispatchPassengers').value,
                    vehicleType: document.getElementById('dispatchVehicleType').value,
                    paymentMethod: document.getElementById('dispatchPaymentMethod').value,
                    extraStopCount: dispatchExtraStopCount,
                    returnActive: dispatchRetourActive,
                    returnDate: dispatchRetourActive ? document.getElementById('dispatchReturnDate').value.trim() : '',
                    returnHour: dispatchRetourActive ? document.getElementById('dispatchReturnHour').value : '',
                    returnMinute: dispatchRetourActive ? document.getElementById('dispatchReturnMinute').value : ''
                };
                
                // Get extra stops
                const extraStops = [];
                for (let i = 1; i <= dispatchExtraStopCount; i++) {
                    const stopInput = document.getElementById(`dispatchExtraStopAddress${i}`);
                    if (stopInput && stopInput.value.trim()) {
                        extraStops.push(stopInput.value.trim());
                    }
                }
                
                // Validate required fields
                if (!dispatchData.pickup || !dispatchData.destination || !dispatchData.date || 
                    !dispatchData.hour || !dispatchData.minute || !dispatchData.firstName || 
                    !dispatchData.lastName || !dispatchData.email || !dispatchData.phone) {
                    showDispatchStatus('‚ùå Please fill in all required fields', 'error');
                    return;
                }
                
                // Get vehicle data from localStorage
                const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
                const selectedVehicle = vehicles.find(v => v.id === dispatchData.vehicleType) || 
                                      { id: dispatchData.vehicleType, name: dispatchData.vehicleType, price: 50.00 };
                
                // Get pricing data
                const pricingData = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
                const pricing = pricingData[dispatchData.vehicleType] || { minimumPrice: 50.00, pricePerKm: 2.50 };
                
                // Generate booking ID
                const bookingId = 'BK' + Date.now();
                
                // Create main booking object (heen trip)
                const mainBooking = {
                    bookingId: bookingId,
                    customer: {
                        firstName: dispatchData.firstName,
                        lastName: dispatchData.lastName,
                        email: dispatchData.email,
                        phone: dispatchData.phone,
                        passengers: dispatchData.passengers,
                        paymentMethod: dispatchData.paymentMethod,
                        koffers: 1, // Default
                        handbagage: 1 // Default
                    },
                    trip: {
                        fromLocation: dispatchData.pickup,
                        toLocation: dispatchData.destination,
                        travelDate: dispatchData.date,
                        travelHour: dispatchData.hour,
                        travelMinute: dispatchData.minute,
                        extraStopCount: dispatchData.extraStopCount,
                        extraStops: extraStops,
                        returnActive: 'false', // Main trip doesn't have return status
                        tripType: 'heen',
                        direction: 'outbound'
                    },
                    vehicle: {
                        vehicle: selectedVehicle,
                        pricing: pricing
                    },
                    status: 'confirmed', // Admin bookings are pre-confirmed
                    source: 'dispatch', // Mark as dispatch booking
                    createdAt: new Date().toISOString(),
                    confirmedAt: new Date().toISOString(),
                    bookingDate: new Date().toISOString(),
                    lastUpdated: new Date().toISOString()
                };
                
                // Save main booking to confirmed bookings
                let confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
                confirmedBookings.unshift(mainBooking);
                
                // Create return booking if return trip is active
                let returnBooking = null;
                if (dispatchData.returnActive && dispatchData.returnDate && dispatchData.returnHour && dispatchData.returnMinute) {
                    const returnBookingId = 'BK' + (Date.now() + 1); // Slightly different timestamp
                    
                    returnBooking = {
                        bookingId: returnBookingId,
                        customer: {
                            firstName: dispatchData.firstName,
                            lastName: dispatchData.lastName,
                            email: dispatchData.email,
                            phone: dispatchData.phone,
                            passengers: dispatchData.passengers,
                            paymentMethod: dispatchData.paymentMethod,
                            koffers: 1, // Default
                            handbagage: 1 // Default
                        },
                        trip: {
                            fromLocation: dispatchData.destination, // Reversed: from destination back to origin
                            toLocation: dispatchData.pickup, // Reversed: to origin from destination
                            travelDate: dispatchData.returnDate,
                            travelHour: dispatchData.returnHour,
                            travelMinute: dispatchData.returnMinute,
                            extraStopCount: 0, // No extra stops for return trip
                            extraStops: [],
                            returnActive: 'false', // Return trip doesn't have another return
                            tripType: 'terug',
                            direction: 'inbound',
                            relatedBookingId: bookingId // Link to main booking
                        },
                        vehicle: {
                            vehicle: selectedVehicle,
                            pricing: pricing
                        },
                        status: 'confirmed', // Admin bookings are pre-confirmed
                        source: 'dispatch', // Mark as dispatch booking
                        createdAt: new Date().toISOString(),
                        confirmedAt: new Date().toISOString(),
                        bookingDate: new Date().toISOString(),
                        lastUpdated: new Date().toISOString()
                    };
                    
                    // Add return booking to confirmed bookings
                    confirmedBookings.unshift(returnBooking);
                }
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                
                // Send email notification for main booking
                try {
                    const emailResponse = await fetch('http://localhost:3001/api/send-booking-email', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(mainBooking)
                    });
                    
                    // Send email for return booking if exists
                    if (returnBooking) {
                        const returnEmailResponse = await fetch('http://localhost:3001/api/send-booking-email', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(returnBooking)
                        });
                    }
                    
                    if (emailResponse.ok) {
                        console.log('‚úÖ Email notifications sent successfully');
                    } else {
                        console.log('‚ö†Ô∏è Email sending failed, but booking created');
                    }
                } catch (emailError) {
                    console.log('‚ö†Ô∏è Email server not available, but booking created');
                }
                
                // Show success message
                let successMessage = `‚úÖ Dispatch Booking${returnBooking ? 's' : ''} Created Successfully!

HEEN REIS: ${bookingId}
Van: ${dispatchData.pickup}
Naar: ${dispatchData.destination}
Datum: ${dispatchData.date} om ${dispatchData.hour}:${dispatchData.minute}`;

                if (returnBooking) {
                    successMessage += `

TERUG REIS: ${returnBooking.bookingId}
Van: ${dispatchData.destination}
Naar: ${dispatchData.pickup}
Datum: ${dispatchData.returnDate} om ${dispatchData.returnHour}:${dispatchData.returnMinute}`;
                }

                successMessage += `

Both bookings added to confirmed bookings list!`;
                
                showDispatchStatus(successMessage, 'success');
                
                // Clear form
                document.getElementById('dispatchBookingForm').reset();
                
                // Reset extra stops
                document.getElementById('dispatchExtraStopsContainer').innerHTML = '';
                dispatchExtraStopCount = 0;
                
                // Reset retour
                if (dispatchRetourActive) {
                    toggleDispatchRetour(); // Turn off retour
                }
                
                // Reset selected dates
                dispatchSelectedDate = null;
                dispatchReturnSelectedDate = null;
                
                console.log('‚úÖ Dispatch booking(s) created:', mainBooking.bookingId, returnBooking ? `& ${returnBooking.bookingId}` : '');
                
            } catch (error) {
                console.error('‚ùå Error creating dispatch booking:', error);
                showDispatchStatus('‚ùå Error creating booking: ' + error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        function showDispatchStatus(message, type) {
            const statusDiv = document.getElementById('dispatchStatus');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            
            // Set colors based on type
            if (type === 'success') {
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
            } else if (type === 'error') {
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
            } else {
                statusDiv.style.background = '#d1ecf1';
                statusDiv.style.color = '#0c5460';
                statusDiv.style.border = '1px solid #bee5eb';
            }
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
        }

        // Load functions for all sections
        // Helper function to generate driver dropdown HTML
        function generateDriverDropdown(booking) {
            const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            const assignedDriver = booking.assignedDriver;
            
            let driverOptions = '';
            
            // Add available drivers
            drivers.forEach(driver => {
                const isSelected = assignedDriver && assignedDriver.id === driver.id;
                driverOptions += `
                    <div class="driver-option ${isSelected ? 'selected' : ''}" onclick="assignDriverToBooking('${booking.bookingId}', '${driver.id}', '${driver.name}')">
                        ${isSelected ? '‚úì ' : ''}${driver.name}
                    </div>
                `;
            });
            
            // Add unassign option if driver is assigned
            if (assignedDriver) {
                driverOptions += `
                    <div class="driver-option unassign" onclick="unassignDriver('${booking.bookingId}')">
                        ‚úó Unassign Driver
                    </div>
                `;
            }
            
            const badgeText = assignedDriver ? assignedDriver.name : 'Assign Driver';
            const badgeClass = assignedDriver ? 'assigned' : 'unassigned';
            
            return `
                <div class="driver-dropdown">
                    <span class="driver-badge ${badgeClass}" onclick="toggleDriverDropdown('${booking.bookingId}')" id="driverBadge_${booking.bookingId}">
                        ${badgeText}
                    </span>
                    <div class="driver-dropdown-menu" id="driverDropdown_${booking.bookingId}">
                        ${driverOptions || '<div class="driver-option" style="color: #6c757d; font-style: italic;">No drivers available</div>'}
                    </div>
                </div>
            `;
        }

        function loadNext24hBookings() {
            console.log('üö® NIEUWE VERSIE GELADEN - TEST 123');
            
            const tableBody = document.getElementById('next24hTableBody');
            if (!tableBody) {
                console.error('‚ùå Next 24h table body not found');
                return;
            }
            
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            console.log(`üîç DEBUG: Found ${confirmedBookings.length} confirmed bookings:`, confirmedBookings);
            document.getElementById('next24hCount').textContent = `${confirmedBookings.length} confirmed`;
            
            if (confirmedBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <h3>üìã No Confirmed Bookings</h3>
                            <p>Confirmed bookings will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            confirmedBookings.forEach((booking, index) => {
                // üö® KOPIEER EXACT DEZELFDE LOGICA ALS UNCONFIRMED
                let finalTotalPrice = 0;
                
                // Try different sources in priority order (EXACT same as Unconfirmed)
                const step2Price = localStorage.getItem('step2FinalTotalPrice');
                if (step2Price && parseFloat(step2Price) > 0) {
                    finalTotalPrice = parseFloat(step2Price);
                } else if (booking.finalPrice) {
                    finalTotalPrice = parseFloat(booking.finalPrice);
                } else if (booking.totalPrice) {
                    finalTotalPrice = parseFloat(booking.totalPrice);
                } else {
                    // Fallback to vehicle pricing
                    finalTotalPrice = parseFloat(booking.vehicle?.pricing?.totalPrice || booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00);
                }
                
                const hasIndividualTrips = booking.trip?.tripType === 'heen' || booking.trip?.tripType === 'terug';
                
                let total;
                
                if (hasIndividualTrips) {
                    // EXACT STAP 3 PRICING LOGIC - MARCEL APPROVED
                    const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                    let heenTotaal, terugTotaal;
                    
                    if (step2FinalPrice > 0) {
                        finalTotalPrice = step2FinalPrice;
                        
                        // Find Meet & Greet price for correct distribution (EXACT STAP 3 logic)
                        let meetGreetPrice = 0;
                        const surchargeData = booking.surcharges;
                        if (surchargeData && surchargeData.selectedSurcharges) {
                            for (const [key, value] of Object.entries(surchargeData.selectedSurcharges)) {
                                if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                    if (typeof value === 'object' && value.price) {
                                        meetGreetPrice = parseFloat(value.price) || 0;
                                    } else if (typeof value === 'number') {
                                        meetGreetPrice = value;
                                    }
                                    break;
                                }
                            }
                        }
                        
                        // Calculate exactly like STAP 3
                        if (meetGreetPrice > 0) {
                            const basePricePerTrip = (step2FinalPrice - meetGreetPrice) / 2;
                            heenTotaal = basePricePerTrip;
                            terugTotaal = basePricePerTrip + meetGreetPrice;
                        } else {
                            heenTotaal = step2FinalPrice / 2;
                            terugTotaal = step2FinalPrice / 2;
                        }
                    } else {
                        // Fallback if no step2 price
                        heenTotaal = finalTotalPrice / 2;
                        terugTotaal = finalTotalPrice / 2;
                    }
                    
                    if (booking.trip.tripType === 'heen') {
                        total = heenTotaal.toFixed(2);
                    } else {
                        total = terugTotaal.toFixed(2);
                    }
                } else {
                    total = finalTotalPrice.toFixed(2);
                }
                
                console.log(`üîç COMPLETE DEBUG for booking ${booking.bookingId}:`);
                console.log(`   step2Price: "${step2Price}"`);
                console.log(`   booking.finalPrice: "${booking.finalPrice}"`);
                console.log(`   booking.totalPrice: "${booking.totalPrice}"`);
                console.log(`   booking.surcharges:`, booking.surcharges);
                console.log(`   finalTotalPrice chosen: ‚Ç¨${finalTotalPrice}`);
                console.log(`   final total displayed: ‚Ç¨${total}`);
                
                const travelDateTime = `${booking.trip.travelDate} ${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="table-cell" style="text-align: center;">
                            ${(() => {
                                const country = detectCountryFromAddress(booking.trip.fromLocation);
                                const countryInfo = getCountryInfo(country);
                                const isCrossBorder = detectCountryFromAddress(booking.trip.fromLocation) !== detectCountryFromAddress(booking.trip.toLocation);
                                return `
                                    <div style="display: flex; flex-direction: column; align-items: center; gap: 2px;">
                                        <span style="font-size: 20px;" title="${countryInfo.name}">${countryInfo.flag}</span>
                                        ${isCrossBorder ? '<div style="font-size: 9px; color: #dc3545;">Cross</div>' : ''}
                                        <button style="background: transparent; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="openProfessionalBookingEdit('${booking.bookingId}')" title="View Details">
                                            üëÅ
                                        </button>
                                    </div>
                                `;
                            })()}
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text">üìû ${booking.customer.phone}</div>
                            ${booking.trip.tripType ? `<div style="font-size: 11px; color: #007bff; font-weight: 500;">${booking.trip.tripType === 'heen' ? 'üîÑ HEEN' : 'üîÑ TERUG'}</div>` : ''}
                        </td>
                        <td class="table-cell">
                            <div class="font-medium">${travelDateTime}</div>
                        </td>
                        <td class="table-cell">
                            <div class="status-dropdown">
                                <span class="status-badge ${booking.status === 'confirmed' || !booking.status ? 'confirmed' : ''}" onclick="toggleStatusDropdown('${booking.bookingId}')" id="statusBadge_${booking.bookingId}" style="font-size: 11px; padding: 4px 8px;">
                                    ${booking.status === 'confirmed' || !booking.status ? 'Confirmed' : getStatusDisplayName(booking.status)}
                                </span>
                                <div class="status-dropdown-menu" id="statusDropdown_${booking.bookingId}">
                                    <div class="status-option ${booking.status === 'unconfirmed' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'unconfirmed')">
                                        ${booking.status === 'unconfirmed' ? '‚úì ' : ''}Unconfirmed
                                    </div>
                                    <div class="status-option ${booking.status === 'confirmed' || !booking.status ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'confirmed')">
                                        ${booking.status === 'confirmed' || !booking.status ? '‚úì ' : ''}Confirmed
                                    </div>
                                    <div class="status-option ${booking.status === 'request_quote' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'request_quote')">
                                        ${booking.status === 'request_quote' ? '‚úì ' : ''}Request Quote
                                    </div>
                                    <div class="status-option ${booking.status === 'assigned' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'assigned')">
                                        ${booking.status === 'assigned' ? '‚úì ' : ''}Assigned
                                    </div>
                                    <div class="status-option ${booking.status === 'job_accepted' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'job_accepted')">
                                        ${booking.status === 'job_accepted' ? '‚úì ' : ''}Job Accepted
                                    </div>
                                    <div class="status-option ${booking.status === 'job_rejected' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'job_rejected')">
                                        ${booking.status === 'job_rejected' ? '‚úì ' : ''}Job Rejected
                                    </div>
                                    <div class="status-option ${booking.status === 'on_route' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'on_route')">
                                        ${booking.status === 'on_route' ? '‚úì ' : ''}On Route
                                    </div>
                                    <div class="status-option ${booking.status === 'arrived' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'arrived')">
                                        ${booking.status === 'arrived' ? '‚úì ' : ''}Arrived
                                    </div>
                                    <div class="status-option ${booking.status === 'on_board' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'on_board')">
                                        ${booking.status === 'on_board' ? '‚úì ' : ''}On Board
                                    </div>
                                    <div class="status-option ${booking.status === 'no_show' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'no_show')">
                                        ${booking.status === 'no_show' ? '‚úì ' : ''}No Show
                                    </div>
                                    <div class="status-option ${booking.status === 'completed' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'completed')">
                                        ${booking.status === 'completed' ? '‚úì ' : ''}Completed
                                    </div>
                                    <div class="status-option ${booking.status === 'cancelled' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'cancelled')">
                                        ${booking.status === 'cancelled' ? '‚úì ' : ''}Cancelled
                                    </div>
                                    <div class="status-option ${booking.status === 'driver_cancelled' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'driver_cancelled')">
                                        ${booking.status === 'driver_cancelled' ? '‚úì ' : ''}Driver Cancelled
                                    </div>
                                    <div class="status-option ${booking.status === 'incomplete' ? 'selected' : ''}" onclick="changeBookingStatus('${booking.bookingId}', 'incomplete')">
                                        ${booking.status === 'incomplete' ? '‚úì ' : ''}Incomplete
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="table-cell">
                            <select style="padding: 4px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-size: 14px; width: auto; min-width: 120px; max-width: 180px;" onchange="assignDriverToBooking('${booking.bookingId}', this.value)">
                                <option value="">-- Select --</option>
                                <optgroup label="Auto">
                                    <option value="auto-all" ${booking.driver === 'auto-all' ? 'selected' : ''}>All Drivers</option>
                                    <option value="auto-nearby" ${booking.driver === 'auto-nearby' ? 'selected' : ''}>Nearby</option>
                                    <option value="auto-lastminute" ${booking.driver === 'auto-lastminute' ? 'selected' : ''}>Last-Minute</option>
                                </optgroup>
                                <optgroup label="Drivers">
                                    ${getDriverOptionsHTML(booking.driver)}
                                </optgroup>
                            </select>
                        </td>
                        <td class="table-cell">
                            <div>${booking.vehicle?.vehicle?.name || 'Saloon'}</div>
                        </td>
                        <td class="table-cell">
                            <div style="font-size: 12px;">${booking.specialInstructions || '-'}</div>
                        </td>
                        <td class="table-cell" style="text-align: left;">
                            <div style="font-weight: 500; color: #28a745;">‚Ç¨${total}</div>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function loadCompletedBookings() {
            console.log('üìã Loading completed bookings...');
            
            const tableBody = document.getElementById('completedTableBody');
            if (!tableBody) {
                console.error('‚ùå Completed table body not found');
                return;
            }
            
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            document.getElementById('completedCount').textContent = `${completedBookings.length} completed`;
            
            if (completedBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h3>‚úÖ No Completed Bookings</h3>
                            <p>Completed trips will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            let tableHTML = '';
            completedBookings.forEach((booking, index) => {
                const vehiclePrice = booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00;
                const total = parseFloat(vehiclePrice).toFixed(2);
                const travelDateTime = `${booking.trip.travelDate} ${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                const completedDate = new Date(booking.completedAt || booking.lastUpdated);
                const formattedCompletedDate = completedDate.toLocaleDateString('nl-BE');
                
                const fromCountry = detectCountryFromAddress(booking.trip.fromLocation);
                const toCountry = detectCountryFromAddress(booking.trip.toLocation);
                const isCrossBorder = fromCountry !== toCountry;
                const countryInfo = getCountryInfo(fromCountry);
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="table-cell" style="text-align: center; padding: 8px 4px;">
                            <div style="position: relative; display: inline-block;">
                                ${countryInfo.flag}
                                ${isCrossBorder ? '<div style="font-size: 10px; color: #ff6b6b;">üåê</div>' : ''}
                                <button onclick="viewBookingDetails('${booking.bookingId}')" style="display: block; background: transparent; border: none; cursor: pointer; margin-top: 2px; font-size: 12px;">üëÅ</button>
                            </div>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <div class="font-medium" style="font-size: 13px;">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">üìû ${booking.customer.phone}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">${booking.trip.fromLocation} ‚Üí ${booking.trip.toLocation}</div>
                            ${booking.trip.tripType ? `<div style="font-size: 10px; color: #007bff; font-weight: 500;">${booking.trip.tripType === 'heen' ? 'üîÑ HEEN' : 'üîÑ TERUG'}</div>` : ''}
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <div>${travelDateTime.split(' ')[0]}</div>
                            <div style="font-size: 11px; color: #666;">${travelDateTime.split(' ')[1]}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <span class="status-badge confirmed" style="font-size: 11px; padding: 4px 8px; background: #28a745; color: white; border-radius: 4px;">
                                Completed
                            </span>
                        </td>
                        <td class="table-cell" style="padding: 8px;">
                            <select style="width: 120px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;" onchange="assignDriverToBooking('${booking.bookingId}', this.value)">
                                <option value="">Assigned</option>
                                ${getDriverOptionsHTML()}
                            </select>
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <div>${booking.vehicle?.vehicle?.name || 'Saloon'}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px; font-size: 12px;">
                            <div>Completed ${formattedCompletedDate}</div>
                        </td>
                        <td class="table-cell" style="padding: 8px; text-align: left;">
                            <div style="font-weight: 500; color: #28a745;">‚Ç¨${total}</div>
                        </td>
                        <td class="table-cell" style="text-align: center; padding: 8px 4px;">
                            <button onclick="openEmailModal('${booking.bookingId}')" style="background: transparent; border: none; cursor: pointer; font-size: 16px;">‚úâÔ∏è</button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        function clearAllCompleted() {
            if (confirm('Are you sure you want to clear all completed bookings?')) {
                localStorage.setItem('completedBookings', JSON.stringify([]));
                loadCompletedBookings();
                alert('‚úÖ All completed bookings cleared');
            }
        }

        // All Bookings Functions
        function loadAllBookings() {
            console.log('üìã Loading all bookings...');
            
            const tableBody = document.getElementById('allBookingsTableBody');
            if (!tableBody) {
                console.error('‚ùå All bookings table body not found');
                return;
            }
            
            // Collect all bookings from different sources
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            // Combine all bookings and sort by creation date (newest first)
            const allBookings = [
                ...unconfirmedBookings.map(b => ({...b, section: 'unconfirmed'})),
                ...confirmedBookings.map(b => ({...b, section: 'confirmed'})),
                ...completedBookings.map(b => ({...b, section: 'completed'})),
                ...cancelledBookings.map(b => ({...b, section: 'cancelled'}))
            ].sort((a, b) => new Date(b.createdAt || b.bookingDate) - new Date(a.createdAt || a.bookingDate));
            
            // Update counter
            document.getElementById('allBookingsCount').textContent = `${allBookings.length} bookings`;
            
            if (allBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <h3>üìã No Bookings Found</h3>
                            <p>All customer and dispatch bookings will appear here</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Generate table rows
            let tableHTML = '';
            
            allBookings.forEach((booking, index) => {
                const createdDate = new Date(booking.createdAt || booking.bookingDate);
                const formattedDate = createdDate.toLocaleDateString('nl-BE');
                const formattedTime = createdDate.toLocaleTimeString('nl-BE', { hour: '2-digit', minute: '2-digit' });
                const travelDateTime = `${booking.trip.travelDate} ${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                
                // Get actual price
                const vehiclePrice = booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00;
                const total = parseFloat(vehiclePrice).toFixed(2);
                
                // Determine source
                const source = booking.source === 'dispatch' ? 
                    '<span style="background: #dc3545; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">DISPATCH</span>' :
                    '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 500;">CUSTOMER</span>';
                
                // Status styling
                let statusClass = '';
                let statusText = booking.status || 'unconfirmed';
                if (['confirmed', 'job_accepted', 'completed'].includes(statusText)) {
                    statusClass = 'confirmed';
                } else if (['cancelled', 'driver_cancelled', 'job_rejected', 'no_show'].includes(statusText)) {
                    statusClass = 'cancelled';
                }
                
                // Determine country flag (default to Belgian flag for now)
                const countryFlag = 'üáßüá™';
                
                // Get assigned driver info
                const assignedDriver = booking.assignedDriver || 'Not assigned';
                const driverInfo = typeof assignedDriver === 'object' ? 
                    `${assignedDriver.name} (${assignedDriver.id})` : assignedDriver;
                
                // Get notes from booking
                const notes = booking.customer?.specialRequests || booking.notes || '';
                const notesDisplay = notes ? 
                    `<span style="color: #666; font-size: 12px;" title="${notes}">${notes.length > 30 ? notes.substring(0, 30) + '...' : notes}</span>` : 
                    '<span style="color: #ccc;">-</span>';
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="table-cell" style="text-align: center;">
                            <div style="display: flex; align-items: center; gap: 5px;">
                                <span style="font-size: 16px;">${countryFlag}</span>
                                <button style="background: transparent; border: 1px solid #dee2e6; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-size: 12px;" onclick="showBookingActions('${booking.bookingId}')">
                                    üëÅ
                                </button>
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="font-medium" style="font-size: 13px;">${booking.customer.firstName} ${booking.customer.lastName}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">üìû ${booking.customer.phone}</div>
                            <div class="small-text" style="font-size: 11px; color: #007bff;">${booking.trip.fromLocation} ‚Üí ${booking.trip.toLocation}</div>
                        </td>
                        <td class="table-cell">
                            <div class="font-medium" style="font-size: 13px;">${booking.trip.travelDate}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">${booking.trip.travelHour}:${booking.trip.travelMinute}</div>
                        </td>
                        <td class="table-cell">
                            <span class="status-badge ${statusClass}" style="font-size: 10px; padding: 3px 6px; border-radius: 3px;">
                                ${getStatusDisplayName(statusText)}
                            </span>
                        </td>
                        <td class="table-cell">
                            <div style="font-size: 12px; color: ${assignedDriver === 'Not assigned' ? '#dc3545' : '#28a745'};">
                                ${driverInfo}
                            </div>
                        </td>
                        <td class="table-cell">
                            <div class="font-medium" style="font-size: 12px;">${booking.vehicle.vehicle?.name || 'Saloon'}</div>
                            <div class="small-text" style="font-size: 11px; color: #666;">${booking.customer.passengers}p</div>
                        </td>
                        <td class="table-cell">
                            ${notesDisplay}
                        </td>
                        <td class="table-cell" style="text-align: left;">
                            <div style="font-weight: 500; color: #28a745; font-size: 13px;">‚Ç¨${total}</div>
                            <div class="small-text" style="font-size: 10px; color: #666;">${booking.customer.paymentMethod}</div>
                        </td>
                        <td class="table-cell" style="text-align: center;">
                            <button style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-size: 11px;" onclick="sendEmail('${booking.customer.email}', '${booking.bookingId}')" title="Send email to ${booking.customer.email}">
                                ‚úâÔ∏è
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
        }

        // Send email function
        function sendEmail(customerEmail, bookingId) {
            const subject = `Booking Confirmation - ${bookingId}`;
            const mailtoLink = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}`;
            
            // Open default email client
            window.open(mailtoLink);
            
            console.log('üìß Opening email client for:', customerEmail, 'Booking:', bookingId);
        }

        function filterAllBookings() {
            const filter = document.getElementById('allBookingsFilter').value;
            console.log('üîç Filtering all bookings by:', filter);
            
            // Get all bookings
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            let filteredBookings = [];
            
            switch(filter) {
                case 'customer':
                    filteredBookings = [
                        ...unconfirmedBookings.filter(b => !b.source || b.source !== 'dispatch'),
                        ...confirmedBookings.filter(b => !b.source || b.source !== 'dispatch'),
                        ...completedBookings.filter(b => !b.source || b.source !== 'dispatch'),
                        ...cancelledBookings.filter(b => !b.source || b.source !== 'dispatch')
                    ];
                    break;
                case 'dispatch':
                    filteredBookings = [
                        ...unconfirmedBookings.filter(b => b.source === 'dispatch'),
                        ...confirmedBookings.filter(b => b.source === 'dispatch'),
                        ...completedBookings.filter(b => b.source === 'dispatch'),
                        ...cancelledBookings.filter(b => b.source === 'dispatch')
                    ];
                    break;
                case 'confirmed':
                    filteredBookings = confirmedBookings;
                    break;
                case 'unconfirmed':
                    filteredBookings = unconfirmedBookings;
                    break;
                case 'completed':
                    filteredBookings = completedBookings;
                    break;
                case 'cancelled':
                    filteredBookings = cancelledBookings;
                    break;
                default: // 'all'
                    filteredBookings = [...unconfirmedBookings, ...confirmedBookings, ...completedBookings, ...cancelledBookings];
                    break;
            }
            
            // Update counter
            document.getElementById('allBookingsCount').textContent = `${filteredBookings.length} bookings`;
            
            // Force reload with filtered data
            // For simplicity, we'll just reload all and then apply client-side filtering
            loadAllBookings();
        }

        // Vehicle Management Functions
        let vehicles = [];
        let editingVehicleIndex = -1;

        function loadVehiclesForTypesSection() {
            const savedVehicles = localStorage.getItem('taxiVehicles');
            if (savedVehicles) {
                vehicles = JSON.parse(savedVehicles);
            } else {
                // Create default vehicles if none exist
                vehicles = [
                    {
                        id: 'saloon',
                        name: 'Saloon',
                        description: 'Comfort sedan voor dagelijks gebruik',
                        active: true,
                        capacity: { passengers: 4, luggage: 2 },
                        image: null
                    },
                    {
                        id: 'estate',
                        name: 'Estate',
                        description: 'Ruime stationwagen met extra bagageruimte',
                        active: true,
                        capacity: { passengers: 4, luggage: 4 },
                        image: null
                    },
                    {
                        id: 'minivan',
                        name: 'Minivan',
                        description: 'Ideaal voor kleine groepen',
                        active: true,
                        capacity: { passengers: 6, luggage: 4 },
                        image: null
                    },
                    {
                        id: 'minivan_long',
                        name: 'Minivan Long',
                        description: 'Grote groepsvervoer met maximum comfort',
                        active: true,
                        capacity: { passengers: 8, luggage: 6 },
                        image: null
                    }
                ];
                localStorage.setItem('taxiVehicles', JSON.stringify(vehicles));
            }
            renderVehicleTable();
        }

        function renderVehicleTable() {
            const tableBody = document.getElementById('vehicleTableBody');
            if (!tableBody) return;

            if (vehicles.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <h3>üöó No Vehicles Found</h3>
                            <p>Click "Add New Vehicle" to start adding vehicles</p>
                        </td>
                    </tr>
                `;
                return;
            }

            let tableHTML = '';
            vehicles.forEach((vehicle, index) => {
                const statusColor = vehicle.active ? '#28a745' : '#dc3545';
                const statusText = vehicle.active ? 'Active' : 'Inactive';
                
                const imageDisplay = vehicle.image ? 
                    `<img src="${vehicle.image}" style="width: 50px; height: 30px; object-fit: cover; border-radius: 4px;">` :
                    '<span style="font-size: 24px;">üöó</span>';

                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="section-padding">${imageDisplay}</td>
                        <td style="padding: 15px; font-weight: 500;">${vehicle.name}</td>
                        <td style="padding: 15px; color: #666;">${vehicle.description || 'No description'}</td>
                        <td class="section-padding">
                            <div>üë• ${vehicle.capacity?.passengers || 4} passengers</div>
                            <div class="small-text">üß≥ ${vehicle.capacity?.luggage || 2} luggage</div>
                            <div class="small-text">üëú ${vehicle.capacity?.handLuggage || 2} hand luggage</div>
                        </td>
                        <td class="section-padding">
                            <span style="color: ${statusColor}; font-weight: 500;">
                                ${vehicle.active ? '‚úÖ' : '‚ùå'} ${statusText}
                            </span>
                        </td>
                        <td class="section-padding">
                            <button style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer;" onclick="editVehicle(${index})">‚úèÔ∏è Edit</button>
                            <button style="background: ${vehicle.active ? '#e74c3c' : '#27ae60'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer;" onclick="toggleVehicleStatus(${index})">${vehicle.active ? '‚ùå Disable' : '‚úÖ Enable'}</button>
                            <button style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer;" onclick="deleteVehicle(${index})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            });

            tableBody.innerHTML = tableHTML;
        }

        function openAddVehicleModal() {
            editingVehicleIndex = -1;
            document.getElementById('vehicleModalTitle').textContent = 'Add New Vehicle';
            document.getElementById('vehicleForm').reset();
            document.getElementById('vehicleImagePreview').style.display = 'none';
            document.getElementById('vehicleUploadText').style.display = 'block';
            document.getElementById('vehicleModal').style.display = 'flex';
        }

        function editVehicle(index) {
            editingVehicleIndex = index;
            const vehicle = vehicles[index];
            
            document.getElementById('vehicleModalTitle').textContent = 'Edit Vehicle';
            document.getElementById('vehicleName').value = vehicle.name;
            document.getElementById('vehicleDescription').value = vehicle.description || '';
            document.getElementById('vehiclePassengers').value = vehicle.capacity?.passengers || 4;
            document.getElementById('vehicleLuggage').value = vehicle.capacity?.luggage || 2;
            document.getElementById('vehicleHandLuggage').value = vehicle.capacity?.handLuggage || 2;
            
            if (vehicle.image) {
                document.getElementById('vehicleImagePreview').src = vehicle.image;
                document.getElementById('vehicleImagePreview').style.display = 'block';
                document.getElementById('vehicleUploadText').style.display = 'none';
            }
            
            document.getElementById('vehicleModal').style.display = 'flex';
        }

        function closeVehicleModal() {
            document.getElementById('vehicleModal').style.display = 'none';
        }

        function handleVehicleImageUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showVehicleError('Image size must be less than 5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('vehicleImagePreview').src = e.target.result;
                    document.getElementById('vehicleImagePreview').style.display = 'block';
                    document.getElementById('vehicleUploadText').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteVehicle(index) {
            if (confirm(`Are you sure you want to delete "${vehicles[index].name}"?`)) {
                vehicles.splice(index, 1);
                saveVehicles();
                renderVehicleTable();
                showVehicleSuccess('Vehicle deleted successfully');
            }
        }

        function toggleVehicleStatus(index) {
            vehicles[index].active = !vehicles[index].active;
            saveVehicles();
            renderVehicleTable();
            showVehicleSuccess(`Vehicle ${vehicles[index].active ? 'enabled' : 'disabled'} successfully`);
        }

        function saveVehicles() {
            localStorage.setItem('taxiVehicles', JSON.stringify(vehicles));
            
            // Set timestamp for booking system to detect updates
            localStorage.setItem('vehicleUpdateTimestamp', Date.now().toString());
            
            // Also sync to booking system
            const bookingVehicles = vehicles.filter(v => v.active).map(v => ({
                id: v.id,
                name: v.name,
                description: v.description,
                active: v.active,
                capacity: v.capacity,
                image: v.image
            }));
            
            localStorage.setItem('bookingSystemVehicles', JSON.stringify(bookingVehicles));
            console.log('‚úÖ Vehicles saved and synced to booking system');
        }

        function showVehicleSuccess(message) {
            const el = document.getElementById('vehicleSuccessMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showVehicleError(message) {
            const el = document.getElementById('vehicleErrorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // Handle vehicle form submission
        document.addEventListener('DOMContentLoaded', function() {
            const vehicleForm = document.getElementById('vehicleForm');
            if (vehicleForm) {
                vehicleForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('vehicleName').value;
                    const description = document.getElementById('vehicleDescription').value;
                    const passengers = parseInt(document.getElementById('vehiclePassengers').value);
                    const luggage = parseInt(document.getElementById('vehicleLuggage').value);
                    const handLuggage = parseInt(document.getElementById('vehicleHandLuggage').value);
                    const imagePreview = document.getElementById('vehicleImagePreview');
                    
                    if (!name.trim()) {
                        showVehicleError('Vehicle name is required');
                        return;
                    }
                    
                    const vehicleData = {
                        id: editingVehicleIndex === -1 ? name.toLowerCase().replace(/[^a-z0-9]/g, '_') : vehicles[editingVehicleIndex].id,
                        name: name,
                        description: description,
                        active: true,
                        capacity: { passengers: passengers, luggage: luggage, handLuggage: handLuggage },
                        image: imagePreview.style.display === 'block' ? imagePreview.src : null
                    };
                    
                    if (editingVehicleIndex === -1) {
                        vehicles.push(vehicleData);
                        showVehicleSuccess('Vehicle added successfully');
                    } else {
                        vehicles[editingVehicleIndex] = { ...vehicles[editingVehicleIndex], ...vehicleData };
                        showVehicleSuccess('Vehicle updated successfully');
                    }
                    
                    saveVehicles();
                    renderVehicleTable();
                    closeVehicleModal();
                });
            }
        });

        // Update the section show function to load vehicles when Types of Vehicles is opened
        const originalShowSection = window.showSection;
        window.showSection = function(sectionName) {
            if (originalShowSection) {
                originalShowSection(sectionName);
            }
            
            if (sectionName === 'types-of-vehicles') {
                setTimeout(() => {
                    loadVehiclesForTypesSection();
                }, 100);
            }
        };

        // Vehicle Manager Functions
        let vehicleManagerData = [];
        let editingVehicleManagerIndex = -1;

        function loadVehicleManagerData() {
            console.log('üöó Loading Vehicle Manager data...');
            
            const savedVehicles = localStorage.getItem('taxiVehicles');
            if (savedVehicles) {
                vehicleManagerData = JSON.parse(savedVehicles);
            } else {
                // Create default vehicles if none exist
                vehicleManagerData = [
                    {
                        id: 'saloon',
                        name: 'Saloon',
                        description: 'Comfort sedan voor dagelijks gebruik',
                        driver: 'All',
                        active: true,
                        capacity: { passengers: 4, luggage: 2, handLuggage: 2 },
                        hourlyRate: 25,
                        image: null // No default images
                    },
                    {
                        id: 'estate',
                        name: 'Estate',
                        description: 'Ruime stationwagen met extra bagageruimte',
                        driver: 'All',
                        active: true,
                        capacity: { passengers: 4, luggage: 4, handLuggage: 2 },
                        hourlyRate: 30,
                        image: null // No default images
                    },
                    {
                        id: 'minivan',
                        name: 'Minivan',
                        description: 'Ideaal voor kleine groepen',
                        driver: 'All',
                        active: true,
                        capacity: { passengers: 6, luggage: 4, handLuggage: 3 },
                        hourlyRate: 35,
                        image: null // No default images
                    },
                    {
                        id: 'minivan_long',
                        name: 'Minivan Long',
                        description: 'Grote groepsvervoer met maximum comfort',
                        driver: 'All',
                        active: true,
                        capacity: { passengers: 8, luggage: 6, handLuggage: 4 },
                        hourlyRate: 45,
                        image: null // No default images
                    }
                ];
                saveVehicleManagerData();
            }
            renderVehicleManagerTable();
        }

        function renderVehicleManagerTable() {
            console.log('üîÑ renderVehicleManagerTable called');
            const tableBody = document.getElementById('vehicleManagerTableBody');
            if (!tableBody) {
                console.error('‚ùå vehicleManagerTableBody element not found');
                return;
            }
            
            console.log('‚úÖ Found tableBody element');
            console.log('üìä Vehicle data length:', vehicleManagerData.length);
            console.log('üìä Vehicle data:', vehicleManagerData);

            if (vehicleManagerData.length === 0) {
                console.log('‚ö†Ô∏è No vehicles found, showing empty state');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üöó</div>
                            <div style="font-size: 18px;">No Vehicles Found</div>
                            <div style="font-size: 14px; margin-top: 5px;">Click "Add New Vehicle" to start adding vehicles</div>
                        </td>
                    </tr>
                `;
                return;
            }

            let tableHTML = '';
            vehicleManagerData.forEach((vehicle, index) => {
                const statusColor = vehicle.active ? '#28a745' : '#dc3545';
                const statusText = vehicle.active ? 'Active' : 'Inactive';
                
                const imageDisplay = vehicle.image ? 
                    `<img src="${vehicle.image}" style="width: 50px; height: 30px; object-fit: cover; border-radius: 4px;">` :
                    '<span style="font-size: 24px;">üöó</span>';

                tableHTML += `
                    <tr style="border-bottom: 1px solid #dee2e6;">
                        <td class="section-padding">${imageDisplay}</td>
                        <td style="padding: 15px; font-weight: 500;">${vehicle.name}</td>
                        <td style="padding: 15px; color: #666;">${vehicle.description || 'No description'}</td>
                        <td class="section-padding">
                            <div>üë• ${vehicle.capacity?.passengers || 4} passengers</div>
                            <div class="small-text">üß≥ ${vehicle.capacity?.luggage || 2} luggage</div>
                            <div class="small-text">üëú ${vehicle.capacity?.handLuggage || 2} hand luggage</div>
                        </td>
                        <td style="padding: 15px; font-weight: 500;">‚Ç¨${vehicle.hourlyRate || 25}/hour</td>
                        <td class="section-padding">
                            <span style="color: ${statusColor}; font-weight: 500;">
                                ${vehicle.active ? '‚úÖ' : '‚ùå'} ${statusText}
                            </span>
                        </td>
                        <td class="section-padding">
                            <button style="background: #3498db; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;" onclick="editVehicleManager(${index})">‚úèÔ∏è Edit</button>
                            <button style="background: ${vehicle.active ? '#e74c3c' : '#27ae60'}; color: white; border: none; padding: 6px 12px; border-radius: 4px; margin-right: 5px; cursor: pointer; font-size: 12px;" onclick="toggleVehicleManagerStatus(${index})">${vehicle.active ? '‚ùå Disable' : '‚úÖ Enable'}</button>
                            <button style="background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;" onclick="deleteVehicleManager(${index})">üóëÔ∏è Delete</button>
                        </td>
                    </tr>
                `;
            });

            console.log('üìã Setting table HTML with', vehicleManagerData.length, 'vehicles');
            console.log('üîç Generated HTML length:', tableHTML.length);
            console.log('üîç First 200 chars of HTML:', tableHTML.substring(0, 200));
            
            // TEMPORARY TEST - Simple HTML to see if ANYTHING shows up
            tableBody.innerHTML = `
                <tr style="background: red; color: white;">
                    <td colspan="7" style="padding: 20px; font-size: 18px; font-weight: bold;">
                        üöó TEST: ${vehicleManagerData.length} VEHICLES LOADED - CAN YOU SEE THIS?
                    </td>
                </tr>
            `;
            
            console.log('‚úÖ Vehicle Manager table rendered successfully');
            console.log('üîç Table body after render:', tableBody.innerHTML.substring(0, 200));
        }

        function openVehicleManagerModal() {
            editingVehicleManagerIndex = -1;
            document.getElementById('vehicleManagerModalTitle').textContent = 'Add New Vehicle';
            document.getElementById('vehicleManagerForm').reset();
            document.getElementById('vehicleManagerImagePreview').style.display = 'none';
            document.getElementById('vehicleManagerUploadText').style.display = 'block';
            document.getElementById('vehicleManagerModal').style.display = 'flex';
        }

        function editVehicleManager(index) {
            editingVehicleManagerIndex = index;
            const vehicle = vehicleManagerData[index];
            
            document.getElementById('vehicleManagerModalTitle').textContent = 'Edit Vehicle';
            document.getElementById('vehicleManagerName').value = vehicle.name;
            document.getElementById('vehicleManagerDriver').value = vehicle.driver || 'All';
            document.getElementById('vehicleManagerDescription').value = vehicle.description || '';
            document.getElementById('vehicleManagerPassengers').value = vehicle.capacity?.passengers || 4;
            document.getElementById('vehicleManagerLuggage').value = vehicle.capacity?.luggage || 2;
            document.getElementById('vehicleManagerHandLuggage').value = vehicle.capacity?.handLuggage || 2;
            document.getElementById('vehicleManagerHourlyRate').value = vehicle.hourlyRate || 25;
            
            // Clear previous image preview first
            document.getElementById('vehicleManagerImagePreview').style.display = 'none';
            document.getElementById('vehicleManagerUploadText').style.display = 'block';
            
            // Then show current vehicle image if it exists
            if (vehicle.image) {
                document.getElementById('vehicleManagerImagePreview').src = vehicle.image;
                document.getElementById('vehicleManagerImagePreview').style.display = 'block';
                document.getElementById('vehicleManagerUploadText').style.display = 'none';
            }
            
            document.getElementById('vehicleManagerModal').style.display = 'flex';
        }

        function closeVehicleManagerModal() {
            document.getElementById('vehicleManagerModal').style.display = 'none';
        }

        function adjustVehicleManagerValue(field, change) {
            const input = document.getElementById(`vehicleManager${field.charAt(0).toUpperCase() + field.slice(1)}`);
            if (input) {
                const currentValue = parseInt(input.value) || 0;
                const newValue = Math.max(0, currentValue + change);
                input.value = newValue;
            }
        }

        function handleVehicleManagerImageUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) {
                    showVehicleManagerError('Image size must be less than 5MB');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('vehicleManagerImagePreview').src = e.target.result;
                    document.getElementById('vehicleManagerImagePreview').style.display = 'block';
                    document.getElementById('vehicleManagerUploadText').style.display = 'none';
                };
                reader.readAsDataURL(file);
            }
        }

        function deleteVehicleManager(index) {
            if (confirm(`Are you sure you want to delete "${vehicleManagerData[index].name}"?`)) {
                vehicleManagerData.splice(index, 1);
                saveVehicleManagerData();
                renderVehicleManagerTable();
                showVehicleManagerSuccess('Vehicle deleted successfully');
            }
        }

        function toggleVehicleManagerStatus(index) {
            vehicleManagerData[index].active = !vehicleManagerData[index].active;
            saveVehicleManagerData();
            renderVehicleManagerTable();
            showVehicleManagerSuccess(`Vehicle ${vehicleManagerData[index].active ? 'enabled' : 'disabled'} successfully`);
        }

        function saveVehicleManagerData() {
            console.log('üíæ Saving vehicle manager data...', vehicleManagerData.length, 'vehicles');
            
            // Check for images in data
            vehicleManagerData.forEach(vehicle => {
                if (vehicle.image) {
                    console.log(`üì∑ Vehicle ${vehicle.name} has image:`, vehicle.image.substring(0, 50) + '...');
                } else {
                    console.log(`üì∑ Vehicle ${vehicle.name} has NO image`);
                }
            });
            
            localStorage.setItem('taxiVehicles', JSON.stringify(vehicleManagerData));
            
            // Also sync to booking system
            const bookingVehicles = vehicleManagerData.filter(v => v.active).map(v => ({
                id: v.id,
                name: v.name,
                description: v.description,
                active: v.active,
                capacity: v.capacity,
                hourlyRate: v.hourlyRate,
                image: v.image
            }));
            
            localStorage.setItem('bookingSystemVehicles', JSON.stringify(bookingVehicles));
            
            // Verify save
            const saved = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            console.log('‚úÖ Vehicle Manager data saved and synced to booking system');
            console.log('üîç Verification: Saved', saved.length, 'vehicles to localStorage');
        }

        function showVehicleManagerSuccess(message) {
            const el = document.getElementById('vehicleManagerSuccessMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        function showVehicleManagerError(message) {
            const el = document.getElementById('vehicleManagerErrorMessage');
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }

        // Handle Vehicle Manager form submission
        document.addEventListener('DOMContentLoaded', function() {
            const vehicleManagerForm = document.getElementById('vehicleManagerForm');
            if (vehicleManagerForm) {
                vehicleManagerForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const name = document.getElementById('vehicleManagerName').value;
                    const driver = document.getElementById('vehicleManagerDriver').value;
                    const description = document.getElementById('vehicleManagerDescription').value;
                    const passengers = parseInt(document.getElementById('vehicleManagerPassengers').value);
                    const luggage = parseInt(document.getElementById('vehicleManagerLuggage').value);
                    const handLuggage = parseInt(document.getElementById('vehicleManagerHandLuggage').value);
                    const hourlyRate = parseInt(document.getElementById('vehicleManagerHourlyRate').value);
                    const imagePreview = document.getElementById('vehicleManagerImagePreview');
                    
                    if (!name.trim()) {
                        showVehicleManagerError('Vehicle name is required');
                        return;
                    }
                    
                    const vehicleData = {
                        id: editingVehicleManagerIndex === -1 ? name.toLowerCase().replace(/[^a-z0-9]/g, '_') : vehicleManagerData[editingVehicleManagerIndex].id,
                        name: name,
                        driver: driver,
                        description: description,
                        active: true,
                        capacity: { 
                            passengers: passengers, 
                            luggage: luggage,
                            handLuggage: handLuggage 
                        },
                        hourlyRate: hourlyRate,
                        image: imagePreview.style.display === 'block' ? imagePreview.src : null
                    };
                    
                    if (editingVehicleManagerIndex === -1) {
                        vehicleManagerData.push(vehicleData);
                        showVehicleManagerSuccess('Vehicle added successfully');
                    } else {
                        vehicleManagerData[editingVehicleManagerIndex] = { ...vehicleManagerData[editingVehicleManagerIndex], ...vehicleData };
                        showVehicleManagerSuccess('Vehicle updated successfully');
                    }
                    
                    saveVehicleManagerData();
                    renderVehicleManagerTable();
                    closeVehicleManagerModal();
                });
            }
        });

        // Update the existing showSection function to load Vehicle Manager data when opened
        if (window.showSection) {
            const existingShowSection = window.showSection;
            window.showSection = function(sectionName) {
                existingShowSection(sectionName);
                
                if (sectionName === 'types-of-vehicles') {
                    setTimeout(() => {
                        loadVehiclesForTypesSection();
                    }, 100);
                }
                
                if (sectionName === 'vehicle-manager') {
                    setTimeout(() => {
                        loadVehicleManagerData();
                    }, 100);
                }
                
                if (sectionName === 'item-surcharge') {
                    setTimeout(() => {
                        loadSurchargeItems();
                    }, 100);
                }
                
                if (sectionName === 'location-surcharge') {
                    setTimeout(() => {
                        if (typeof loadLocationSurcharges === 'function') {
                            loadLocationSurcharges();
                            // Initialize the address list for the modal
                            if (typeof populateLocationAddresses === 'function') {
                                populateLocationAddresses();
                            }
                        }
                        
                        // Button already has inline onclick handler, no need for addEventListener
                    }, 200);
                }
                
                if (sectionName === 'locations') {
                    setTimeout(() => {
                        loadLocationSettings();
                    }, 100);
                }
            };
        }

        // Item Surcharge Management
        let surchargeItems = {
            fixed: [
                { id: 'meet-greet', name: 'Meet and greet', price: 5, enabled: true },
                { id: 'child-seat', name: 'Child seat', price: 3, enabled: true, hasDropdown: true },
                { id: 'dog', name: 'Dog', price: 3, enabled: true, hasDropdown: true },
                { id: 'wheelchair', name: 'Wheelchair', price: 0, enabled: true },
                { id: 'waiting-time', name: 'Waiting time after landing', price: 0, enabled: true },
                { id: 'stopover', name: 'Stopover (Via)', price: 10, enabled: true }
            ],
            additional: [
                { id: 'golf-material', name: 'Golf-material', price: 5, type: 'Amount', quantity: 1 },
                { id: 'ski-material', name: 'Ski-material', price: 5, type: 'Amount', quantity: 1 },
                { id: 'water', name: 'Water', price: 2, type: 'Amount', quantity: 1, hasDropdown: true },
                { id: 'newspaper', name: 'Newspaper', price: 1, type: 'Amount', quantity: 1, hasDropdown: true },
                { id: 'oversize-luggage', name: 'Oversize luggage', price: 0, type: 'Amount', quantity: 1 },
                { id: 'extra-waiting', name: 'Extra waiting time (1 hour)', price: 30, type: 'Amount', quantity: 1 }
            ]
        };

        function loadSurchargeItems() {
            const saved = localStorage.getItem('surchargeItems');
            if (saved) {
                surchargeItems = JSON.parse(saved);
            } else {
                // If no saved data, save the default data to localStorage
                localStorage.setItem('surchargeItems', JSON.stringify(surchargeItems));
                console.log('üíæ Saved default surcharge items to localStorage');
            }
            renderSurchargeItems();
            
            // Update Meet & Greet status display
            const meetGreetItem = surchargeItems.fixed.find(i => i.id === 'meet-greet');
            if (meetGreetItem) {
                const priceElement = document.getElementById('meetGreetSurchargePrice');
                const statusElement = document.getElementById('meetGreetSurchargeStatus');
                if (priceElement) {
                    priceElement.textContent = meetGreetItem.price.toFixed(2);
                }
                if (statusElement) {
                    statusElement.textContent = meetGreetItem.enabled ? 'Enabled' : 'Disabled';
                    statusElement.style.backgroundColor = meetGreetItem.enabled ? '#28a745' : '#dc3545';
                    statusElement.style.color = 'white';
                }
            }
        }

        function renderSurchargeItems() {
            renderFixedItems();
            renderAdditionalItems();
        }
        
        function updateDropdownOptionName(itemId, optionIndex, newName) {
            const item = surchargeItems.fixed.find(item => item.id === itemId) || surchargeItems.additional.find(item => item.id === itemId);
            if (item && item.dropdownOptions && item.dropdownOptions[optionIndex]) {
                item.dropdownOptions[optionIndex].name = newName;
                console.log('Updated dropdown option name:', newName);
            }
        }
        
        function updateDropdownOptionPrice(itemId, optionIndex, newPrice) {
            const item = surchargeItems.fixed.find(item => item.id === itemId) || surchargeItems.additional.find(item => item.id === itemId);
            if (item && item.dropdownOptions && item.dropdownOptions[optionIndex]) {
                item.dropdownOptions[optionIndex].price = parseFloat(newPrice) || 0;
                console.log('Updated dropdown option price:', newPrice);
            }
        }
        
        function addDropdownOption(itemId) {
            const item = surchargeItems.fixed.find(item => item.id === itemId) || surchargeItems.additional.find(item => item.id === itemId);
            if (item && item.dropdownOptions) {
                const newOption = {
                    id: `custom_${Date.now()}`,
                    name: 'Nieuwe optie',
                    price: 3
                };
                item.dropdownOptions.push(newOption);
                renderSurchargeItems();
                console.log('Added new dropdown option:', newOption);
            }
        }
        
        function removeDropdownOption(itemId, optionIndex) {
            const item = surchargeItems.fixed.find(item => item.id === itemId) || surchargeItems.additional.find(item => item.id === itemId);
            if (item && item.dropdownOptions && item.dropdownOptions.length > 1) {
                item.dropdownOptions.splice(optionIndex, 1);
                renderSurchargeItems();
                console.log('Removed dropdown option at index:', optionIndex);
            } else {
                alert('Minimaal 1 optie moet blijven!');
            }
        }

        function renderFixedItems() {
            console.log('üîß Rendering fixed items...', surchargeItems.fixed);
            const container = document.getElementById('fixedItemsContainer');
            if (!container) {
                console.error('‚ùå fixedItemsContainer not found!');
                return;
            }
            container.innerHTML = '';
            console.log('‚úÖ Container found, rendering', surchargeItems.fixed.length, 'items');

            surchargeItems.fixed.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'display: flex; align-items: center; margin-bottom: 15px; padding: 10px; border: 1px solid #e9ecef; border-radius: 8px;';
                
                // Special handling for items with configurable dropdown options
                if (item.hasDropdown && (item.id === 'child-seat' || item.id === 'dog')) {
                    if (!item.dropdownOptions) {
                        if (item.id === 'child-seat') {
                            item.dropdownOptions = [
                                { id: 'maxi_cosi', name: 'Maxi Cosi (baby can\'t sit)', price: 3 },
                                { id: 'baby_seat', name: 'Baby seat', price: 3 },
                                { id: 'verhoostoel', name: 'Verhoostoel', price: 3 }
                            ];
                        } else if (item.id === 'dog') {
                            item.dropdownOptions = [
                                { id: 'kleine_hond', name: 'Kleine hond', price: 3 },
                                { id: 'groten_hond', name: 'Groten hond', price: 5 }
                            ];
                        }
                    }
                    
                    itemDiv.innerHTML = `
                        <div style="flex: 1; color: #6c757d;">
                            ${item.name}
                            <div style="font-size: 12px; color: #868e96; margin-top: 5px;">
                                Dropdown opties configureerbaar:
                            </div>
                            <div id="dropdownOptions_${item.id}" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                ${item.dropdownOptions.map((option, index) => `
                                    <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 10px;">
                                        <input type="text" value="${option.name}" onchange="updateDropdownOptionName('${item.id}', ${index}, this.value)" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <span style="font-size: 12px; color: #6c757d;">‚Ç¨</span>
                                        <input type="number" value="${option.price}" step="0.01" onchange="updateDropdownOptionPrice('${item.id}', ${index}, this.value)" style="width: 60px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                        <button onclick="removeDropdownOption('${item.id}', ${index})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚ùå</button>
                                    </div>
                                `).join('')}
                                <button onclick="addDropdownOption('${item.id}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px;">+ Optie Toevoegen</button>
                            </div>
                        </div>
                        <div style="width: 80px; margin-right: 15px; text-align: center; padding: 8px; color: #6c757d; font-size: 12px;">
                            Individuele<br>prijzen
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center; justify-content: center;">
                            <span style="font-size: 12px; color: #6c757d;">‚úì Per optie</span>
                        </div>
                    `;
                } else {
                    // Special handling for Meet and greet item to add enable/disable toggle
                    if (item.id === 'meet-greet') {
                        itemDiv.innerHTML = `
                            <div style="flex: 1; color: #6c757d; display: flex; align-items: center; gap: 10px;">
                                <span>${item.name}</span>
                                <div style="display: flex; align-items: center; gap: 5px; margin-left: 10px;">
                                    <label style="font-size: 12px; color: #6c757d;">Enabled:</label>
                                    <input type="checkbox" id="meetGreetToggle" ${item.enabled ? 'checked' : ''} 
                                           onchange="toggleMeetGreet(this.checked)" 
                                           style="width: 16px; height: 16px; cursor: pointer;">
                                </div>
                            </div>
                            <div style="width: 80px; margin-right: 15px;">
                                <input type="number" value="${item.price}" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; text-align: center;" 
                                       onchange="updateFixedItemPrice('${item.id}', this.value)">
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button style="width: 30px; height: 30px; border: 1px solid #e9ecef; background: white; border-radius: 4px; cursor: pointer;" 
                                        onclick="adjustFixedItemPrice('${item.id}', 1)">+</button>
                                <button style="width: 30px; height: 30px; border: 1px solid #e9ecef; background: white; border-radius: 4px; cursor: pointer;" 
                                        onclick="adjustFixedItemPrice('${item.id}', -1)">-</button>
                            </div>
                        `;
                    } else {
                        itemDiv.innerHTML = `
                            <div style="flex: 1; color: #6c757d;">${item.name}</div>
                            <div style="width: 80px; margin-right: 15px;">
                                <input type="number" value="${item.price}" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; text-align: center;" 
                                       onchange="updateFixedItemPrice('${item.id}', this.value)">
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button style="width: 30px; height: 30px; border: 1px solid #e9ecef; background: white; border-radius: 4px; cursor: pointer;" 
                                        onclick="adjustFixedItemPrice('${item.id}', 1)">+</button>
                                <button style="width: 30px; height: 30px; border: 1px solid #e9ecef; background: white; border-radius: 4px; cursor: pointer;" 
                                        onclick="adjustFixedItemPrice('${item.id}', -1)">-</button>
                            </div>
                        `;
                    }
                }
                
                container.appendChild(itemDiv);
            });
        }

        function renderAdditionalItems() {
            const container = document.getElementById('additionalOptionsContainer');
            container.innerHTML = `
                <div style="display: flex; background: #f8f9fa; padding: 10px; border-radius: 4px; margin-bottom: 10px; font-weight: 600;">
                    <div style="flex: 1;">Name</div>
                    <div style="width: 100px;">Price</div>
                    <div style="width: 100px;">Type</div>
                    <div style="width: 80px;">Options</div>
                    <div style="width: 50px;"></div>
                </div>
            `;

            surchargeItems.additional.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.style.cssText = 'margin-bottom: 15px; padding: 15px; border: 1px solid #e9ecef; border-radius: 8px;';
                
                // Special handling for items with dropdown options
                if (item.hasDropdown) {
                    if (!item.dropdownOptions) {
                        if (item.id === 'dog') {
                            item.dropdownOptions = [
                                { id: 'kleine_hond', name: 'Kleine hond', price: 3 },
                                { id: 'groten_hond', name: 'Groten hond', price: 5 }
                            ];
                        } else if (item.id === 'water') {
                            item.dropdownOptions = [
                                { id: 'still', name: 'Still water', price: 2 },
                                { id: 'sparkling', name: 'Sparkling water', price: 3 }
                            ];
                        } else if (item.id === 'newspaper') {
                            item.dropdownOptions = [
                                { id: 'local', name: 'Lokale krant', price: 1 },
                                { id: 'national', name: 'Nationale krant', price: 2 }
                            ];
                        }
                    }
                    
                    itemDiv.innerHTML = `
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1; color: #6c757d;">
                                <input type="text" value="${item.name}" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px; font-weight: 600;" 
                                       onchange="updateAdditionalItem(${index}, 'name', this.value)">
                                <div style="font-size: 12px; color: #868e96; margin-top: 5px;">
                                    Dropdown opties configureerbaar:
                                </div>
                                <div id="dropdownOptions_${item.id}" style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 6px;">
                                    ${item.dropdownOptions.map((option, optionIndex) => `
                                        <div style="display: flex; align-items: center; margin-bottom: 8px; gap: 10px;">
                                            <input type="text" value="${option.name}" onchange="updateDropdownOptionName('${item.id}', ${optionIndex}, this.value)" style="flex: 1; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                            <span style="font-size: 12px; color: #6c757d;">‚Ç¨</span>
                                            <input type="number" value="${option.price}" step="0.01" onchange="updateDropdownOptionPrice('${item.id}', ${optionIndex}, this.value)" style="width: 60px; padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                            <button onclick="removeDropdownOption('${item.id}', ${optionIndex})" style="background: #dc3545; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; cursor: pointer;">‚ùå</button>
                                        </div>
                                    `).join('')}
                                    <button onclick="addDropdownOption('${item.id}')" style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-top: 5px;">+ Optie Toevoegen</button>
                                </div>
                            </div>
                            <div style="width: 80px; margin-right: 15px; text-align: center; padding: 8px; color: #6c757d; font-size: 12px;">
                                Individuele<br>prijzen
                            </div>
                            <div style="display: flex; gap: 5px; align-items: center; justify-content: center;">
                                <button style="width: 40px; height: 32px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" 
                                        onclick="removeAdditionalItem(${index})">üóëÔ∏è</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Regular items without dropdown
                    itemDiv.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <div style="flex: 1; margin-right: 10px;">
                                <input type="text" value="${item.name}" style="width: 100%; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px;" 
                                       onchange="updateAdditionalItem(${index}, 'name', this.value)">
                            </div>
                            <input type="number" value="${item.price}" style="width: 90px; margin-right: 10px; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px;" 
                                   onchange="updateAdditionalItem(${index}, 'price', this.value)">
                            <select style="width: 90px; margin-right: 10px; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px;" 
                                    onchange="updateAdditionalItem(${index}, 'type', this.value)">
                                <option value="Amount" ${item.type === 'Amount' ? 'selected' : ''}>Amount</option>
                                <option value="Percentage" ${item.type === 'Percentage' ? 'selected' : ''}>Percentage</option>
                            </select>
                            <input type="number" value="${item.quantity}" style="width: 70px; margin-right: 10px; padding: 8px; border: 1px solid #e9ecef; border-radius: 4px;" 
                                   onchange="updateAdditionalItem(${index}, 'quantity', this.value)">
                            <button style="width: 40px; height: 32px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;" 
                                    onclick="removeAdditionalItem(${index})">üóëÔ∏è</button>
                        </div>
                    `;
                }
                container.appendChild(itemDiv);
            });
        }

        function updateFixedItemPrice(itemId, price) {
            const item = surchargeItems.fixed.find(i => i.id === itemId);
            if (item) {
                item.price = parseFloat(price) || 0;
            }
        }

        function adjustFixedItemPrice(itemId, delta) {
            const item = surchargeItems.fixed.find(i => i.id === itemId);
            if (item) {
                item.price = Math.max(0, item.price + delta);
                renderFixedItems();
            }
        }

        function toggleMeetGreet(enabled) {
            const item = surchargeItems.fixed.find(i => i.id === 'meet-greet');
            if (item) {
                item.enabled = enabled;
                console.log('Meet & greet toggled:', enabled);
                
                // Update the meet & greet price display in the Meet and Greet section
                const priceElement = document.getElementById('meetGreetSurchargePrice');
                const statusElement = document.getElementById('meetGreetSurchargeStatus');
                if (priceElement) {
                    priceElement.textContent = item.price.toFixed(2);
                }
                if (statusElement) {
                    statusElement.textContent = enabled ? 'Enabled' : 'Disabled';
                    statusElement.style.backgroundColor = enabled ? '#28a745' : '#dc3545';
                    statusElement.style.color = 'white';
                }
                
                // Save the changes
                saveSurchargeItems();
            }
        }

        function updateAdditionalItem(index, field, value) {
            if (surchargeItems.additional[index]) {
                surchargeItems.additional[index][field] = field === 'price' || field === 'quantity' ? parseFloat(value) || 0 : value;
            }
        }

        function addNewSurchargeItem() {
            surchargeItems.additional.push({
                id: 'new-item-' + Date.now(),
                name: 'New Item',
                price: 0,
                type: 'Amount',
                quantity: 1
            });
            renderAdditionalItems();
        }

        function removeAdditionalItem(index) {
            surchargeItems.additional.splice(index, 1);
            renderAdditionalItems();
        }

        function saveSurchargeItems() {
            // Add timestamp for update tracking
            const currentTime = Date.now();
            localStorage.setItem('surchargeItems', JSON.stringify(surchargeItems));
            localStorage.setItem('surchargeItemsUpdateTime', currentTime.toString());
            
            alert('‚úÖ Surcharge items saved successfully!');
            
            // Sync to booking system
            syncSurchargeToBookingSystem();
        }

        // Google Settings Functions
        function loadGoogleSettings() {
            const saved = localStorage.getItem('googleSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('googleMapsApiKey').value = settings.googleMapsApiKey || '';
                document.getElementById('googlePlacesApiKey').value = settings.googlePlacesApiKey || '';
                document.getElementById('googleDirectionsApiKey').value = settings.googleDirectionsApiKey || '';
                document.getElementById('googleGeocodingApiKey').value = settings.googleGeocodingApiKey || '';
                document.getElementById('defaultLocation').value = settings.defaultLocation || '';
                document.getElementById('serviceArea').value = settings.serviceArea || '';
            }
        }
        function saveGoogleSettings() {
            const mapsApiKey = document.getElementById('googleMapsApiKey').value.trim();
            const placesApiKey = document.getElementById('googlePlacesApiKey').value.trim();
            const directionsApiKey = document.getElementById('googleDirectionsApiKey').value.trim();
            const geocodingApiKey = document.getElementById('googleGeocodingApiKey').value.trim();
            const defaultLocation = document.getElementById('defaultLocation').value.trim();
            const serviceArea = document.getElementById('serviceArea').value.trim();
            
            // Save to localStorage
            const googleSettings = {
                googleMapsApiKey: mapsApiKey,
                googlePlacesApiKey: placesApiKey,
                googleDirectionsApiKey: directionsApiKey,
                googleGeocodingApiKey: geocodingApiKey,
                defaultLocation: defaultLocation,
                serviceArea: serviceArea,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('googleSettings', JSON.stringify(googleSettings));
            
            // Show success message
            const statusDiv = document.getElementById('googleStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.innerHTML = '‚úÖ Google settings saved successfully!';
            
            // Hide message after 3 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 3000);
            
            console.log('‚úÖ Google settings saved:', googleSettings);
        }
        

        function syncSurchargeToBookingSystem() {
            // Create booking system compatible data
            const bookingSurcharge = {
                fixed: surchargeItems.fixed.filter(item => item.enabled),
                additional: surchargeItems.additional
            };
            localStorage.setItem('bookingSurchargeItems', JSON.stringify(bookingSurcharge));
            
            // Also set timestamp for booking system updates
            const currentTime = Date.now();
            localStorage.setItem('bookingSurchargeItemsUpdateTime', currentTime.toString());
            
            console.log('‚úÖ Surcharge items synced to booking system:', bookingSurcharge);
        }

        // Make functions globally available
        window.showSection = showSection;
        window.showBookingActions = showBookingActions;
        window.confirmBooking = confirmBooking;
        window.cancelBooking = cancelBooking;
        window.confirmAllBookings = confirmAllBookings;
        window.closeBookingModal = closeBookingModal;
        window.saveBookingChanges = saveBookingChanges;
        window.toggleStatusDropdown = toggleStatusDropdown;
        window.changeBookingStatus = changeBookingStatus;
        window.loadSurchargeItems = loadSurchargeItems;
        window.renderSurchargeItems = renderSurchargeItems;
        window.updateFixedItemPrice = updateFixedItemPrice;
        window.adjustFixedItemPrice = adjustFixedItemPrice;
        window.updateAdditionalItem = updateAdditionalItem;
        window.addNewSurchargeItem = addNewSurchargeItem;
        window.removeAdditionalItem = removeAdditionalItem;
        window.saveSurchargeItems = saveSurchargeItems;
        window.loadGoogleSettings = loadGoogleSettings;
        window.saveGoogleSettings = saveGoogleSettings;
        window.loadEmailSettings = loadEmailSettings;
        window.saveEmailSettings = saveEmailSettings;
        window.sendAdminTestEmail = sendAdminTestEmail;
        window.loadEmailTemplate = loadEmailTemplate;
        window.saveEmailTemplate = saveEmailTemplate;
        window.previewEmailTemplate = previewEmailTemplate;
        window.loadTranslation = loadTranslation;
        window.saveTranslation = saveTranslation;
        window.previewTranslationEmail = previewTranslationEmail;
        window.showBookingOverview = showBookingOverview;
        window.closeBookingOverview = closeBookingOverview;
        window.editBookingFromOverview = editBookingFromOverview;
        window.closeEditBookingModal = closeEditBookingModal;
        window.saveBookingChanges = saveBookingChanges;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üì± Admin panel initialized');
            
            // Initialize dispatch calendar and time
            initDispatchDateTime();
            
            // Auto-load vehicle pricing when Distance & Time section is opened
            setTimeout(() => {
                const section = document.getElementById('distance-time-section');
                if (section && section.classList.contains('active')) {
                    console.log('üîÑ Auto-loading vehicle pricing for Distance & Time...');
                    loadVehiclePricing();
                    loadLastMinuteSurcharge();
                }
            }, 1000);

            // Initialize surcharge items and sync to booking system
            loadSurchargeItems();
            syncSurchargeToBookingSystem();
            
            // Load Google settings
            loadGoogleSettings();
            
            // Load email settings
            loadEmailSettings();
            
            // Load email template
            loadEmailTemplate();
            
            // Load translation settings
            loadTranslation();
            
            // Load distance-based pricing
            loadDistancePricing();
        });

        // Email Template Functions
        function loadSelectedTemplate() {
            const selectedType = document.getElementById('templateSelector').value;
            console.log('üìù Loading template:', selectedType);
            
            // Hide all templates
            document.querySelectorAll('.template-content').forEach(el => {
                el.style.display = 'none';
            });
            
            // Show selected template
            document.getElementById(selectedType + 'Template').style.display = 'block';
            
            // Load saved data for this template
            loadEmailTemplate();
        }
        
        function loadEmailTemplate() {
            console.log('üìù Loading email templates from localStorage...');
            
            // Load all templates from localStorage
            const allTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            
            // Load Pending Template (Template 1)
            if (allTemplates.pending) {
                const pending = allTemplates.pending;
                if (pending.subject) document.getElementById('pendingSubject').value = pending.subject;
                if (pending.welcomeMessage) document.getElementById('pendingWelcomeMessage').value = pending.welcomeMessage;
                if (pending.statusMessage) document.getElementById('pendingStatusMessage').value = pending.statusMessage;
            }
            
            // Load Confirmed Template (Template 2)
            if (allTemplates.confirmed) {
                const confirmed = allTemplates.confirmed;
                if (confirmed.subject) document.getElementById('confirmedSubject').value = confirmed.subject;
                if (confirmed.welcomeMessage) document.getElementById('confirmedWelcomeMessage').value = confirmed.welcomeMessage;
                if (confirmed.statusMessage) document.getElementById('confirmedStatusMessage').value = confirmed.statusMessage;
            }
            
            // Load Cancelled Template (Template 3)
            if (allTemplates.cancelled) {
                const cancelled = allTemplates.cancelled;
                if (cancelled.subject) document.getElementById('cancelledSubject').value = cancelled.subject;
                if (cancelled.welcomeMessage) document.getElementById('cancelledWelcomeMessage').value = cancelled.welcomeMessage;
                if (cancelled.statusMessage) document.getElementById('cancelledStatusMessage').value = cancelled.statusMessage;
            }
            
            // Load shared contact info
            const sharedData = allTemplates.shared || {};
            if (sharedData.phone) document.getElementById('templatePhone').value = sharedData.phone;
            if (sharedData.whatsApp) document.getElementById('templateWhatsApp').value = sharedData.whatsApp;
            if (sharedData.email) document.getElementById('templateEmail').value = sharedData.email;
            if (sharedData.contactInfo) document.getElementById('templateContactInfo').value = sharedData.contactInfo;
            if (sharedData.companyName) document.getElementById('templateCompanyName').value = sharedData.companyName;
            if (sharedData.website) document.getElementById('templateWebsite').value = sharedData.website;
            if (sharedData.footer) document.getElementById('templateFooter').value = sharedData.footer;
            if (sharedData.modificationDeadlineHours) {
                document.getElementById('templateModificationDeadline').value = sharedData.modificationDeadlineHours;
                document.getElementById('deadlinePreview').textContent = sharedData.modificationDeadlineHours;
            }
            
        }

        function saveEmailTemplate(event) {
            event.preventDefault();
            
            console.log('üíæ Saving email templates...');
            
            // Get current templates or create new object
            const allTemplates = JSON.parse(localStorage.getItem('emailTemplates') || '{}');
            
            // Save Template 1: Pending
            allTemplates.pending = {
                subject: document.getElementById('pendingSubject').value,
                welcomeMessage: document.getElementById('pendingWelcomeMessage').value,
                statusMessage: document.getElementById('pendingStatusMessage').value
            };
            
            // Save Template 2: Confirmed
            allTemplates.confirmed = {
                subject: document.getElementById('confirmedSubject').value,
                welcomeMessage: document.getElementById('confirmedWelcomeMessage').value,
                statusMessage: document.getElementById('confirmedStatusMessage').value
            };
            
            // Save Template 3: Cancelled
            allTemplates.cancelled = {
                subject: document.getElementById('cancelledSubject').value,
                welcomeMessage: document.getElementById('cancelledWelcomeMessage').value,
                statusMessage: document.getElementById('cancelledStatusMessage').value
            };
            
            // Save shared contact info
            allTemplates.shared = {
                phone: document.getElementById('templatePhone').value,
                whatsApp: document.getElementById('templateWhatsApp').value,
                email: document.getElementById('templateEmail').value,
                contactInfo: document.getElementById('templateContactInfo').value,
                companyName: document.getElementById('templateCompanyName').value,
                website: document.getElementById('templateWebsite').value,
                footer: document.getElementById('templateFooter').value,
                modificationDeadlineHours: document.getElementById('templateModificationDeadline').value,
                lastUpdated: new Date().toISOString()
            };
            
            // Save to localStorage
            localStorage.setItem('emailTemplates', JSON.stringify(allTemplates));
            
            // Show success message
            const statusDiv = document.getElementById('emailTemplateStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.innerHTML = '‚úÖ Email templates opgeslagen! Deze templates worden gebruikt voor de verschillende booking statussen.';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
            
            console.log('‚úÖ Email templates saved successfully:', allTemplates);
        }

        function previewEmailTemplate() {
            console.log('üëÅÔ∏è Generating email template preview...');
            
            const selectedType = document.getElementById('templateSelector').value;
            let templateData = {};
            
            // Get the selected template data
            if (selectedType === 'pending') {
                templateData = {
                    subject: document.getElementById('pendingSubject').value,
                    welcomeMessage: document.getElementById('pendingWelcomeMessage').value,
                    statusMessage: document.getElementById('pendingStatusMessage').value,
                    templateType: 'pending'
                };
            } else if (selectedType === 'confirmed') {
                templateData = {
                    subject: document.getElementById('confirmedSubject').value,
                    welcomeMessage: document.getElementById('confirmedWelcomeMessage').value,
                    statusMessage: document.getElementById('confirmedStatusMessage').value,
                    templateType: 'confirmed'
                };
            } else if (selectedType === 'cancelled') {
                templateData = {
                    subject: document.getElementById('cancelledSubject').value,
                    welcomeMessage: document.getElementById('cancelledWelcomeMessage').value,
                    statusMessage: document.getElementById('cancelledStatusMessage').value,
                    templateType: 'cancelled'
                };
            }
            
            // Add shared data
            templateData.phone = document.getElementById('templatePhone').value;
            templateData.whatsApp = document.getElementById('templateWhatsApp').value;
            templateData.email = document.getElementById('templateEmail').value;
            templateData.contactInfo = document.getElementById('templateContactInfo').value;
            templateData.companyName = document.getElementById('templateCompanyName').value;
            templateData.website = document.getElementById('templateWebsite').value;
            templateData.footer = document.getElementById('templateFooter').value;
            
            // Generate preview email HTML
            const previewHTML = generateEmailPreview(templateData);
            
            // Open preview in new window
            const previewWindow = window.open('', '_blank', 'width=800,height=600,scrollbars=yes');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
            
            console.log('‚úÖ Email template preview opened');
        }

        function generateEmailPreview(templateData) {
            // Sample booking data for preview
            const sampleBooking = {
                bookingId: 'BK12345678',
                customer: {
                    firstName: 'Jan',
                    lastName: 'Janssen',
                    email: 'jan.janssen@email.com',
                    phone: '+32 496 12 34 56'
                },
                trip: {
                    fromLocation: 'Brussels Airport (BRU)',
                    toLocation: 'Leuven Centrum',
                    travelDate: '15/07/2025',
                    travelHour: '14',
                    travelMinute: '30'
                },
                vehicle: {
                    vehicle: { name: 'Saloon' },
                    pricing: { minimumPrice: '45.00' }
                }
            };
            
            // Determine colors and title based on template type
            let headerColor = '#007bff'; // Default blue
            let statusBadgeColor = '#ffc107'; // Default yellow
            let statusBadgeTextColor = '#212529';
            let title = 'Booking Bevestiging';
            
            if (templateData.templateType === 'pending') {
                headerColor = '#ffa500'; // Orange
                statusBadgeColor = '#ffc107'; // Yellow
                title = 'Booking Ontvangen - Wacht op Bevestiging';
            } else if (templateData.templateType === 'confirmed') {
                headerColor = '#28a745'; // Green
                statusBadgeColor = '#28a745'; // Green
                statusBadgeTextColor = 'white';
                title = '‚úÖ Booking Bevestigd';
            } else if (templateData.templateType === 'cancelled') {
                headerColor = '#dc3545'; // Red
                statusBadgeColor = '#dc3545'; // Red
                statusBadgeTextColor = 'white';
                title = '‚ùå Booking Geannuleerd';
            }
            
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>Email Template Preview - ${title}</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 20px; }
                    .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                    .header { background: ${headerColor}; color: white; padding: 20px; text-align: center; border-radius: 8px 8px 0 0; }
                    .content { padding: 20px; background: #f9f9f9; }
                    .booking-details { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; border-left: 4px solid ${headerColor}; }
                    .footer { text-align: center; padding: 20px; color: #666; font-size: 14px; background: #f1f1f1; border-radius: 0 0 8px 8px; }
                    .status-badge { background: ${statusBadgeColor}; color: ${statusBadgeTextColor}; padding: 8px 16px; border-radius: 20px; font-weight: bold; display: inline-block; margin: 10px 0; }
                    .contact-info { background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 15px 0; }
                </style>
            </head>
            <body>
                <div class="container">
                    <div class="header">
                        <h1>üöó ${templateData.companyName || 'Marcel\'s Taxi'}</h1>
                        <h2>${title}</h2>
                    </div>
                    <div class="content">
                        <h3>Beste ${sampleBooking.customer.firstName} ${sampleBooking.customer.lastName},</h3>
                        <div class="section-margin-lg">
                            ${templateData.welcomeMessage.replace(/\n/g, '<br>')}
                        </div>
                        
                        <div class="status-badge">
                            ${templateData.statusMessage.split('\n')[0]}
                        </div>
                        
                        <div class="booking-details">
                            <h4>üìã Booking ${sampleBooking.bookingId}</h4>
                            <p><strong>Klant:</strong> ${sampleBooking.customer.firstName} ${sampleBooking.customer.lastName}</p>
                            <p><strong>üìç Van:</strong> ${sampleBooking.trip.fromLocation}</p>
                            <p><strong>üìç Naar:</strong> ${sampleBooking.trip.toLocation}</p>
                            <p><strong>üìÖ Datum:</strong> ${sampleBooking.trip.travelDate}</p>
                            <p><strong>üïê Tijd:</strong> ${sampleBooking.trip.travelHour}:${sampleBooking.trip.travelMinute}</p>
                            <p><strong>üöó Voertuig:</strong> ${sampleBooking.vehicle.vehicle.name}</p>
                            <p><strong>üí∞ Prijs:</strong> ‚Ç¨${sampleBooking.vehicle.pricing.minimumPrice}</p>
                        </div>
                        
                        <div style="margin: 20px 0;">
                            ${templateData.statusMessage.replace(/\n/g, '<br>')}
                        </div>
                        
                        <div class="contact-info">
                            <h4>üìû Contact Informatie</h4>
                            <p><strong>Telefoon:</strong> ${templateData.phone}</p>
                            <p><strong>WhatsApp:</strong> ${templateData.whatsApp}</p>
                            <p><strong>Email:</strong> ${templateData.email}</p>
                            <div style="margin-top: 10px;">
                                ${templateData.contactInfo.replace(/\n/g, '<br>')}
                            </div>
                        </div>
                    </div>
                    <div class="footer">
                        <p><strong>${templateData.companyName || 'Marcel\'s Taxi'}</strong></p>
                        <p>${templateData.website}</p>
                        <div style="margin-top: 15px;">
                            ${templateData.footer.replace(/\n/g, '<br>')}
                        </div>
                    </div>
                </div>
            </body>
            </html>
            `;
        }

        // Modification Deadline Functions
        function adjustModificationDeadline(delta) {
            const input = document.getElementById('templateModificationDeadline');
            const preview = document.getElementById('deadlinePreview');
            let currentValue = parseInt(input.value) || 24;
            
            // Apply delta with bounds checking
            currentValue = Math.max(1, Math.min(168, currentValue + delta)); // 1 hour to 7 days (168 hours)
            
            // Update input and preview
            input.value = currentValue;
            preview.textContent = currentValue;
            
            console.log('‚è∞ Modification deadline updated to:', currentValue, 'hours');
        }

        // Update preview when input changes directly
        document.addEventListener('DOMContentLoaded', function() {
            const input = document.getElementById('templateModificationDeadline');
            if (input) {
                input.addEventListener('input', function() {
                    const preview = document.getElementById('deadlinePreview');
                    if (preview) {
                        preview.textContent = this.value || '24';
                    }
                });
            }
        });

        // Translation Functions

        function generateProfessionalEmailPreview(translation) {
            // Sample booking data for preview - exactly like the screenshot
            const sampleBooking = {
                bookingId: 'KIGK23',
                customer: {
                    firstName: 'Kelly',
                    lastName: 'Mortelmans',
                    email: 'mortelmanskelly@gmail.com',
                    phone: '+32472950917',
                    passengers: '1'
                },
                trip: {
                    fromLocation: 'Boterveldstraat 2, 3390 Tielt-Winge, Belgium, Boterveldstraat 2, 3390 Tielt-winge',
                    toLocation: 'DAVO SINT-TRUIDEN Mini, Spookvliegerlaan, Sint-Truiden, Belgium, Davo, spookvliegerlaan sint-truiden',
                    travelDate: '27/06/2025',
                    travelHour: '09',
                    travelMinute: '00'
                },
                vehicle: {
                    vehicle: { name: 'Saloon' },
                    pricing: { minimumPrice: '63.00' }
                },
                bookingDate: '26/06/2025 09:36'
            };
            
            return `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="utf-8">
                <title>Professional Email Preview</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.4; color: #333; margin: 20px; background: #f5f5f5; }
                    .email-container { max-width: 600px; margin: 0 auto; background: white; border: 1px solid #ddd; }
                    .header { text-align: center; padding: 20px; border-bottom: 3px solid #333; background: white; }
                    .header h1 { margin: 0; font-size: 24px; color: #333; }
                    .content { padding: 20px; background: white; }
                    .status-line { color: #d9534f; font-weight: bold; margin-bottom: 15px; }
                    .main-message { margin-bottom: 20px; line-height: 1.5; }
                    .booking-id { color: #d9534f; font-weight: bold; }
                    .section { margin-bottom: 25px; }
                    .section-title { font-weight: bold; font-size: 16px; margin-bottom: 10px; border-bottom: 1px solid #ddd; padding-bottom: 5px; }
                    .info-table { width: 100%; }
                    .info-table td { padding: 5px 0; vertical-align: top; }
                    .info-table td:first-child { font-weight: bold; width: 150px; }
                    .footer-rules { margin-top: 20px; padding-top: 15px; border-top: 1px solid #ddd; font-size: 13px; line-height: 1.4; }
                    .footer-rules p { margin-bottom: 12px; }
                </style>
            </head>
            <body>
                <div class="email-container">
                    <div class="header">
                        ${translation.logoUrl ? `<img src="${translation.logoUrl}" alt="Logo" style="max-height: 50px; margin-bottom: 10px;">` : ''}
                        <h1>${translation.companyName}</h1>
                    </div>
                    <div class="content">
                        <div class="status-line">${translation.statusLine}</div>
                        
                        <div class="main-message">
                            ${translation.mainMessage.replace('[BOOKING_ID]', `<span class="booking-id">${sampleBooking.bookingId}</span>`).replace(/\n/g, '<br>')}
                        </div>
                        
                        <div class="section">
                            <div class="section-title">${translation.tripSection}</div>
                            <table class="info-table">
                                <tr>
                                    <td>${translation.dateTime}</td>
                                    <td>${sampleBooking.trip.travelDate} ${sampleBooking.trip.travelHour}:${sampleBooking.trip.travelMinute}</td>
                                </tr>
                                <tr>
                                    <td>${translation.pickupLocation}</td>
                                    <td>${sampleBooking.trip.fromLocation}</td>
                                </tr>
                                <tr>
                                    <td>${translation.destination}</td>
                                    <td>${sampleBooking.trip.toLocation}</td>
                                </tr>
                                <tr>
                                    <td>${translation.vehicle}</td>
                                    <td>${sampleBooking.vehicle.vehicle.name}</td>
                                </tr>
                                <tr>
                                    <td>${translation.passengers}</td>
                                    <td>${sampleBooking.customer.passengers}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">${translation.clientSection}</div>
                            <table class="info-table">
                                <tr>
                                    <td>${translation.name}</td>
                                    <td>${sampleBooking.customer.firstName} ${sampleBooking.customer.lastName}</td>
                                </tr>
                                <tr>
                                    <td>${translation.phone}</td>
                                    <td>${sampleBooking.customer.phone}</td>
                                </tr>
                                <tr>
                                    <td>${translation.email}</td>
                                    <td>${sampleBooking.customer.email}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">${translation.reservationSection}</div>
                            <table class="info-table">
                                <tr>
                                    <td>${translation.referenceId}</td>
                                    <td>${sampleBooking.bookingId}</td>
                                </tr>
                                <tr>
                                    <td>${translation.bookingDate}</td>
                                    <td>${sampleBooking.bookingDate}</td>
                                </tr>
                                <tr>
                                    <td>${translation.summary}</td>
                                    <td>Journey ‚Ç¨${sampleBooking.vehicle.pricing.minimumPrice}</td>
                                </tr>
                                <tr>
                                    <td>${translation.total}</td>
                                    <td>‚Ç¨${sampleBooking.vehicle.pricing.minimumPrice}</td>
                                </tr>
                                <tr>
                                    <td>${translation.payments}</td>
                                    <td>‚Ç¨${sampleBooking.vehicle.pricing.minimumPrice} (Cash) - <span style="color: #f39c12;">${translation.paymentStatus}</span></td>
                                </tr>
                                <tr>
                                    <td>${translation.owedAmount}</td>
                                    <td>‚Ç¨${sampleBooking.vehicle.pricing.minimumPrice}</td>
                                </tr>
                            </table>
                        </div>
                        
                        <div class="footer-rules">
                            <p>${translation.cancellation}</p>
                            <p>${translation.changes}</p>
                            <p>${translation.bookingAdvice}</p>
                            <p>${translation.driverInfo}</p>
                        </div>
                    </div>
                </div>
            </body>
            </html>
            `;
        }

        // Load existing email settings from localStorage
        function loadEmailSettings() {
            console.log('üìß Loading existing email settings...');
            
            // Load individual settings
            const fromName = localStorage.getItem('adminFromName');
            const fromEmail = localStorage.getItem('adminFromEmail');
            const replyToEmail = localStorage.getItem('adminReplyToEmail');
            const adminEmail = localStorage.getItem('adminAdminEmail');
            const connectionType = localStorage.getItem('adminConnectionType');
            const provider = localStorage.getItem('adminProvider');
            const smtpHost = localStorage.getItem('adminSmtpHost');
            const smtpPort = localStorage.getItem('adminSmtpPort');
            const smtpUsername = localStorage.getItem('adminSmtpUsername');
            const smtpPassword = localStorage.getItem('adminSmtpPassword');
            const smtpSecurity = localStorage.getItem('adminSmtpSecurity');
            
            // Update form fields if values exist
            if (fromName) document.getElementById('adminFromName').value = fromName;
            if (fromEmail) document.getElementById('adminFromEmail').value = fromEmail;
            if (replyToEmail) document.getElementById('adminReplyToEmail').value = replyToEmail;
            if (adminEmail) document.getElementById('adminAdminEmail').value = adminEmail;
            if (connectionType) document.getElementById('adminConnectionType').value = connectionType;
            if (provider) document.getElementById('adminProvider').value = provider;
            if (smtpHost) document.getElementById('adminSmtpHost').value = smtpHost;
            if (smtpPort) document.getElementById('adminSmtpPort').value = smtpPort;
            if (smtpUsername) document.getElementById('adminSmtpUsername').value = smtpUsername;
            if (smtpPassword) document.getElementById('adminSmtpPassword').value = smtpPassword;
            
            // Set security radio button
            if (smtpSecurity) {
                const securityRadio = document.querySelector(`input[name="adminSmtpSecurity"][value="${smtpSecurity}"]`);
                if (securityRadio) securityRadio.checked = true;
            }
            
            // Update status display
            if (fromEmail && smtpHost && smtpUsername && smtpPassword) {
                document.getElementById('configStatus').textContent = 'Configured ‚úÖ';
                document.getElementById('configHost').textContent = smtpHost;
                document.getElementById('configEmail').textContent = fromEmail;
            }
            
        }

        // Email configuration save function
        function saveEmailSettings(event) {
            event.preventDefault();
            
            console.log('üíæ Saving email settings...');
            
            // Get form values
            const fromName = document.getElementById('adminFromName').value;
            const fromEmail = document.getElementById('adminFromEmail').value;
            const replyToEmail = document.getElementById('adminReplyToEmail').value;
            const adminEmail = document.getElementById('adminAdminEmail').value;
            const connectionType = document.getElementById('adminConnectionType').value;
            const provider = document.getElementById('adminProvider').value;
            const smtpHost = document.getElementById('adminSmtpHost').value;
            const smtpPort = document.getElementById('adminSmtpPort').value;
            const smtpUsername = document.getElementById('adminSmtpUsername').value;
            const smtpPassword = document.getElementById('adminSmtpPassword').value;
            
            // Get selected security option
            const securityRadio = document.querySelector('input[name="adminSmtpSecurity"]:checked');
            const smtpSecurity = securityRadio ? securityRadio.value : 'tls';
            
            // Validate required fields
            if (!fromName || !fromEmail || !smtpHost || !smtpUsername || !smtpPassword) {
                alert('‚ö†Ô∏è Vul alle verplichte velden in');
                return;
            }
            
            // Save to localStorage for booking system
            localStorage.setItem('adminFromName', fromName);
            localStorage.setItem('adminFromEmail', fromEmail);
            localStorage.setItem('adminReplyToEmail', replyToEmail);
            localStorage.setItem('adminAdminEmail', adminEmail);
            localStorage.setItem('adminConnectionType', connectionType);
            localStorage.setItem('adminProvider', provider);
            localStorage.setItem('adminSmtpHost', smtpHost);
            localStorage.setItem('adminSmtpPort', smtpPort);
            localStorage.setItem('adminSmtpUsername', smtpUsername);
            localStorage.setItem('adminSmtpPassword', smtpPassword);
            localStorage.setItem('adminSmtpSecurity', smtpSecurity);
            
            // Also save as complete email settings object
            const emailSettings = {
                fromName,
                fromEmail,
                replyToEmail,
                adminEmail,
                connectionType,
                provider,
                smtpHost,
                smtpPort,
                smtpUsername,
                smtpPassword,
                smtpSecurity,
                lastUpdated: new Date().toISOString()
            };
            localStorage.setItem('adminEmailSettings', JSON.stringify(emailSettings));
            
            // Update configuration status display
            document.getElementById('configStatus').textContent = 'Configured ‚úÖ';
            document.getElementById('configHost').textContent = smtpHost;
            document.getElementById('configEmail').textContent = fromEmail;
            
            // Show success message
            const statusDiv = document.getElementById('adminEmailStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.innerHTML = '‚úÖ Email instellingen opgeslagen! Het booking systeem kan nu emails versturen.';
            
            // Hide after 5 seconds
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
            
            console.log('‚úÖ Email settings saved successfully:', emailSettings);
        }

        // Email test function

        // Translation Section Functions
        function loadTranslation() {
            console.log('üåç Loading Translation settings...');
            
            const saved = localStorage.getItem('translationSettings');
            if (saved) {
                try {
                    const translation = JSON.parse(saved);
                    
                    // Load all form fields
                    document.getElementById('translationCompanyName').value = translation.companyName || '';
                    document.getElementById('translationLogoUrl').value = translation.logoUrl || '';
                    document.getElementById('translationStatusLine').value = translation.statusLine || '';
                    document.getElementById('translationMainMessage').value = translation.mainMessage || '';
                    document.getElementById('translationTripSection').value = translation.tripSection || '';
                    document.getElementById('translationDateTime').value = translation.dateTime || '';
                    document.getElementById('translationPickupLocation').value = translation.pickupLocation || '';
                    document.getElementById('translationDestination').value = translation.destination || '';
                    document.getElementById('translationVehicle').value = translation.vehicle || '';
                    document.getElementById('translationPassengers').value = translation.passengers || '';
                    document.getElementById('translationClientSection').value = translation.clientSection || '';
                    document.getElementById('translationName').value = translation.name || '';
                    document.getElementById('translationPhone').value = translation.phone || '';
                    document.getElementById('translationEmail').value = translation.email || '';
                    document.getElementById('translationReservationSection').value = translation.reservationSection || '';
                    document.getElementById('translationReferenceId').value = translation.referenceId || '';
                    document.getElementById('translationBookingDate').value = translation.bookingDate || '';
                    document.getElementById('translationSummary').value = translation.summary || '';
                    document.getElementById('translationTotal').value = translation.total || '';
                    document.getElementById('translationPayments').value = translation.payments || '';
                    document.getElementById('translationPaymentStatus').value = translation.paymentStatus || '';
                    document.getElementById('translationOwedAmount').value = translation.owedAmount || '';
                    document.getElementById('translationCancellation').value = translation.cancellation || '';
                    document.getElementById('translationChanges').value = translation.changes || '';
                    document.getElementById('translationBookingAdvice').value = translation.bookingAdvice || '';
                    document.getElementById('translationDriverInfo').value = translation.driverInfo || '';
                    
                } catch (error) {
                    console.error('‚ùå Error loading translation settings:', error);
                }
            } else {
                // Set default values
                setDefaultTranslationValues();
            }
        }

        function setDefaultTranslationValues() {
            document.getElementById('translationCompanyName').value = 'Taxi Leuven';
            document.getElementById('translationStatusLine').value = 'Uw booking wacht op bevestiging. Bedankt voor uw booking bij Taxi Leuven. Uw reservatienummer is [BOOKING_ID].';
            document.getElementById('translationMainMessage').value = 'Een bevestigingsmail wordt naar uw e-mailadres verzonden binnen 1 uur. ALS U GEEN EMAIL ONTVANGEN HEBT, GELIEVE MET ONS CONTACT OP TE NEMEN!';
            document.getElementById('translationTripSection').value = 'Reis';
            document.getElementById('translationDateTime').value = 'Datum & tijd:';
            document.getElementById('translationPickupLocation').value = 'Ophaallocatie:';
            document.getElementById('translationDestination').value = 'Bestemming:';
            document.getElementById('translationVehicle').value = 'Voertuig:';
            document.getElementById('translationPassengers').value = 'Passagiers:';
            document.getElementById('translationClientSection').value = 'Klant';
            document.getElementById('translationName').value = 'Naam:';
            document.getElementById('translationPhone').value = 'Telefoonnummer:';
            document.getElementById('translationEmail').value = 'E-mail:';
            document.getElementById('translationReservationSection').value = 'Reservatie';
            document.getElementById('translationReferenceId').value = 'Referentie-ID:';
            document.getElementById('translationBookingDate').value = 'Boekingsdatum:';
            document.getElementById('translationSummary').value = 'Samenvatting:';
            document.getElementById('translationTotal').value = 'Totaal:';
            document.getElementById('translationPayments').value = 'Betalingen:';
            document.getElementById('translationPaymentStatus').value = 'Pending';
            document.getElementById('translationOwedAmount').value = 'Verschuldigd bedrag:';
            document.getElementById('translationCancellation').value = 'Annulatie binnen 24 uur: Bij annulering binnen 24 uur voor de geplande rit wordt het volledige bedrag van de rit in rekening gebracht.';
            document.getElementById('translationChanges').value = 'Wijzigingen binnen 24 uur: Voor aanpassingen aan een bestaande reservering binnen 24 uur (bijvoorbeeld door het missen van een vlucht) wordt een toeslag van ‚Ç¨30 gerekend.';
            document.getElementById('translationBookingAdvice').value = 'Boekingsregels: Het rechtstreeks reserveren van een rit via een van onze chauffeurs is niet toegestaan. Voor een verzekerde en kwalitatieve dienstverlening verzoeken wij u uw taxi uitsluitend via ons offici√´le systeem te boeken.';
            document.getElementById('translationDriverInfo').value = 'E√©n dag voor uw vertrek sturen wij u het nummer van de chauffeur, zodra wij onze planning hebben gemaakt.';
        }

        function saveTranslation(event) {
            event.preventDefault();
            
            console.log('üíæ Saving Translation settings...');
            
            const translationData = {
                companyName: document.getElementById('translationCompanyName').value,
                logoUrl: document.getElementById('translationLogoUrl').value,
                statusLine: document.getElementById('translationStatusLine').value,
                mainMessage: document.getElementById('translationMainMessage').value,
                tripSection: document.getElementById('translationTripSection').value,
                dateTime: document.getElementById('translationDateTime').value,
                pickupLocation: document.getElementById('translationPickupLocation').value,
                destination: document.getElementById('translationDestination').value,
                vehicle: document.getElementById('translationVehicle').value,
                passengers: document.getElementById('translationPassengers').value,
                clientSection: document.getElementById('translationClientSection').value,
                name: document.getElementById('translationName').value,
                phone: document.getElementById('translationPhone').value,
                email: document.getElementById('translationEmail').value,
                reservationSection: document.getElementById('translationReservationSection').value,
                referenceId: document.getElementById('translationReferenceId').value,
                bookingDate: document.getElementById('translationBookingDate').value,
                summary: document.getElementById('translationSummary').value,
                total: document.getElementById('translationTotal').value,
                payments: document.getElementById('translationPayments').value,
                paymentStatus: document.getElementById('translationPaymentStatus').value,
                owedAmount: document.getElementById('translationOwedAmount').value,
                cancellation: document.getElementById('translationCancellation').value,
                changes: document.getElementById('translationChanges').value,
                bookingAdvice: document.getElementById('translationBookingAdvice').value,
                driverInfo: document.getElementById('translationDriverInfo').value,
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('translationSettings', JSON.stringify(translationData));
            
            // Show success message
            const statusDiv = document.getElementById('translationStatus');
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#d4edda';
            statusDiv.style.color = '#155724';
            statusDiv.style.border = '1px solid #c3e6cb';
            statusDiv.innerHTML = '‚úÖ Translation settings saved successfully!';
            
            setTimeout(() => {
                statusDiv.style.display = 'none';
            }, 5000);
            
            console.log('‚úÖ Translation settings saved:', translationData);
        }

        function previewTranslationEmail() {
            console.log('üìß Generating email preview...');
            
            // Get current translation values
            const translation = {
                companyName: document.getElementById('translationCompanyName').value || 'Taxi Leuven',
                logoUrl: document.getElementById('translationLogoUrl').value || '',
                statusLine: document.getElementById('translationStatusLine').value || 'Uw booking wacht op bevestiging.',
                mainMessage: document.getElementById('translationMainMessage').value || 'Bedankt voor uw booking.',
                tripSection: document.getElementById('translationTripSection').value || 'Reis',
                dateTime: document.getElementById('translationDateTime').value || 'Datum & tijd:',
                pickupLocation: document.getElementById('translationPickupLocation').value || 'Ophaallocatie:',
                destination: document.getElementById('translationDestination').value || 'Bestemming:',
                vehicle: document.getElementById('translationVehicle').value || 'Voertuig:',
                passengers: document.getElementById('translationPassengers').value || 'Passagiers:',
                clientSection: document.getElementById('translationClientSection').value || 'Klant',
                name: document.getElementById('translationName').value || 'Naam:',
                phone: document.getElementById('translationPhone').value || 'Telefoonnummer:',
                email: document.getElementById('translationEmail').value || 'E-mail:',
                reservationSection: document.getElementById('translationReservationSection').value || 'Reservatie',
                referenceId: document.getElementById('translationReferenceId').value || 'Referentie-ID:',
                bookingDate: document.getElementById('translationBookingDate').value || 'Boekingsdatum:',
                summary: document.getElementById('translationSummary').value || 'Samenvatting:',
                total: document.getElementById('translationTotal').value || 'Totaal:',
                payments: document.getElementById('translationPayments').value || 'Betalingen:',
                paymentStatus: document.getElementById('translationPaymentStatus').value || 'Pending',
                owedAmount: document.getElementById('translationOwedAmount').value || 'Verschuldigd bedrag:',
                cancellation: document.getElementById('translationCancellation').value || 'Annulatie regels...',
                changes: document.getElementById('translationChanges').value || 'Wijziging regels...',
                bookingAdvice: document.getElementById('translationBookingAdvice').value || 'Booking advies...',
                driverInfo: document.getElementById('translationDriverInfo').value || 'Chauffeur informatie...'
            };
            
            // Generate preview HTML
            const previewHTML = generateEmailPreview(translation);
            
            // Open in new window
            const previewWindow = window.open('', '_blank', 'width=700,height=800,scrollbars=yes');
            previewWindow.document.write(previewHTML);
            previewWindow.document.close();
        }

        // Initialize admin panel when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Admin panel DOM loaded');
            
            // Show dashboard by default
            showSection('dispatch');
            
            // Load email settings
            loadEmailSettings();
            
            // Load translation settings when translation section is opened
            const translationNav = document.querySelector('[onclick="showSection(\'translation\')"]');
            if (translationNav) {
                translationNav.addEventListener('click', () => {
                    setTimeout(loadTranslation, 100);
                });
            }
            
            // Test menu functionality after page load
            setTimeout(() => {
                console.log('üîß Testing menu functionality...');
                
                // Test if menu elements exist
                const bookingsMenu = document.getElementById('bookings-menu');
                const settingsMenu = document.getElementById('settings-menu');
                const pricingMenu = document.getElementById('pricing-menu');
                
                console.log('üìã Bookings menu found:', !!bookingsMenu);
                console.log('‚öôÔ∏è Settings menu found:', !!settingsMenu);
                console.log('üí∞ Pricing menu found:', !!pricingMenu);
                
                // Test toggle functionality
                if (settingsMenu) {
                    console.log('‚úÖ Menu system ready');
                    updateTestResults('‚úÖ Menu system initialized successfully');
                } else {
                    console.error('‚ùå Menu system failed to initialize');
                    updateTestResults('‚ùå Menu system failed to initialize');
                }
                
                // Initialize Meet and Greet when admin loads
                initializeMeetAndGreet();
            }, 500);
        });

        // Meet and Greet Location Management Functions
        let meetAndGreetLocations = {
            airports: [
                {
                    id: 'brussels-airport',
                    name: 'Brussels Airport (BRU)',
                    fullName: 'Brussels Airport',
                    code: 'BRU',
                    address: 'A201, 1930 Zaventem, Belgium',
                    enabled: true,
                    meetGreetEnabled: true,
                    pickupInstructions: 'Onze chauffeur wacht op u in de aankomsthal met een naambord. Locatie: bij de informatiebalie.'
                },
                {
                    id: 'charleroi-airport',
                    name: 'Brussels South Charleroi Airport (CRL)',
                    fullName: 'Brussels South Charleroi Airport',
                    code: 'CRL',
                    address: 'Rue des Fr√®res Wright 8, 6041 Charleroi, Belgium',
                    enabled: true,
                    meetGreetEnabled: true,
                    pickupInstructions: 'Meet & Greet service beschikbaar in de aankomsthal. Onze chauffeur wacht bij de uitgang.'
                }
            ],
            stations: [
                {
                    id: 'brussels-central',
                    name: 'Brussels Central Station',
                    fullName: 'Gare Centrale / Centraal Station',
                    address: 'Carrefour de l\'Europe 2, 1000 Brussels, Belgium',
                    enabled: true,
                    meetGreetEnabled: true,
                    pickupInstructions: 'Onze chauffeur wacht bij de hoofdingang van het station.'
                }
            ],
            hotels: [
                {
                    id: 'hilton-brussels',
                    name: 'Hilton Brussels City',
                    fullName: 'Hilton Brussels City Hotel',
                    address: 'Place Eug√®ne Flagey 20, 1050 Brussels, Belgium',
                    enabled: true,
                    meetGreetEnabled: true,
                    pickupInstructions: 'Onze chauffeur wacht in de lobby van het hotel.'
                }
            ]
        };

        function initializeMeetAndGreet() {
            // Load Meet and Greet settings from localStorage
            const savedLocations = localStorage.getItem('meetAndGreetLocations');
            if (savedLocations) {
                meetAndGreetLocations = JSON.parse(savedLocations);
            } else {
                // Save default locations to localStorage for first time use
                console.log('üíæ No Meet & Greet locations found, saving defaults to localStorage');
                localStorage.setItem('meetAndGreetLocations', JSON.stringify(meetAndGreetLocations));
            }
            
            // Update Meet & Greet surcharge price from Item Surcharge
            updateMeetGreetSurchargeInfo();
            
            // Load locations when Meet and Greet section is shown
            if (document.getElementById('meet-and-greet-section')) {
                renderLocationTabs();
            }
        }

        function updateMeetGreetSurchargeInfo() {
            // Find Meet & Greet item in surchargeItems
            const meetGreetItem = surchargeItems.fixed.find(item => item.id === 'meet-greet');
            if (meetGreetItem) {
                const priceElement = document.getElementById('meetGreetSurchargePrice');
                const statusElement = document.getElementById('meetGreetSurchargeStatus');
                
                if (priceElement) {
                    priceElement.textContent = meetGreetItem.price.toFixed(2);
                }
                
                if (statusElement) {
                    if (meetGreetItem.enabled) {
                        statusElement.textContent = 'Actief';
                        statusElement.style.background = '#28a745';
                        statusElement.style.color = 'white';
                    } else {
                        statusElement.textContent = 'Uitgeschakeld';
                        statusElement.style.background = '#dc3545';
                        statusElement.style.color = 'white';
                    }
                }
            }
        }

        function switchLocationTab(type) {
            // Update tab appearance
            document.querySelectorAll('.location-tab').forEach(tab => {
                if (tab.dataset.type === type) {
                    tab.style.background = '#007bff';
                    tab.style.color = 'white';
                } else {
                    tab.style.background = '#6c757d';
                    tab.style.color = 'white';
                }
            });
            
            // Show/hide tab content
            document.querySelectorAll('.location-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            document.getElementById(type + 'Tab').style.display = 'block';
            
            // Render locations for selected type
            renderLocations(type);
        }

        function renderLocationTabs() {
            // Default to airports tab
            switchLocationTab('airports');
        }

        function renderLocations(type) {
            const container = document.getElementById(type + 'List');
            const locations = meetAndGreetLocations[type] || [];
            
            if (locations.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìç</div>
                        <p>Nog geen ${type === 'airports' ? 'luchthavens' : type === 'stations' ? 'stations' : 'hotels'} toegevoegd.</p>
                        <p style="font-size: 14px;">Klik op "+ Nieuwe ${type === 'airports' ? 'Luchthaven' : type === 'stations' ? 'Station' : 'Hotel'}" om te beginnen.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = locations.map((location, index) => `
                <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 15px; background: ${location.enabled ? 'white' : '#f8f9fa'};">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div style="flex: 1;">
                            <h5 style="margin: 0 0 5px 0; color: #2c3e50; font-size: 16px;">
                                ${getLocationIcon(type)} ${location.name}
                            </h5>
                            <p style="margin: 0 0 5px 0; color: #6c757d; font-size: 14px;">${location.fullName}</p>
                            ${location.code ? `<span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: 600;">${location.code}</span>` : ''}
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button onclick="editLocation('${type}', ${index})" style="background: #007bff; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">‚úèÔ∏è Edit</button>
                            <button onclick="deleteLocation('${type}', ${index})" style="background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è</button>
                        </div>
                    </div>
                    
                    <div class="section-margin">
                        <p style="margin: 0; color: #495057; font-size: 14px;"><strong>Adres:</strong> ${location.address}</p>
                    </div>
                    
                    <div class="section-margin">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 14px;">
                            <input type="checkbox" ${location.meetGreetEnabled ? 'checked' : ''} onchange="toggleLocationMeetGreet('${type}', ${index}, this.checked)">
                            <span>ü§ù Meet & Greet service actief</span>
                        </label>
                    </div>
                    
                    ${location.meetGreetEnabled ? `
                    <div style="background: #e8f5e9; padding: 15px; border-radius: 6px; border-left: 4px solid #28a745;">
                        <h6 style="margin: 0 0 10px 0; color: #155724;">üìù Ophaalinstructies</h6>
                        <textarea onchange="updatePickupInstructions('${type}', ${index}, this.value)" 
                                  style="width: 100%; padding: 8px; border: 1px solid #c3e6cb; border-radius: 4px; resize: vertical; min-height: 60px; font-size: 13px;"
                                  placeholder="Beschrijf waar de klant opgehaald wordt...">${location.pickupInstructions || ''}</textarea>
                    </div>
                    ` : ''}
                </div>
            `).join('');
        }

        function getLocationIcon(type) {
            switch(type) {
                case 'airports': return '‚úàÔ∏è';
                case 'stations': return 'üöâ';
                case 'hotels': return 'üè®';
                default: return 'üìç';
            }
        }

        function addNewLocation(type) {
            showAddLocationModal(type);
        }

        function showAddLocationModal(type) {
            const typeLabels = {
                'airports': 'Luchthaven',
                'stations': 'Station', 
                'hotels': 'Hotel'
            };
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.5);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 2px solid #e9ecef; padding-bottom: 15px;">
                        <h3 style="margin: 0; color: #2c3e50; font-size: 24px;">
                            ${getLocationIcon(type)} Nieuwe ${typeLabels[type]} Toevoegen
                        </h3>
                        <button onclick="closeAddLocationModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">√ó</button>
                    </div>
                    
                    <form id="addLocationForm" onsubmit="submitNewLocation(event, '${type}')">
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                üìç Naam van de ${typeLabels[type].toLowerCase()}:
                            </label>
                            <input type="text" id="locationName" required 
                                   placeholder="Bijv. Brussels Airport" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                üè† Volledig adres:
                            </label>
                            <input type="text" id="locationAddress" required 
                                   placeholder="Bijv. A201, 1930 Zaventem, Belgium" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px;">
                        </div>
                        
                        ${type === 'airports' ? `
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                ‚úàÔ∏è Luchthaven code (optioneel):
                            </label>
                            <input type="text" id="locationCode" 
                                   placeholder="Bijv. BRU" 
                                   style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; text-transform: uppercase;" 
                                   maxlength="4">
                        </div>
                        ` : ''}
                        
                        <div class="section-margin-lg">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #495057;">
                                üìù Ophaalinstructies:
                            </label>
                            <textarea id="locationInstructions" 
                                      placeholder="Bijv. Onze chauffeur wacht op u in de aankomsthal met een naambord."
                                      style="width: 100%; padding: 12px; border: 2px solid #e9ecef; border-radius: 8px; font-size: 16px; min-height: 80px; resize: vertical;">${getDefaultPickupInstructions(type)}</textarea>
                        </div>
                        
                        <div style="margin-bottom: 25px; background: #e8f5e8; padding: 15px; border-radius: 8px; border-left: 4px solid #28a745;">
                            <label style="display: flex; align-items: center; cursor: pointer;">
                                <input type="checkbox" id="meetGreetEnabled" checked 
                                       style="margin-right: 10px; transform: scale(1.2);">
                                <span style="font-weight: 600; color: #155724;">
                                    ü§ù Meet & Greet service inschakelen voor deze locatie
                                </span>
                            </label>
                            <p style="margin: 8px 0 0 0; font-size: 14px; color: #155724;">
                                Wanneer iemand boekt vanaf deze locatie wordt automatisch ‚Ç¨5.00 Meet & Greet toeslag toegevoegd.
                            </p>
                        </div>
                        
                        <div style="display: flex; gap: 15px; justify-content: flex-end;">
                            <button type="button" onclick="closeAddLocationModal()" 
                                    style="padding: 12px 24px; border: 2px solid #6c757d; background: white; color: #6c757d; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                Annuleren
                            </button>
                            <button type="submit" 
                                    style="padding: 12px 24px; border: none; background: #28a745; color: white; border-radius: 8px; cursor: pointer; font-weight: 600;">
                                ${typeLabels[type]} Toevoegen
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('locationName').focus();
        }

        function closeAddLocationModal() {
            const modal = document.querySelector('[style*="position: fixed"][style*="z-index: 10000"]');
            if (modal) {
                modal.remove();
            }
        }

        function submitNewLocation(event, type) {
            event.preventDefault();
            
            const name = document.getElementById('locationName').value.trim();
            const address = document.getElementById('locationAddress').value.trim();
            const code = document.getElementById('locationCode')?.value.trim().toUpperCase() || '';
            const instructions = document.getElementById('locationInstructions').value.trim();
            const meetGreetEnabled = document.getElementById('meetGreetEnabled').checked;
            
            if (!name || !address) {
                alert('Naam en adres zijn verplicht.');
                return;
            }
            
            const newLocation = {
                id: name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
                name: name,
                fullName: name,
                address: address,
                enabled: true,
                meetGreetEnabled: meetGreetEnabled,
                pickupInstructions: instructions || getDefaultPickupInstructions(type)
            };
            
            if (code) {
                newLocation.code = code;
            }
            
            if (!meetAndGreetLocations[type]) {
                meetAndGreetLocations[type] = [];
            }
            
            meetAndGreetLocations[type].push(newLocation);
            renderLocations(type);
            closeAddLocationModal();
            
            console.log(`‚úÖ Nieuwe ${type} locatie toegevoegd:`, newLocation);
            
            // Show success message
            showNotification(`‚úÖ ${newLocation.name} succesvol toegevoegd!`, 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#007bff'};
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10001;
                font-weight: 600;
                max-width: 400px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        function getDefaultPickupInstructions(type) {
            switch(type) {
                case 'airports':
                    return 'Onze chauffeur wacht op u in de aankomsthal met een naambord.';
                case 'stations':
                    return 'Onze chauffeur wacht bij de hoofdingang van het station.';
                case 'hotels':
                    return 'Onze chauffeur wacht in de lobby van het hotel.';
                default:
                    return 'Onze chauffeur wacht op de afgesproken locatie.';
            }
        }

        function toggleLocationMeetGreet(type, index, enabled) {
            meetAndGreetLocations[type][index].meetGreetEnabled = enabled;
            renderLocations(type);
            console.log(`ü§ù Meet & Greet ${enabled ? 'ingeschakeld' : 'uitgeschakeld'} voor ${meetAndGreetLocations[type][index].name}`);
        }

        function updatePickupInstructions(type, index, instructions) {
            meetAndGreetLocations[type][index].pickupInstructions = instructions;
            console.log(`üìù Ophaalinstructies bijgewerkt voor ${meetAndGreetLocations[type][index].name}`);
        }

        function editLocation(type, index) {
            const location = meetAndGreetLocations[type][index];
            
            const newName = prompt('Naam:', location.name);
            if (newName === null) return;
            
            const newAddress = prompt('Adres:', location.address);
            if (newAddress === null) return;
            
            let newCode = location.code || '';
            if (type === 'airports') {
                newCode = prompt('Luchthaven code:', newCode) || '';
            }
            
            // Update location
            location.name = newName;
            location.fullName = newName;
            location.address = newAddress;
            if (newCode) {
                location.code = newCode.toUpperCase();
            }
            
            renderLocations(type);
            console.log(`‚úèÔ∏è Locatie bijgewerkt:`, location);
        }

        function deleteLocation(type, index) {
            const location = meetAndGreetLocations[type][index];
            if (confirm(`Weet je zeker dat je "${location.name}" wilt verwijderen?`)) {
                meetAndGreetLocations[type].splice(index, 1);
                renderLocations(type);
                console.log(`üóëÔ∏è Locatie verwijderd: ${location.name}`);
            }
        }

        function saveMeetAndGreetSettings() {
            try {
                // Save to localStorage
                localStorage.setItem('meetAndGreetLocations', JSON.stringify(meetAndGreetLocations));
                
                // Show success message
                const statusDiv = document.getElementById('meetGreetStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = '‚úÖ Meet & Greet instellingen succesvol opgeslagen!';
                
                // Hide after 3 seconds
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
                
                console.log('‚úÖ Meet & Greet settings saved:', meetAndGreetLocations);
                
                // Update surcharge info
                updateMeetGreetSurchargeInfo();
                
            } catch (error) {
                console.error('‚ùå Failed to save Meet & Greet settings:', error);
                
                const statusDiv = document.getElementById('meetGreetStatus');
                statusDiv.style.display = 'block';
                statusDiv.style.background = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.innerHTML = '‚ùå Fout bij opslaan van instellingen: ' + error.message;
            }
        }

        // Function to check if a location requires Meet & Greet
        function checkMeetAndGreetRequired(fromLocation) {
            const allLocations = [
                ...meetAndGreetLocations.airports,
                ...meetAndGreetLocations.stations,
                ...meetAndGreetLocations.hotels
            ];
            
            // Check if the pickup location matches any registered Meet & Greet location
            for (const location of allLocations) {
                if (!location.enabled || !location.meetGreetEnabled) continue;
                
                // Simple text matching - in production you might want more sophisticated matching
                const locationNames = [
                    location.name.toLowerCase(),
                    location.fullName.toLowerCase(),
                    location.code?.toLowerCase()
                ].filter(Boolean);
                
                const fromLoc = fromLocation.toLowerCase();
                
                for (const locName of locationNames) {
                    if (fromLoc.includes(locName) || locName.includes(fromLoc)) {
                        return {
                            required: true,
                            location: location,
                            instructions: location.pickupInstructions
                        };
                    }
                }
            }
            
            return { required: false };
        }
        

        window.inspectSelectedSurcharges = function() {
            const selectedSurcharges = localStorage.getItem('selectedSurcharges');
            console.log('üîç LOCALSTORAGE selectedSurcharges RAW:', selectedSurcharges);
            
            if (selectedSurcharges) {
                try {
                    const parsed = JSON.parse(selectedSurcharges);
                    console.log('üîç PARSED selectedSurcharges:', parsed);
                    console.log('üîç KEYS:', Object.keys(parsed));
                    console.log('üîç VALUES:', Object.values(parsed));
                } catch (e) {
                    console.log('‚ùå Failed to parse selectedSurcharges:', e);
                }
            } else {
                console.log('‚ùå No selectedSurcharges in localStorage');
            }
        };

        // üÜï PROFESSIONAL BOOKING OVERVIEW MODAL (matches STEP 3 format)
        function showBookingOverview(bookingId, tripType = 'both') {
            console.log('üìã Opening professional booking overview for:', bookingId, 'tripType:', tripType);
            
            // Find booking in all possible lists
            let booking = null;
            let bookingSource = '';
            
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            const cancelledBookings = JSON.parse(localStorage.getItem('cancelledBookings') || '[]');
            
            booking = unconfirmedBookings.find(b => b.bookingId === bookingId);
            if (booking) bookingSource = 'unconfirmed';
            
            if (!booking) {
                booking = confirmedBookings.find(b => b.bookingId === bookingId);
                if (booking) bookingSource = 'confirmed';
            }
            
            if (!booking) {
                booking = completedBookings.find(b => b.bookingId === bookingId);
                if (booking) bookingSource = 'completed';
            }
            
            if (!booking) {
                booking = cancelledBookings.find(b => b.bookingId === bookingId);
                if (booking) bookingSource = 'cancelled';
            }
            
            if (!booking) {
                alert('‚ùå Booking niet gevonden!');
                return;
            }
            
            console.log('üìã Found booking:', booking);
            console.log('üìã Booking source:', bookingSource);
            
            // Store booking data globally for editing
            currentBookingData = booking;
            currentBookingSource = bookingSource;
            
            // Generate professional overview content
            const overviewContent = generateProfessionalOverview(booking, tripType);
            
            // Create modal with same styling as STEP 3
            const modalHTML = `
                <div id="bookingOverviewModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                    backdrop-filter: blur(4px);
                ">
                    <div style="
                        background: white;
                        border-radius: 15px;
                        max-width: 700px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <!-- Gradient Header matching STEP 3 -->
                        <div style="
                            background: linear-gradient(135deg, #2c3e50, #34495e);
                            color: white;
                            padding: 25px;
                            border-radius: 15px 15px 0 0;
                            position: relative;
                        ">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">
                                üìã Booking Overzicht
                            </h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                Booking ID: ${booking.bookingId} ‚Ä¢ Status: ${bookingSource.charAt(0).toUpperCase() + bookingSource.slice(1)}
                            </p>
                            <button onclick="closeBookingOverview()" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 35px;
                                height: 35px;
                                cursor: pointer;
                                font-size: 18px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: background 0.3s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                ‚úï
                            </button>
                        </div>
                        
                        <!-- Content Area -->
                        <div style="padding: 25px;">
                            ${overviewContent}
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }
        
        // Helper function voor personal info
        function generatePersonalInfoSection(customer, booking) {
            return `
                <div style="margin-bottom: 25px;">
                    <h3 style="
                        margin: 0 0 15px 0;
                        padding: 12px 0;
                        border-bottom: 2px solid #e9ecef;
                        color: #2c3e50;
                        font-size: 18px;
                        font-weight: 600;
                    ">Persoonlijke gegevens</h3>
                    <div style="
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 15px;
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 10px;
                        border: 1px solid #e9ecef;
                    ">
                        <div>
                            <label class="field-label">Voornaam:</label>
                            <div class="field-value">${customer.firstName || 'Niet opgegeven'}</div>
                        </div>
                        <div>
                            <label class="field-label">Achternaam:</label>
                            <div class="field-value">${customer.lastName || 'Niet opgegeven'}</div>
                        </div>
                        <div>
                            <label class="field-label">Email:</label>
                            <div class="field-value">${customer.email || 'Niet opgegeven'}</div>
                        </div>
                        <div>
                            <label class="field-label">Telefoon:</label>
                            <div class="field-value">${customer.phone || 'Niet opgegeven'}</div>
                        </div>
                        <div>
                            <label class="field-label">Aantal passagiers:</label>
                            <div class="field-value">${customer.passengers || 1}</div>
                        </div>
                        ${customer.flightNumber && booking.status === 'Unconfirmed' && booking.tripType === 'terug' ? `
                        <div>
                            <label class="field-label">Vluchtnummer (Terugreis):</label>
                            <div style="margin-top: 4px; font-size: 16px; color: #2c3e50; font-weight: 600; background: #e3f2fd; padding: 8px; border-radius: 6px; border: 1px solid #bbdefb;">‚úàÔ∏è ${customer.flightNumber}</div>
                        </div>
                        ` : ''}
                        <div>
                            <label class="field-label">Koffers:</label>
                            <div class="field-value">üß≥ ${customer.koffers || 0}</div>
                        </div>
                        <div>
                            <label class="field-label">Handbagage:</label>
                            <div class="field-value">üíº ${customer.handbagage || 0}</div>
                        </div>
                        <div>
                            <label class="field-label">Betaalmethode:</label>
                            <div class="field-value">${customer.paymentMethod || 'Cash'}</div>
                        </div>
                        ${customer.paypalPayment ? `
                        <div style="grid-column: 1 / -1;">
                            <label class="field-label">PayPal Details:</label>
                            <div style="margin-top: 8px; background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb;">
                                <div style="font-size: 14px; color: #1976d2; margin-bottom: 8px;">
                                    <strong>Transaction ID:</strong> ${customer.paypalPayment.transactionId || 'N/A'}
                                </div>
                                <div style="font-size: 14px; color: #1976d2; margin-bottom: 8px;">
                                    <strong>Amount:</strong> ‚Ç¨${customer.paypalPayment.amount?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #1976d2; margin-bottom: 8px;">
                                    <strong>PayPal Fee:</strong> ‚Ç¨${customer.paypalPayment.fee?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #1976d2; margin-bottom: 8px;">
                                    <strong>Total Charged:</strong> ‚Ç¨${customer.paypalPayment.total?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #1976d2; margin-bottom: 8px;">
                                    <strong>Currency:</strong> ${customer.paypalPayment.currency || 'EUR'}
                                </div>
                                <div style="font-size: 14px; color: #1976d2;">
                                    <strong>Environment:</strong> ${customer.paypalPayment.environment || 'Live'}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                        ${customer.creditCardPayment ? `
                        <div style="grid-column: 1 / -1;">
                            <label class="field-label">Credit Card Details:</label>
                            <div style="margin-top: 8px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Transaction ID:</strong> ${customer.creditCardPayment.transactionId || 'N/A'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Card Type:</strong> ${customer.creditCardPayment.cardType || 'N/A'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Last 4 Digits:</strong> ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ${customer.creditCardPayment.last4 || 'N/A'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Amount:</strong> ‚Ç¨${customer.creditCardPayment.amount?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Processing Fee:</strong> ‚Ç¨${customer.creditCardPayment.fee?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Total Charged:</strong> ‚Ç¨${customer.creditCardPayment.total?.toFixed(2) || '0.00'}
                                </div>
                                <div style="font-size: 14px; color: #495057; margin-bottom: 8px;">
                                    <strong>Currency:</strong> ${customer.creditCardPayment.currency || 'EUR'}
                                </div>
                                <div style="font-size: 14px; color: #495057;">
                                    <strong>Environment:</strong> ${customer.creditCardPayment.environment || 'Live'}
                                </div>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                    ${customer.specialRequests ? `
                        <div style="margin-top: 15px; background: #fff3cd; padding: 15px; border-radius: 8px; border: 1px solid #ffeaa7;">
                            <label style="font-weight: 600; color: #856404; font-size: 14px;">Bijzondere verzoeken:</label>
                            <div style="margin-top: 8px; color: #856404; font-size: 15px; line-height: 1.4;">${customer.specialRequests}</div>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        function generateProfessionalOverview(booking, tripType = 'both') {
            console.log('üìã Generating professional overview for booking:', booking.bookingId, 'tripType:', tripType);
            
            // Extract data with fallbacks
            const customer = booking.customer || {};
            const trip = booking.trip || {};
            const vehicle = booking.vehicle || {};
            const surcharges = booking.surcharges || {};
            
            // Get surcharge data - handle nested structure
            const actualSurcharges = surcharges.selectedSurcharges || surcharges;
            
            console.log('üìã Processing surcharges:', actualSurcharges);
            
            // Build personal information section
            const personalInfoHTML = generatePersonalInfoSection(customer, booking);
            
            // Handle return trips with separate display - WITH CONDITIONAL LOGIC
            let tripDetailsHTML = '';
            const isReturnTrip = trip.returnActive === 'true' || trip.returnActive === true;
            
            if (isReturnTrip) {
                // Determine which sections to show based on tripType parameter
                const showHeen = tripType === 'both' || tripType === 'heen';
                const showTerug = tripType === 'both' || tripType === 'terug';
                
                // Build title based on what we're showing
                let titleText = 'Reis Details';
                if (tripType === 'heen') {
                    titleText = 'Reis Details - Heen Reis';
                } else if (tripType === 'terug') {
                    titleText = 'Reis Details - Terug Reis';
                } else {
                    titleText = 'Reis Details - Heen & Terug';
                }
                
                // Build grid layout - single column if only showing one trip
                const gridColumns = (showHeen && showTerug) ? '1fr 1fr' : '1fr';
                
                tripDetailsHTML = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="
                            margin: 0 0 15px 0;
                            padding: 12px 0;
                            border-bottom: 2px solid #e9ecef;
                            color: #2c3e50;
                            font-size: 18px;
                            font-weight: 600;
                        ">${titleText}</h3>
                        <div style="display: grid; grid-template-columns: ${gridColumns}; gap: 20px;">
                            ${showHeen ? `
                            <!-- HEEN REIS -->
                            <div style="
                                background: #e3f2fd;
                                padding: 20px;
                                border-radius: 10px;
                                border: 1px solid #bbdefb;
                            ">
                                <h4 style="margin: 0 0 15px 0; color: #1976d2; font-size: 16px; font-weight: 600;">üöó Heen Reis</h4>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #1565c0; font-size: 13px;">Van waar:</label>
                                    <div style="margin-top: 4px; color: #0d47a1; font-size: 14px;">${trip.fromLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #1565c0; font-size: 13px;">Naar waar:</label>
                                    <div style="margin-top: 4px; color: #0d47a1; font-size: 14px;">${trip.toLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #1565c0; font-size: 13px;">Datum & Tijd:</label>
                                    <div style="margin-top: 4px; color: #0d47a1; font-size: 14px;">${trip.travelDate || 'Niet opgegeven'} om ${trip.travelHour || '00'}:${trip.travelMinute || '00'}</div>
                                </div>
                            </div>
                            ` : ''}
                            
                            ${showTerug ? `
                            <!-- TERUG REIS -->
                            <div style="
                                background: #f3e5f5;
                                padding: 20px;
                                border-radius: 10px;
                                border: 1px solid #ce93d8;
                            ">
                                <h4 style="margin: 0 0 15px 0; color: #7b1fa2; font-size: 16px; font-weight: 600;">üîÑ Terug Reis</h4>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #6a1b9a; font-size: 13px;">Van waar:</label>
                                    <div style="margin-top: 4px; color: #4a148c; font-size: 14px;">${trip.toLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #6a1b9a; font-size: 13px;">Naar waar:</label>
                                    <div style="margin-top: 4px; color: #4a148c; font-size: 14px;">${trip.fromLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div style="margin-bottom: 10px;">
                                    <label style="font-weight: 600; color: #6a1b9a; font-size: 13px;">Datum & Tijd:</label>
                                    <div style="margin-top: 4px; color: #4a148c; font-size: 14px;">${trip.returnDate || trip.travelDate || 'Niet opgegeven'} om ${trip.returnHour || trip.travelHour || '00'}:${trip.returnMinute || trip.travelMinute || '00'}</div>
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        ${trip.extraStops && trip.extraStops.length > 0 ? `
                            <div style="margin-top: 15px; background: #fff8e1; padding: 15px; border-radius: 8px; border: 1px solid #ffcc02;">
                                <label style="font-weight: 600; color: #f57f17; font-size: 14px;">Extra Stops (${trip.extraStops.length}):</label>
                                <div style="margin-top: 8px;">
                                    ${trip.extraStops.map((stop, index) => `
                                        <div style="color: #ef6c00; font-size: 14px; margin-bottom: 4px;">
                                            ${index + 1}. ${stop}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else {
                // Single trip display
                tripDetailsHTML = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="
                            margin: 0 0 15px 0;
                            padding: 12px 0;
                            border-bottom: 2px solid #e9ecef;
                            color: #2c3e50;
                            font-size: 18px;
                            font-weight: 600;
                        ">Reis Details</h3>
                        <div style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            border: 1px solid #e9ecef;
                        ">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                                <div>
                                    <label class="field-label">Van waar:</label>
                                    <div class="field-value">${trip.fromLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div>
                                    <label class="field-label">Naar waar:</label>
                                    <div class="field-value">${trip.toLocation || 'Niet opgegeven'}</div>
                                </div>
                                <div>
                                    <label class="field-label">Datum:</label>
                                    <div class="field-value">${trip.travelDate || 'Niet opgegeven'}</div>
                                </div>
                                <div>
                                    <label class="field-label">Tijd:</label>
                                    <div class="field-value">${trip.travelHour || '00'}:${trip.travelMinute || '00'}</div>
                                </div>
                            </div>
                            ${trip.extraStops && trip.extraStops.length > 0 ? `
                                <div style="margin-top: 15px; background: #fff8e1; padding: 15px; border-radius: 8px; border: 1px solid #ffcc02;">
                                    <label style="font-weight: 600; color: #f57f17; font-size: 14px;">Extra Stops (${trip.extraStops.length}):</label>
                                    <div style="margin-top: 8px;">
                                        ${trip.extraStops.map((stop, index) => `
                                            <div style="color: #ef6c00; font-size: 14px; margin-bottom: 4px;">
                                                ${index + 1}. ${stop}
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // Vehicle information
            const vehicleHTML = `
                <div style="margin-bottom: 25px;">
                    <h3 style="
                        margin: 0 0 15px 0;
                        padding: 12px 0;
                        border-bottom: 2px solid #e9ecef;
                        color: #2c3e50;
                        font-size: 18px;
                        font-weight: 600;
                    ">Voertuig Informatie</h3>
                    <div style="
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 10px;
                        border: 1px solid #e9ecef;
                    ">
                        <div style="font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 8px;">
                            ${vehicle.vehicle?.name || 'Saloon'}
                        </div>
                        <div style="font-size: 14px; color: #6c757d;">
                            Type: ${vehicle.vehicle?.type || 'Standard'} | Capaciteit: ${vehicle.vehicle?.capacity || '4'} personen
                        </div>
                    </div>
                </div>
            `;
            
            // Extra options (surcharges) - filtered and formatted like STEP 3
            let extraOptionsHTML = '';
            const filteredSurcharges = [];
            
            if (actualSurcharges && typeof actualSurcharges === 'object') {
                Object.entries(actualSurcharges).forEach(([key, value]) => {
                    // Filter out technical fields
                    if (key === 'totalSurcharge' || key === 'surchargeTotal' || 
                        key === 'Airport surcharge' || key === 'ExtraStopCount' || 
                        key === 'extraStopCount' || key === 'SurchargeTotal') {
                        return;
                    }
                    
                    // Handle both object and simple value formats
                    let name, price, quantity = 1;
                    
                    if (value && typeof value === 'object') {
                        name = value.name || key;
                        price = value.price || 0;
                        quantity = value.quantity || 1;
                    } else if (typeof value === 'number') {
                        name = key;
                        price = value;
                    } else if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                        name = key;
                        price = parseFloat(value);
                    }
                    
                    if (name && price > 0) {
                        // Filter Meet & Greet for heen trips - only show for terug trips
                        const isMeetAndGreet = name.toLowerCase().includes('meet') || name.toLowerCase().includes('greet');
                        
                        // Use actual booking trip type, not the parameter
                        const actualTripType = trip.tripType || tripType;
                        if (isMeetAndGreet && actualTripType === 'heen') {
                            return; // Don't show Meet & Greet for heen trips
                        }
                        
                        filteredSurcharges.push({ name, price, quantity });
                    }
                });
            }
            
            // Add extra stops to surcharges if they exist
            const extraStopCount = parseInt(trip.extraStopCount) || (trip.extraStops ? trip.extraStops.length : 0);
            if (extraStopCount > 0) {
                // Get stopover price from admin settings
                const surchargeItems = JSON.parse(localStorage.getItem('bookingSurchargeItems') || '{}');
                let stopoverPrice = 0;
                
                if (surchargeItems.fixed) {
                    const stopoverItem = surchargeItems.fixed.find(item => 
                        item.name.toLowerCase().includes('stopover') ||
                        item.name.toLowerCase().includes('stop')
                    );
                    if (stopoverItem) {
                        stopoverPrice = parseFloat(stopoverItem.price) || 0;
                    }
                }
                
                if (stopoverPrice > 0) {
                    const totalStopoverPrice = stopoverPrice * extraStopCount;
                    filteredSurcharges.push({
                        name: `Stopover (${extraStopCount} stop${extraStopCount > 1 ? 's' : ''})`,
                        price: totalStopoverPrice,
                        quantity: 1
                    });
                }
            }
            
            if (filteredSurcharges.length > 0) {
                extraOptionsHTML = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="
                            margin: 0 0 15px 0;
                            padding: 12px 0;
                            border-bottom: 2px solid #e9ecef;
                            color: #2c3e50;
                            font-size: 18px;
                            font-weight: 600;
                        ">Extra Opties</h3>
                        <div style="
                            background: #f8f9fa;
                            padding: 20px;
                            border-radius: 10px;
                            border: 1px solid #e9ecef;
                        ">
                            ${filteredSurcharges.map(item => `
                                <div style="
                                    display: flex;
                                    justify-content: space-between;
                                    align-items: center;
                                    padding: 12px 0;
                                    border-bottom: 1px solid #e9ecef;
                                ">
                                    <div style="font-size: 16px; color: #2c3e50;">
                                        ${item.name}${item.quantity > 1 ? ` (${item.quantity}x)` : ''}
                                    </div>
                                    <div style="font-size: 16px; font-weight: 600; color: #28a745;">
                                        ‚Ç¨${(item.price * item.quantity).toFixed(2)}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            // EXACTE STAP 3 PRICING LOGIC - MARCEL APPROVED
            let finalTotal = 0;
            
            const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            const hasIndividualTrips = booking.trip?.tripType === 'heen' || booking.trip?.tripType === 'terug';
            
            console.log(`üìã OVERVIEW MODAL ${booking.bookingId}:`);
            console.log(`   tripType: ${tripType}`);
            console.log(`   booking.trip?.tripType: ${booking.trip?.tripType}`);
            console.log(`   step2FinalPrice: ‚Ç¨${step2FinalPrice}`);
            console.log(`   hasIndividualTrips: ${hasIndividualTrips}`);
            
            if (hasIndividualTrips && step2FinalPrice > 0) {
                // Find Meet & Greet price for correct distribution (EXACT STAP 3 logic)
                let meetGreetPrice = 0;
                if (surcharges && surcharges.selectedSurcharges) {
                    for (const [key, value] of Object.entries(surcharges.selectedSurcharges)) {
                        if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                            if (typeof value === 'object' && value.price) {
                                meetGreetPrice = parseFloat(value.price) || 0;
                            } else if (typeof value === 'number') {
                                meetGreetPrice = value;
                            }
                            break;
                        }
                    }
                }
                
                console.log(`   meetGreetPrice found: ‚Ç¨${meetGreetPrice}`);
                
                // Calculate exactly like STAP 3
                let heenTotaal, terugTotaal;
                if (meetGreetPrice > 0) {
                    const basePricePerTrip = (step2FinalPrice - meetGreetPrice) / 2;
                    heenTotaal = basePricePerTrip;
                    terugTotaal = basePricePerTrip + meetGreetPrice;
                } else {
                    heenTotaal = step2FinalPrice / 2;
                    terugTotaal = step2FinalPrice / 2;
                }
                
                // Set final total based on trip type
                if (booking.trip.tripType === 'heen') {
                    finalTotal = heenTotaal;
                } else if (booking.trip.tripType === 'terug') {
                    finalTotal = terugTotaal;
                }
                
                console.log(`   heenTotaal: ‚Ç¨${heenTotaal}`);
                console.log(`   terugTotaal: ‚Ç¨${terugTotaal}`);
                console.log(`   finalTotal for ${booking.trip.tripType}: ‚Ç¨${finalTotal}`);
            } else {
                // Fallback for single trips or when no step2FinalPrice
                finalTotal = parseFloat(booking.finalPrice || booking.totalPrice || 50);
                console.log(`   Using fallback finalTotal: ‚Ç¨${finalTotal}`);
            }
            
            // Final fallback calculation (if needed)
            if (finalTotal === 0) {
                vehiclePrice = parseFloat(vehicle.pricing?.totalPrice || vehicle.pricing?.minimumPrice || 0);
                
                // Use authoritative totalSurcharge when available, otherwise calculate from items
                const authoritativeSurchargeTotal = parseFloat(actualSurcharges.totalSurcharge || actualSurcharges.surchargeTotal || 0);
                if (authoritativeSurchargeTotal > 0) {
                    surchargesTotal = authoritativeSurchargeTotal;
                    console.log(`‚úÖ Using authoritative surcharge total (fallback): ‚Ç¨${surchargesTotal}`);
                } else {
                    surchargesTotal = filteredSurcharges.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                    console.log(`‚ö†Ô∏è Calculated surcharge total from items (fallback): ‚Ç¨${surchargesTotal}`);
                }
                
                let calculatedTotal = vehiclePrice + surchargesTotal;
                
                // üî• MARCEL FIX: No more dividing - use individual trip prices or full total
                if (booking.tripPrice !== undefined) {
                    finalTotal = parseFloat(booking.tripPrice);
                    console.log(`üí∞ Using individual tripPrice from booking: ‚Ç¨${finalTotal}`);
                } else {
                    finalTotal = calculatedTotal;
                    console.log(`üí∞ Using full calculated total: ‚Ç¨${finalTotal}`);
                }
            }
            
            // Calculate heen/terug price breakdown for return trips
            let priceBreakdownHTML = '';
            
            if (isReturnTrip) {
                // Get total from Step 2 or booking data
                const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                const totalPrice = step2FinalPrice > 0 ? step2FinalPrice : finalTotal;
                
                // Check for Meet & Greet in surcharges
                let meetGreetPrice = 0;
                if (actualSurcharges) {
                    for (const [key, value] of Object.entries(actualSurcharges)) {
                        if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                            if (typeof value === 'object' && value.price) {
                                meetGreetPrice = parseFloat(value.price) || 0;
                            } else if (typeof value === 'number') {
                                meetGreetPrice = value;
                            }
                            break;
                        }
                    }
                }
                
                // Calculate correct price distribution
                let heenPrice, terugPrice;
                if (meetGreetPrice > 0) {
                    // Meet & Greet only on return trip (terug)
                    const basePricePerTrip = (totalPrice - meetGreetPrice) / 2;
                    heenPrice = basePricePerTrip;
                    terugPrice = basePricePerTrip + meetGreetPrice;
                } else {
                    // No Meet & Greet, split evenly
                    heenPrice = totalPrice / 2;
                    terugPrice = totalPrice / 2;
                }
                
                priceBreakdownHTML = `
                    <div style="margin-bottom: 25px;">
                        <h3 style="
                            margin: 0 0 15px 0;
                            padding: 12px 0;
                            border-bottom: 2px solid #e9ecef;
                            color: #2c3e50;
                            font-size: 18px;
                            font-weight: 600;
                        ">Prijs Overzicht</h3>
                        <div style="
                            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                            padding: 25px;
                            border-radius: 12px;
                            border: 2px solid #28a745;
                        ">
                            ${tripType === 'both' ? `
                            <!-- Individual Trip Prices - Only show for BOTH trips -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; border: 1px solid #bbdefb;">
                                    <div style="font-weight: 600; color: #1976d2; margin-bottom: 8px;">üöó Heen Reis</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #0d47a1;">‚Ç¨${heenPrice.toFixed(2)}</div>
                                </div>
                                <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; border: 1px solid #ce93d8;">
                                    <div style="font-weight: 600; color: #7b1fa2; margin-bottom: 8px;">üîÑ Terug Reis</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #4a148c;">‚Ç¨${terugPrice.toFixed(2)}</div>
                                    ${meetGreetPrice > 0 ? `<div style="font-size: 12px; color: #6a1b9a; margin-top: 4px;">incl. Meet & Greet ‚Ç¨${meetGreetPrice.toFixed(2)}</div>` : ''}
                                </div>
                            </div>
                            ` : ''}
                            
                            <!-- Total -->
                            <div style="border-top: 2px solid #28a745; padding-top: 15px;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">${tripType === 'both' ? 'Totaal (Heen + Terug):' : 'Totaal te betalen:'}</div>
                                    <div style="font-size: 24px; font-weight: 700; color: #28a745;">‚Ç¨${tripType === 'both' ? totalPrice.toFixed(2) : (tripType === 'heen' ? heenPrice : terugPrice).toFixed(2)}</div>
                                </div>
                                <div style="text-align: right; margin-top: 5px;">
                                    <div style="font-size: 14px; color: #6c757d;">
                                        Betaalmethode: ${customer.paymentMethod || 'Cash'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Single trip display - but for return trip bookings, we need individual pricing
                if (isReturnTrip && (tripType === 'heen' || tripType === 'terug')) {
                    // For individual bookings from return trip, show the specific trip section
                    const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                    const totalPrice = step2FinalPrice > 0 ? step2FinalPrice : finalTotal * 2; // Reconstruct total
                    
                    // Calculate individual prices using same logic as return trip section
                    let meetGreetPrice = 0;
                    if (actualSurcharges) {
                        for (const [key, value] of Object.entries(actualSurcharges)) {
                            if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                if (typeof value === 'object' && value.price) {
                                    meetGreetPrice = parseFloat(value.price) || 0;
                                } else if (typeof value === 'number') {
                                    meetGreetPrice = value;
                                }
                                break;
                            }
                        }
                    }
                    
                    let heenPrice, terugPrice;
                    if (meetGreetPrice > 0) {
                        const basePricePerTrip = (totalPrice - meetGreetPrice) / 2;
                        heenPrice = basePricePerTrip;
                        terugPrice = basePricePerTrip + meetGreetPrice;
                    } else {
                        heenPrice = totalPrice / 2;
                        terugPrice = totalPrice / 2;
                    }
                    
                    // Use step2 price from localStorage with correct distribution
                    const step2TotalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
                    console.log('üí∞ ADMIN: Using step2 total ‚Ç¨' + step2TotalPrice);
                    
                    // Find Meet & Greet
                    meetGreetPrice = 0;
                    if (actualSurcharges) {
                        for (const [key, value] of Object.entries(actualSurcharges)) {
                            if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                                if (typeof value === 'object' && value.price) {
                                    meetGreetPrice = parseFloat(value.price) || 0;
                                } else if (typeof value === 'number') {
                                    meetGreetPrice = value;
                                }
                                break;
                            }
                        }
                    }
                    
                    // Calculate correct prices
                    let showPrice;
                    if (step2TotalPrice > 0) {
                        if (meetGreetPrice > 0) {
                            const basePricePerTrip = (step2TotalPrice - meetGreetPrice) / 2;
                            if (tripType === 'terug') {
                                showPrice = basePricePerTrip + meetGreetPrice;
                                console.log(`üí∞ ADMIN: Terug = ‚Ç¨${basePricePerTrip} + ‚Ç¨${meetGreetPrice} = ‚Ç¨${showPrice}`);
                            } else {
                                showPrice = basePricePerTrip;
                                console.log(`üí∞ ADMIN: Heen = ‚Ç¨${basePricePerTrip}`);
                            }
                        } else {
                            showPrice = step2TotalPrice / 2;
                            console.log(`üí∞ ADMIN: ${tripType} = ‚Ç¨${showPrice} (no Meet & Greet)`);
                        }
                    } else {
                        // Fallback to booking data
                        showPrice = finalTotal;
                        console.log(`üí∞ ADMIN: Using booking total ‚Ç¨${showPrice}`);
                    }
                    const showMeetGreet = tripType === 'terug' && meetGreetPrice > 0;
                    
                    priceBreakdownHTML = `
                        <div style="margin-bottom: 25px;">
                            <h3 style="
                                margin: 0 0 15px 0;
                                padding: 12px 0;
                                border-bottom: 2px solid #e9ecef;
                                color: #2c3e50;
                                font-size: 18px;
                                font-weight: 600;
                            ">Prijs Overzicht</h3>
                            <div style="
                                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                padding: 25px;
                                border-radius: 12px;
                                border: 2px solid #28a745;
                            ">
                                
                                <div style="border-top: 2px solid #28a745; padding-top: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">Totaal te betalen:</div>
                                        <div style="font-size: 24px; font-weight: 700; color: #28a745;">‚Ç¨${showPrice.toFixed(2)}</div>
                                    </div>
                                    <div style="text-align: right; margin-top: 5px;">
                                        <div style="font-size: 14px; color: #6c757d;">
                                            Betaalmethode: ${customer.paymentMethod || 'Cash'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    // Normal single trip display
                    priceBreakdownHTML = `
                        <div style="margin-bottom: 25px;">
                            <h3 style="
                                margin: 0 0 15px 0;
                                padding: 12px 0;
                                border-bottom: 2px solid #e9ecef;
                                color: #2c3e50;
                                font-size: 18px;
                                font-weight: 600;
                            ">Prijs Overzicht</h3>
                            <div style="
                                background: linear-gradient(135deg, #f8f9fa, #e9ecef);
                                padding: 25px;
                                border-radius: 12px;
                                border: 2px solid #28a745;
                            ">
                                <div style="border-top: 2px solid #28a745; padding-top: 15px; margin-top: 15px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-size: 20px; font-weight: 700; color: #2c3e50;">Totaal te betalen:</div>
                                        <div style="font-size: 24px; font-weight: 700; color: #28a745;">‚Ç¨${finalTotal.toFixed(2)}</div>
                                    </div>
                                    <div style="text-align: right; margin-top: 5px;">
                                        <div style="font-size: 14px; color: #6c757d;">
                                            Betaalmethode: ${customer.paymentMethod || 'Cash'}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            return personalInfoHTML + tripDetailsHTML + vehicleHTML + extraOptionsHTML + priceBreakdownHTML;
        }
        
        function closeBookingOverview() {
            const modal = document.getElementById('bookingOverviewModal');
            if (modal) {
                modal.remove();
            }
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        // Global variable to store current booking data for editing
        let currentBookingData = null;
        let currentBookingSource = null;

        // Professional Booking Edit Modal for Next 24 Hours
        function openProfessionalBookingEdit(bookingId) {
            console.log('üè¢ Opening professional booking edit for:', bookingId);
            
            // Find booking in confirmed bookings
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const booking = confirmedBookings.find(b => b.bookingId === bookingId);
            
            if (!booking) {
                alert('‚ùå Booking niet gevonden!');
                return;
            }
            
            console.log('üìã Found booking:', booking);
            
            // Store booking data globally for editing
            currentBookingData = booking;
            currentBookingSource = 'confirmed';
            
            // Initialize extra stops and surcharges
            initializeExtraStops(booking);
            initializeSurcharges(booking);
            
            // Create professional modal
            const modalHTML = `
                <div id="professionalBookingModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 10000;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    padding: 20px;
                ">
                    <div style="
                        background: white;
                        border-radius: 8px;
                        width: 100%;
                        max-width: 800px;
                        max-height: 90vh;
                        overflow-y: auto;
                        position: relative;
                    ">
                        <!-- Header -->
                        <div style="
                            padding: 20px;
                            border-bottom: 1px solid #e9ecef;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h3 style="margin: 0; color: #333; font-size: 18px;">Booking details ${booking.bookingId}</h3>
                            <button onclick="closeProfessionalBookingEdit()" style="
                                background: none;
                                border: none;
                                font-size: 24px;
                                cursor: pointer;
                                color: #999;
                                padding: 0;
                                width: 30px;
                                height: 30px;
                            ">√ó</button>
                        </div>
                        
                        <!-- Content -->
                        <div style="padding: 20px;">
                            ${generateProfessionalEditForm(booking)}
                        </div>
                        
                        <!-- Footer -->
                        <div style="
                            padding: 20px;
                            border-top: 1px solid #e9ecef;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <div style="font-weight: 600; font-size: 16px;">
                                Total: ‚Ç¨<span id="professionalTotal">${calculateBookingTotal(booking)}</span>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button onclick="closeProfessionalBookingEdit()" style="
                                    background: #6c757d;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">Cancel</button>
                                <button onclick="saveProfessionalBooking()" style="
                                    background: #28a745;
                                    color: white;
                                    border: none;
                                    padding: 10px 20px;
                                    border-radius: 4px;
                                    cursor: pointer;
                                ">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function generateProfessionalEditForm(booking) {
            const trip = booking.trip || {};
            const customer = booking.customer || {};
            const vehicle = booking.vehicle || {};
            
            return `
                <!-- LOCATIONS Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="
                        color: #007bff;
                        font-size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin: 0 0 15px 0;
                        letter-spacing: 0.5px;
                    ">LOCATIONS</h4>
                    
                    <div class="section-margin">
                        <label class="help-text">Address or Postcode</label>
                        <input id="editFromLocation" type="text" value="${trip.fromLocation || ''}" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                        ">
                    </div>
                    
                    <!-- Extra Stops Container -->
                    <div id="extraStopsContainer">
                        ${generateExtraStops(trip.extraStops || [])}
                    </div>
                    
                    <div class="section-margin">
                        <button type="button" onclick="addExtraStop()" style="
                            background: #007bff;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                            margin-bottom: 10px;
                        ">+ Add Extra Stop</button>
                    </div>
                    
                    <div class="section-margin">
                        <label class="help-text">Address or Postcode (Final Destination)</label>
                        <input id="editToLocation" type="text" value="${trip.toLocation || ''}" style="
                            width: 100%;
                            padding: 10px;
                            border: 1px solid #ddd;
                            border-radius: 4px;
                            font-size: 14px;
                        ">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="help-text">Date & Time</label>
                            <input id="editDateTime" type="datetime-local" value="${formatDateTimeForInput(trip.travelDate, trip.travelHour, trip.travelMinute)}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label class="help-text">Vehicle type</label>
                            <select id="editVehicleType" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                                <option value="Saloon" ${vehicle.vehicle?.name === 'Saloon' ? 'selected' : ''}>Saloon</option>
                                <option value="Estate" ${vehicle.vehicle?.name === 'Estate' ? 'selected' : ''}>Estate</option>
                                <option value="Minivan" ${vehicle.vehicle?.name === 'Minivan' ? 'selected' : ''}>Minivan</option>
                                <option value="Minivan Long" ${vehicle.vehicle?.name === 'Minivan Long' ? 'selected' : ''}>Minivan Long</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- PASSENGERS Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="
                        color: #007bff;
                        font-size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin: 0 0 15px 0;
                        letter-spacing: 0.5px;
                    ">PASSENGERS</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="help-text">First Name</label>
                            <input id="editCustomerFirstName" type="text" value="${customer.firstName || ''}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label class="help-text">Last Name</label>
                            <input id="editCustomerLastName" type="text" value="${customer.lastName || ''}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label class="help-text">Phone</label>
                            <input id="editCustomerPhone" type="text" value="${customer.phone || ''}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="help-text">üë• Passengers</label>
                            <input id="editPassengers" type="number" min="1" max="8" value="${customer.passengers || 1}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label class="help-text">üß≥ Luggage</label>
                            <input id="editLuggage" type="number" min="0" max="10" value="${customer.koffers || 0}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <div>
                            <label class="help-text">üíº Hand luggage</label>
                            <input id="editHandLuggage" type="number" min="0" max="10" value="${customer.handbagage || 0}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                    
                    <!-- Flight Information - Collapsible -->
                    <div class="section-margin">
                        <div onclick="toggleFlightInfo()" style="
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            padding: 12px;
                            cursor: pointer;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                        ">
                            <h5 style="margin: 0; color: #666; font-size: 14px; font-weight: 600;">‚úàÔ∏è Flight Information</h5>
                            <span id="flightInfoToggle" style="
                                font-size: 18px;
                                color: #666;
                                transition: transform 0.2s;
                            ">‚ñº</span>
                        </div>
                        
                        <div id="flightInfoContent" style="
                            display: none;
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 4px;
                            padding: 15px;
                        ">
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="help-text">Flight number</label>
                                    <input id="editFlightNumber" type="text" value="${customer.flightNumber || ''}" style="
                                        width: 100%;
                                        padding: 10px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 14px;
                                        background: white;
                                    ">
                                </div>
                                <div>
                                    <label class="help-text">Flight landing time</label>
                                    <input id="editFlightLandingTime" type="time" value="${customer.flightLandingTime || ''}" style="
                                        width: 100%;
                                        padding: 10px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 14px;
                                        background: white;
                                    ">
                                </div>
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                                <div>
                                    <label class="help-text">Arriving from</label>
                                    <input id="editArrivingFrom" type="text" value="${customer.arrivingFrom || ''}" style="
                                        width: 100%;
                                        padding: 10px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 14px;
                                        background: white;
                                    ">
                                </div>
                            </div>
                            
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div class="flex-center">
                                    <input id="editMeetGreet" type="checkbox" ${customer.meetGreet ? 'checked' : ''} style="
                                        width: 20px;
                                        height: 20px;
                                        cursor: pointer;
                                    ">
                                    <label for="editMeetGreet" style="color: #666; font-size: 13px; cursor: pointer;">Meet & Greet</label>
                                </div>
                                <div>
                                    <label class="help-text">Meeting point</label>
                                    <input id="editMeetingPoint" type="text" value="${customer.meetingPoint || ''}" style="
                                        width: 100%;
                                        padding: 10px;
                                        border: 1px solid #ddd;
                                        border-radius: 4px;
                                        font-size: 14px;
                                        background: white;
                                    ">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Extra Surcharges - Collapsible -->
                    <div class="section-margin">
                        <div onclick="toggleSurchargesInfo()" style="
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            border-radius: 4px;
                            padding: 12px;
                            cursor: pointer;
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                            margin-bottom: 10px;
                        ">
                            <h5 style="margin: 0; color: #856404; font-size: 14px; font-weight: 600;">üí∞ Extra Surcharges & Options</h5>
                            <span id="surchargesInfoToggle" style="
                                font-size: 18px;
                                color: #856404;
                                transition: transform 0.2s;
                            ">‚ñº</span>
                        </div>
                        
                        <div id="surchargesInfoContent" style="
                            display: none;
                            background: #fff3cd;
                            border: 1px solid #ffeaa7;
                            border-radius: 4px;
                            padding: 15px;
                        ">
                            <div id="currentSurcharges">
                                ${generateCurrentSurcharges(booking)}
                            </div>
                            
                            <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #ffeaa7;">
                                <h6 style="margin: 0 0 10px 0; color: #856404; font-size: 13px; font-weight: 600;">Add Additional Surcharges:</h6>
                                <div style="display: grid; grid-template-columns: 2fr 1fr 1fr auto; gap: 10px; align-items: end;">
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: #856404; font-size: 12px;">Item Name</label>
                                        <input id="newSurchargeName" type="text" placeholder="e.g. Child seat, Pet transport..." style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            font-size: 13px;
                                            background: white;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: #856404; font-size: 12px;">Price (‚Ç¨)</label>
                                        <input id="newSurchargePrice" type="number" step="0.01" min="0" placeholder="0.00" style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            font-size: 13px;
                                            background: white;
                                        ">
                                    </div>
                                    <div>
                                        <label style="display: block; margin-bottom: 5px; color: #856404; font-size: 12px;">Qty</label>
                                        <input id="newSurchargeQty" type="number" min="1" value="1" style="
                                            width: 100%;
                                            padding: 8px;
                                            border: 1px solid #ddd;
                                            border-radius: 4px;
                                            font-size: 13px;
                                            background: white;
                                        ">
                                    </div>
                                    <div>
                                        <button type="button" onclick="addNewSurcharge()" style="
                                            background: #28a745;
                                            color: white;
                                            border: none;
                                            padding: 8px 12px;
                                            border-radius: 4px;
                                            cursor: pointer;
                                            font-size: 12px;
                                        ">Add</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- PAYMENT & DRIVER Section -->
                <div style="margin-bottom: 30px;">
                    <h4 style="
                        color: #007bff;
                        font-size: 14px;
                        font-weight: 600;
                        text-transform: uppercase;
                        margin: 0 0 15px 0;
                        letter-spacing: 0.5px;
                    ">PAYMENT & DRIVER</h4>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label class="help-text">Price</label>
                            <input id="editPrice" type="number" step="0.01" value="${calculateBookingTotal(booking)}" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            " onchange="updateProfessionalTotal()">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr; gap: 15px;">
                        <div>
                            <label class="help-text">Driver</label>
                            <input id="editDriver" type="text" value="${booking.driver || ''}" placeholder="Search driver..." style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                    </div>
                </div>
                
                <!-- NOTES Section -->
                <div class="section-margin-lg">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label class="help-text">Note for Driver ‚≠ê</label>
                            <textarea id="editDriverNote" rows="3" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                                resize: vertical;
                            ">${booking.driverNote || ''}</textarea>
                        </div>
                        <div>
                            <label class="help-text">Admin note ‚≠ê</label>
                            <textarea id="editAdminNote" rows="3" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                                resize: vertical;
                            ">${booking.adminNote || ''}</textarea>
                        </div>
                        <div>
                            <label class="help-text">Customer requirements ‚≠ê</label>
                            <textarea id="editCustomerRequirements" rows="3" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                                resize: vertical;
                            ">${customer.specialRequests || ''}</textarea>
                        </div>
                    </div>
                </div>
                
                <!-- TRANSACTIONS Section -->
                <div class="section-margin-lg">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h4 style="
                            color: #007bff;
                            font-size: 14px;
                            font-weight: 600;
                            text-transform: uppercase;
                            margin: 0;
                            letter-spacing: 0.5px;
                        ">ADVANCE</h4>
                        <button type="button" onclick="toggleTransactions()" id="transactionsToggleBtn" style="
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            padding: 6px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            color: #666;
                        ">Hide transactions</button>
                    </div>
                    
                    <div id="transactionsContent" style="
                        background: white;
                        border: 1px solid #dee2e6;
                        border-radius: 4px;
                        overflow: hidden;
                    ">
                        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                            <thead style="background: #f8f9fa;">
                                <tr>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;"></th>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;">Amount</th>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;">Payment charge</th>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;">Payment method</th>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;">Status</th>
                                    <th style="padding: 8px 12px; text-align: left; font-weight: 600; color: #666; border-bottom: 1px solid #dee2e6;">Updated at</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                        <button style="background: none; border: none; cursor: pointer; color: #666;">‚ñº</button>
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                        <input id="transactionAmount" type="text" value="‚Ç¨${calculateBookingTotal(booking)}" style="
                                            border: none;
                                            background: #f8f9fa;
                                            padding: 6px 8px;
                                            border-radius: 3px;
                                            font-size: 13px;
                                            width: 80px;
                                            font-weight: 600;
                                        ">
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                        <input id="paymentCharge" type="text" value="‚Ç¨0.00" style="
                                            border: none;
                                            background: #f8f9fa;
                                            padding: 6px 8px;
                                            border-radius: 3px;
                                            font-size: 13px;
                                            width: 60px;
                                        ">
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                        <select id="paymentMethod" style="
                                            border: none;
                                            background: #f8f9fa;
                                            padding: 6px 8px;
                                            border-radius: 3px;
                                            font-size: 13px;
                                            width: 150px;
                                        ">
                                            <option value="Cash or Card in the taxi" ${(customer.paymentMethod || 'Cash') === 'Cash' ? 'selected' : ''}>Cash or Card in the taxi</option>
                                            <option value="PayPal" ${customer.paymentMethod === 'PayPal' ? 'selected' : ''}>PayPal</option>
                                            <option value="Credit Card" ${customer.paymentMethod === 'Credit Card' ? 'selected' : ''}>Credit Card</option>
                                            <option value="Bank Transfer" ${customer.paymentMethod === 'Bank Transfer' ? 'selected' : ''}>Bank Transfer</option>
                                        </select>
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6;">
                                        <select id="paymentStatus" style="
                                            border: none;
                                            background: #fff3cd;
                                            padding: 6px 8px;
                                            border-radius: 3px;
                                            font-size: 13px;
                                            color: #856404;
                                            font-weight: 500;
                                        ">
                                            <option value="Pending" selected>Pending</option>
                                            <option value="Paid">Paid</option>
                                            <option value="Failed">Failed</option>
                                            <option value="Refunded">Refunded</option>
                                        </select>
                                    </td>
                                    <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 12px; color: #666;">
                                        ${new Date().toLocaleDateString('en-GB')} ${new Date().toLocaleTimeString('en-GB', {hour: '2-digit', minute: '2-digit'})}
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        
                        <div style="padding: 12px; background: #f8f9fa; border-top: 1px solid #dee2e6; font-size: 12px; color: #666;">
                            <button type="button" onclick="addNewTransaction()" style="
                                background: #007bff;
                                color: white;
                                border: none;
                                padding: 6px 12px;
                                border-radius: 4px;
                                cursor: pointer;
                                font-size: 12px;
                            ">+ Add new transaction</button>
                            <span style="margin-left: 15px;">These transactions include outbound and return bookings.</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function formatDateTimeForInput(date, hour, minute) {
            if (!date) return '';
            
            // Convert DD/MM/YYYY to YYYY-MM-DD
            const parts = date.split('/');
            if (parts.length !== 3) return '';
            
            const formattedDate = `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
            const formattedTime = `${(hour || '00').padStart(2, '0')}:${(minute || '00').padStart(2, '0')}`;
            
            return `${formattedDate}T${formattedTime}`;
        }

        function calculateBookingTotal(booking) {
            // Use same logic as existing pricing
            let total = 0;
            
            const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            if (step2FinalPrice > 0) {
                total = step2FinalPrice;
            } else if (booking.finalPrice) {
                total = parseFloat(booking.finalPrice);
            } else if (booking.totalPrice) {
                total = parseFloat(booking.totalPrice);
            } else {
                total = parseFloat(booking.vehicle?.pricing?.totalPrice || booking.vehicle?.pricing?.minimumPrice || booking.vehicle?.price || 50.00);
            }
            
            // Handle return trips
            const hasIndividualTrips = booking.trip?.tripType === 'heen' || booking.trip?.tripType === 'terug';
            if (hasIndividualTrips) {
                let meetGreetPrice = 0;
                const surchargeData = booking.surcharges;
                if (surchargeData && surchargeData.selectedSurcharges) {
                    for (const [key, value] of Object.entries(surchargeData.selectedSurcharges)) {
                        if (key.toLowerCase().includes('meet') || key.toLowerCase().includes('greet')) {
                            if (typeof value === 'object' && value.price) {
                                meetGreetPrice = parseFloat(value.price) || 0;
                            } else if (typeof value === 'number') {
                                meetGreetPrice = value;
                            }
                            break;
                        }
                    }
                }
                
                if (meetGreetPrice > 0) {
                    const basePricePerTrip = (total - meetGreetPrice) / 2;
                    if (booking.trip.tripType === 'heen') {
                        total = basePricePerTrip;
                    } else {
                        total = basePricePerTrip + meetGreetPrice;
                    }
                } else {
                    total = total / 2;
                }
            }
            
            return total.toFixed(2);
        }

        function updateProfessionalTotal() {
            const priceInput = document.getElementById('editPrice');
            const totalSpan = document.getElementById('professionalTotal');
            if (priceInput && totalSpan) {
                totalSpan.textContent = parseFloat(priceInput.value || 0).toFixed(2);
            }
        }

        function saveProfessionalBooking() {
            if (!currentBookingData) {
                alert('‚ùå Geen booking data gevonden!');
                return;
            }
            
            // Get updated values from form
            const updatedBooking = {
                ...currentBookingData,
                trip: {
                    ...currentBookingData.trip,
                    fromLocation: document.getElementById('editFromLocation').value,
                    toLocation: document.getElementById('editToLocation').value,
                    extraStops: extraStopsData.filter(stop => stop && stop.trim() !== ''), // Remove empty stops
                    extraStopCount: extraStopsData.filter(stop => stop && stop.trim() !== '').length,
                },
                customer: {
                    ...currentBookingData.customer,
                    phone: document.getElementById('editCustomerPhone').value,
                    passengers: parseInt(document.getElementById('editPassengers').value) || 1,
                    koffers: parseInt(document.getElementById('editLuggage').value) || 0,
                    handbagage: parseInt(document.getElementById('editHandLuggage').value) || 0,
                    specialRequests: document.getElementById('editCustomerRequirements').value,
                    // Flight information
                    flightNumber: document.getElementById('editFlightNumber').value,
                    flightLandingTime: document.getElementById('editFlightLandingTime').value,
                    arrivingFrom: document.getElementById('editArrivingFrom').value,
                    meetGreet: document.getElementById('editMeetGreet').checked,
                    meetingPoint: document.getElementById('editMeetingPoint').value,
                },
                driver: document.getElementById('editDriver').value,
                driverNote: document.getElementById('editDriverNote').value,
                adminNote: document.getElementById('editAdminNote').value,
                editedPrice: parseFloat(document.getElementById('editPrice').value) || 0,
                lastUpdated: new Date().toISOString(),
                // Update surcharges with any new additions
                surcharges: {
                    ...currentBookingData.surcharges,
                    selectedSurcharges: {
                        ...currentBookingData.surcharges?.selectedSurcharges,
                        ...currentBookingSurcharges
                    }
                }
            };
            
            // Handle customer name split
            const fullName = document.getElementById('editCustomerName').value.trim();
            const nameParts = fullName.split(' ');
            if (nameParts.length > 0) {
                updatedBooking.customer.firstName = nameParts[0];
                updatedBooking.customer.lastName = nameParts.slice(1).join(' ');
            }
            
            // Handle date/time
            const dateTimeInput = document.getElementById('editDateTime').value;
            if (dateTimeInput) {
                const dateTime = new Date(dateTimeInput);
                updatedBooking.trip.travelDate = dateTime.toLocaleDateString('nl-BE');
                updatedBooking.trip.travelHour = dateTime.getHours().toString().padStart(2, '0');
                updatedBooking.trip.travelMinute = dateTime.getMinutes().toString().padStart(2, '0');
            }
            
            // Handle vehicle type
            const vehicleType = document.getElementById('editVehicleType').value;
            if (!updatedBooking.vehicle) updatedBooking.vehicle = {};
            if (!updatedBooking.vehicle.vehicle) updatedBooking.vehicle.vehicle = {};
            updatedBooking.vehicle.vehicle.name = vehicleType;
            
            // Update booking in localStorage
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const bookingIndex = confirmedBookings.findIndex(b => b.bookingId === currentBookingData.bookingId);
            
            if (bookingIndex !== -1) {
                confirmedBookings[bookingIndex] = updatedBooking;
                localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
                
                console.log('‚úÖ Booking updated successfully:', updatedBooking);
                alert('‚úÖ Booking succesvol bijgewerkt!');
                
                // Close modal and refresh list
                closeProfessionalBookingEdit();
                loadNext24hBookings();
            } else {
                alert('‚ùå Fout bij het bijwerken van de booking!');
            }
        }

        function closeProfessionalBookingEdit() {
            const modal = document.getElementById('professionalBookingModal');
            if (modal) {
                modal.remove();
            }
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
            
            // Clear current booking data
            currentBookingData = null;
            currentBookingSource = null;
        }

        // Extra Stops Management Functions
        function generateExtraStops(extraStops) {
            if (!extraStops || extraStops.length === 0) {
                return '';
            }
            
            return extraStops.map((stop, index) => `
                <div class="extra-stop-item" data-index="${index}" class="section-margin">
                    <div class="btn-group">
                        <div style="flex: 1;">
                            <label class="help-text">Extra Stop ${index + 1}</label>
                            <input type="text" value="${stop}" onchange="updateExtraStop(${index}, this.value)" style="
                                width: 100%;
                                padding: 10px;
                                border: 1px solid #ddd;
                                border-radius: 4px;
                                font-size: 14px;
                            ">
                        </div>
                        <button type="button" onclick="removeExtraStop(${index})" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 8px 12px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 12px;
                            margin-top: 20px;
                        ">Remove</button>
                    </div>
                </div>
            `).join('');
        }

        let extraStopsData = [];

        function addExtraStop() {
            const container = document.getElementById('extraStopsContainer');
            if (!container) return;
            
            // Initialize or get current extra stops
            if (!extraStopsData) {
                extraStopsData = currentBookingData?.trip?.extraStops || [];
            }
            
            // Add new empty stop
            extraStopsData.push('');
            
            // Re-render all stops
            container.innerHTML = generateExtraStops(extraStopsData);
            
            console.log('‚úÖ Added extra stop. Total stops:', extraStopsData.length);
        }

        function removeExtraStop(index) {
            if (!extraStopsData) return;
            
            // Remove stop at index
            extraStopsData.splice(index, 1);
            
            // Re-render all stops
            const container = document.getElementById('extraStopsContainer');
            if (container) {
                container.innerHTML = generateExtraStops(extraStopsData);
            }
            
            console.log('‚úÖ Removed extra stop at index:', index, 'Remaining stops:', extraStopsData.length);
        }

        function updateExtraStop(index, value) {
            if (!extraStopsData) {
                extraStopsData = [];
            }
            
            // Ensure array is large enough
            while (extraStopsData.length <= index) {
                extraStopsData.push('');
            }
            
            extraStopsData[index] = value;
            console.log('‚úÖ Updated extra stop', index, 'to:', value);
        }

        // Initialize extra stops when modal opens
        function initializeExtraStops(booking) {
            extraStopsData = booking?.trip?.extraStops ? [...booking.trip.extraStops] : [];
        }

        // Flight Information Toggle Function
        function toggleFlightInfo() {
            const content = document.getElementById('flightInfoContent');
            const toggle = document.getElementById('flightInfoToggle');
            
            if (content && toggle) {
                if (content.style.display === 'none' || content.style.display === '') {
                    // Show flight info
                    content.style.display = 'block';
                    toggle.style.transform = 'rotate(180deg)';
                    toggle.textContent = '‚ñ≤';
                } else {
                    // Hide flight info
                    content.style.display = 'none';
                    toggle.style.transform = 'rotate(0deg)';
                    toggle.textContent = '‚ñº';
                }
            }
        }

        // Surcharges Information Toggle Function
        function toggleSurchargesInfo() {
            const content = document.getElementById('surchargesInfoContent');
            const toggle = document.getElementById('surchargesInfoToggle');
            
            if (content && toggle) {
                if (content.style.display === 'none' || content.style.display === '') {
                    // Show surcharges info
                    content.style.display = 'block';
                    toggle.style.transform = 'rotate(180deg)';
                    toggle.textContent = '‚ñ≤';
                } else {
                    // Hide surcharges info
                    content.style.display = 'none';
                    toggle.style.transform = 'rotate(0deg)';
                    toggle.textContent = '‚ñº';
                }
            }
        }

        // Generate current surcharges display
        function generateCurrentSurcharges(booking) {
            const surcharges = booking.surcharges;
            if (!surcharges) {
                return '<p style="color: #856404; font-style: italic; margin: 0;">No surcharges found for this booking.</p>';
            }

            let html = '<div style="margin-bottom: 10px;"><h6 style="margin: 0 0 8px 0; color: #856404; font-size: 13px; font-weight: 600;">Current Surcharges:</h6>';
            
            const actualSurcharges = surcharges.selectedSurcharges || surcharges;
            let foundSurcharges = false;

            if (actualSurcharges && typeof actualSurcharges === 'object') {
                Object.entries(actualSurcharges).forEach(([key, value]) => {
                    // Skip technical fields
                    if (key === 'totalSurcharge' || key === 'surchargeTotal' || 
                        key === 'Airport surcharge' || key === 'ExtraStopCount' || 
                        key === 'extraStopCount' || key === 'SurchargeTotal') {
                        return;
                    }

                    let name, price, quantity = 1;
                    
                    if (value && typeof value === 'object') {
                        name = value.name || key;
                        price = parseFloat(value.price) || 0;
                        quantity = parseInt(value.quantity) || 1;
                    } else if (typeof value === 'number') {
                        name = key;
                        price = value;
                    } else if (typeof value === 'string' && !isNaN(parseFloat(value))) {
                        name = key;
                        price = parseFloat(value);
                    }

                    if (name && price > 0) {
                        foundSurcharges = true;
                        const total = (price * quantity).toFixed(2);
                        html += `
                            <div style="
                                display: flex; 
                                justify-content: space-between; 
                                align-items: center;
                                padding: 8px 12px;
                                background: white;
                                border-radius: 4px;
                                margin-bottom: 5px;
                                border: 1px solid #ffeaa7;
                            ">
                                <div>
                                    <span style="font-weight: 500; color: #333;">${name}</span>
                                    ${quantity > 1 ? `<span style="color: #666; font-size: 12px;"> (${quantity}x)</span>` : ''}
                                </div>
                                <div class="btn-group">
                                    <span style="font-weight: 600; color: #28a745;">‚Ç¨${total}</span>
                                    <button onclick="removeSurcharge('${key}')" style="
                                        background: #dc3545;
                                        color: white;
                                        border: none;
                                        padding: 4px 8px;
                                        border-radius: 3px;
                                        cursor: pointer;
                                        font-size: 11px;
                                    ">Remove</button>
                                </div>
                            </div>
                        `;
                    }
                });
            }

            if (!foundSurcharges) {
                html += '<p style="color: #856404; font-style: italic; margin: 0;">No surcharges selected for this booking.</p>';
            }
            
            html += '</div>';
            return html;
        }

        let currentBookingSurcharges = {};

        // Add new surcharge - DUPLICATE REMOVED
        /*
        function addNewSurchargeToList() {
            const name = document.getElementById('newSurchargeName').value.trim();
            const price = parseFloat(document.getElementById('newSurchargePrice').value) || 0;
            const quantity = parseInt(document.getElementById('newSurchargeQty').value) || 1;

            if (!name || price <= 0) {
                alert('Please enter a valid surcharge name and price.');
                return;
            }

            const surchargeKey = `custom_${Date.now()}`;
            if (!currentBookingSurcharges) currentBookingSurcharges = {};
            
            currentBookingSurcharges[surchargeKey] = {
                name: name,
                price: price,
                quantity: quantity,
                type: 'custom'
            };

            // Clear inputs
            document.getElementById('newSurchargeName').value = '';
            document.getElementById('newSurchargePrice').value = '';
            document.getElementById('newSurchargeQty').value = '1';

            // Refresh display
            refreshSurchargesDisplay();
            
            console.log('‚úÖ Added new surcharge:', name, '‚Ç¨' + price);
        }
        */

        // Remove surcharge - DUPLICATE REMOVED
        /*
        function removeSurchargeFromBooking(key) {
            if (currentBookingSurcharges && currentBookingSurcharges[key]) {
                delete currentBookingSurcharges[key];
                refreshSurchargesDisplay();
                console.log('‚úÖ Removed surcharge:', key);
            }
        }
        */

        // Refresh surcharges display
        function refreshSurchargesDisplay() {
            const container = document.getElementById('currentSurcharges');
            if (container && currentBookingData) {
                // Merge original surcharges with new ones
                const mergedBooking = {
                    ...currentBookingData,
                    surcharges: {
                        selectedSurcharges: {
                            ...currentBookingData.surcharges?.selectedSurcharges,
                            ...currentBookingSurcharges
                        }
                    }
                };
                container.innerHTML = generateCurrentSurcharges(mergedBooking);
            }
        }

        // Initialize surcharges when modal opens
        function initializeSurcharges(booking) {
            currentBookingSurcharges = {};
        }

        // Transactions Management Functions
        function toggleTransactions() {
            const content = document.getElementById('transactionsContent');
            const button = document.getElementById('transactionsToggleBtn');
            
            if (content && button) {
                if (content.style.display === 'none') {
                    // Show transactions
                    content.style.display = 'block';
                    button.textContent = 'Hide transactions';
                } else {
                    // Hide transactions
                    content.style.display = 'none';
                    button.textContent = 'Show transactions';
                }
            }
        }

        function addNewTransaction() {
            alert('üöß Add new transaction functionality - Coming soon!');
            // Future enhancement: Add new transaction row
        }

        function editBookingFromOverview() {
            console.log('‚úèÔ∏è Edit booking from overview requested');
            
            if (!currentBookingData) {
                alert('‚ùå Geen booking data beschikbaar voor bewerken!');
                return;
            }
            
            // Close the overview modal first
            closeBookingOverview();
            
            // Create an edit form modal
            const editFormHTML = `
                <div id="editBookingModal" style="
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.7);
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    z-index: 2000;
                    backdrop-filter: blur(4px);
                ">
                    <div style="
                        background: white;
                        border-radius: 15px;
                        max-width: 600px;
                        width: 90%;
                        max-height: 90vh;
                        overflow-y: auto;
                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                        position: relative;
                    ">
                        <!-- Header -->
                        <div style="
                            background: linear-gradient(135deg, #2c3e50, #34495e);
                            color: white;
                            padding: 25px;
                            border-radius: 15px 15px 0 0;
                            position: relative;
                        ">
                            <h2 style="margin: 0; font-size: 24px; font-weight: 600;">
                                ‚úèÔ∏è Edit Booking
                            </h2>
                            <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">
                                Booking ID: ${currentBookingData.bookingId}
                            </p>
                            <button onclick="closeEditBookingModal()" style="
                                position: absolute;
                                top: 15px;
                                right: 15px;
                                background: rgba(255,255,255,0.2);
                                color: white;
                                border: none;
                                border-radius: 50%;
                                width: 35px;
                                height: 35px;
                                cursor: pointer;
                                font-size: 18px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                                transition: background 0.3s;
                            " onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                                ‚úï
                            </button>
                        </div>
                        
                        <!-- Edit Form -->
                        <div style="padding: 25px;">
                            <form id="editBookingForm">
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Klant Naam:</label>
                                    <input type="text" id="edit-customerName" value="${currentBookingData.customerName || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Email:</label>
                                    <input type="email" id="edit-customerEmail" value="${currentBookingData.customerEmail || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Telefoon:</label>
                                    <input type="tel" id="edit-customerPhone" value="${currentBookingData.customerPhone || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Van waar:</label>
                                    <input type="text" id="edit-fromLocation" value="${currentBookingData.fromLocation || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Naar waar:</label>
                                    <input type="text" id="edit-toLocation" value="${currentBookingData.toLocation || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reisdatum:</label>
                                    <input type="text" id="edit-travelDate" value="${currentBookingData.travelDate || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Reistijd:</label>
                                    <input type="text" id="edit-travelTime" value="${currentBookingData.travelTime || ''}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Aantal passagiers:</label>
                                    <input type="number" id="edit-passengers" value="${currentBookingData.passengers || '1'}" 
                                           style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px;">
                                </div>
                                
                                <div class="section-margin-lg">
                                    <label style="display: block; margin-bottom: 5px; font-weight: 600;">Bijzondere verzoeken:</label>
                                    <textarea id="edit-specialRequests" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; height: 80px; resize: vertical;">${currentBookingData.specialRequests || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        
                        <!-- Action buttons -->
                        <div style="padding: 20px; border-top: 1px solid #dee2e6; text-align: center;">
                            <button onclick="closeEditBookingModal()" style="
                                background: #6c757d;
                                color: white;
                                padding: 12px 24px;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                margin-right: 10px;
                                font-size: 14px;
                            ">Cancel</button>
                            <button onclick="saveBookingChanges()" style="
                                background: #007bff;
                                color: white;
                                padding: 12px 24px;
                                border: none;
                                border-radius: 6px;
                                cursor: pointer;
                                font-size: 14px;
                            ">üíæ Save Changes</button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', editFormHTML);
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        function closeEditBookingModal() {
            const modal = document.getElementById('editBookingModal');
            if (modal) {
                modal.remove();
            }
            
            // Restore body scroll
            document.body.style.overflow = 'auto';
        }

        /*
        function saveBookingChangesFromModal() {
            console.log('üíæ Saving booking changes...');
            
            if (!currentBookingData || !currentBookingSource) {
                alert('‚ùå Geen booking data beschikbaar!');
                return;
            }
            
            // Get updated values from the form
            const updatedBooking = {
                ...currentBookingData,
                customerName: document.getElementById('edit-customerName').value,
                customerEmail: document.getElementById('edit-customerEmail').value,
                customerPhone: document.getElementById('edit-customerPhone').value,
                fromLocation: document.getElementById('edit-fromLocation').value,
                toLocation: document.getElementById('edit-toLocation').value,
                travelDate: document.getElementById('edit-travelDate').value,
                travelTime: document.getElementById('edit-travelTime').value,
                passengers: parseInt(document.getElementById('edit-passengers').value) || 1,
                specialRequests: document.getElementById('edit-specialRequests').value
            };
            
            // Update the booking in the appropriate localStorage array
            const storageKey = currentBookingSource + 'Bookings';
            const bookings = JSON.parse(localStorage.getItem(storageKey) || '[]');
            const bookingIndex = bookings.findIndex(b => b.bookingId === currentBookingData.bookingId);
            
            if (bookingIndex !== -1) {
                bookings[bookingIndex] = updatedBooking;
                localStorage.setItem(storageKey, JSON.stringify(bookings));
                
                // Update the current booking data
                currentBookingData = updatedBooking;
                
                alert('‚úÖ Booking successfully updated!');
                closeEditBookingModal();
                
                // Refresh the bookings display if we're in the right section
                if (typeof loadBookings === 'function') {
                    loadBookings();
                }
            } else {
                alert('‚ùå Error: Could not find booking to update!');
            }
        }
        */

        // üÜï ENHANCED DELETE BUTTON FUNCTIONALITY - Additional event listeners
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üîß Setting up enhanced delete button functionality...');
            
            // Add backup event listeners for delete buttons
            const refreshBtn = document.getElementById('refreshUnconfirmedBtn');
            const deleteAllBtn = document.getElementById('deleteAllUnconfirmedBtn');
            
            if (refreshBtn) {
                console.log('‚úÖ Found refresh button - using onclick handler only');
            } else {
                console.error('‚ùå Refresh button not found by ID');
            }
            
            if (deleteAllBtn) {
                console.log('‚úÖ Found delete all button - using onclick handler only');
            } else {
                console.error('‚ùå Delete all button not found by ID');
            }
            
            // Log when individual delete buttons are clicked (for debugging)
            document.addEventListener('click', function(e) {
                // Check if clicked element is an individual delete button
                if (e.target.closest('button[onclick*="deleteUnconfirmedBooking"]')) {
                    console.log('üóëÔ∏è Individual delete button clicked via document listener');
                    const onclick = e.target.closest('button').getAttribute('onclick');
                    console.log('   Onclick:', onclick);
                }
            });
            
            console.log('‚úÖ Enhanced delete button functionality setup complete');
            console.log('üîß DEBUG FUNCTIONS READY:');
            console.log('   - inspectSelectedSurcharges() - Check localStorage selectedSurcharges');
        });
    </script>
    
    <!-- Last-Minute Surcharge Modal -->
    <div id="lastMinuteModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; justify-content: center; align-items: center;">
        <div style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="margin: 0; color: #2c3e50;">‚ö° Last-Minute Toeslag</h3>
                <button onclick="closeLastMinuteModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: #6c757d;">√ó</button>
            </div>
            
            <div id="lastMinuteBookingInfo" style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <!-- Booking info will be populated here -->
            </div>
            
            <div class="section-margin-lg">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #495057;">Toeslag Type:</label>
                <select id="lastMinuteSurchargeModalType" onchange="updateLastMinuteModalExample()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="none">Geen toeslag</option>
                    <option value="percentage">Percentage (%)</option>
                    <option value="fixed">Vast bedrag (‚Ç¨)</option>
                </select>
            </div>
            
            <div id="lastMinuteSurchargeAmountContainer" style="display: none; margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #495057;">Bedrag:</label>
                <input type="number" id="lastMinuteSurchargeModalAmount" step="0.01" min="0" placeholder="25.00" onchange="updateLastMinuteModalExample()" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            
            <div class="section-margin-lg">
                <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #495057;">Reden (optioneel):</label>
                <textarea id="lastMinuteReason" placeholder="Bijv. Minder dan 2 uur voor vertrek, spitsuur, etc." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; height: 60px; resize: vertical;"></textarea>
            </div>
            
            <div id="lastMinuteModalExample" style="background: #e8f5e9; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #28a745;">
                <strong>Voorbeeld:</strong> <span id="lastMinuteModalExampleText">Geen toeslag toegepast</span>
            </div>
            
            <div style="display: flex; gap: 10px; justify-content: flex-end;">
                <button onclick="closeLastMinuteModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer;">Annuleren</button>
                <button onclick="applyLastMinuteSurcharge()" style="background: #f39c12; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; font-weight: 600;">‚ö° Toeslag Toepassen</button>
            </div>
        </div>
    </div>
    
    <script>
        // Last-Minute Modal Functions
        let currentLastMinuteBookingId = null;
        let currentLastMinuteBooking = null;
        
        function openLastMinuteModal(bookingId) {
            console.log('‚ö° Opening last-minute modal for booking:', bookingId);
            
            // Find the booking
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const booking = unconfirmedBookings.find(b => b.bookingId === bookingId);
            
            if (!booking) {
                alert('‚ùå Booking not found');
                return;
            }
            
            currentLastMinuteBookingId = bookingId;
            currentLastMinuteBooking = booking;
            
            // Populate booking info
            const bookingInfo = document.getElementById('lastMinuteBookingInfo');
            bookingInfo.innerHTML = `
                <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Booking ID: ${booking.bookingId}</div>
                <div style="margin-bottom: 5px;"><strong>Klant:</strong> ${booking.customer.firstName} ${booking.customer.lastName}</div>
                <div style="margin-bottom: 5px;"><strong>Datum:</strong> ${booking.trip.travelDate} om ${booking.trip.travelHour}:${booking.trip.travelMinute}</div>
                <div style="margin-bottom: 5px;"><strong>Route:</strong> ${booking.trip.fromLocation} ‚Üí ${booking.trip.toLocation}</div>
                <div><strong>Huidige prijs:</strong> ‚Ç¨${getCurrentBookingPrice(booking).toFixed(2)}</div>
            `;
            
            // Load default settings or reset form
            let defaultType = 'percentage';
            let defaultAmount = '25.00';
            
            // Try to load saved default settings
            const savedDefaults = localStorage.getItem('defaultLastMinuteSettings');
            if (savedDefaults) {
                try {
                    const defaults = JSON.parse(savedDefaults);
                    defaultType = defaults.type || 'percentage';
                    defaultAmount = defaults.amount || 25;
                } catch (error) {
                    console.log('Using fallback defaults for last-minute modal');
                }
            }
            
            // Set form values with defaults
            document.getElementById('lastMinuteSurchargeModalType').value = defaultType;
            document.getElementById('lastMinuteSurchargeModalAmount').value = defaultAmount;
            document.getElementById('lastMinuteReason').value = '';
            
            // Check if booking already has last-minute surcharge (this overrides defaults)
            if (booking.lastMinuteSurcharge) {
                document.getElementById('lastMinuteSurchargeModalType').value = booking.lastMinuteSurcharge.type;
                document.getElementById('lastMinuteSurchargeModalAmount').value = booking.lastMinuteSurcharge.amount;
                document.getElementById('lastMinuteReason').value = booking.lastMinuteSurcharge.reason || '';
            }
            
            updateLastMinuteModalExample();
            
            // Show modal
            document.getElementById('lastMinuteModal').style.display = 'flex';
        }
        
        function closeLastMinuteModal() {
            document.getElementById('lastMinuteModal').style.display = 'none';
            currentLastMinuteBookingId = null;
            currentLastMinuteBooking = null;
        }
        
        function updateLastMinuteModalExample() {
            const type = document.getElementById('lastMinuteSurchargeModalType').value;
            const amount = parseFloat(document.getElementById('lastMinuteSurchargeModalAmount').value) || 0;
            const amountContainer = document.getElementById('lastMinuteSurchargeAmountContainer');
            const exampleText = document.getElementById('lastMinuteModalExampleText');
            
            if (type === 'none') {
                amountContainer.style.display = 'none';
                exampleText.textContent = 'Geen toeslag toegepast';
            } else {
                amountContainer.style.display = 'block';
                
                if (currentLastMinuteBooking) {
                    const currentPrice = getCurrentBookingPrice(currentLastMinuteBooking);
                    let surcharge = 0;
                    
                    if (type === 'percentage') {
                        surcharge = (currentPrice * amount) / 100;
                        exampleText.textContent = `Huidige prijs ‚Ç¨${currentPrice.toFixed(2)} + ${amount}% = ‚Ç¨${(currentPrice + surcharge).toFixed(2)}`;
                    } else if (type === 'fixed') {
                        surcharge = amount;
                        exampleText.textContent = `Huidige prijs ‚Ç¨${currentPrice.toFixed(2)} + ‚Ç¨${amount} = ‚Ç¨${(currentPrice + surcharge).toFixed(2)}`;
                    }
                }
            }
        }
        
        function getCurrentBookingPrice(booking) {
            // Get current price from booking or calculate it
            const step2FinalTotal = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            if (step2FinalTotal > 0) {
                return booking.trip.returnActive ? step2FinalTotal / 2 : step2FinalTotal;
            }
            
            // Fallback calculation
            const vehiclePrice = parseFloat(booking.vehicle?.pricing?.minimumPrice || 50);
            const surchargeTotal = parseFloat(booking.surcharges?.surchargeTotal || 0);
            return vehiclePrice + surchargeTotal;
        }
        
        function applyLastMinuteSurcharge() {
            if (!currentLastMinuteBookingId || !currentLastMinuteBooking) {
                alert('‚ùå Geen booking geselecteerd');
                return;
            }
            
            const type = document.getElementById('lastMinuteSurchargeModalType').value;
            const amount = parseFloat(document.getElementById('lastMinuteSurchargeModalAmount').value) || 0;
            const reason = document.getElementById('lastMinuteReason').value;
            
            // Update booking with last-minute surcharge
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const bookingIndex = unconfirmedBookings.findIndex(b => b.bookingId === currentLastMinuteBookingId);
            
            if (bookingIndex === -1) {
                alert('‚ùå Booking not found in database');
                return;
            }
            
            if (type === 'none') {
                // Remove last-minute surcharge
                delete unconfirmedBookings[bookingIndex].lastMinuteSurcharge;
                console.log('‚úÖ Last-minute surcharge removed from booking:', currentLastMinuteBookingId);
            } else {
                // Add/update last-minute surcharge
                unconfirmedBookings[bookingIndex].lastMinuteSurcharge = {
                    type: type,
                    amount: amount,
                    reason: reason,
                    appliedAt: new Date().toISOString(),
                    appliedBy: 'admin'
                };
                console.log('‚úÖ Last-minute surcharge applied to booking:', currentLastMinuteBookingId);
            }
            
            // Save back to localStorage
            localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            
            // Refresh the bookings table
            loadUnconfirmedBookingsV2();
            
            // Close modal
            closeLastMinuteModal();
            
            // Show success message
            const surchargeText = type === 'none' ? 'verwijderd' : 
                                type === 'percentage' ? `${amount}% toegepast` : 
                                `‚Ç¨${amount} toegepast`;
            alert(`‚úÖ Last-minute toeslag ${surchargeText} voor booking ${currentLastMinuteBookingId}`);
        }
        
        // Add event listener for modal type change (only if elements exist)
        const modalTypeElement = document.getElementById('lastMinuteSurchargeModalType');
        const modalAmountElement = document.getElementById('lastMinuteSurchargeModalAmount');
        
        if (modalTypeElement) {
            modalTypeElement.addEventListener('change', updateLastMinuteModalExample);
        }
        if (modalAmountElement) {
            modalAmountElement.addEventListener('input', updateLastMinuteModalExample);
        }
        
        // Distance-Based Pricing Tiers Functions
        function toggleDistanceTiers() {
            const checkbox = document.getElementById('distanceTiersEnabled');
            const config = document.getElementById('distanceTiersConfig');
            
            // Return early if elements don't exist
            if (!checkbox || !config) {
                console.log('‚ÑπÔ∏è Distance tiers elements not found on current page');
                return;
            }
            
            if (checkbox.checked) {
                config.style.display = 'block';
                console.log('‚úÖ Distance tiers enabled');
            } else {
                config.style.display = 'none';
                console.log('‚ùå Distance tiers disabled');
            }
            
            updateDistanceTiers();
        }
        
        function updateDistanceTiers() {
            // Check if required elements exist
            const enabledElement = document.getElementById('distanceTiersEnabled');
            const tier1MaxElement = document.getElementById('tier1MaxKm');
            const tier2MaxElement = document.getElementById('tier2MaxKm');
            const tier1DiscountElement = document.getElementById('tier1Discount');
            const tier2DiscountElement = document.getElementById('tier2Discount');
            const tier3DiscountElement = document.getElementById('tier3Discount');
            
            // Return early if required elements don't exist
            if (!enabledElement || !tier1MaxElement || !tier2MaxElement) {
                console.log('‚ÑπÔ∏è Distance tiers elements not found on current page');
                return;
            }
            
            const enabled = enabledElement.checked;
            const tier1Max = parseFloat(tier1MaxElement.value) || 50;
            const tier2Max = parseFloat(tier2MaxElement.value) || 100;
            const tier1Discount = parseFloat(tier1DiscountElement?.value) || 0;
            const tier2Discount = parseFloat(tier2DiscountElement?.value) || 10;
            const tier3Discount = parseFloat(tier3DiscountElement?.value) || 20;
            
            // Update tier 2 and 3 minimum values if elements exist
            const tier2MinElement = document.getElementById('tier2MinKm');
            const tier3MinElement = document.getElementById('tier3MinKm');
            if (tier2MinElement) tier2MinElement.textContent = tier1Max;
            if (tier3MinElement) tier3MinElement.textContent = tier2Max;
            
            // Update example text if element exists
            const exampleText = document.getElementById('distanceTiersExample');
            if (exampleText) {
                if (enabled) {
                    const exampleDistance = 150;
                    const tier1Distance = Math.min(exampleDistance, tier1Max);
                    const tier2Distance = Math.min(Math.max(exampleDistance - tier1Max, 0), tier2Max - tier1Max);
                    const tier3Distance = Math.max(exampleDistance - tier2Max, 0);
                    
                    let exampleParts = [];
                    if (tier1Distance > 0) {
                        exampleParts.push(`eerste ${tier1Distance}km normale prijs`);
                    }
                    if (tier2Distance > 0) {
                        exampleParts.push(`volgende ${tier2Distance}km met ${tier2Discount}% korting`);
                    }
                    if (tier3Distance > 0) {
                        exampleParts.push(`laatste ${tier3Distance}km met ${tier3Discount}% korting`);
                    }
                    
                    exampleText.textContent = `Voor een rit van ${exampleDistance}km: ${exampleParts.join(', ')}`;
                } else {
                    exampleText.textContent = 'Distance tiers zijn uitgeschakeld';
                }
            }
            
            // Save distance tiers settings
            const distanceTiersSettings = {
                enabled: enabled,
                tier1: {
                    maxKm: tier1Max,
                    discount: tier1Discount
                },
                tier2: {
                    maxKm: tier2Max,
                    discount: tier2Discount
                },
                tier3: {
                    discount: tier3Discount
                }
            };
            
            localStorage.setItem('distanceTiersSettings', JSON.stringify(distanceTiersSettings));
            console.log('üíæ Distance tiers settings saved:', distanceTiersSettings);
        }
        
        function loadDistanceTiersSettings() {
            const saved = localStorage.getItem('distanceTiersSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    
                    // Check if elements exist before accessing them
                    const distanceTiersEnabled = document.getElementById('distanceTiersEnabled');
                    const tier1MaxKm = document.getElementById('tier1MaxKm');
                    const tier2MaxKm = document.getElementById('tier2MaxKm');
                    const tier1Discount = document.getElementById('tier1Discount');
                    const tier2Discount = document.getElementById('tier2Discount');
                    const tier3Discount = document.getElementById('tier3Discount');
                    
                    // Only set values if elements exist
                    if (distanceTiersEnabled) {
                        distanceTiersEnabled.checked = settings.enabled || false;
                    }
                    
                    if (tier1MaxKm) tier1MaxKm.value = settings.tier1?.maxKm || 50;
                    if (tier2MaxKm) tier2MaxKm.value = settings.tier2?.maxKm || 100;
                    if (tier1Discount) tier1Discount.value = settings.tier1?.discount || 0;
                    if (tier2Discount) tier2Discount.value = settings.tier2?.discount || 10;
                    if (tier3Discount) tier3Discount.value = settings.tier3?.discount || 20;
                    
                    // Update display only if function exists
                    if (typeof toggleDistanceTiers === 'function') {
                        toggleDistanceTiers();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading distance tiers settings:', error);
                }
            }
        }
        
        // Load distance tiers settings when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                loadDistanceTiersSettings();
                loadDefaultLastMinuteSettings();
                
                // Add backup event listener to save button
                const saveBtn = document.getElementById('saveLastMinuteBtn');
                if (saveBtn) {
                    saveBtn.addEventListener('click', function(e) {
                        console.log('üíæ Backup event listener triggered');
                        e.preventDefault();
                        updateDefaultLastMinuteSettings();
                    });
                    console.log('‚úÖ Backup event listener added to save button');
                } else {
                    console.log('‚ö†Ô∏è Save button not found for backup event listener');
                }
            }, 1000);
        });
        
        // Default Last-Minute Settings Functions
        function updateLastMinuteSymbol() {
            const typeElement = document.getElementById('defaultLastMinuteType');
            const symbolElement = document.getElementById('defaultLastMinuteSymbol');
            
            if (typeElement && symbolElement) {
                const type = typeElement.value;
                symbolElement.textContent = type === 'percentage' ? '%' : '‚Ç¨';
                console.log('üîÑ Symbol updated to:', symbolElement.textContent);
            }
        }
        
        function updateDefaultLastMinuteSettings() {
            console.log('üíæ OPSLAAN button clicked - updating last-minute settings...');
            
            // Check if elements exist before accessing them
            const typeElement = document.getElementById('defaultLastMinuteType');
            const amountElement = document.getElementById('defaultLastMinuteAmount');
            const hoursElement = document.getElementById('defaultLastMinuteHours');
            const symbolElement = document.getElementById('defaultLastMinuteSymbol');
            const exampleElement = document.getElementById('defaultLastMinuteExample');
            const hoursDisplayElement = document.getElementById('hoursDisplay');
            
            console.log('üîç Elements found:', {
                typeElement: !!typeElement,
                amountElement: !!amountElement, 
                hoursElement: !!hoursElement,
                symbolElement: !!symbolElement,
                exampleElement: !!exampleElement,
                hoursDisplayElement: !!hoursDisplayElement
            });
            
            // Return early if required elements don't exist
            if (!typeElement || !amountElement || !hoursElement) {
                console.error('‚ùå Last-minute settings elements not found!');
                alert('‚ùå FOUT: Last-minute elementen niet gevonden! Zorg dat je in de Distance & Time Pricing sectie bent.');
                return;
            }
            
            const type = typeElement.value;
            const amount = parseFloat(amountElement.value) || 25;
            const hours = parseFloat(hoursElement.value !== '' ? hoursElement.value : 3);
            
            // Update symbol if element exists
            if (symbolElement) {
                symbolElement.textContent = type === 'percentage' ? '%' : '‚Ç¨';
            }
            
            // Update hours display if element exists
            if (hoursDisplayElement) {
                hoursDisplayElement.textContent = hours;
            }
            
            // Update example if element exists
            if (exampleElement) {
                const examplePrice = 100;
                if (amount === 0) {
                    exampleElement.textContent = `Last-minute surcharge is DISABLED (0% / ‚Ç¨0) - geen extra kosten worden toegevoegd`;
                    exampleElement.style.color = '#28a745';
                    exampleElement.style.fontWeight = 'bold';
                } else {
                    exampleElement.style.color = '#495057';
                    exampleElement.style.fontWeight = 'normal';
                    if (type === 'percentage') {
                        const surcharge = (examplePrice * amount) / 100;
                        exampleElement.textContent = `Bij een boeking van ‚Ç¨${examplePrice} wordt ‚Ç¨${surcharge.toFixed(2)} extra gerekend (totaal ‚Ç¨${(examplePrice + surcharge).toFixed(2)})`;
                    } else {
                        exampleElement.textContent = `Bij een boeking van ‚Ç¨${examplePrice} wordt ‚Ç¨${amount.toFixed(2)} extra gerekend (totaal ‚Ç¨${(examplePrice + amount).toFixed(2)})`;
                    }
                }
            }
            
            // Save settings
            const defaultSettings = {
                type: type,
                amount: amount,
                hours: hours
            };
            
            localStorage.setItem('defaultLastMinuteSettings', JSON.stringify(defaultSettings));
            console.log('üíæ Default last-minute settings saved:', defaultSettings);
            
            // Show success notification
            if (typeof showNotification === 'function') {
                showNotification(`‚úÖ Last-minute instellingen opgeslagen: ${type === 'percentage' ? amount + '%' : '‚Ç¨' + amount} binnen ${hours} uur!`, 'success');
            }
            
            // Always show console confirmation
            console.log('‚úÖ CONFIRMED: Settings saved to localStorage:', defaultSettings);
            console.log('üìç LocalStorage key "defaultLastMinuteSettings" now contains:', localStorage.getItem('defaultLastMinuteSettings'));
            
            // Try to trigger refresh in step2 if it's open in another tab
            try {
                window.postMessage({ 
                    type: 'LAST_MINUTE_UPDATED', 
                    settings: defaultSettings,
                    timestamp: Date.now()
                }, '*');
                console.log('üì° Sent last-minute update message to step2');
            } catch (e) {
                console.log('‚ö†Ô∏è Could not send refresh message:', e.message);
            }
        }
        
        function loadDefaultLastMinuteSettings() {
            const saved = localStorage.getItem('defaultLastMinuteSettings');
            if (saved) {
                try {
                    const settings = JSON.parse(saved);
                    
                    // Check if elements exist before accessing them
                    const defaultLastMinuteType = document.getElementById('defaultLastMinuteType');
                    const defaultLastMinuteAmount = document.getElementById('defaultLastMinuteAmount');
                    const defaultLastMinuteHours = document.getElementById('defaultLastMinuteHours');
                    
                    // Only set values if elements exist
                    if (defaultLastMinuteType) {
                        defaultLastMinuteType.value = settings.type || 'percentage';
                    }
                    if (defaultLastMinuteAmount) {
                        defaultLastMinuteAmount.value = settings.amount || 25;
                    }
                    if (defaultLastMinuteHours) {
                        defaultLastMinuteHours.value = settings.hours || 3;
                    }
                    
                    // Update hours display immediately with loaded value
                    const hoursDisplayElement = document.getElementById('hoursDisplay');
                    if (hoursDisplayElement) {
                        hoursDisplayElement.textContent = settings.hours || 3;
                    }
                    
                    // Update symbol and display
                    if (typeof updateLastMinuteSymbol === 'function') {
                        updateLastMinuteSymbol();
                    }
                    if (typeof updateDefaultLastMinuteSettings === 'function') {
                        updateDefaultLastMinuteSettings();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error loading default last-minute settings:', error);
                    // Set defaults if loading fails and function exists
                    if (typeof updateLastMinuteSymbol === 'function') {
                        updateLastMinuteSymbol();
                    }
                    if (typeof updateDefaultLastMinuteSettings === 'function') {
                        updateDefaultLastMinuteSettings();
                    }
                }
            } else {
                console.log('‚ö° No last-minute settings found, creating defaults...');
                // Set initial defaults 
                const defaultSettings = {
                    type: 'percentage',
                    amount: 25,
                    hours: 3
                };
                localStorage.setItem('defaultLastMinuteSettings', JSON.stringify(defaultSettings));
                console.log('üíæ Default last-minute settings created:', defaultSettings);
                
                // Set form values if elements exist
                const defaultLastMinuteType = document.getElementById('defaultLastMinuteType');
                const defaultLastMinuteAmount = document.getElementById('defaultLastMinuteAmount');
                const defaultLastMinuteHours = document.getElementById('defaultLastMinuteHours');
                
                if (defaultLastMinuteType) defaultLastMinuteType.value = 'percentage';
                if (defaultLastMinuteAmount) defaultLastMinuteAmount.value = 25;
                if (defaultLastMinuteHours) defaultLastMinuteHours.value = 3;
                
                // Update hours display immediately with default value
                const hoursDisplayElement = document.getElementById('hoursDisplay');
                if (hoursDisplayElement) {
                    hoursDisplayElement.textContent = '3';
                }
                
                // Update symbol and display
                if (typeof updateLastMinuteSymbol === 'function') {
                    updateLastMinuteSymbol();
                }
                if (typeof updateDefaultLastMinuteSettings === 'function') {
                    updateDefaultLastMinuteSettings();
                }
            }
        }
        
        // Quick Preset Functions
        function setQuickPreset(type, amount) {
            console.log('‚ö° Quick preset clicked:', { type, amount });
            
            // Set the form values
            const typeElement = document.getElementById('defaultLastMinuteType');
            const amountElement = document.getElementById('defaultLastMinuteAmount');
            
            if (typeElement && amountElement) {
                typeElement.value = type;
                amountElement.value = amount;
                
                // Update the symbol and display and save
                updateLastMinuteSymbol();
                updateDefaultLastMinuteSettings();
            } else {
                console.error('‚ùå Quick preset elements not found');
                alert('Fout: Quick preset elementen niet gevonden. Ga naar Distance & Time pagina.');
                return;
            }
            
            // Show feedback
            const feedback = document.createElement('div');
            feedback.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 10px 20px;
                border-radius: 6px;
                z-index: 9999;
                font-weight: 600;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            `;
            feedback.textContent = `‚úÖ Quick preset ingesteld: ${type === 'percentage' ? amount + '%' : '‚Ç¨' + amount}`;
            document.body.appendChild(feedback);
            
            // Remove feedback after 2 seconds
            setTimeout(() => {
                if (feedback.parentNode) {
                    feedback.parentNode.removeChild(feedback);
                }
            }, 2000);
            
            console.log(`‚úÖ Quick preset applied: ${type} = ${amount}`);
        }
        
        // Advanced Distance-Based KM Price Functions
        function loadDistancePricing() {
            // Load saved settings
            const saved = localStorage.getItem('distanceBasedPricing');
            let distancePricing = {};
            
            if (saved) {
                try {
                    distancePricing = JSON.parse(saved);
                    document.getElementById('distanceThreshold').value = distancePricing.threshold || 100;
                } catch (error) {
                    console.error('‚ùå Error loading distance pricing:', error);
                    document.getElementById('distanceThreshold').value = 100;
                }
            } else {
                document.getElementById('distanceThreshold').value = 100;
            }
            
            // Generate vehicle pricing cards
            generateVehicleDistancePricing(distancePricing);
        }
        
        function generateVehicleDistancePricing(savedPricing) {
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            const container = document.getElementById('vehicleDistancePricing');
            const threshold = parseInt(document.getElementById('distanceThreshold').value) || 100;
            
            if (vehicles.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #6c757d; border: 2px dashed #dee2e6; border-radius: 8px;">
                        <h4>üöó Geen voertuigen gevonden</h4>
                        <p>Configureer eerst voertuigen in Types of Vehicles</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            vehicles.forEach(vehicle => {
                // Get current pricing from existing vehicle data
                const existingPricing = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
                const minimumPrice = existingPricing[vehicle.id]?.minimumPrice || 15.00;
                const standardKmPrice = existingPricing[vehicle.id]?.pricePerKm || 1.80;
                const longDistancePrice = existingPricing[vehicle.id]?.longDistancePerKm || (standardKmPrice * 0.8);
                
                const card = document.createElement('div');
                card.style.cssText = `
                    background: white; border: 1px solid #dee2e6; border-radius: 8px; 
                    padding: 20px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
                `;
                
                card.innerHTML = `
                    <h4 style="color: #2c3e50; margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                        üöó ${vehicle.name}
                    </h4>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="max-width: 400px;">
                            <label style="font-weight: 600; color: #495057; margin-bottom: 8px; display: block; font-size: 13px;">
                                Lange rit ‚Ç¨/km
                            </label>
                            <div style="display: flex; align-items: center; border: 1px solid #e9ecef; border-radius: 8px; overflow: hidden;">
                                <button type="button" onclick="adjustDistancePrice('${vehicle.id}', 'longDistancePerKm', -0.10)" 
                                        style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">-</button>
                                <input type="number" id="long_${vehicle.id}" value="${longDistancePrice.toFixed(2)}" 
                                       step="0.10" min="0" 
                                       style="border: none; text-align: center; padding: 8px; width: 100%; outline: none; font-weight: 500;"
                                       onchange="updateDynamicPricing('${vehicle.id}', 'longDistancePerKm', this.value); updateDistanceExamples();">
                                <button type="button" onclick="adjustDistancePrice('${vehicle.id}', 'longDistancePerKm', 0.10)" 
                                        style="background: #f8f9fa; border: none; padding: 8px 12px; cursor: pointer; color: #6c757d;">+</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="example_${vehicle.id}" style="background: #f0f8ff; padding: 10px; border-radius: 4px; border-left: 3px solid #007bff; font-size: 13px; color: #495057;">
                        <!-- Example will be generated here -->
                    </div>
                `;
                
                container.appendChild(card);
            });
            
            updateDistanceExamples();
        }
        
        function adjustDistancePrice(vehicleId, priceType, adjustment) {
            console.log(`üîß Adjusting ${priceType} for vehicle ${vehicleId} by ${adjustment}`);
            
            // Get the input element based on the price type
            let inputId;
            switch(priceType) {
                case 'minimum':
                    inputId = `minimum_${vehicleId}`;
                    break;
                case 'perKm':
                    inputId = `perKm_${vehicleId}`;
                    break;
                case 'longDistancePerKm':
                    inputId = `long_${vehicleId}`;
                    break;
                default:
                    console.error('Unknown price type:', priceType);
                    return;
            }
            
            const input = document.getElementById(inputId);
            if (!input) {
                console.error('Input element not found:', inputId);
                return;
            }
            
            // Get current value and apply adjustment
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + adjustment);
            
            // Update the input field
            input.value = newValue.toFixed(2);
            
            // Save to localStorage using the existing updateDynamicPricing function
            updateDynamicPricing(vehicleId, priceType, newValue);
            
            // Update the examples to reflect the new pricing
            updateDistanceExamples();
            
            console.log(`‚úÖ Updated ${priceType} for vehicle ${vehicleId} from ‚Ç¨${currentValue.toFixed(2)} to ‚Ç¨${newValue.toFixed(2)} and saved to localStorage`);
        }
        
        function updateDistanceExamples() {
            console.log('üîÑ Updating distance examples...');
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            const threshold = parseInt(document.getElementById('distanceThreshold').value) || 100;
            console.log(`üìè Using threshold: ${threshold} km`);
            
            vehicles.forEach(vehicle => {
                // Get pricing from existing vehicle pricing
                const existingPricing = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
                const minimumPrice = existingPricing[vehicle.id]?.minimum || 5.00;
                const shortPrice = existingPricing[vehicle.id]?.pricePerKm || 1.30;
                
                // Load saved long distance price or use default
                const savedLongPrice = existingPricing[vehicle.id]?.longDistancePerKm;
                const longPriceInput = document.getElementById(`long_${vehicle.id}`);
                let longPrice = 1.20;
                
                if (savedLongPrice && longPriceInput) {
                    longPriceInput.value = savedLongPrice;
                    longPrice = savedLongPrice;
                    console.log(`‚úÖ Loaded long distance price for ${vehicle.name}: ‚Ç¨${savedLongPrice}`);
                } else if (longPriceInput && longPriceInput.value) {
                    longPrice = parseFloat(longPriceInput.value);
                }
                const exampleElement = document.getElementById(`example_${vehicle.id}`);
                
                // Also update the label for long distance price
                const longLabel = document.querySelector(`label[for="long_${vehicle.id}"]`);
                if (longLabel) {
                    longLabel.textContent = `Lange rit tarief (vanaf ${threshold}km):`;
                }
                
                if (exampleElement) {
                    // Example calculation for 150km
                    const exampleDistance = 150;
                    
                    let totalCost = 0;
                    let breakdown = '';
                    
                    if (exampleDistance <= threshold) {
                        // Short trip: Minimum + per km
                        totalCost = minimumPrice + (exampleDistance * shortPrice);
                        breakdown = `Minimum (‚Ç¨${minimumPrice.toFixed(2)}) + ${exampleDistance}km √ó ‚Ç¨${shortPrice.toFixed(2)} = ‚Ç¨${totalCost.toFixed(2)}`;
                    } else {
                        // Long trip: Minimum + short distance + long distance
                        const shortCost = minimumPrice + (threshold * shortPrice);
                        const longKm = exampleDistance - threshold;
                        const longCost = longKm * longPrice;
                        totalCost = shortCost + longCost;
                        breakdown = `Eerste ${threshold}km: Minimum (‚Ç¨${minimumPrice.toFixed(2)}) + ${threshold}km √ó ‚Ç¨${shortPrice.toFixed(2)} = ‚Ç¨${shortCost.toFixed(2)}<br>Volgende ${longKm}km: ${longKm}km √ó ‚Ç¨${longPrice.toFixed(2)} = ‚Ç¨${longCost.toFixed(2)}`;
                    }
                    
                    console.log(`üöó ${vehicle.name}: ‚Ç¨${totalCost.toFixed(2)}`);
                    
                    exampleElement.innerHTML = `
                        <strong>Voorbeeld (${exampleDistance}km):</strong><br>
                        ${breakdown}<br>
                        <strong>Totaal: ‚Ç¨${totalCost.toFixed(2)}</strong>
                    `;
                }
            });
        }
        
        function saveDistancePricing() {
            const vehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            const threshold = parseInt(document.getElementById('distanceThreshold').value) || 100;
            
            const distancePricing = {
                threshold: threshold,
                lastUpdated: new Date().toISOString(),
                vehicles: {}
            };
            
            vehicles.forEach(vehicle => {
                const longPrice = parseFloat(document.getElementById(`long_${vehicle.id}`)?.value) || 1.50;
                
                distancePricing.vehicles[vehicle.id] = {
                    longDistance: longPrice
                };
            });
            
            // Save to localStorage
            localStorage.setItem('distanceBasedPricing', JSON.stringify(distancePricing));
            
            // Show success message
            showDistancePricingStatus(`‚úÖ Afstand-gebaseerde prijzen opgeslagen voor ${vehicles.length} voertuigen`, 'success');
            
            console.log('üíæ Distance-based pricing saved:', distancePricing);
        }
        
        function showDistancePricingStatus(message, type) {
            const statusElement = document.getElementById('distancePricingStatus');
            
            if (type === 'success') {
                statusElement.style.background = '#d4edda';
                statusElement.style.color = '#155724';
                statusElement.style.border = '1px solid #c3e6cb';
            } else {
                statusElement.style.background = '#f8d7da';
                statusElement.style.color = '#721c24';
                statusElement.style.border = '1px solid #f5c6cb';
            }
            
            statusElement.textContent = message;
            statusElement.style.display = 'block';
            
            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 3000);
        }

        // PayPal Configuration Functions
        function configurePayPal() {
            console.log('Opening PayPal configuration...');
            
            // Load existing PayPal settings from localStorage
            const paypalSettings = JSON.parse(localStorage.getItem('paypalSettings') || '{}');
            
            // Populate form with existing values
            if (paypalSettings.businessEmail) {
                document.getElementById('paypalBusinessEmail').value = paypalSettings.businessEmail;
            }
            if (paypalSettings.environment) {
                document.getElementById('paypalEnvironment').value = paypalSettings.environment;
            }
            if (paypalSettings.currency) {
                document.getElementById('paypalCurrency').value = paypalSettings.currency;
            }
            if (paypalSettings.chargeType) {
                document.getElementById('paypalChargeType').value = paypalSettings.chargeType;
            }
            if (paypalSettings.chargeValue !== undefined) {
                document.getElementById('paypalChargeValue').value = paypalSettings.chargeValue;
            }
            if (paypalSettings.language) {
                document.getElementById('paypalLanguage').value = paypalSettings.language;
            }
            if (paypalSettings.deposit) {
                document.getElementById('paypalDeposit').value = paypalSettings.deposit;
            }
            if (paypalSettings.ordering !== undefined) {
                document.getElementById('paypalOrdering').value = paypalSettings.ordering;
            }
            if (paypalSettings.isDefault !== undefined) {
                document.getElementById('paypalDefault').checked = paypalSettings.isDefault;
            }
            if (paypalSettings.isActive !== undefined) {
                document.getElementById('paypalActive').checked = paypalSettings.isActive;
            }
            if (paypalSettings.display) {
                document.getElementById('paypalDisplay').value = paypalSettings.display;
            }
            
            // Show configuration section
            document.getElementById('paypalConfigSection').style.display = 'block';
            
            // Update charge type label
            updateChargeTypeLabel();
        }

        function closePayPalConfig() {
            document.getElementById('paypalConfigSection').style.display = 'none';
        }

        function updateChargeTypeLabel() {
            const chargeType = document.getElementById('paypalChargeType').value;
            const chargeUnit = document.getElementById('chargeUnit');
            
            if (chargeType === 'percent') {
                chargeUnit.textContent = '(%)';
            } else {
                chargeUnit.textContent = '(‚Ç¨)';
            }
        }

        function savePayPalConfig(event) {
            event.preventDefault();
            
            const paypalSettings = {
                name: document.getElementById('paypalName').value,
                description: document.getElementById('paypalDescription').value,
                environment: document.getElementById('paypalEnvironment').value,
                businessEmail: document.getElementById('paypalBusinessEmail').value,
                currency: document.getElementById('paypalCurrency').value,
                language: document.getElementById('paypalLanguage').value,
                deposit: document.getElementById('paypalDeposit').value,
                chargeType: document.getElementById('paypalChargeType').value,
                chargeValue: parseFloat(document.getElementById('paypalChargeValue').value),
                ordering: parseInt(document.getElementById('paypalOrdering').value),
                isDefault: document.getElementById('paypalDefault').checked,
                isActive: document.getElementById('paypalActive').checked,
                display: document.getElementById('paypalDisplay').value,
                enabled: document.getElementById('paypalActive').checked
            };
            
            // Save to localStorage
            localStorage.setItem('paypalSettings', JSON.stringify(paypalSettings));
            
            // Update enabled checkbox in main payment methods
            document.getElementById('paypalEnabled').checked = paypalSettings.isActive;
            
            console.log('‚úÖ PayPal settings saved:', paypalSettings);
            
            // Show success message
            showNotification('‚úÖ PayPal settings saved successfully!', 'success');
            
            // Close configuration section
            setTimeout(() => {
                closePayPalConfig();
            }, 1500);
        }

        function testPayPalConnection() {
            const businessEmail = document.getElementById('paypalBusinessEmail').value;
            const environment = document.getElementById('paypalEnvironment').value;
            
            if (!businessEmail) {
                showNotification('‚ùå Please enter PayPal Business Email first', 'error');
                return;
            }
            
            showNotification('üîÑ Testing PayPal connection...', 'info');
            
            // Simulate test connection
            setTimeout(() => {
                if (environment === 'sandbox') {
                    showNotification('‚úÖ PayPal Sandbox connection successful!', 'success');
                } else {
                    showNotification('‚úÖ PayPal Live connection ready! Make sure your business email is verified.', 'success');
                }
            }, 1500);
        }

        // Credit Card Configuration Functions
        function configureCreditCard() {
            console.log('Opening Credit Card configuration...');
            
            // Load existing Credit Card settings from localStorage
            const creditCardSettings = JSON.parse(localStorage.getItem('creditCardSettings') || '{}');
            
            // Populate form with existing values
            if (creditCardSettings.name) {
                document.getElementById('creditCardName').value = creditCardSettings.name;
            }
            if (creditCardSettings.description) {
                document.getElementById('creditCardDescription').value = creditCardSettings.description;
            }
            if (creditCardSettings.environment) {
                document.getElementById('creditCardEnvironment').value = creditCardSettings.environment;
            }
            if (creditCardSettings.livePublishableKey) {
                document.getElementById('creditCardLivePublishableKey').value = creditCardSettings.livePublishableKey;
            }
            if (creditCardSettings.liveSecretKey) {
                document.getElementById('creditCardLiveSecretKey').value = creditCardSettings.liveSecretKey;
            }
            if (creditCardSettings.sca) {
                document.getElementById('creditCardSCA').value = creditCardSettings.sca;
            }
            if (creditCardSettings.futurePayment) {
                document.getElementById('creditCardFuturePayment').value = creditCardSettings.futurePayment;
            }
            if (creditCardSettings.captureMethod) {
                document.getElementById('creditCardCaptureMethod').value = creditCardSettings.captureMethod;
            }
            if (creditCardSettings.currency) {
                document.getElementById('creditCardCurrency').value = creditCardSettings.currency;
            }
            if (creditCardSettings.language) {
                document.getElementById('creditCardLanguage').value = creditCardSettings.language;
            }
            if (creditCardSettings.deposit) {
                document.getElementById('creditCardDeposit').value = creditCardSettings.deposit;
            }
            if (creditCardSettings.chargeType) {
                document.getElementById('creditCardChargeType').value = creditCardSettings.chargeType;
            }
            if (creditCardSettings.chargeValue !== undefined) {
                document.getElementById('creditCardChargeValue').value = creditCardSettings.chargeValue;
            }
            if (creditCardSettings.ordering !== undefined) {
                document.getElementById('creditCardOrdering').value = creditCardSettings.ordering;
            }
            if (creditCardSettings.isDefault !== undefined) {
                document.getElementById('creditCardDefault').checked = creditCardSettings.isDefault;
            }
            if (creditCardSettings.isActive !== undefined) {
                document.getElementById('creditCardActive').checked = creditCardSettings.isActive;
            }
            if (creditCardSettings.display) {
                document.getElementById('creditCardDisplay').value = creditCardSettings.display;
            }
            
            // Show configuration section
            document.getElementById('creditCardConfigSection').style.display = 'block';
            
            // Update charge type label
            updateCreditCardChargeTypeLabel();
        }

        function closeCreditCardConfig() {
            document.getElementById('creditCardConfigSection').style.display = 'none';
        }

        function updateCreditCardChargeTypeLabel() {
            const chargeType = document.getElementById('creditCardChargeType').value;
            const chargeUnit = document.getElementById('creditCardChargeUnit');
            
            if (chargeType === 'percent') {
                chargeUnit.textContent = '(%)';
            } else {
                chargeUnit.textContent = '(‚Ç¨)';
            }
        }

        function saveCreditCardConfig(event) {
            event.preventDefault();
            
            const creditCardSettings = {
                name: document.getElementById('creditCardName').value,
                description: document.getElementById('creditCardDescription').value,
                environment: document.getElementById('creditCardEnvironment').value,
                livePublishableKey: document.getElementById('creditCardLivePublishableKey').value,
                liveSecretKey: document.getElementById('creditCardLiveSecretKey').value,
                sca: document.getElementById('creditCardSCA').value,
                futurePayment: document.getElementById('creditCardFuturePayment').value,
                captureMethod: document.getElementById('creditCardCaptureMethod').value,
                currency: document.getElementById('creditCardCurrency').value,
                language: document.getElementById('creditCardLanguage').value,
                deposit: document.getElementById('creditCardDeposit').value,
                chargeType: document.getElementById('creditCardChargeType').value,
                chargeValue: parseFloat(document.getElementById('creditCardChargeValue').value),
                ordering: parseInt(document.getElementById('creditCardOrdering').value),
                isDefault: document.getElementById('creditCardDefault').checked,
                isActive: document.getElementById('creditCardActive').checked,
                display: document.getElementById('creditCardDisplay').value,
                enabled: document.getElementById('creditCardActive').checked
            };
            
            // Save to localStorage
            localStorage.setItem('creditCardSettings', JSON.stringify(creditCardSettings));
            
            // Update enabled checkbox in main payment methods
            document.getElementById('creditCardEnabled').checked = creditCardSettings.isActive;
            
            console.log('‚úÖ Credit Card settings saved:', creditCardSettings);
            
            // Show success message
            showNotification('‚úÖ Credit Card settings saved successfully!', 'success');
            
            // Close configuration section
            setTimeout(() => {
                closeCreditCardConfig();
            }, 1500);
        }

        function testCreditCardConnection() {
            console.log('üîß Testing Credit Card connection...');
            
            // Get settings
            const settings = JSON.parse(localStorage.getItem('creditCardSettings') || '{}');
            
            if (!settings.livePublishableKey || !settings.liveSecretKey) {
                showNotification('‚ùå Please configure your Credit Card API keys first', 'error');
                return;
            }
            
            showNotification('üîÑ Testing Credit Card connection...', 'info');
            
            // Simulate API test
            setTimeout(() => {
                if (settings.environment === 'live') {
                    showNotification('‚úÖ Credit Card Live connection successful!', 'success');
                } else {
                    showNotification('‚úÖ Credit Card Sandbox connection successful!', 'success');
                }
            }, 2000);
            
            console.log('‚úÖ Credit Card connection test completed');
        }

        // Add CSS animations
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
        
        // ===============================
        // DRIVER MANAGEMENT FUNCTIONS
        // ===============================
        
        // Initialize driver manager variable
        let driverManager = null;
        
        // Define all functions immediately (before loading classes)
        
        // Show add driver modal - Define immediately
        function showAddDriverModal() {
            console.log('Opening add driver modal...');
            const modal = document.getElementById('addDriverModal');
            if (modal) {
                modal.style.display = 'block';
                // Reset form
                const form = document.getElementById('addDriverForm');
                if (form) {
                    form.reset();
                }
            } else {
                console.error('Modal not found');
                alert('Modal formulier niet gevonden. Probeer de pagina te verversen.');
            }
        }
        
        // Close driver modal
        
        // Save new driver with complete form data
        function saveNewDriver() {
            console.log('Saving new driver with complete data...');
            
            if (!driverManager) {
                alert('Driver systeem wordt nog geladen, probeer over een paar seconden opnieuw.');
                return;
            }
            
            try {
                // Get all form data
                const driverData = {
                    personal: {
                        firstName: document.getElementById('driverFirstName').value.trim(),
                        lastName: document.getElementById('driverLastName').value.trim(),
                        email: document.getElementById('driverEmail').value.trim(),
                        phone: document.getElementById('driverPhone').value.trim(),
                        dateOfBirth: document.getElementById('driverBirthDate').value,
                        bsn: document.getElementById('driverBSN').value.trim(),
                        address: {
                            street: document.getElementById('driverStreet').value.trim(),
                            houseNumber: document.getElementById('driverHouseNumber').value.trim(),
                            postalCode: document.getElementById('driverPostalCode').value.trim(),
                            city: document.getElementById('driverCity').value.trim()
                        }
                    },
                    documents: {
                        driverLicense: {
                            number: document.getElementById('driverLicenseNumber').value.trim(),
                            expiryDate: document.getElementById('driverLicenseExpiry').value
                        },
                        taxiPass: {
                            number: document.getElementById('taxiPassNumber').value.trim(),
                            expiryDate: document.getElementById('taxiPassExpiry').value
                        }
                    },
                    vehicle: {
                        brand: document.getElementById('vehicleBrand').value.trim(),
                        model: document.getElementById('vehicleModel').value.trim(),
                        licensePlate: document.getElementById('vehicleLicensePlate').value.trim(),
                        color: document.getElementById('vehicleColor').value.trim(),
                        seats: parseInt(document.getElementById('vehicleSeats').value) || 4,
                        vehicleType: document.getElementById('vehicleType').value
                    },
                    account: {
                        username: document.getElementById('driverUsername').value.trim(),
                        password: document.getElementById('driverPassword').value.trim()
                    }
                };
                
                // Add the driver using DriverManager
                const newDriver = driverManager.addDriver(driverData);
                
                alert(`‚úÖ Chauffeur ${newDriver.personal.getFullName()} succesvol toegevoegd!`);
                console.log('New driver added:', newDriver);
                
                // Close modal and refresh list
                closeDriverModal();
                refreshDriversList();
                
            } catch (error) {
                console.error('Error adding driver:', error);
                alert(`‚ùå Fout bij toevoegen chauffeur: ${error.message}`);
            }
        }
        window.showAddDriverModal = showAddDriverModal;
        window.closeDriverModal = closeDriverModal;
        window.saveNewDriver = saveNewDriver;
        
        
        
        
        // Refresh drivers list - Define immediately
        function refreshDriversList() {
            if (!driverManager) {
                console.error('Driver manager not initialized');
                return;
            }
            
            const tbody = document.getElementById('driversTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            const drivers = driverManager.getAllDrivers();
            
            if (drivers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="padding: 40px; text-align: center; color: #6c757d;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üöñ</div>
                            <div style="font-size: 18px;">Nog geen chauffeurs toegevoegd</div>
                            <div style="font-size: 14px; margin-top: 5px;">Klik op "Nieuwe Chauffeur Toevoegen" om te beginnen</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            drivers.forEach(driver => {
                const row = createDriverTableRow(driver);
                tbody.appendChild(row);
            });
            
            updateDriverStats();
        }
        window.refreshDriversList = refreshDriversList;
        
        // Load driver classes
        const script = document.createElement('script');
        script.src = 'driver-classes.js';
        document.head.appendChild(script);
        
        // Initialize driver manager after classes are loaded
        script.onload = function() {
            console.log('Driver classes loaded successfully');
            driverManager = new window.DriverClasses.DriverManager();
            
            // Update driver stats on page load
            updateDriverStats();
        };
        
        
        
        // Create driver table row
        function createDriverTableRow(driver) {
            const tr = document.createElement('tr');
            tr.style.borderBottom = '1px solid #dee2e6';
            
            // Status indicator
            const statusColors = {
                'online': '#28a745',
                'busy': '#ffc107',
                'break': '#17a2b8',
                'offline': '#6c757d'
            };
            
            const statusText = {
                'online': 'Online',
                'busy': 'Bezig',
                'break': 'Pauze',
                'offline': 'Offline'
            };
            
            tr.innerHTML = `
                <td class="section-padding">
                    <div style="display: flex; align-items: center; gap: 8px;">
                        <div style="width: 10px; height: 10px; border-radius: 50%; background: ${statusColors[driver.status.currentStatus]}"></div>
                        <span>${statusText[driver.status.currentStatus]}</span>
                    </div>
                </td>
                <td style="padding: 15px; font-weight: 500;">${driver.personal.getFullName()}</td>
                <td class="section-padding">${driver.personal.phone}</td>
                <td class="section-padding">${driver.personal.email}</td>
                <td class="section-padding">${driver.vehicle.displayName || 'Geen voertuig'}</td>
                <td class="section-padding">
                    ${driver.documents.isVerified() ? 
                        '<span style="color: #28a745;">‚úÖ Geverifieerd</span>' : 
                        '<span style="color: #dc3545;">‚è≥ Verificatie nodig</span>'}
                </td>
                <td class="section-padding">
                    <div style="display: flex; align-items: center; gap: 5px;">
                        <span style="color: #ffc107;">‚≠ê</span>
                        <span>${driver.status.rating.toFixed(1)}</span>
                        <span style="color: #6c757d; font-size: 12px;">(${driver.status.ratingCount})</span>
                    </div>
                </td>
                <td style="padding: 15px; text-align: center;">
                    <button onclick="editDriver('${driver.id}')" style="background: #007bff; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; margin-right: 5px;">
                        ‚úèÔ∏è Bewerk
                    </button>
                    <button onclick="deleteDriver('${driver.id}')" style="background: #dc3545; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">
                        üóëÔ∏è Verwijder
                    </button>
                </td>
            `;
            
            return tr;
        }
        
        
        // WORKING DRIVER FUNCTIONS
        
        // Sample driver data
        drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
        
        function addNewDriverWorking() {
            // WERKENDE VERSIE - GEKOPIEERD UIT SIMPLE-TEST
            const name = prompt('Naam van de nieuwe chauffeur:');
            if (!name) return;
            
            const phone = prompt('Telefoonnummer:', '+32');
            if (!phone) return;
            
            const email = prompt('Email adres:', name.toLowerCase().replace(' ', '.') + '@email.com');
            if (!email) return;
            
            const vehicle = prompt('Voertuig:', 'Toyota Prius');
            if (!vehicle) return;
            
            const newDriver = {
                id: 'DRV_' + Date.now(),
                name: name,
                phone: phone,
                email: email,
                vehicle: vehicle,
                status: 'offline',
                rating: 5.0,
                verified: true
            };
            
            // Get current drivers from localStorage
            let drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            drivers.push(newDriver);
            localStorage.setItem('taxiDrivers', JSON.stringify(drivers));
            
            // Refresh the drivers list
            if (typeof loadDriversList === 'function') {
                loadDriversList();
            }
            
            alert('‚úÖ Chauffeur toegevoegd aan systeem!\n\nNaam: ' + name + '\nTelefoon: ' + phone + '\nEmail: ' + email + '\nVoertuig: ' + vehicle);
        }

        // Professional Location Surcharge Management System
        let locationSurcharges = [];
        let currentEditingIndex = -1;
        let addressCounter = 0;

        function loadLocationSurcharges() {
            const saved = localStorage.getItem('locationSurcharges');
            if (saved) {
                locationSurcharges = JSON.parse(saved);
            } else {
                // Default professional location surcharges
                locationSurcharges = [
                    {
                        id: 'airport-parking-' + Date.now(),
                        name: 'Airport Parking',
                        price: 5.00,
                        overrideTaxRate: false,
                        addToJourneyPrice: true,
                        displayInSummary: true,
                        limitToLocation: true,
                        locationDirection: 'any',
                        addresses: [
                            { address: 'Schiphol Airport', postcode: '1118' },
                            { address: 'Brussels Airport', postcode: '1930' }
                        ],
                        limitToVehicleType: false,
                        limitToEvent: false,
                        active: true
                    },
                    {
                        id: 'hotel-surcharge-' + Date.now() + 1,
                        name: 'Hotel Service Fee',
                        price: 3.50,
                        overrideTaxRate: false,
                        addToJourneyPrice: true,
                        displayInSummary: true,
                        limitToLocation: true,
                        locationDirection: 'pickup',
                        addresses: [
                            { address: 'Hilton Hotel', postcode: '1000' },
                            { address: 'Marriott Hotel', postcode: '2000' }
                        ],
                        limitToVehicleType: false,
                        limitToEvent: false,
                        active: true
                    }
                ];
                localStorage.setItem('locationSurcharges', JSON.stringify(locationSurcharges));
            }
            renderLocationSurchargesList();
        }

        function renderLocationSurchargesList() {
            const tbody = document.getElementById('locationSurchargesTableBody');
            if (!tbody) {
                console.error('‚ùå locationSurchargesTableBody not found!');
                return;
            }
            
            tbody.innerHTML = '';

            if (locationSurcharges.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 40px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 10px;">üìç</div>
                            <div style="font-size: 16px;">No location surcharges configured</div>
                            <div style="font-size: 14px; margin-top: 5px;">Click "Add Location Surcharge" to create your first location-based pricing rule</div>
                        </td>
                    </tr>
                `;
                return;
            }

            locationSurcharges.forEach((item, index) => {
                const row = document.createElement('tr');
                row.style.cssText = 'border-bottom: 1px solid #dee2e6; transition: background-color 0.2s;';
                row.onmouseenter = () => row.style.backgroundColor = '#f8f9fa';
                row.onmouseleave = () => row.style.backgroundColor = 'transparent';
                
                // Build location restrictions display exactly like screenshot
                let restrictionsHtml = '';
                if (item.limitToLocation && item.addresses && item.addresses.length > 0) {
                    restrictionsHtml = `
                        <div style="color: #856404; font-size: 13px; font-weight: 500;">Location (Any):</div>
                    `;
                    item.addresses.forEach(addr => {
                        if (addr.address && addr.postcode) {
                            restrictionsHtml += `<div style="color: #6c757d; font-size: 12px;">${addr.address}, ${addr.postcode}</div>`;
                        } else if (addr.address) {
                            restrictionsHtml += `<div style="color: #6c757d; font-size: 12px;">${addr.address}</div>`;
                        } else if (addr.postcode) {
                            restrictionsHtml += `<div style="color: #6c757d; font-size: 12px;">${addr.postcode}</div>`;
                        }
                    });
                } else {
                    restrictionsHtml = '<div style="color: #6c757d; font-size: 12px;">No restrictions</div>';
                }

                row.innerHTML = `
                    <td style="padding: 12px 15px; border-right: 1px solid #dee2e6; vertical-align: top;">
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button onclick="editLocationSurcharge(${index})" style="
                                background: none; 
                                border: none; 
                                color: #6c757d; 
                                cursor: pointer; 
                                padding: 4px;
                                border-radius: 3px;
                                font-size: 14px;
                                transition: all 0.2s;
                            " title="Edit" onmouseenter="this.style.backgroundColor='#e9ecef'" onmouseleave="this.style.backgroundColor='transparent'">‚úèÔ∏è</button>
                            <button onclick="duplicateLocationSurcharge(${index})" style="
                                background: none; 
                                border: none; 
                                color: #6c757d; 
                                cursor: pointer; 
                                padding: 4px;
                                border-radius: 3px;
                                font-size: 14px;
                                transition: all 0.2s;
                            " title="Duplicate" onmouseenter="this.style.backgroundColor='#e9ecef'" onmouseleave="this.style.backgroundColor='transparent'">üìã</button>
                            <button onclick="deleteLocationSurcharge(${index})" style="
                                background: none; 
                                border: none; 
                                color: #6c757d; 
                                cursor: pointer; 
                                padding: 4px;
                                border-radius: 3px;
                                font-size: 14px;
                                transition: all 0.2s;
                            " title="Delete" onmouseenter="this.style.backgroundColor='#e9ecef'" onmouseleave="this.style.backgroundColor='transparent'">üóëÔ∏è</button>
                        </div>
                    </td>
                    <td style="padding: 12px 15px; border-right: 1px solid #dee2e6; vertical-align: top;">
                        <div style="font-weight: 500; color: #212529; font-size: 14px;">${item.name}</div>
                        ${item.id ? `<div style="color: #6c757d; font-size: 11px; font-family: monospace;">‚ìò</div>` : ''}
                    </td>
                    <td style="padding: 12px 15px; border-right: 1px solid #dee2e6; text-align: right; vertical-align: top; font-weight: 600; color: #212529;">
                        ‚Ç¨${item.price.toFixed(2)}
                    </td>
                    <td style="padding: 12px 15px; border-right: 1px solid #dee2e6; text-align: center; vertical-align: top;">
                        <span style="color: #6c757d; font-size: 13px;">${item.overrideTaxRate ? 'Custom' : 'No tax'}</span>
                    </td>
                    <td style="padding: 12px 15px; border-right: 1px solid #dee2e6; vertical-align: top;">
                        ${restrictionsHtml}
                    </td>
                    <td style="padding: 12px 15px; text-align: center; vertical-align: top;">
                        <div style="
                            display: inline-flex; 
                            align-items: center; 
                            justify-content: center; 
                            width: 20px; 
                            height: 20px; 
                            border-radius: 50%; 
                            font-size: 12px; 
                            font-weight: bold;
                            ${item.active ? 'background: #28a745; color: white;' : 'background: #6c757d; color: white;'}
                        ">
                            ${item.active ? '‚úì' : '√ó'}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        function openLocationSurchargeModal(editIndex = -1) {
            const modal = document.getElementById('locationSurchargeModal');
            if (!modal) {
                console.error('‚ùå locationSurchargeModal element not found!');
                alert('Error: Modal not found. Please refresh the page.');
                return;
            }
            currentEditingIndex = editIndex;
            
            // Reset form with null checks
            const priceEl = document.getElementById('locationSurchargePrice');
            const nameEl = document.getElementById('locationSurchargeName');
            const overrideTaxEl = document.getElementById('overrideTaxRate');
            const addToJourneyEl = document.getElementById('addToJourneyPrice');
            const displaySummaryEl = document.getElementById('displayInSummary');
            const limitLocationEl = document.getElementById('limitToLocation');
            const locationDirEl = document.getElementById('locationDirection');
            const limitVehicleEl = document.getElementById('limitToVehicleType');
            const limitEventEl = document.getElementById('limitToEvent');
            const activeEl = document.getElementById('locationSurchargeActive');
            
            if (priceEl) priceEl.value = '';
            if (nameEl) nameEl.value = '';
            if (overrideTaxEl) overrideTaxEl.checked = false;
            if (addToJourneyEl) addToJourneyEl.checked = true;
            if (displaySummaryEl) displaySummaryEl.checked = true;
            if (limitLocationEl) limitLocationEl.checked = false;
            if (locationDirEl) locationDirEl.value = 'any';
            
            // Clear address list
            const addressList = document.getElementById('addressPostcodeList');
            if (addressList) addressList.innerHTML = '';
            
            if (limitVehicleEl) limitVehicleEl.checked = false;
            if (limitEventEl) limitEventEl.checked = false;
            if (activeEl) activeEl.checked = true;
            
            // Hide location limits by default
            const limitsContainer = document.getElementById('locationLimitsContainer');
            if (limitsContainer) limitsContainer.style.display = 'none';
            
            // If editing, populate form
            if (editIndex >= 0 && locationSurcharges[editIndex]) {
                const item = locationSurcharges[editIndex];
                if (priceEl) priceEl.value = item.price;
                if (nameEl) nameEl.value = item.name;
                if (overrideTaxEl) overrideTaxEl.checked = item.overrideTaxRate || false;
                if (addToJourneyEl) addToJourneyEl.checked = item.addToJourneyPrice !== false;
                if (displaySummaryEl) displaySummaryEl.checked = item.displayInSummary !== false;
                if (limitLocationEl) limitLocationEl.checked = item.limitToLocation || false;
                if (locationDirEl) locationDirEl.value = item.locationDirection || 'any';
                if (limitVehicleEl) limitVehicleEl.checked = item.limitToVehicleType || false;
                if (limitEventEl) limitEventEl.checked = item.limitToEvent || false;
                if (activeEl) activeEl.checked = item.active !== false;
                
                // Show location limits if applicable
                if (item.limitToLocation && limitsContainer) {
                    limitsContainer.style.display = 'block';
                    // Populate addresses
                    if (item.addresses) {
                        populateLocationAddresses(item.addresses);
                    }
                }
            }
            
            // Show modal
            modal.style.display = 'block';
        }

        function closeLocationSurchargeModal() {
            document.getElementById('locationSurchargeModal').style.display = 'none';
            currentEditingIndex = -1;
        }

        function toggleLocationLimits() {
            const checkbox = document.getElementById('limitToLocation');
            const container = document.getElementById('locationLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleVehicleTypeLimits() {
            const checkbox = document.getElementById('limitToVehicleType');
            const container = document.getElementById('vehicleTypeLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleEventLimits() {
            const checkbox = document.getElementById('limitToEvent');
            const container = document.getElementById('eventLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleDateTimeLimits() {
            const checkbox = document.getElementById('limitToDateTime');
            const container = document.getElementById('dateTimeLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function togglePassengerLimits() {
            const checkbox = document.getElementById('limitToPassengers');
            const container = document.getElementById('passengerLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function toggleDistanceLimits() {
            const checkbox = document.getElementById('limitToDistance');
            const container = document.getElementById('distanceLimitsContainer');
            container.style.display = checkbox.checked ? 'block' : 'none';
        }

        function addNewLocationAddress() {
            const container = document.getElementById('addressPostcodeList');
            if (!container) return;
            
            addressCounter++;
            const addressId = `address_${addressCounter}`;
            
            const addressDiv = document.createElement('div');
            addressDiv.id = addressId;
            addressDiv.style.cssText = 'margin-bottom: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white; position: relative;';
            
            addressDiv.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                    <span style="background: #f1f1f1; border: 1px solid #ddd; padding: 8px; border-radius: 4px 0 0 0; font-size: 14px; width: 30px; text-align: center;">üìç</span>
                    <input type="text" placeholder="Address (e.g., Schiphol Airport)" style="
                        flex: 1;
                        padding: 8px; 
                        border: 1px solid #ddd; 
                        border-left: none;
                        border-radius: 0;
                        font-size: 14px;
                        outline: none;
                    " data-field="address">
                    <button onclick="removeLocationAddress('${addressId}')" style="
                        background: #dc3545;
                        color: white;
                        border: none;
                        padding: 8px 10px;
                        border-radius: 4px;
                        cursor: pointer;
                        font-size: 12px;
                    " title="Remove">üóëÔ∏è</button>
                </div>
                <input type="text" placeholder="Postcode (e.g., 1118, 5657, 2100)" style="
                    width: 100%; 
                    padding: 8px; 
                    border: 1px solid #ddd; 
                    border-top: none;
                    border-radius: 0 0 4px 4px;
                    font-size: 14px;
                    outline: none;
                    box-sizing: border-box;
                " data-field="postcode">
            `;
            
            container.appendChild(addressDiv);
        }

        function removeLocationAddress(addressId) {
            const element = document.getElementById(addressId);
            if (element) {
                element.remove();
            }
        }

        function getLocationAddresses() {
            const container = document.getElementById('addressPostcodeList');
            if (!container) return [];
            
            const addresses = [];
            const addressDivs = container.querySelectorAll('[id^="address_"]');
            
            addressDivs.forEach(div => {
                const addressInput = div.querySelector('input[data-field="address"]');
                const postcodeInput = div.querySelector('input[data-field="postcode"]');
                
                const address = addressInput ? addressInput.value.trim() : '';
                const postcode = postcodeInput ? postcodeInput.value.trim() : '';
                
                if (address || postcode) {
                    addresses.push({ address, postcode });
                }
            });
            
            return addresses;
        }

        function populateLocationAddresses(addresses) {
            const container = document.getElementById('addressPostcodeList');
            if (!container) return;
            
            // Clear existing addresses
            container.innerHTML = '';
            addressCounter = 0;
            
            // Add existing addresses
            if (addresses && addresses.length > 0) {
                addresses.forEach(addr => {
                    addNewLocationAddress();
                    const lastDiv = container.lastElementChild;
                    if (lastDiv) {
                        const addressInput = lastDiv.querySelector('input[data-field="address"]');
                        const postcodeInput = lastDiv.querySelector('input[data-field="postcode"]');
                        
                        if (addressInput) addressInput.value = addr.address || '';
                        if (postcodeInput) postcodeInput.value = addr.postcode || '';
                    }
                });
            } else {
                // Add one empty address by default when modal opens
                addNewLocationAddress();
            }
        }

        function saveLocationSurcharge() {
            const price = parseFloat(document.getElementById('locationSurchargePrice').value) || 0;
            const name = document.getElementById('locationSurchargeName').value.trim();
            
            if (!name) {
                alert('‚ö†Ô∏è Please enter a charge name');
                return;
            }
            
            if (price <= 0) {
                alert('‚ö†Ô∏è Please enter a valid price');
                return;
            }
            
            const surchargeData = {
                id: currentEditingIndex >= 0 && locationSurcharges[currentEditingIndex] ? locationSurcharges[currentEditingIndex].id : 'location-' + Date.now(),
                name: name,
                price: price,
                overrideTaxRate: document.getElementById('overrideTaxRate').checked,
                addToJourneyPrice: document.getElementById('addToJourneyPrice').checked,
                displayInSummary: document.getElementById('displayInSummary').checked,
                limitToLocation: document.getElementById('limitToLocation').checked,
                locationDirection: document.getElementById('locationDirection').value,
                limitToVehicleType: document.getElementById('limitToVehicleType').checked,
                limitToEvent: document.getElementById('limitToEvent').checked,
                active: document.getElementById('locationSurchargeActive').checked,
                addresses: []
            };
            
            // Add address data if location limit is enabled
            if (surchargeData.limitToLocation) {
                surchargeData.addresses = getLocationAddresses();
            }
            
            if (currentEditingIndex >= 0) {
                locationSurcharges[currentEditingIndex] = surchargeData;
            } else {
                locationSurcharges.push(surchargeData);
            }
            
            // Save to localStorage
            localStorage.setItem('locationSurcharges', JSON.stringify(locationSurcharges));
            localStorage.setItem('locationSurchargesUpdateTime', Date.now().toString());
            
            // Close modal and refresh list
            closeLocationSurchargeModal();
            renderLocationSurchargesList();
            
            // Show success message
            showSuccessMessage('Location surcharge saved successfully!');
            
            // Sync to booking system
            syncLocationSurchargesToBookingSystem();
        }

        function editLocationSurcharge(index) {
            openLocationSurchargeModal(index);
        }

        function duplicateLocationSurcharge(index) {
            if (locationSurcharges[index]) {
                const original = locationSurcharges[index];
                const duplicate = {
                    ...original,
                    id: 'location-copy-' + Date.now(),
                    name: original.name + ' (Copy)'
                };
                locationSurcharges.push(duplicate);
                localStorage.setItem('locationSurcharges', JSON.stringify(locationSurcharges));
                renderLocationSurchargesList();
                showSuccessMessage('Location surcharge duplicated successfully!');
            }
        }

        function deleteLocationSurcharge(index) {
            if (confirm('Are you sure you want to delete this location surcharge?')) {
                locationSurcharges.splice(index, 1);
                localStorage.setItem('locationSurcharges', JSON.stringify(locationSurcharges));
                renderLocationSurchargesList();
                showSuccessMessage('Location surcharge deleted successfully!');
            }
        }

        function showSuccessMessage(message) {
            // Simple success notification (can be enhanced)
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed; 
                top: 20px; 
                right: 20px; 
                background: #28a745; 
                color: white; 
                padding: 15px 20px; 
                border-radius: 6px; 
                box-shadow: 0 4px 12px rgba(0,0,0,0.2); 
                z-index: 10001;
                font-size: 14px;
                font-weight: 600;
            `;
            notification.textContent = '‚úÖ ' + message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function syncLocationSurchargesToBookingSystem() {
            // Professional sync function to integrate with booking system
            // This could include API calls to update the booking system
            // For now, we update localStorage for the booking system to read
            const bookingSystemData = locationSurcharges
                .filter(item => item.active && item.addToJourneyPrice)
                .map(item => ({
                    ...item,
                    locationDirection: item.locationDirection || 'any'
                }));
            localStorage.setItem('bookingSystemLocationSurcharges', JSON.stringify(bookingSystemData));
        }

        // ============================================================
        // DISPATCH TABLE FUNCTIONS
        // ============================================================
        
        // Load and display dispatch table data
        function loadDispatchTable() {
            console.log('üìã Loading dispatch table...');
            const tableBody = document.getElementById('dispatchTableBody');
            if (!tableBody) return;
            
            // Get all bookings from different localStorage keys
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            const unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            const completedBookings = JSON.parse(localStorage.getItem('completedBookings') || '[]');
            
            // Combine all bookings for dispatch view
            const allBookings = [
                ...confirmedBookings.map(b => ({...b, status: 'confirmed'})),
                ...unconfirmedBookings.map(b => ({...b, status: 'unquoted'})),
                ...completedBookings.map(b => ({...b, status: 'completed'}))
            ];
            
            // Sort by date/time
            allBookings.sort((a, b) => {
                const dateA = new Date(`${a.trip.travelDate.split('/').reverse().join('-')}T${a.trip.travelHour}:${a.trip.travelMinute}`);
                const dateB = new Date(`${b.trip.travelDate.split('/').reverse().join('-')}T${b.trip.travelHour}:${b.trip.travelMinute}`);
                return dateA - dateB;
            });
            
            if (allBookings.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">
                            No active bookings found
                        </td>
                    </tr>
                `;
                document.getElementById('dispatchTableInfo').textContent = 'Showing 0 entries';
                return;
            }
            
            let tableHTML = '';
            allBookings.forEach((booking, index) => {
                const dateTime = `${booking.trip.travelDate} ${booking.trip.travelHour}:${booking.trip.travelMinute}`;
                const vehicleName = booking.vehicle?.vehicle?.name || booking.selectedVehicle || 'Saloon';
                const totalPrice = getCorrectTripPrice(booking);
                const driverName = booking.driver || 'Unassigned';
                
                // Status styling
                let statusStyle = '';
                let statusText = '';
                switch(booking.status) {
                    case 'unquoted':
                        statusStyle = 'background: #ffc107; color: #000; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;';
                        statusText = 'Unquoted';
                        break;
                    case 'confirmed':
                        statusStyle = 'background: #007bff; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;';
                        statusText = 'Confirmed';
                        break;
                    case 'completed':
                        statusStyle = 'background: #28a745; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 500;';
                        statusText = 'Completed';
                        break;
                }
                
                tableHTML += `
                    <tr style="border-bottom: 1px solid #f1f3f4; cursor: pointer;" onclick="selectDispatchBooking('${booking.bookingId}')">
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4;">
                            <div style="display: flex; gap: 4px;">
                                <button onclick="event.stopPropagation(); viewDispatchBooking('${booking.bookingId}')" 
                                        style="background: #007bff; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                                    üëÅ View
                                </button>
                                <button onclick="event.stopPropagation(); assignDispatchDriver('${booking.bookingId}')" 
                                        style="background: #28a745; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; cursor: pointer;">
                                    üöñ Assign
                                </button>
                            </div>
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4; font-size: 13px;">
                            <div style="font-weight: 500;">${dateTime.split(' ')[0]}</div>
                            <div style="color: #6c757d; font-size: 12px;">${dateTime.split(' ')[1]}</div>
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4; font-size: 13px; font-weight: 500;">
                            ${booking.bookingId}
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4;">
                            <span style="${statusStyle}">${statusText}</span>
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4; font-size: 13px;">
                            <div style="font-weight: 500;">${driverName}</div>
                            ${driverName === 'Unassigned' ? '<div style="color: #dc3545; font-size: 11px;">Not assigned</div>' : '<div style="color: #28a745; font-size: 11px;">Assigned</div>'}
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4; font-size: 13px;">
                            ${booking.trip?.passengers || 1}
                        </td>
                        <td style="padding: 12px 8px; border-right: 1px solid #f1f3f4; font-size: 13px;">
                            <div style="font-weight: 500;">${vehicleName}</div>
                        </td>
                        <td style="padding: 12px 8px; font-size: 13px; font-weight: 600; color: #28a745;">
                            ‚Ç¨${parseFloat(totalPrice).toFixed(2)}
                        </td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = tableHTML;
            document.getElementById('dispatchTableInfo').textContent = `Showing ${allBookings.length} entries`;
        }
        
        // Refresh dispatch table
        function refreshDispatchTable() {
            loadDispatchTable();
            showNotification('Dispatch table refreshed', 'success');
        }
        
        // Filter dispatch bookings by status
        function filterDispatchBookings() {
            const filter = document.getElementById('dispatchStatusFilter').value;
            const rows = document.querySelectorAll('#dispatchTable tbody tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return; // Skip empty state row
                
                const statusCell = row.cells[3];
                const statusText = statusCell.textContent.toLowerCase().trim();
                
                if (filter === '' || statusText.includes(filter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Search dispatch bookings
        function searchDispatchBookings() {
            const searchTerm = document.getElementById('dispatchSearch').value.toLowerCase();
            const rows = document.querySelectorAll('#dispatchTable tbody tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return; // Skip empty state row
                
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        // Select dispatch booking (highlight row)
        function selectDispatchBooking(bookingId) {
            // Remove previous selection
            document.querySelectorAll('#dispatchTable tbody tr').forEach(row => {
                row.style.backgroundColor = '';
            });
            
            // Highlight selected row
            event.target.closest('tr').style.backgroundColor = '#e3f2fd';
            console.log('Selected booking:', bookingId);
        }
        
        // View dispatch booking details
        function viewDispatchBooking(bookingId) {
            console.log('Viewing booking:', bookingId);
            // You can implement a modal or redirect to booking details
            showNotification(`Viewing booking ${bookingId}`, 'info');
        }
        
        // Assign driver to dispatch booking
        function assignDispatchDriver(bookingId) {
            console.log('Assigning driver to booking:', bookingId);
            // Open driver assignment modal or dropdown
            const drivers = JSON.parse(localStorage.getItem('taxiDrivers') || '[]');
            if (drivers.length === 0) {
                showNotification('No drivers available. Please add drivers first.', 'warning');
                return;
            }
            
            // Simple prompt for now - can be enhanced with a proper modal
            const driverNames = drivers.map(d => `${d.firstName} ${d.lastName}`);
            const selectedDriver = prompt('Select driver:\n' + driverNames.map((name, i) => `${i + 1}. ${name}`).join('\n'));
            
            if (selectedDriver && !isNaN(selectedDriver)) {
                const driverIndex = parseInt(selectedDriver) - 1;
                if (driverIndex >= 0 && driverIndex < drivers.length) {
                    assignDriverToBooking(bookingId, `${drivers[driverIndex].firstName} ${drivers[driverIndex].lastName}`);
                    loadDispatchTable(); // Refresh table
                    showNotification(`Driver assigned to booking ${bookingId}`, 'success');
                }
            }
        }
        
        // Initialize dispatch table when page loads
        function initDispatchTable() {
            loadDispatchTable();
        }
        
        // Auto-refresh dispatch table every 30 seconds
        setInterval(() => {
            if (document.getElementById('dispatch-section').classList.contains('active')) {
                loadDispatchTable();
            }
        }, 30000);
        
        // ============================================================
        // DISPATCH FORM FUNCTIONS
        // ============================================================
        
        function addDispatchStop() {
            showNotification('Extra stop functionality coming soon', 'info');
        }
        
        function swapLocations() {
            const fromInput = document.getElementById('dispatchFromLocation');
            const toInput = document.getElementById('dispatchToLocation');
            
            const temp = fromInput.value;
            fromInput.value = toInput.value;
            toInput.value = temp;
            
            showNotification('Locations swapped', 'success');
        }
        
        function addDispatchItem() {
            showNotification('Add item functionality coming soon', 'info');
        }
        
        function getDispatchQuote() {
            const fromLocation = document.getElementById('dispatchFromLocation').value;
            const toLocation = document.getElementById('dispatchToLocation').value;
            
            if (!fromLocation || !toLocation) {
                showNotification('Please enter pickup and destination locations', 'warning');
                return;
            }
            
            // Simulate quote calculation with admin pricing
            const vehiclePricing = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
            const basePrice = vehiclePricing.minimumPrice || 25;
            const perKmPrice = vehiclePricing.pricePerKm || 2.5;
            const perMinutePrice = vehiclePricing.pricePerMinute || 0.5;
            
            // Estimate distance and time (would normally use maps API)
            const estimatedKm = Math.floor(Math.random() * 20) + 5;
            const estimatedMinutes = Math.floor(estimatedKm * 2.5);
            
            const total = basePrice + (estimatedKm * perKmPrice) + (estimatedMinutes * perMinutePrice);
            
            // Update the total price display
            document.getElementById('totalPrice').textContent = total.toFixed(2);
            
            // Update distance/time display
            const distanceDisplay = document.querySelector('div:has(> strong)');
            if (distanceDisplay) {
                distanceDisplay.innerHTML = `Pickup to Dropoff: <strong>${estimatedKm} km, ${estimatedMinutes.toFixed(2)} minutes</strong>`;
            }
            
            showNotification(`Quote calculated: ‚Ç¨${total.toFixed(2)} (${estimatedKm}km, ${estimatedMinutes}min)`, 'success');
        }
        
        function openNoteModal(noteType) {
            const noteTypes = {
                'driver': 'Note for Driver',
                'admin': 'Admin Note', 
                'customer': 'Customer Requirements'
            };
            
            const note = prompt(`Enter ${noteTypes[noteType]}:`);
            if (note) {
                showNotification(`${noteTypes[noteType]} saved: "${note}"`, 'success');
            }
        }
        
        function toggleAdvanced() {
            const section = document.getElementById('advanceSection');
            const arrow = document.getElementById('advanceArrow');
            
            if (section.style.display === 'none' || section.style.display === '') {
                section.style.display = 'block';
                arrow.textContent = '‚ñº';
            } else {
                section.style.display = 'none';
                arrow.textContent = '‚ñ≤';
            }
        }
        
        function saveDispatchBooking() {
            const fromLocation = document.getElementById('dispatchFromLocation').value;
            const toLocation = document.getElementById('dispatchToLocation').value;
            const totalPrice = document.getElementById('totalPrice').textContent;
            
            if (!fromLocation || !toLocation) {
                showNotification('Please enter pickup and destination locations', 'warning');
                return;
            }
            
            // Create professional booking with all form data
            const newBooking = {
                bookingId: 'BK' + Date.now(),
                trip: {
                    fromLocation: fromLocation,
                    toLocation: toLocation,
                    travelDate: new Date().toLocaleDateString('en-GB'),
                    travelHour: new Date().getHours().toString().padStart(2, '0'),
                    travelMinute: new Date().getMinutes().toString().padStart(2, '0'),
                    passengers: document.querySelector('#dispatchPassengers select')?.value || '1',
                    tripType: 'dispatch'
                },
                customer: {
                    firstName: 'Dispatch',
                    lastName: 'Customer',
                    phone: '+32123456789',
                    email: 'dispatch@example.com'
                },
                vehicle: {
                    vehicle: { 
                        name: document.querySelector('select option:checked')?.textContent?.replace('üöó ', '').replace('üöô ', '').replace('üöê ', '').replace('üöå ', '') || 'Saloon' 
                    }
                },
                driver: null,
                totalPrice: totalPrice,
                paymentStatus: document.getElementById('paidCheckbox').checked ? 'paid' : 'unpaid',
                createdAt: new Date().toISOString(),
                source: 'dispatch'
            };
            
            // Add to confirmed bookings
            const confirmedBookings = JSON.parse(localStorage.getItem('confirmedBookings') || '[]');
            confirmedBookings.push(newBooking);
            localStorage.setItem('confirmedBookings', JSON.stringify(confirmedBookings));
            
            showNotification(`Professional booking created: ${newBooking.bookingId}`, 'success');
            
            // Clear form
            clearDispatchForm();
            
            // Refresh dispatch table
            if (typeof loadDispatchTable === 'function') {
                loadDispatchTable();
            }
        }
        
        function clearDispatchForm() {
            document.getElementById('dispatchFromLocation').value = '';
            document.getElementById('dispatchToLocation').value = '';
            document.getElementById('totalPrice').textContent = '0.00';
            document.getElementById('paidCheckbox').checked = false;
            
            // Reset passenger counters
            const selects = document.querySelectorAll('select');
            selects.forEach(select => {
                if (select.options[0]) select.selectedIndex = 0;
            });
        }
        
        // Integration with Step 2 booking system - use admin pricing like step2.html
        function connectToStep2System() {
            // Load admin vehicle pricing for accurate quotes
            const vehiclePricing = JSON.parse(localStorage.getItem('vehiclePricing') || '{}');
            const taxiVehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            
            console.log('üîó Dispatch connected to Step 2 pricing system');
            console.log('Available vehicles:', taxiVehicles);
            console.log('Pricing config:', vehiclePricing);
            
            return { vehiclePricing, taxiVehicles };
        }
        
        function findDriver() {
            showNotification('Finding nearby drivers...', 'info');
            
            setTimeout(() => {
                showNotification('Found 3 drivers within 2km', 'success');
            }, 2000);
        }
        
        // Load vehicles from Vehicle Manager into dispatch form
        function loadDispatchVehicles() {
            const vehicleSelect = document.getElementById('dispatchVehicleSelect');
            if (!vehicleSelect) {
                console.error('‚ùå Vehicle select element not found!');
                return;
            }
            
            console.log('üöó Loading vehicles into dispatch form...');
            
            // Get vehicles from admin Vehicle Manager
            let taxiVehicles = JSON.parse(localStorage.getItem('taxiVehicles') || '[]');
            
            // Debug: log what we found
            console.log('üîç Vehicle Manager localStorage data:', taxiVehicles);
            console.log('üîç Vehicle Manager length:', taxiVehicles.length);
            
            // Always add default vehicles for testing
            const defaultVehicles = [
                { id: 'saloon', name: 'Saloon', passengers: 4 },
                { id: 'estate', name: 'Estate', passengers: 4 },
                { id: 'minivan', name: 'Minivan', passengers: 6 },
                { id: 'minibus', name: 'Minibus', passengers: 8 }
            ];
            
            // If no vehicles found, use defaults
            if (taxiVehicles.length === 0) {
                console.log('‚ö†Ô∏è No vehicles found, using default vehicles');
                taxiVehicles = defaultVehicles;
                // Save default vehicles to localStorage
                localStorage.setItem('taxiVehicles', JSON.stringify(defaultVehicles));
            }
            
            // Clear existing options
            vehicleSelect.innerHTML = '';
            
            // Add Unassigned option first
            const unassignedOption = document.createElement('option');
            unassignedOption.value = '';
            unassignedOption.textContent = 'üöó Unassigned';
            vehicleSelect.appendChild(unassignedOption);
            
            // Add vehicles to dropdown
            taxiVehicles.forEach(vehicle => {
                const option = document.createElement('option');
                option.value = vehicle.id;
                option.textContent = `üöó ${vehicle.name} (${vehicle.passengers} seats)`;
                vehicleSelect.appendChild(option);
                console.log(`‚ûï Added vehicle: ${vehicle.name}`);
            });
            
            console.log(`‚úÖ Successfully loaded ${taxiVehicles.length} vehicles into dispatch form`);
            console.log(`‚úÖ Total options in dropdown: ${vehicleSelect.options.length}`);
        }

        // Manual test function for vehicles (call in console)
        function testVehicleLoading() {
            console.log('üîß Manual vehicle loading test...');
            loadDispatchVehicles();
        }

        // Initialize dispatch map and connect to Step 2 system
        function initDispatchMap() {
            const mapElement = document.getElementById('dispatchMap');
            if (mapElement) {
                // Connect to Step 2 pricing system
                connectToStep2System();
                
                // Load vehicles from Vehicle Manager
                setTimeout(() => {
                    loadDispatchVehicles();
                }, 500);
                
                // Initialize map with Brussels location
                mapElement.innerHTML = `
                    <div style="width: 100%; height: 100%; background: linear-gradient(45deg, #e8f5e8 25%, transparent 25%), 
                                linear-gradient(-45deg, #e8f5e8 25%, transparent 25%), 
                                linear-gradient(45deg, transparent 75%, #e8f5e8 75%), 
                                linear-gradient(-45deg, transparent 75%, #e8f5e8 75%);
                         background-size: 20px 20px;
                         background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
                         position: relative;
                         overflow: hidden;">
                        
                        <!-- Fake map markers -->
                        <div style="position: absolute; top: 30%; left: 40%; width: 20px; height: 20px; background: #ff4757; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                        <div style="position: absolute; top: 50%; left: 60%; width: 20px; height: 20px; background: #2ed573; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                        <div style="position: absolute; top: 70%; left: 30%; width: 20px; height: 20px; background: #3742fa; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.3);"></div>
                        
                        <!-- Map center marker -->
                        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 30px; height: 30px; background: #ffa502; border-radius: 50%; border: 4px solid white; box-shadow: 0 4px 10px rgba(0,0,0,0.4); z-index: 100;">
                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-weight: bold; font-size: 10px;">üìç</div>
                        </div>
                        
                        <!-- Brussels text -->
                        <div style="position: absolute; bottom: 20px; left: 20px; background: rgba(255,255,255,0.9); padding: 8px 12px; border-radius: 6px; font-weight: 600; color: #2c3e50; font-size: 14px; box-shadow: 0 2px 8px rgba(0,0,0,0.2);">
                            üìç Brussels Center
                        </div>
                    </div>
                `;
            }
        }

        // Expose Professional Location Surcharge functions globally
        window.loadLocationSurcharges = loadLocationSurcharges;
        window.renderLocationSurchargesList = renderLocationSurchargesList;
        window.openLocationSurchargeModal = openLocationSurchargeModal;
        window.closeLocationSurchargeModal = closeLocationSurchargeModal;
        window.toggleLocationLimits = toggleLocationLimits;
        window.addNewLocationAddress = addNewLocationAddress;
        window.removeLocationAddress = removeLocationAddress;
        window.toggleVehicleTypeLimits = toggleVehicleTypeLimits;
        window.toggleEventLimits = toggleEventLimits;
        window.toggleDateTimeLimits = toggleDateTimeLimits;
        window.togglePassengerLimits = togglePassengerLimits;
        window.toggleDistanceLimits = toggleDistanceLimits;
        window.saveLocationSurcharge = saveLocationSurcharge;
        window.editLocationSurcharge = editLocationSurcharge;
        window.duplicateLocationSurcharge = duplicateLocationSurcharge;
        window.deleteLocationSurcharge = deleteLocationSurcharge;
    </script>

    <!-- Location Surcharge Modal -->
    <div id="locationSurchargeModal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 10000; overflow-y: auto; padding: 20px; box-sizing: border-box;">
        <div class="modal-content" style="max-width: 500px; max-height: 80vh; margin: 20px auto; background: white; border-radius: 12px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); overflow-y: auto; display: flex; flex-direction: column;">
            <!-- Modal Header -->
            <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 20px; text-align: center; position: relative;">
                <h2 style="margin: 0; font-size: 20px; font-weight: 600;">Add Location Surcharge</h2>
                <button onclick="document.getElementById('locationSurchargeModal').style.display='none';" style="position: absolute; top: 15px; right: 20px; background: none; border: none; color: white; font-size: 24px; cursor: pointer; opacity: 0.8; transition: opacity 0.2s;">&times;</button>
            </div>

            <!-- Modal Body -->
            <div style="padding: 20px; flex: 1; overflow-y: auto;">
                <!-- Price Section -->
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span style="background: #f1f1f1; border: 1px solid #ddd; padding: 12px; border-radius: 6px 0 0 6px; font-weight: 600; color: #666;">‚Ç¨</span>
                        <input type="number" id="locationSurchargePrice" step="0.01" placeholder="0,00" style="
                            width: 120px; 
                            padding: 12px; 
                            border: 1px solid #ddd; 
                            border-left: none;
                            border-radius: 0 6px 6px 0;
                            font-size: 16px;
                            outline: none;
                        ">
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666;">
                            <input type="checkbox" id="overrideTaxRate" style="transform: scale(1.0);">
                            Override the default tax rate
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666;">
                            <input type="checkbox" id="addToJourneyPrice" style="transform: scale(1.0);" checked>
                            Add this charge to Journey Price in step 2 of Web Booking
                        </label>
                    </div>
                    
                    <div style="margin-bottom: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #666;">
                            <input type="checkbox" id="displayInSummary" style="transform: scale(1.0);" checked>
                            Display charge name in summary
                        </label>
                    </div>
                </div>

                <!-- Charge Name -->
                <div style="margin-bottom: 25px;">
                    <input type="text" id="locationSurchargeName" placeholder="Parking" style="
                        width: 100%; 
                        padding: 12px; 
                        border: 1px solid #ddd; 
                        border-radius: 6px; 
                        font-size: 16px;
                        outline: none;
                        box-sizing: border-box;
                    ">
                </div>

                <!-- Location Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToLocation" style="transform: scale(1.1);" onchange="
                            const container = document.getElementById('locationLimitsContainer');
                            container.style.display = this.checked ? 'block' : 'none';
                            if (this.checked) {
                                // Add one address field when enabled
                                const addressList = document.getElementById('addressPostcodeList');
                                if (addressList && addressList.children.length === 0) {
                                    addressList.innerHTML = `
                                        <div style='margin-bottom: 10px; padding: 12px; border: 1px solid #ddd; border-radius: 6px; background: white;'>
                                            <div style='display: flex; align-items: center; gap: 8px; margin-bottom: 8px;'>
                                                <span style='background: #f1f1f1; border: 1px solid #ddd; padding: 8px; border-radius: 4px 0 0 0; font-size: 14px; width: 30px; text-align: center;'>üìç</span>
                                                <input type='text' placeholder='Address (e.g., Schiphol Airport)' style='flex: 1; padding: 8px; border: 1px solid #ddd; border-left: none; border-radius: 0; font-size: 14px; outline: none;'>
                                            </div>
                                            <input type='text' placeholder='Postcode (e.g., 1118, 5657, 2100)' style='width: 100%; padding: 8px; border: 1px solid #ddd; border-top: none; border-radius: 0 0 4px 4px; font-size: 14px; outline: none; box-sizing: border-box;'>
                                        </div>
                                    `;
                                }
                            }
                        ">
                        Limit to location
                    </label>

                    <div id="locationLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <!-- Direction Selection -->
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; margin-bottom: 8px;">
                                <span style="background: #f1f1f1; border: 1px solid #ddd; padding: 10px; border-radius: 6px 0 0 6px; font-size: 14px;">‚úàÔ∏è</span>
                                <select id="locationDirection" style="
                                    padding: 10px; 
                                    border: 1px solid #ddd; 
                                    border-left: none;
                                    border-radius: 0 6px 6px 0;
                                    font-size: 14px;
                                    outline: none;
                                    width: 120px;
                                ">
                                    <option value="any">Any</option>
                                    <option value="pickup">Pick up</option>
                                    <option value="dropoff">Drop off</option>
                                </select>
                            </div>
                        </div>

                        <!-- Multiple Address/Postcode Container -->
                        <div id="addressPostcodeList" style="margin-bottom: 15px;">
                            <!-- Address entries will be added here -->
                        </div>

                        <button onclick="addNewLocationAddress()" style="
                            background: #28a745;
                            color: white;
                            border: none;
                            padding: 8px 16px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 13px;
                            font-weight: 500;
                            width: 100%;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 6px;
                        ">‚ûï Add Address/Postcode</button>
                    </div>
                </div>

                <!-- Vehicle Type Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToVehicleType" style="transform: scale(1.1);" onchange="toggleVehicleTypeLimits()">
                        Limit to vehicle type
                    </label>
                    
                    <div id="vehicleTypeLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Select Vehicle Types:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="vehicleTypeSaloon" style="transform: scale(0.9);">
                                    Saloon
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="vehicleTypeEstate" style="transform: scale(0.9);">
                                    Estate
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="vehicleTypeMinivan" style="transform: scale(0.9);">
                                    Minivan
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="vehicleTypeMinivanLong" style="transform: scale(0.9);">
                                    Minivan Long
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Event Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToEvent" style="transform: scale(1.1);" onchange="toggleEventLimits()">
                        Limit to event
                    </label>
                    
                    <div id="eventLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="margin-bottom: 15px;">
                            <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Event Types:</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="eventTypeConference" style="transform: scale(0.9);">
                                    Conference
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="eventTypeWedding" style="transform: scale(0.9);">
                                    Wedding
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="eventTypeCorporate" style="transform: scale(0.9);">
                                    Corporate
                                </label>
                                <label style="display: flex; align-items: center; gap: 6px; font-size: 13px; color: #666;">
                                    <input type="checkbox" id="eventTypeAirport" style="transform: scale(0.9);">
                                    Airport Transfer
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date/Time Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToDateTime" style="transform: scale(1.1);" onchange="toggleDateTimeLimits()">
                        Limit to date/time
                    </label>
                    
                    <div id="dateTimeLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Start Date:</label>
                                <input type="date" id="startDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">End Date:</label>
                                <input type="date" id="endDate" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Start Time:</label>
                                <input type="time" id="startTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">End Time:</label>
                                <input type="time" id="endTime" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Passenger Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToPassengers" style="transform: scale(1.1);" onchange="togglePassengerLimits()">
                        Limit to passenger count
                    </label>
                    
                    <div id="passengerLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Min Passengers:</label>
                                <input type="number" id="minPassengers" min="1" max="8" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Max Passengers:</label>
                                <input type="number" id="maxPassengers" min="1" max="8" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Distance Limits -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; margin-bottom: 15px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="limitToDistance" style="transform: scale(1.1);" onchange="toggleDistanceLimits()">
                        Limit to distance
                    </label>
                    
                    <div id="distanceLimitsContainer" style="display: none; margin-left: 20px; padding: 15px; background: #f9f9f9; border-radius: 6px;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Min Distance (km):</label>
                                <input type="number" id="minDistance" min="0" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-size: 13px; font-weight: 500; color: #495057;">Max Distance (km):</label>
                                <input type="number" id="maxDistance" min="0" step="0.1" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Active Status -->
                <div style="margin-bottom: 25px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 14px; color: #666;">
                        <input type="checkbox" id="locationSurchargeActive" style="transform: scale(1.1);" checked>
                        Active
                    </label>
                </div>
            </div>

            <!-- Modal Footer -->
            <div style="padding: 15px 20px; background: #f8f9fa; display: flex; gap: 10px; flex-shrink: 0; border-top: 1px solid #dee2e6;">
                <button onclick="saveLocationSurcharge()" style="
                    background: #28a745; 
                    color: white; 
                    border: none; 
                    padding: 10px 20px; 
                    border-radius: 6px; 
                    cursor: pointer; 
                    font-size: 14px;
                    font-weight: 600;
                    flex: 1;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    gap: 8px;
                ">üíæ Save</button>
            </div>
        </div>
    </div>

    <script>
        // Vehicle Manager Functions for Admin Panel
        let adminVehicles = [
            {
                id: 'saloon',
                name: 'Saloon',
                description: 'Comfort sedan for daily use',
                capacity: 4,
                rate: 55,
                status: 'active'
            },
            {
                id: 'estate',
                name: 'Estate',
                description: 'Station wagon with extra space',
                capacity: 4,
                rate: 65,
                status: 'active'
            },
            {
                id: 'minivan',
                name: 'Minivan',
                description: 'Perfect voor grotere groepen',
                capacity: 7,
                rate: 85,
                status: 'active'
            },
            {
                id: 'minivan-long',
                name: 'Minivan Long',
                description: 'Extra lange versie',
                capacity: 8,
                rate: 95,
                status: 'active'
            }
        ];

        function loadAdminVehicles() {
            console.log('üîÑ Loading vehicles for admin panel');
            
            const saved = localStorage.getItem('taxiVehicles');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        adminVehicles = parsed;
                    }
                } catch (e) {
                    console.error('Error loading vehicles:', e);
                }
            }
            
            renderAdminVehicles();
            syncAdminVehiclesToStep2();
        }

        function renderAdminVehicles() {
            const grid = document.getElementById('adminVehiclesGrid');
            if (!grid) return;

            if (adminVehicles.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 60px; color: #7f8c8d;">
                        <div style="font-size: 64px; margin-bottom: 20px;">üöó</div>
                        <h3>No Vehicles Found</h3>
                        <p>Click "Add New Vehicle" to start building your fleet</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = adminVehicles.map(vehicle => `
                <div style="background: #f8f9fa; border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; transition: all 0.3s ease;">
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <div style="font-size: 32px; margin-right: 15px;">üöó</div>
                        <h3 style="font-size: 20px; font-weight: 600; color: #2c3e50; margin: 0;">${vehicle.name}</h3>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #34495e;">
                            <span>Description:</span>
                            <strong style="color: #2c3e50;">${vehicle.description}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #34495e;">
                            <span>Capacity:</span>
                            <strong style="color: #2c3e50;">${vehicle.capacity} passengers</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #34495e;">
                            <span>Hourly Rate:</span>
                            <strong style="color: #2c3e50;">‚Ç¨${vehicle.rate}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: #34495e;">
                            <span>Status:</span>
                            <span style="background: #d4edda; color: #155724; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase;">Active</span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="adminEditVehicle('${vehicle.id}')" style="background: #3498db; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">‚úèÔ∏è Edit</button>
                        <button onclick="adminDeleteVehicle('${vehicle.id}')" style="background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 600;">üóëÔ∏è Delete</button>
                    </div>
                </div>
            `).join('');

            console.log('‚úÖ Admin vehicles rendered:', adminVehicles.length);
        }

        function syncAdminVehiclesToStep2() {
            const step2Format = adminVehicles.map(vehicle => ({
                vehicle: {
                    id: vehicle.id,
                    name: vehicle.name,
                    passengers: vehicle.capacity,
                    description: vehicle.description
                },
                pricing: {
                    hourlyRate: vehicle.rate,
                    basePrice: vehicle.rate,
                    currency: 'EUR'
                },
                active: vehicle.status === 'active'
            }));
            
            localStorage.setItem('vehiclePricing', JSON.stringify({
                vehicles: step2Format,
                lastUpdated: new Date().toISOString()
            }));
            
            localStorage.setItem('taxiVehicles', JSON.stringify(adminVehicles));
            
            console.log('‚úÖ Vehicles synced to Step2 format');
            
            const status = document.getElementById('adminVehicleSync');
            if (status) {
                status.innerHTML = `‚úÖ Vehicle data synchronized with Step2 booking system (${new Date().toLocaleTimeString()})`;
            }
        }

        function adminAddVehicle() {
            alert('Add vehicle functionality - coming soon!');
        }

        function adminEditVehicle(id) {
            alert(`Edit vehicle ${id} - coming soon!`);
        }

        function adminDeleteVehicle(id) {
            if (!confirm('Are you sure you want to delete this vehicle?')) return;
            
            adminVehicles = adminVehicles.filter(v => v.id !== id);
            localStorage.setItem('taxiVehicles', JSON.stringify(adminVehicles));
            renderAdminVehicles();
            syncAdminVehiclesToStep2();
        }
    </script>

</body>
</html>
