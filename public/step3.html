<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marcel's Taxi - STAP 3: Klantgegevens</title>
    <meta name="version" content="simplified">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f0f2f5;
            color: #333;
            min-height: 100vh;
            margin: 0;
            padding: 20px 0;
        }

        .booking-container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            min-height: calc(100vh - 40px);
        }

        .step-header {
            text-align: center;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 25px 20px;
            position: relative;
        }

        .back-button {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .back-button:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-50%) translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .step-title {
            font-size: 22px;
            font-weight: 700;
            color: white;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .step-progress {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .progress-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progress-dot:hover {
            transform: scale(1.2);
        }

        .progress-dot.active {
            background: white;
        }

        .progress-dot.completed {
            background: #28a745;
        }

        /* FORM SECTIONS */
        .form-section {
            background: #fff;
            padding: 25px 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: #f8f9fa;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-input:valid {
            border-color: #28a745;
        }

        .form-textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        /* BOOKING SUMMARY */
        .booking-summary {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 2px solid #dee2e6;
            border-radius: 15px;
            padding: 20px;
            margin: 20px;
        }

        .summary-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .summary-row:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 18px;
            color: #667eea;
            margin-top: 10px;
            padding-top: 15px;
            border-top: 2px solid #dee2e6;
        }

        .summary-label {
            color: #6c757d;
            font-size: 14px;
        }

        .summary-value {
            color: #2c3e50;
            font-weight: 600;
        }

        /* ACTION BUTTONS */
        .action-buttons {
            text-align: center;
            padding: 30px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-top: 1px solid #dee2e6;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 20px 50px;
            border-radius: 50px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #667eea 100%);
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:disabled {
            background: linear-gradient(135deg, #6c757d 0%, #adb5bd 100%);
            cursor: not-allowed;
            transform: none;
            box-shadow: 0 4px 15px rgba(108, 117, 125, 0.2);
            opacity: 0.6;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 15px;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        /* PHONE INPUT WITH FLAG */
        .phone-input-container {
            position: relative;
            display: flex;
            align-items: center;
        }

        .phone-flag {
            position: absolute;
            left: 15px;
            font-size: 20px;
            z-index: 2;
            pointer-events: none;
        }

        .phone-input {
            padding-left: 50px !important;
        }

        /* PAYMENT METHODS */
        .payment-methods {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .payment-method {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 20px 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
        }

        .payment-method:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .payment-method.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .payment-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }

        .payment-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
        }

        /* BOOKING OVERVIEW MODAL */
        .booking-overview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 20px;
        }

        .booking-overview-content {
            background: white;
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }

        .booking-overview-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            border-radius: 20px 20px 0 0;
        }

        .booking-overview-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .booking-overview-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }

        .booking-overview-body {
            padding: 30px;
        }

        .overview-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .overview-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .overview-section-title {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .overview-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .overview-row:last-child {
            border-bottom: none;
        }

        .overview-label {
            font-size: 14px;
            color: #6c757d;
            font-weight: 500;
        }

        .overview-value {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
            text-align: right;
        }

        .overview-total {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .overview-total-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
            color: #667eea;
        }

        .booking-overview-actions {
            padding: 20px 30px;
            background: #f8f9fa;
            border-radius: 0 0 20px 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn-overview-confirm {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.3);
        }

        .btn-overview-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(40, 167, 69, 0.4);
        }

        .btn-overview-cancel {
            background: #6c757d;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-overview-cancel:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .surcharge-item-overview {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f8f9fa;
        }

        .surcharge-item-overview:last-child {
            border-bottom: none;
        }

        .surcharge-details {
            display: flex;
            flex-direction: column;
        }

        .surcharge-name {
            font-size: 14px;
            color: #2c3e50;
            font-weight: 600;
        }

        .surcharge-quantity {
            font-size: 12px;
            color: #6c757d;
        }

        .surcharge-price {
            font-size: 14px;
            color: #667eea;
            font-weight: 600;
        }

    </style>
</head>
<body>
    <div class="booking-container">
        <button class="back-button" onclick="goBack()">‚Üê Terug naar STAP 2</button>
        
        <div class="step-header">
            <h1 class="step-title">STAP 3: Klantgegevens</h1>
            <div class="step-progress">
                <div class="progress-dot completed" onclick="goToStep(1)" title="Ga naar STAP 1"></div>
                <div class="progress-dot completed" onclick="goToStep(2)" title="Ga naar STAP 2"></div>
                <div class="progress-dot active"></div>
            </div>
        </div>

        <!-- PERSOONLIJKE GEGEVENS -->
        <div class="form-section">
            <h2 class="section-title">Persoonlijke gegevens</h2>
            <div class="form-row">
                <div class="form-group">
                    <input type="text" class="form-input" id="firstName" required placeholder="Voornaam">
                </div>
                <div class="form-group">
                    <input type="text" class="form-input" id="lastName" required placeholder="Achternaam">
                </div>
                <div class="form-group">
                    <input type="email" class="form-input" id="email" required placeholder="uw@email.com">
                </div>
                <div class="form-group">
                    <div class="phone-input-container">
                        <span class="phone-flag" id="phoneFlag">üáßüá™</span>
                        <input type="tel" class="form-input phone-input" id="phone" required placeholder="+32 xxx xx xx xx">
                    </div>
                </div>
            </div>
        </div>

        <!-- EXTRA REIS GEGEVENS -->
        <div class="form-section">
            <h2 class="section-title">Extra reisgegevens</h2>
            <div class="form-row">
                <div class="form-group" id="flightNumberGroup" style="display: none;">
                    <input type="text" class="form-input" id="flightNumber" placeholder="Vluchtnummer (bijv. SN2713)">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group" style="width: 100%;">
                    <textarea class="form-input" id="specialRequests" rows="3" placeholder="Bijzondere verzoeken of opmerkingen (optioneel)"></textarea>
                </div>
            </div>
        </div>

        <!-- PAYMENT METHOD -->
        <div class="form-section">
            <h2 class="section-title">Payment method</h2>
            <div class="payment-methods">
                <div class="payment-method" onclick="selectPayment('cash')">
                    <div class="payment-icon">üíµ</div>
                    <div class="payment-name">Cash</div>
                </div>
                <div class="payment-method" onclick="selectPayment('card')">
                    <div class="payment-icon">üí≥</div>
                    <div class="payment-name">Credit card</div>
                </div>
                <div class="payment-method" onclick="selectPayment('paypal')">
                    <div class="payment-icon">üÖøÔ∏è</div>
                    <div class="payment-name">PayPal</div>
                </div>
            </div>
        </div>


        <!-- ACTION BUTTONS -->
        <div class="action-buttons">
            <button class="btn-secondary" onclick="goToStep1()">‚Üê STAP 1</button>
            <button class="btn-primary" id="completeBookingBtn" onclick="showBookingOverview()">
                Boeking Bevestigen
            </button>
        </div>
    </div>

    <!-- BOOKING OVERVIEW MODAL -->
    <div class="booking-overview-modal" id="bookingOverviewModal">
        <div class="booking-overview-content">
            <div class="booking-overview-header">
                <div class="booking-overview-title">Bestellings Overzicht</div>
                <div class="booking-overview-subtitle">Controleer uw gegevens voordat u bevestigt</div>
            </div>
            
            <div class="booking-overview-body" id="bookingOverviewBody">
                <!-- Content will be populated by JavaScript -->
            </div>
            
            <div class="booking-overview-actions">
                <button class="btn-overview-cancel" onclick="closeBookingOverview()">
                    Wijzigen
                </button>
                <button class="btn-overview-confirm" onclick="confirmFinalBooking()">
                    ‚úÖ Definitief Bevestigen
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global functions must be declared first
        function selectPayment(method) {
            // Remove selected class from all payment methods
            document.querySelectorAll('.payment-method').forEach(pm => {
                pm.classList.remove('selected');
            });
            
            // Add selected class to clicked method
            document.querySelector(`[onclick="selectPayment('${method}')"]`).classList.add('selected');
            
            // Store selected payment method
            localStorage.setItem('selectedPaymentMethod', method);
            
            console.log('Payment method selected:', method);
        }

        function getPaymentMethodName(method) {
            const paymentMethods = {
                'cash': 'üíµ Cash',
                'card': 'üí≥ Credit card',
                'paypal': 'üÖøÔ∏è PayPal'
            };
            return paymentMethods[method] || 'üíµ Cash';
        }

        // Load booking data from previous steps
        document.addEventListener('DOMContentLoaded', function() {
            initializeForm();
        });


        function initializeForm() {
            // Form validation
            const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
            const completeBtn = document.getElementById('completeBookingBtn');
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                field.addEventListener('input', function() {
                    validateForm();
                });
            });
            
            // Initialize phone input with flag detection
            initializePhoneInput();
            
            // Initialize payment method selection
            initializePaymentMethods();
            
            // Check if trip involves airport for flight number field
            checkAirportTrip();
            
            validateForm();
        }

        function initializePaymentMethods() {
            // Check if a payment method was already selected
            const savedPaymentMethod = localStorage.getItem('selectedPaymentMethod');
            
            if (savedPaymentMethod) {
                selectPayment(savedPaymentMethod);
                console.log('Loaded saved payment method:', savedPaymentMethod);
            } else {
                // Set default payment method to Cash
                selectPayment('cash');
                console.log('Set default payment method: cash');
            }
        }

        function checkAirportTrip() {
            // Get trip data from localStorage
            const fromLocation = localStorage.getItem('fromLocation') || '';
            const toLocation = localStorage.getItem('toLocation') || '';
            const returnActive = localStorage.getItem('returnActive') === 'true';
            
            // Check if either location is an airport
            const airportKeywords = ['airport', 'luchthaven', 'zaventem', 'charleroi', 'schiphol', 'eindhoven'];
            
            const fromLower = fromLocation.toLowerCase();
            const toLower = toLocation.toLowerCase();
            
            const isAirportPickup = airportKeywords.some(keyword => fromLower.includes(keyword));
            const isAirportDropoff = airportKeywords.some(keyword => toLower.includes(keyword));
            
            // Show flight number field for:
            // 1. Direct pickup from airport (heen reis)
            // 2. Return trip where the return journey starts from airport (terug reis vanuit luchthaven)
            const flightNumberGroup = document.getElementById('flightNumberGroup');
            const flightNumberInput = document.getElementById('flightNumber');
            
            let showFlightNumber = false;
            let flightNumberLabel = '';
            
            // MARCEL'S RULE: Vluchtnummer ALLEEN voor terugreis (Unconfirmed status)
            if (returnActive && isAirportDropoff) {
                // Alleen retour reis waarbij terugreis vanuit luchthaven vertrekt
                showFlightNumber = true;
                flightNumberLabel = 'Retour vluchtnummer (bijv. SN2714)';
                console.log('‚úàÔ∏è MARCEL: Retour reis - Flight number ENABLED for return trip from airport');
            } else if (isAirportPickup) {
                // Heen reis vanuit luchthaven - GEEN vluchtnummer meer!
                showFlightNumber = false;
                console.log('‚úàÔ∏è MARCEL: Heen reis - Flight number DISABLED for outbound airport pickup');
            }
            
            if (showFlightNumber) {
                flightNumberGroup.style.display = 'block';
                flightNumberInput.placeholder = flightNumberLabel;
                console.log('‚úàÔ∏è Showing flight number field: ' + flightNumberLabel);
            } else {
                flightNumberGroup.style.display = 'none';
                console.log('üöó No airport pickup - hiding flight number field');
            }
        }

        function initializePhoneInput() {
            const phoneInput = document.getElementById('phone');
            const phoneFlag = document.getElementById('phoneFlag');

            // Country codes with their flags and validation rules
            const countryData = {
                '+32': { flag: 'üáßüá™', name: 'Belgium', minLength: 12, maxLength: 12, example: '+32 xxx xx xx xx' },
                '+31': { flag: 'üá≥üá±', name: 'Netherlands', minLength: 12, maxLength: 12, example: '+31 x xxxx xxxx' },
                '+33': { flag: 'üá´üá∑', name: 'France', minLength: 12, maxLength: 12, example: '+33 x xx xx xx xx' },
                '+49': { flag: 'üá©üá™', name: 'Germany', minLength: 12, maxLength: 13, example: '+49 xxx xxxxxxx' },
                '+44': { flag: 'üá¨üáß', name: 'UK', minLength: 12, maxLength: 13, example: '+44 xxxx xxxxxx' },
                '+1': { flag: 'üá∫üá∏', name: 'USA/Canada', minLength: 12, maxLength: 12, example: '+1 xxx xxx xxxx' },
                '+34': { flag: 'üá™üá∏', name: 'Spain', minLength: 12, maxLength: 12, example: '+34 xxx xxx xxx' },
                '+39': { flag: 'üáÆüáπ', name: 'Italy', minLength: 12, maxLength: 13, example: '+39 xxx xxx xxxx' },
                '+41': { flag: 'üá®üá≠', name: 'Switzerland', minLength: 12, maxLength: 12, example: '+41 xx xxx xxxx' },
                '+43': { flag: 'üá¶üáπ', name: 'Austria', minLength: 12, maxLength: 13, example: '+43 xxx xxxxxxx' },
                '+45': { flag: 'üá©üá∞', name: 'Denmark', minLength: 11, maxLength: 11, example: '+45 xx xx xx xx' },
                '+46': { flag: 'üá∏üá™', name: 'Sweden', minLength: 12, maxLength: 12, example: '+46 xx xxx xxxx' },
                '+47': { flag: 'üá≥üá¥', name: 'Norway', minLength: 11, maxLength: 11, example: '+47 xxx xx xxx' },
                '+48': { flag: 'üáµüá±', name: 'Poland', minLength: 12, maxLength: 12, example: '+48 xxx xxx xxx' },
                '+351': { flag: 'üáµüáπ', name: 'Portugal', minLength: 13, maxLength: 13, example: '+351 xxx xxx xxx' },
                '+420': { flag: 'üá®üáø', name: 'Czech Republic', minLength: 13, maxLength: 13, example: '+420 xxx xxx xxx' },
                '+36': { flag: 'üá≠üá∫', name: 'Hungary', minLength: 12, maxLength: 12, example: '+36 xx xxx xxxx' },
                '+30': { flag: 'üá¨üá∑', name: 'Greece', minLength: 13, maxLength: 13, example: '+30 xxx xxx xxxx' },
                '+90': { flag: 'üáπüá∑', name: 'Turkey', minLength: 13, maxLength: 13, example: '+90 xxx xxx xxxx' },
                '+7': { flag: 'üá∑üá∫', name: 'Russia', minLength: 12, maxLength: 12, example: '+7 xxx xxx xxxx' },
                '+86': { flag: 'üá®üá≥', name: 'China', minLength: 13, maxLength: 13, example: '+86 xxx xxxx xxxx' },
                '+81': { flag: 'üáØüáµ', name: 'Japan', minLength: 13, maxLength: 13, example: '+81 xx xxxx xxxx' },
                '+82': { flag: 'üá∞üá∑', name: 'South Korea', minLength: 13, maxLength: 13, example: '+82 xx xxxx xxxx' },
                '+91': { flag: 'üáÆüá≥', name: 'India', minLength: 13, maxLength: 13, example: '+91 xxxxx xxxxx' },
                '+61': { flag: 'üá¶üá∫', name: 'Australia', minLength: 12, maxLength: 12, example: '+61 xxx xxx xxx' },
                '+64': { flag: 'üá≥üáø', name: 'New Zealand', minLength: 12, maxLength: 12, example: '+64 xx xxx xxxx' },
                '+27': { flag: 'üáøüá¶', name: 'South Africa', minLength: 12, maxLength: 12, example: '+27 xx xxx xxxx' },
                '+55': { flag: 'üáßüá∑', name: 'Brazil', minLength: 13, maxLength: 14, example: '+55 xx xxxxx xxxx' },
                '+52': { flag: 'üá≤üáΩ', name: 'Mexico', minLength: 13, maxLength: 13, example: '+52 xxx xxx xxxx' },
                '+54': { flag: 'üá¶üá∑', name: 'Argentina', minLength: 13, maxLength: 13, example: '+54 xxx xxx xxxx' },
                '+56': { flag: 'üá®üá±', name: 'Chile', minLength: 12, maxLength: 12, example: '+56 x xxxx xxxx' }
            };

            // Create validation message element
            const validationMessage = document.createElement('div');
            validationMessage.id = 'phoneValidationMessage';
            validationMessage.style.cssText = `
                margin-top: 8px;
                padding: 8px 12px;
                border-radius: 6px;
                font-size: 14px;
                display: none;
            `;
            phoneInput.parentNode.appendChild(validationMessage);

            phoneInput.addEventListener('input', function() {
                const value = this.value.trim();
                console.log('Phone input changed:', value);
                
                // Remove all non-digit characters except + for validation
                const digitsOnly = value.replace(/[^\d+]/g, '');
                
                // Sort country codes by length (longest first) to prevent conflicts
                const sortedCodes = Object.entries(countryData).sort((a, b) => b[0].length - a[0].length);
                
                let matchedCountry = null;
                let flagFound = false;
                
                // Check for country code matches
                for (const [code, data] of sortedCodes) {
                    if (digitsOnly.startsWith(code)) {
                        phoneFlag.textContent = data.flag;
                        matchedCountry = { code, ...data };
                        flagFound = true;
                        break;
                    }
                }
                
                // Default to Belgium flag if no match or empty
                if (!flagFound || !digitsOnly.startsWith('+')) {
                    phoneFlag.textContent = 'üáßüá™';
                    matchedCountry = { code: '+32', ...countryData['+32'] };
                }
                
                // Validate phone number length
                validatePhoneNumber(digitsOnly, matchedCountry, validationMessage, phoneInput);
                
                // Update form validation after phone validation
                validateForm();
            });

            // Set default Belgium flag and placeholder
            phoneFlag.textContent = 'üáßüá™';
            phoneInput.placeholder = countryData['+32'].example;
        }

        function validatePhoneNumber(phoneNumber, countryInfo, messageElement, inputElement) {
            const length = phoneNumber.length;
            
            // Clear previous validation state
            inputElement.style.borderColor = '';
            messageElement.style.display = 'none';
            
            // Don't validate if empty or just starting with +
            if (length <= 1) {
                inputElement.setAttribute('data-valid', 'false');
                return;
            }
            
            // Check if phone number is valid
            if (length >= countryInfo.minLength && length <= countryInfo.maxLength) {
                // Valid phone number
                inputElement.style.borderColor = '#28a745';
                messageElement.style.display = 'block';
                messageElement.style.backgroundColor = '#d4edda';
                messageElement.style.color = '#155724';
                messageElement.style.borderLeft = '4px solid #28a745';
                messageElement.innerHTML = `‚úÖ Valid ${countryInfo.name} phone number`;
                
                // Store validation state
                inputElement.setAttribute('data-valid', 'true');
                console.log(`‚úÖ Valid phone number for ${countryInfo.name}: ${phoneNumber}`);
                
            } else if (length < countryInfo.minLength) {
                // Too short
                inputElement.style.borderColor = '#ffc107';
                messageElement.style.display = 'block';
                messageElement.style.backgroundColor = '#fff3cd';
                messageElement.style.color = '#856404';
                messageElement.style.borderLeft = '4px solid #ffc107';
                messageElement.innerHTML = `‚ö†Ô∏è ${countryInfo.name} phone numbers need ${countryInfo.minLength} digits. Current: ${length}`;
                
                // Store validation state
                inputElement.setAttribute('data-valid', 'false');
                console.log(`‚ö†Ô∏è Phone number too short for ${countryInfo.name}: ${phoneNumber} (${length}/${countryInfo.minLength})`);
                
            } else if (length > countryInfo.maxLength) {
                // Too long
                inputElement.style.borderColor = '#dc3545';
                messageElement.style.display = 'block';
                messageElement.style.backgroundColor = '#f8d7da';
                messageElement.style.color = '#721c24';
                messageElement.style.borderLeft = '4px solid #dc3545';
                messageElement.innerHTML = `‚ùå ${countryInfo.name} phone numbers can't exceed ${countryInfo.maxLength} digits. Current: ${length}`;
                
                // Store validation state
                inputElement.setAttribute('data-valid', 'false');
                console.log(`‚ùå Phone number too long for ${countryInfo.name}: ${phoneNumber} (${length}/${countryInfo.maxLength})`);
            }
            
            // Update placeholder with country example
            inputElement.placeholder = countryInfo.example;
        }

        function validateForm() {
            const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
            const completeBtn = document.getElementById('completeBookingBtn');
            
            let allValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    allValid = false;
                }
            });
            
            // Email validation
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                allValid = false;
            }
            
            // Phone validation - check if phone number is valid
            const phoneField = document.getElementById('phone');
            const phoneValid = phoneField.getAttribute('data-valid') === 'true';
            if (phoneField.value.trim() && !phoneValid) {
                allValid = false;
            }
            
            completeBtn.disabled = !allValid;
            
            // Update button text based on validation state
            if (phoneField.value.trim() && !phoneValid) {
                completeBtn.textContent = 'Controleer telefoonnummer';
            } else if (!allValid) {
                completeBtn.textContent = 'Vul alle velden in';
            } else {
                completeBtn.textContent = 'Boeking Bevestigen';
            }
        }

        async function showBookingOverview() {
            // Get localStorage data
            
            // Validate form first
            const requiredFields = ['firstName', 'lastName', 'email', 'phone'];
            let allValid = true;
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    allValid = false;
                }
            });
            
            // Email validation
            const email = document.getElementById('email').value;
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email && !emailRegex.test(email)) {
                allValid = false;
            }
            
            if (!allValid) {
                alert('‚ö†Ô∏è Vul eerst alle verplichte velden correct in voordat u de bestelling bevestigt.');
                return;
            }
            
            // Generate overview content
            generateBookingOverview();
            
            // Show modal
            const modal = document.getElementById('bookingOverviewModal');
            modal.style.display = 'flex';
            
            // Add escape key listener
            document.addEventListener('keydown', handleEscapeKey);
        }

        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                closeBookingOverview();
            }
        }

        function closeBookingOverview() {
            const modal = document.getElementById('bookingOverviewModal');
            modal.style.display = 'none';
            
            // Remove escape key listener
            document.removeEventListener('keydown', handleEscapeKey);
        }

        function generateBookingOverview() {
            const body = document.getElementById('bookingOverviewBody');
            
            // Get all data with debugging
            const step1Data = {
                fromLocation: localStorage.getItem('fromLocation'),
                toLocation: localStorage.getItem('toLocation'),
                travelDate: localStorage.getItem('travelDate'),
                travelHour: localStorage.getItem('travelHour'),
                travelMinute: localStorage.getItem('travelMinute'),
                extraStops: JSON.parse(localStorage.getItem('extraStops') || '[]'),
                extraStopCount: parseInt(localStorage.getItem('extraStopCount') || '0'),
                returnActive: localStorage.getItem('returnActive'),
                returnDate: localStorage.getItem('returnDate'),
                returnHour: localStorage.getItem('returnHour'),
                returnMinute: localStorage.getItem('returnMinute')
            };
            
            const step2Data = JSON.parse(localStorage.getItem('selectedVehicleStep2') || '{}');
            const surchargeData = JSON.parse(localStorage.getItem('selectedSurcharges') || '{}');
            const passengerDetails = JSON.parse(localStorage.getItem('passengerDetails') || '{}');
            
            // Get all booking data
            
            const customerData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                passengers: passengerDetails.passengers || '1',
                specialRequests: document.getElementById('specialRequests').value || '',
                flightNumber: document.getElementById('flightNumber').value || '',
                paymentMethod: localStorage.getItem('selectedPaymentMethod') || 'cash'
            };
            
            let html = '';
            
            // Personal Information Section
            html += `
                <div class="overview-section">
                    <div class="overview-section-title">Persoonlijke Gegevens</div>
                    <div class="overview-row">
                        <span class="overview-label">Naam</span>
                        <span class="overview-value">${customerData.firstName} ${customerData.lastName}</span>
                    </div>
                    <div class="overview-row">
                        <span class="overview-label">Email</span>
                        <span class="overview-value">${customerData.email}</span>
                    </div>
                    <div class="overview-row">
                        <span class="overview-label">Telefoon</span>
                        <span class="overview-value">${customerData.phone}</span>
                    </div>
                    <div class="overview-row">
                        <span class="overview-label">Betaalmethode</span>
                        <span class="overview-value">${getPaymentMethodName(customerData.paymentMethod)}</span>
                    </div>
                    ${customerData.paymentMethod === 'paypal' ? `
                        <div class="overview-row">
                            <span class="overview-label">PayPal status</span>
                            <span class="overview-value">üí≥ Wordt verwerkt bij bevestiging</span>
                        </div>
                    ` : ''}
                    ${customerData.paymentMethod === 'card' ? `
                        <div class="overview-row">
                            <span class="overview-label">Credit Card status</span>
                            <span class="overview-value">üí≥ Wordt verwerkt bij bevestiging</span>
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Extra Travel Information Section
            if (customerData.flightNumber || customerData.specialRequests) {
                html += `
                    <div class="overview-section">
                        <div class="overview-section-title">Extra Reisgegevens</div>
                `;
                
                if (customerData.flightNumber) {
                    html += `
                        <div class="overview-row">
                            <span class="overview-label">Vluchtnummer</span>
                            <span class="overview-value">${customerData.flightNumber}</span>
                        </div>
                    `;
                }
                
                if (customerData.specialRequests) {
                    html += `
                        <div class="overview-row">
                            <span class="overview-label">Bijzondere verzoeken</span>
                            <span class="overview-value">${customerData.specialRequests}</span>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // Trip Information Section - Different layout for return trips
            if (step1Data.returnActive === 'true') {
                // RETURN TRIP - Show separate Heen and Terug sections
                html += `
                    <div class="overview-section">
                        <div class="overview-section-title">Reis Informatie</div>
                        
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Heen Rit</div>
                            <div class="overview-row">
                                <span class="overview-label">Van waar</span>
                                <span class="overview-value">${step1Data.fromLocation}</span>
                            </div>
                `;
                
                // Extra stops for outbound trip
                if (step1Data.extraStops && step1Data.extraStops.length > 0) {
                    step1Data.extraStops.forEach((stop, index) => {
                        html += `
                            <div class="overview-row">
                                <span class="overview-label">Extra stop ${index + 1}</span>
                                <span class="overview-value">${stop}</span>
                            </div>
                        `;
                    });
                }
                
                html += `
                            <div class="overview-row">
                                <span class="overview-label">Naar waar</span>
                                <span class="overview-value">${step1Data.toLocation}</span>
                            </div>
                            <div class="overview-row">
                                <span class="overview-label">Datum & Tijd</span>
                                <span class="overview-value">${step1Data.travelDate} om ${step1Data.travelHour}:${step1Data.travelMinute}</span>
                            </div>
                        </div>
                        
                        <div style="background: #e8f5e8; padding: 15px; border-radius: 8px;">
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 10px;">Terug Rit</div>
                            <div class="overview-row">
                                <span class="overview-label">Van waar</span>
                                <span class="overview-value">${step1Data.toLocation}</span>
                            </div>
                            <div class="overview-row">
                                <span class="overview-label">Naar waar</span>
                                <span class="overview-value">${step1Data.fromLocation}</span>
                            </div>
                            <div class="overview-row">
                                <span class="overview-label">Datum & Tijd</span>
                                <span class="overview-value">${step1Data.returnDate} om ${step1Data.returnHour}:${step1Data.returnMinute}</span>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // SINGLE TRIP - Show normal layout
                html += `
                    <div class="overview-section">
                        <div class="overview-section-title">Reis Informatie</div>
                        <div class="overview-row">
                            <span class="overview-label">Van waar</span>
                            <span class="overview-value">${step1Data.fromLocation}</span>
                        </div>
                `;
                
                // Extra stops for single trip
                if (step1Data.extraStops && step1Data.extraStops.length > 0) {
                    step1Data.extraStops.forEach((stop, index) => {
                        html += `
                            <div class="overview-row">
                                <span class="overview-label">Extra stop ${index + 1}</span>
                                <span class="overview-value">${stop}</span>
                            </div>
                        `;
                    });
                }
                
                html += `
                        <div class="overview-row">
                            <span class="overview-label">Naar waar</span>
                            <span class="overview-value">${step1Data.toLocation}</span>
                        </div>
                        <div class="overview-row">
                            <span class="overview-label">Datum & Tijd</span>
                            <span class="overview-value">${step1Data.travelDate} om ${step1Data.travelHour}:${step1Data.travelMinute}</span>
                        </div>
                    </div>
                `;
            }
            
            html += `
                    <div class="overview-row">
                        <span class="overview-label">Passagiers</span>
                        <span class="overview-value">${passengerDetails.passengers || '1'}</span>
                    </div>
                    <div class="overview-row">
                        <span class="overview-label">Koffers</span>
                        <span class="overview-value">${passengerDetails.koffers || '0'}</span>
                    </div>
                    <div class="overview-row">
                        <span class="overview-label">Handbagage</span>
                        <span class="overview-value">${passengerDetails.handbagage || '0'}</span>
                    </div>
                </div>
            `;
            
            // Vehicle Section - UNIVERSAL for all vehicles
            let vehicleData, vehiclePricing;
            
            // Handle different vehicle data structures from STEP 2
            if (step2Data.outbound && step2Data.outbound.vehicle) {
                vehicleData = step2Data.outbound.vehicle;
                vehiclePricing = step2Data.outbound.pricing;
            } else if (step2Data.vehicle && step2Data.pricing) {
                vehicleData = step2Data.vehicle;
                vehiclePricing = step2Data.pricing;
            } else {
                vehicleData = step2Data;
                vehiclePricing = step2Data.pricing || step2Data;
            }
            
            const vehicleName = vehicleData?.name || vehicleData?.type || 'Onbekend';
            const basePrice = vehiclePricing?.minimumPrice || vehiclePricing?.basePrice || 50.00;
            const isReturnTrip = step1Data.returnActive === 'true';
            
            
            html += `
                <div class="overview-section">
                    <div class="overview-section-title">Voertuig</div>
                    <div class="overview-row">
                        <span class="overview-label">Type</span>
                        <span class="overview-value">${vehicleName}</span>
                    </div>
                </div>
            `;
            
            // Extra Opties Section - Display ALL surcharges (selected + automatic)
            // Fix nested selectedSurcharges structure from step2
            let selectedSurcharges = surchargeData?.selectedSurcharges || {};
            
            // Handle nested selectedSurcharges structure
            while (selectedSurcharges.selectedSurcharges && typeof selectedSurcharges.selectedSurcharges === 'object') {
                selectedSurcharges = selectedSurcharges.selectedSurcharges;
            }
            
            const automaticCharges = surchargeData?.automaticCharges || {};
            const surchargeTotal = surchargeData?.surchargeTotal || surchargeData?.totalSurcharge || 0;
            
            const hasSelectedSurcharges = selectedSurcharges && Object.keys(selectedSurcharges).length > 0;
            const hasAutomaticCharges = automaticCharges && Object.keys(automaticCharges).length > 0;
            
            if (hasSelectedSurcharges || hasAutomaticCharges || surchargeTotal > 0) {
                html += `
                    <div class="overview-section">
                        <div class="overview-section-title">Extra Opties</div>
                `;
                
                let hasShownAnyItems = false;
                
                // Display manually selected surcharges
                if (hasSelectedSurcharges) {
                    Object.entries(selectedSurcharges).forEach(([key, value]) => {
                        // Skip technical fields
                        if (key === 'totalSurcharge' || key === 'surchargeTotal') return;
                        
                        if (typeof value === 'object' && value !== null && value.name) {
                            let itemPrice = parseFloat(value.price) || 0;
                            const itemQuantity = parseInt(value.quantity) || 1;
                            
                            // Fix: If return trip and price seems halved, restore to full price
                            // BUT NOT for Meet & Greet or Stopover (those are already correct prices)
                            if (step1Data.returnActive === 'true' && itemPrice > 0 && 
                                !key.toLowerCase().includes('meet') && !key.toLowerCase().includes('greet') &&
                                !key.toLowerCase().includes('stopover') && !key.toLowerCase().includes('via')) {
                                itemPrice = itemPrice * 2;
                            }
                            
                            const totalItemPrice = itemPrice * itemQuantity;
                            
                            if (itemPrice > 0) {
                                html += `
                                    <div class="overview-row">
                                        <span class="overview-label">${value.name}</span>
                                        <span class="overview-value">‚Ç¨${totalItemPrice.toFixed(2)}</span>
                                    </div>
                                `;
                                hasShownAnyItems = true;
                            }
                        }
                    });
                }
                
                // Display automatic charges (like stopover)
                if (hasAutomaticCharges) {
                    Object.entries(automaticCharges).forEach(([key, value]) => {
                        if (typeof value === 'object' && value !== null && value.name) {
                            let itemPrice = parseFloat(value.price) || 0;
                            const itemQuantity = parseInt(value.quantity) || 1;
                            
                            // Fix: If return trip and price seems halved, restore to full price
                            // BUT NOT for Meet & Greet or Stopover (those are already correct prices)
                            if (step1Data.returnActive === 'true' && itemPrice > 0 && 
                                !key.toLowerCase().includes('meet') && !key.toLowerCase().includes('greet') &&
                                !key.toLowerCase().includes('stopover') && !key.toLowerCase().includes('via')) {
                                itemPrice = itemPrice * 2;
                            }
                            
                            const totalItemPrice = itemPrice * itemQuantity;
                            
                            if (itemPrice > 0) {
                                html += `
                                    <div class="overview-row">
                                        <span class="overview-label">${value.name}</span>
                                        <span class="overview-value">‚Ç¨${totalItemPrice.toFixed(2)}</span>
                                    </div>
                                `;
                                hasShownAnyItems = true;
                            }
                        }
                    });
                }
                
                // If no individual items shown but there's a total, show it
                if (!hasShownAnyItems && surchargeTotal > 0) {
                    html += `
                        <div class="overview-row">
                            <span class="overview-label">Extra opties</span>
                            <span class="overview-value">‚Ç¨${parseFloat(surchargeTotal).toFixed(2)}</span>
                        </div>
                    `;
                }
                
                html += `</div>`;
            }
            
            // SIMPLIFIED PRICING - Just use step2FinalTotalPrice directly
            const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            let finalTotalPrice = step2FinalPrice;
            
            // Fallback if no step2 price available
            if (finalTotalPrice <= 0) {
                // Get base price from vehicle data
                let basePrice = 0;
                if (step2Data.outbound && step2Data.outbound.pricing) {
                    basePrice = parseFloat(step2Data.outbound.pricing.minimumPrice) || 0;
                } else if (step2Data.vehicle && step2Data.vehicle.pricing) {
                    basePrice = parseFloat(step2Data.vehicle.pricing.minimumPrice) || 0;
                } else if (step2Data.pricing) {
                    basePrice = parseFloat(step2Data.pricing.minimumPrice) || 0;
                }
                
                const surchargeTotal = parseFloat(surchargeData?.surchargeTotal || surchargeData?.totalSurcharge || 0);
                finalTotalPrice = basePrice + surchargeTotal;
            }
            
            // Simple price display for both single and return trips
            let priceBreakdownHTML;
            if (step1Data.returnActive === 'true') {
                priceBreakdownHTML = `
                    <div class="overview-total">
                        <div class="overview-total-row" style="font-weight: 700; font-size: 18px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                            <span>Totaal (Heen + Terug)</span>
                            <span>‚Ç¨${finalTotalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            } else {
                priceBreakdownHTML = `
                    <div class="overview-total">
                        <div class="overview-total-row">
                            <span>Totaalprijs:</span>
                            <span>‚Ç¨${finalTotalPrice.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            }
            
            // Add the price breakdown to HTML
            html += priceBreakdownHTML;
            
            body.innerHTML = html;
        }

        function getPaymentMethodName(method) {
            switch (method) {
                case 'cash': return 'üíµ Cash';
                case 'card': return 'üí≥ Credit card';
                case 'paypal': return 'üÖøÔ∏è PayPal';
                default: return method;
            }
        }

        async function confirmFinalBooking() {
            const paymentMethod = localStorage.getItem('selectedPaymentMethod') || 'cash';
            
            if (paymentMethod === 'paypal') {
                // Process PayPal payment
                await processPayPalPayment();
            } else if (paymentMethod === 'card') {
                // Process Credit Card payment
                await processCreditCardPayment();
            } else {
                // Process other payment methods
                closeBookingOverview();
                await completeBooking();
            }
        }

        async function processPayPalPayment() {
            // Get PayPal configuration from admin settings
            const paypalSettings = getPayPalSettings();
            
            if (!paypalSettings || !paypalSettings.active) {
                alert('PayPal is currently not available. Please choose another payment method.');
                return;
            }
            
            // Get total amount from Step 2
            const totalAmount = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            
            if (totalAmount <= 0) {
                alert('Invalid amount for PayPal payment.');
                return;
            }
            
            // Create PayPal payment
            try {
                console.log('üí≥ Processing PayPal payment:', {
                    amount: totalAmount,
                    currency: paypalSettings.currency,
                    environment: paypalSettings.environment
                });
                
                // Show processing message
                showPaymentProcessing('PayPal payment wordt verwerkt...');
                
                // Simulate PayPal payment process
                await simulatePayPalPayment(totalAmount, paypalSettings);
                
                // Payment successful
                hidePaymentProcessing();
                closeBookingOverview();
                await completeBooking();
                
            } catch (error) {
                console.error('PayPal payment failed:', error);
                hidePaymentProcessing();
                alert('PayPal payment failed. Please try again or choose another payment method.');
            }
        }
        
        function getPayPalSettings() {
            try {
                const paymentSettings = JSON.parse(localStorage.getItem('paymentSettings') || '{}');
                return paymentSettings.paypal || null;
            } catch (error) {
                console.error('Error loading PayPal settings:', error);
                return null;
            }
        }
        
        async function simulatePayPalPayment(amount, settings) {
            // Simulate PayPal payment process
            return new Promise((resolve, reject) => {
                // Simulate payment processing time
                setTimeout(() => {
                    // Calculate PayPal fee based on admin settings
                    const chargeType = settings.chargeType || 'percentage';
                    const chargeValue = parseFloat(settings.chargeValue || '3.6');
                    
                    let paypalFee = 0;
                    if (chargeType === 'percentage') {
                        paypalFee = (amount * chargeValue) / 100;
                    } else {
                        paypalFee = chargeValue;
                    }
                    
                    console.log('üí∞ PayPal payment details:', {
                        amount: amount,
                        fee: paypalFee,
                        total: amount + paypalFee,
                        currency: settings.currency
                    });
                    
                    // Store payment details for confirmation
                    localStorage.setItem('paypalPaymentDetails', JSON.stringify({
                        amount: amount,
                        fee: paypalFee,
                        total: amount + paypalFee,
                        currency: settings.currency,
                        environment: settings.environment,
                        transactionId: 'PP' + Date.now() + Math.random().toString(36).substr(2, 9)
                    }));
                    
                    // Simulate successful payment (90% success rate)
                    if (Math.random() < 0.9) {
                        resolve();
                    } else {
                        reject(new Error('PayPal payment failed'));
                    }
                }, 2000);
            });
        }
        
        function showPaymentProcessing(message) {
            // Create processing overlay
            const overlay = document.createElement('div');
            overlay.id = 'paymentProcessingOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
                color: white;
                font-size: 18px;
                font-weight: 600;
            `;
            
            overlay.innerHTML = `
                <div style="text-align: center; padding: 40px; background: #2c3e50; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
                    <div style="margin-bottom: 20px; font-size: 24px;">üÖøÔ∏è</div>
                    <div>${message}</div>
                    <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">Even geduld a.u.b...</div>
                </div>
            `;
            
            document.body.appendChild(overlay);
        }
        
        function hidePaymentProcessing() {
            const overlay = document.getElementById('paymentProcessingOverlay');
            if (overlay) {
                overlay.remove();
            }
        }

        async function processCreditCardPayment() {
            // Get Credit Card configuration from admin settings
            const creditCardSettings = getCreditCardSettings();
            
            if (!creditCardSettings || !creditCardSettings.enabled) {
                alert('Credit Card payment is currently not available. Please choose another payment method.');
                return;
            }
            
            // Get total amount from Step 2
            const totalAmount = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            
            if (totalAmount <= 0) {
                alert('Invalid amount for Credit Card payment.');
                return;
            }
            
            // Create Credit Card payment
            try {
                console.log('üí≥ Processing Credit Card payment:', {
                    amount: totalAmount,
                    currency: creditCardSettings.currency,
                    environment: creditCardSettings.environment
                });
                
                // Show processing message
                showPaymentProcessing('Credit Card payment wordt verwerkt...');
                
                // Simulate Credit Card payment process
                await simulateCreditCardPayment(totalAmount, creditCardSettings);
                
                // Payment successful
                hidePaymentProcessing();
                closeBookingOverview();
                await completeBooking();
                
            } catch (error) {
                console.error('Credit Card payment failed:', error);
                hidePaymentProcessing();
                alert('Credit Card payment failed. Please try again or choose another payment method.');
            }
        }
        
        function getCreditCardSettings() {
            try {
                const paymentSettings = JSON.parse(localStorage.getItem('paymentSettings') || '{}');
                const creditCardSettings = JSON.parse(localStorage.getItem('creditCardSettings') || '{}');
                return creditCardSettings.enabled ? creditCardSettings : null;
            } catch (error) {
                console.error('Error loading Credit Card settings:', error);
                return null;
            }
        }
        
        async function simulateCreditCardPayment(amount, settings) {
            // Simulate Credit Card payment process
            return new Promise((resolve, reject) => {
                // Simulate payment processing time
                setTimeout(() => {
                    // Calculate Credit Card fee based on admin settings
                    const chargeType = settings.chargeType || 'percent';
                    const chargeValue = parseFloat(settings.chargeValue || '6');
                    
                    let creditCardFee = 0;
                    if (chargeType === 'percent') {
                        creditCardFee = (amount * chargeValue) / 100;
                    } else {
                        creditCardFee = chargeValue;
                    }
                    
                    console.log('üí≥ Credit Card payment details:', {
                        amount: amount,
                        fee: creditCardFee,
                        total: amount + creditCardFee,
                        currency: settings.currency
                    });
                    
                    // Store payment details for confirmation
                    localStorage.setItem('creditCardPaymentDetails', JSON.stringify({
                        amount: amount,
                        fee: creditCardFee,
                        total: amount + creditCardFee,
                        currency: settings.currency,
                        environment: settings.environment,
                        transactionId: 'CC' + Date.now() + Math.random().toString(36).substr(2, 9),
                        cardType: 'Visa', // Simulate card type
                        last4: '4242' // Simulate last 4 digits
                    }));
                    
                    // Simulate successful payment (90% success rate)
                    if (Math.random() < 0.9) {
                        resolve();
                    } else {
                        reject(new Error('Credit Card payment failed'));
                    }
                }, 2500);
            });
        }

        async function completeBooking() {
            // Get passenger details from STAP 2
            const passengerDetails = JSON.parse(localStorage.getItem('passengerDetails') || '{}');
            
            // Collect all form data
            const customerData = {
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                passengers: passengerDetails.passengers || '1',
                specialRequests: document.getElementById('specialRequests').value || '',
                flightNumber: document.getElementById('flightNumber').value || '',
                koffers: passengerDetails.koffers || '0',
                handbagage: passengerDetails.handbagage || '0',
                paymentMethod: localStorage.getItem('selectedPaymentMethod') || 'cash'
            };
            
            // Add PayPal payment details if PayPal was used
            const paypalDetails = localStorage.getItem('paypalPaymentDetails');
            if (paypalDetails && customerData.paymentMethod === 'paypal') {
                customerData.paypalPayment = JSON.parse(paypalDetails);
            }
            
            // Add Credit Card payment details if Credit Card was used
            const creditCardDetails = localStorage.getItem('creditCardPaymentDetails');
            if (creditCardDetails && customerData.paymentMethod === 'card') {
                customerData.creditCardPayment = JSON.parse(creditCardDetails);
            }

            // Get booking data
            const step1Data = {
                fromLocation: localStorage.getItem('fromLocation'),
                toLocation: localStorage.getItem('toLocation'),
                travelDate: localStorage.getItem('travelDate'),
                travelHour: localStorage.getItem('travelHour'),
                travelMinute: localStorage.getItem('travelMinute'),
                extraStopCount: localStorage.getItem('extraStopCount'),
                extraStops: JSON.parse(localStorage.getItem('extraStops') || '[]'),
                returnActive: localStorage.getItem('returnActive'),
                returnDate: localStorage.getItem('returnDate'),
                returnHour: localStorage.getItem('returnHour'),
                returnMinute: localStorage.getItem('returnMinute')
            };

            const step2Data = JSON.parse(localStorage.getItem('selectedVehicleStep2') || '{}');
            
            // üÜï Load surcharge data including Meet & Greet locations for email
            const surchargeData = JSON.parse(localStorage.getItem('selectedSurcharges') || '{}');
            console.log('üìß CRITICAL DEBUG - Loaded surcharge data for email:', surchargeData);
            console.log('üìß CRITICAL DEBUG - localStorage selectedSurcharges RAW:', localStorage.getItem('selectedSurcharges'));
            console.log('üìß CRITICAL DEBUG - Object.keys(surchargeData):', Object.keys(surchargeData));
            console.log('üìß CRITICAL DEBUG - Object.values(surchargeData):', Object.values(surchargeData));

            // Generate shared base code for heen/terug trips
            const sharedBaseCode = generateBookingId('heen').slice(0, -1); // Remove the 'a' suffix to get base code
            
            // Handle both old and new vehicle selection formats
            let outboundVehicle, returnVehicle;
            if (step2Data.hasReturnTrip !== undefined) {
                // New format with separate outbound and return vehicles
                outboundVehicle = step2Data.outbound;
                returnVehicle = step2Data.return;
            } else {
                // Old format - single vehicle for both trips
                outboundVehicle = step2Data;
                returnVehicle = step2Data;
            }

            // Calculate final total price and individual trip prices
            const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            const surchargeTotal = parseFloat(surchargeData?.surchargeTotal || 0);
            const basePrice = step2Data?.pricing?.totalPrice || step2Data?.vehicle?.price || 0;
            const finalTotalPrice = step2FinalPrice > 0 ? step2FinalPrice : (parseFloat(basePrice) + surchargeTotal);
            
            // Calculate individual trip prices based on Meet & Greet location
            let heenTripPrice, terugTripPrice;
            
            if (step1Data.returnActive === 'true') {
                // For return trips, calculate prices based on where Meet & Greet is needed
                const basePricePerTrip = (finalTotalPrice - surchargeTotal) / 2; // Base price split evenly
                
                // Check which trip needs Meet & Greet
                const heenNeedsMeetGreet = checkIfLocationNeedsMeetGreet(step1Data.fromLocation);
                const terugNeedsMeetGreet = checkIfLocationNeedsMeetGreet(step1Data.toLocation);
                
                if (heenNeedsMeetGreet && !terugNeedsMeetGreet) {
                    // Heen trip has Meet & Greet
                    heenTripPrice = basePricePerTrip + surchargeTotal;
                    terugTripPrice = basePricePerTrip;
                } else if (!heenNeedsMeetGreet && terugNeedsMeetGreet) {
                    // Terug trip has Meet & Greet  
                    heenTripPrice = basePricePerTrip;
                    terugTripPrice = basePricePerTrip + surchargeTotal;
                } else {
                    // Split evenly if no Meet & Greet or both have it
                    heenTripPrice = finalTotalPrice / 2;
                    terugTripPrice = finalTotalPrice / 2;
                }
            } else {
                // Single trip gets full price
                heenTripPrice = finalTotalPrice;
            }
            
            // Helper function to check if location needs Meet & Greet
            function checkIfLocationNeedsMeetGreet(location) {
                if (!location) return false;
                const loc = location.toLowerCase();
                return loc.includes('airport') || loc.includes('luchthaven') || 
                       loc.includes('zaventem') || loc.includes('charleroi') ||
                       loc.includes('station') || loc.includes('centraal');
            }

            // Create main booking (heen trip)
            const mainBooking = {
                customer: customerData,
                trip: {
                    ...step1Data,
                    tripType: 'heen',
                    direction: 'outbound',
                    extraStops: step1Data.extraStops || [] // Ensure extra stops are included
                },
                vehicle: outboundVehicle,
                surcharges: surchargeData, // üÜï Include surcharge data (including Meet & Greet locations)
                bookingDate: new Date().toISOString(),
                bookingId: generateBookingId('heen', sharedBaseCode),
                // Add individual trip price for heen
                tripPrice: heenTripPrice,
                totalPrice: finalTotalPrice
            };

            // Save main booking
            localStorage.setItem('completedBooking', JSON.stringify(mainBooking));
            
            // Add main booking to unconfirmed bookings list
            console.log('üìã Adding main booking (heen) to unconfirmed list:', mainBooking.bookingId);
            addToUnconfirmedBookings(mainBooking);

            // Create return booking if return trip is active
            let returnBooking = null;
            if (step1Data.returnActive === 'true' && step1Data.returnDate && step1Data.returnHour && step1Data.returnMinute) {
                // Calculate return trip surcharges (different pickup location)
                const returnSurchargeData = JSON.parse(JSON.stringify(surchargeData)); // Deep copy
                
                // Recalculate airport surcharge for return trip
                const returnFromAirport = isAirportLocation(step1Data.toLocation);
                if (returnFromAirport) {
                    // Add airport surcharge if return trip starts from airport
                    returnSurchargeData.totalSurcharge = (returnSurchargeData.totalSurcharge || 0) + 5.00;
                    if (!returnSurchargeData.items) returnSurchargeData.items = {};
                    returnSurchargeData.items.airport_surcharge = {
                        name: 'Airport surcharge',
                        price: 5.00,
                        quantity: 1
                    };
                } else {
                    // Remove airport surcharge if return trip doesn't start from airport
                    if (returnSurchargeData.items && returnSurchargeData.items.airport_surcharge) {
                        returnSurchargeData.totalSurcharge = (returnSurchargeData.totalSurcharge || 0) - 5.00;
                        delete returnSurchargeData.items.airport_surcharge;
                    }
                }
                
                // Recalculate return vehicle pricing based on return trip specifics
                const returnPricing = JSON.parse(JSON.stringify(returnVehicle.pricing)); // Deep copy
                returnPricing.totalPrice = (returnPricing.minimumPrice || 50.00) + (returnSurchargeData.totalSurcharge || 0);
                
                returnBooking = {
                    customer: customerData,
                    trip: {
                        fromLocation: step1Data.toLocation, // Reversed: from destination back to origin
                        toLocation: step1Data.fromLocation, // Reversed: to origin from destination
                        travelDate: step1Data.returnDate,
                        travelHour: step1Data.returnHour,
                        travelMinute: step1Data.returnMinute,
                        extraStopCount: step1Data.extraStopCount || '0', // Same extra stops as outbound
                        extraStops: step1Data.extraStops || [], // Same extra stops as outbound trip
                        returnActive: 'false', // Return trip doesn't have another return
                        tripType: 'terug',
                        direction: 'inbound',
                        relatedBookingId: mainBooking.bookingId // Link to main booking
                    },
                    vehicle: {
                        ...returnVehicle,
                        pricing: returnPricing
                    },
                    surcharges: returnSurchargeData,
                    bookingDate: new Date().toISOString(),
                    bookingId: generateBookingId('terug', sharedBaseCode),
                    // Add individual trip price for terug
                    tripPrice: terugTripPrice,
                    totalPrice: finalTotalPrice
                };
                
                console.log('üìã Adding return booking (terug) to unconfirmed list:', returnBooking.bookingId);
                addToUnconfirmedBookings(returnBooking);
            }
            
            // Verify it was added
            const unconfirmedCheck = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            console.log('üìã Unconfirmed bookings after adding:', unconfirmedCheck.length);

            console.log('‚úÖ Booking completed!', mainBooking);
            if (returnBooking) {
                console.log('‚úÖ Return booking created!', returnBooking);
            }

            // Send emails for main booking (and return booking if exists)
            try {
                // Show processing message
                const originalBtn = document.getElementById('completeBookingBtn');
                originalBtn.disabled = true;
                originalBtn.textContent = 'Verzenden...';
                
                // Get email settings from admin panel
                const emailSettings = {
                    fromName: localStorage.getItem('adminFromName') || 'Marcel\'s Taxi',
                    fromEmail: localStorage.getItem('adminFromEmail') || 'info@airporttransfer.be',
                    smtpHost: localStorage.getItem('adminSmtpHost') || 'smtp.gmail.com',
                    smtpPort: localStorage.getItem('adminSmtpPort') || '587',
                    smtpUsername: localStorage.getItem('adminSmtpUsername') || 'info@airporttransfer.be',
                    smtpPassword: localStorage.getItem('adminSmtpPassword') || ''
                };

                // Get email template from admin panel
                const emailTemplate = JSON.parse(localStorage.getItem('emailTemplate') || '{}');

                // Send email for main booking
                const response = await fetch('/api/send-booking-email', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        ...mainBooking,
                        emailSettings: emailSettings,
                        emailTemplate: emailTemplate
                    })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ Main booking email sent successfully:', result);
                } else {
                    throw new Error(result.error || 'Email sending failed');
                }

                // Send email for return booking if exists
                if (returnBooking) {
                    const returnResponse = await fetch('/api/send-booking-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            ...returnBooking,
                            emailSettings: emailSettings,
                            emailTemplate: emailTemplate
                        })
                    });
                    
                    const returnResult = await returnResponse.json();
                    
                    if (returnResult.success) {
                        console.log('‚úÖ Return booking email sent successfully:', returnResult);
                    } else {
                        console.warn('‚ö†Ô∏è Return booking email failed:', returnResult.error);
                    }
                }
                
                // Show success confirmation
                let successMessage = `‚úÖ Boeking${returnBooking ? 'en' : ''} Bevestigd!

HEEN REIS:
Boeking ID: ${mainBooking.bookingId}
Klant: ${customerData.firstName} ${customerData.lastName}
Van: ${step1Data.fromLocation}
Naar: ${step1Data.toLocation}
Datum: ${step1Data.travelDate} om ${step1Data.travelHour}:${step1Data.travelMinute}
Voertuig: ${outboundVehicle?.vehicle?.name || 'Niet gespecificeerd'}
Betaalmethode: ${customerData.paymentMethod}`;

                if (returnBooking) {
                    successMessage += `

TERUG REIS:
Boeking ID: ${returnBooking.bookingId}
Van: ${step1Data.toLocation}
Naar: ${step1Data.fromLocation}
Datum: ${step1Data.returnDate} om ${step1Data.returnHour}:${step1Data.returnMinute}
Voertuig: ${returnVehicle?.vehicle?.name || 'Niet gespecificeerd'}`;
                }

                successMessage += `

‚úÖ Bevestigingsmail verzonden naar: ${customerData.email}
‚úÖ Notificatie verzonden naar admin`;

                alert(successMessage);
                
            } catch (error) {
                console.error('‚ùå Email sending failed:', error);
                
                let errorMessage = `‚úÖ Boeking${returnBooking ? 'en' : ''} Bevestigd!

HEEN REIS:
Boeking ID: ${mainBooking.bookingId}
Klant: ${customerData.firstName} ${customerData.lastName}
Van: ${step1Data.fromLocation}
Naar: ${step1Data.toLocation}
Datum: ${step1Data.travelDate} om ${step1Data.travelHour}:${step1Data.travelMinute}
Voertuig: ${outboundVehicle?.vehicle?.name || 'Niet gespecificeerd'}`;

                if (returnBooking) {
                    errorMessage += `

TERUG REIS:
Boeking ID: ${returnBooking.bookingId}
Van: ${step1Data.toLocation}
Naar: ${step1Data.fromLocation}
Datum: ${step1Data.returnDate} om ${step1Data.returnHour}:${step1Data.returnMinute}
Voertuig: ${returnVehicle?.vehicle?.name || 'Niet gespecificeerd'}`;
                }

                errorMessage += `

‚ö†Ô∏è Email kon niet worden verzonden. We nemen contact met u op.`;

                alert(errorMessage);
            }

            // Reset form and redirect
            setTimeout(() => {
                // Clear booking data
                clearBookingData();
                // Redirect to step 1 for new booking
                window.location.href = 'booking-exact.html';
            }, 3000);
        }

        function generateBookingId(tripType, baseCode = null) {
            // Generate short 6-character base code like "0OCQ3K"
            if (!baseCode) {
                const chars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                baseCode = '';
                for (let i = 0; i < 6; i++) {
                    baseCode += chars.charAt(Math.floor(Math.random() * chars.length));
                }
            }
            
            // Add suffix: 'a' for heen, 'b' for terug
            const suffix = tripType === 'terug' ? 'b' : 'a';
            return baseCode + suffix;
        }
        
        function isAirportLocation(location) {
            if (!location) return false;
            const airportKeywords = [
                'Brussels Airport', 'Brussels South Charleroi Airport', 'Antwerp Airport',
                'Li√®ge Airport', 'Ostend-Bruges Airport', 'airport', 'luchthaven', 'BRU', 'CRL'
            ];
            return airportKeywords.some(keyword => 
                location.toLowerCase().includes(keyword.toLowerCase())
            );
        }

        function addToUnconfirmedBookings(booking) {
            // Get existing unconfirmed bookings
            let unconfirmedBookings = JSON.parse(localStorage.getItem('unconfirmedBookings') || '[]');
            
            // Add new booking with status
            const bookingWithStatus = {
                ...booking,
                status: 'unconfirmed',
                createdAt: new Date().toISOString(),
                lastUpdated: new Date().toISOString()
            };
            
            unconfirmedBookings.unshift(bookingWithStatus); // Add to beginning of array
            
            // Keep only last 100 bookings to prevent storage overflow
            if (unconfirmedBookings.length > 100) {
                unconfirmedBookings = unconfirmedBookings.slice(0, 100);
            }
            
            // Save back to localStorage
            localStorage.setItem('unconfirmedBookings', JSON.stringify(unconfirmedBookings));
            
            console.log('üìã Booking added to unconfirmed list:', booking.bookingId);
        }

        function clearBookingData() {
            const keys = [
                'fromLocation', 'toLocation', 'travelDate', 'travelHour', 'travelMinute',
                'extraStopCount', 'extraStops', 'returnActive', 'returnDate', 'returnHour', 
                'returnMinute', 'selectedVehicleStep2', 'selectedSurcharges', 'passengerDetails',
                'selectedPaymentMethod'
            ];
            keys.forEach(key => localStorage.removeItem(key));
        }

        function goBack() {
            window.location.href = 'step2.html';
        }

        function goToStep1() {
            window.location.href = 'booking-exact.html';
        }

        function goToStep(stepNumber) {
            if (stepNumber === 1) {
                window.location.href = 'booking-exact.html';
            } else if (stepNumber === 2) {
                window.location.href = 'step2.html';
            }
        }

        // üîç SIMPLE TEST FUNCTION
        window.testOverview = function() {
            console.log('=== OVERZICHT TEST ===');
            
            const step2Data = JSON.parse(localStorage.getItem('selectedVehicleStep2') || '{}');
            const surchargeData = JSON.parse(localStorage.getItem('selectedSurcharges') || '{}');
            
            console.log('STAP 2 Data:', step2Data);
            console.log('Surcharge Data:', surchargeData);
            
            // Test what should appear in overview
            const vehicleName = step2Data?.outbound?.vehicle?.name || 'Onbekend';
            const basePrice = step2Data?.outbound?.pricing?.minimumPrice || 50;
            const surchargeTotal = surchargeData?.surchargeTotal || 0;
            
            // Use the correct final price from step2 (includes last-minute surcharge)
            const step2FinalPrice = parseFloat(localStorage.getItem('step2FinalTotalPrice') || '0');
            const finalTotal = step2FinalPrice > 0 ? step2FinalPrice : basePrice + surchargeTotal;
            
            console.log('OVERZICHT MOET TONEN:');
            console.log(`Vehicle: ${vehicleName}`);
            console.log(`Basis prijs: ‚Ç¨${basePrice}`);
            console.log(`Surcharge totaal: ‚Ç¨${surchargeTotal}`);
            console.log(`Step2 final price (incl. last-minute): ‚Ç¨${step2FinalPrice}`);
            console.log(`EINDTOTAAL: ‚Ç¨${finalTotal}`);
            
            // Test surcharge items
            const selectedSurcharges = surchargeData?.selectedSurcharges || {};
            console.log('EXTRA OPTIES:');
            Object.entries(selectedSurcharges).forEach(([key, value]) => {
                if (key !== 'totalSurcharge' && value?.name && value?.price > 0) {
                    console.log(`  ${value.name}: ‚Ç¨${value.price}`);
                }
            });
        };
        // Emergency fallback: Define driver functions globally to prevent errors
        function showAddDriverModal() {
            alert('Deze functie is alleen beschikbaar in het admin panel');
        }
        function refreshDriversList() {
            console.log('refreshDriversList called from step3 - redirecting to admin');
        }
        function editDriver() {
            alert('Deze functie is alleen beschikbaar in het admin panel');
        }
        function deleteDriver() {
            alert('Deze functie is alleen beschikbaar in het admin panel');
        }
        function searchDrivers() {
            console.log('searchDrivers called from step3');
        }
        
        // Make them global
        window.showAddDriverModal = showAddDriverModal;
        window.refreshDriversList = refreshDriversList;
        window.editDriver = editDriver;
        window.deleteDriver = deleteDriver;
        window.searchDrivers = searchDrivers;
    </script>
</body>
</html>